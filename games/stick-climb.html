<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STICK CLIMB</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{--c1:#7B4FFF;--c2:#00D4FF;--c3:#FF6B35;--c4:#FF2255;--gold:#FFD000;--dark:#03020A;--coin:#FFCC00;}
body{background:#000;overflow:hidden;font-family:'Orbitron',sans-serif;cursor:none;}
canvas{display:block;}
#cursor{position:fixed;width:12px;height:12px;border:1.5px solid var(--c2);border-radius:50%;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);background:rgba(0,212,255,0.1);box-shadow:0 0 8px var(--c2);}
#cursor::after{content:'';position:absolute;top:50%;left:50%;width:3px;height:3px;background:var(--c2);border-radius:50%;transform:translate(-50%,-50%);}
#vignette{position:fixed;inset:0;pointer-events:none;z-index:50;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,0.92) 100%);}
#scanlines{position:fixed;inset:0;pointer-events:none;z-index:51;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.05) 3px,rgba(0,0,0,0.05) 6px);opacity:0.3;}
#flash{position:fixed;inset:0;pointer-events:none;z-index:53;background:rgba(123,79,255,0.4);opacity:0;transition:opacity 0.05s;}
#cpFlash{position:fixed;inset:0;pointer-events:none;z-index:55;background:rgba(0,212,255,0.1);opacity:0;border:2px solid rgba(0,212,255,0.4);transition:opacity 0.15s;}
#winFlash{position:fixed;inset:0;pointer-events:none;z-index:60;background:radial-gradient(ellipse at center,rgba(255,208,0,0.35) 0%,transparent 70%);opacity:0;transition:opacity 0.1s;}
#cpMsg{position:fixed;top:42%;left:50%;transform:translate(-50%,-50%);z-index:56;pointer-events:none;font-size:1.4rem;letter-spacing:8px;color:var(--c2);text-shadow:0 0 30px var(--c2);opacity:0;transition:opacity 0.2s;font-weight:700;}

/* MENU */
#menu{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:var(--dark);}
#menu.hide{display:none;}
.menu-bg{position:absolute;inset:0;background:radial-gradient(ellipse 70% 50% at 50% 110%,rgba(123,79,255,0.2) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 15% 25%,rgba(0,212,255,0.1) 0%,transparent 55%);}
.menu-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(123,79,255,0.05) 1px,transparent 1px),linear-gradient(90deg,rgba(123,79,255,0.05) 1px,transparent 1px);background-size:50px 50px;mask-image:radial-gradient(ellipse at center,black 20%,transparent 75%);}
.menu-inner{position:relative;z-index:1;text-align:center;max-width:600px;padding:0 24px;}
.menu-eyebrow{font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:5px;color:var(--c2);margin-bottom:8px;opacity:0.6;}
.menu-title{font-size:clamp(4rem,10vw,7rem);letter-spacing:6px;line-height:0.88;color:#fff;font-weight:900;text-shadow:0 0 80px rgba(123,79,255,0.6),3px 3px 0 rgba(123,79,255,0.4);margin-bottom:4px;}
.menu-title .accent{color:var(--c1);}
.menu-sub{font-family:'Space Mono',monospace;font-size:0.65rem;color:#aaa;letter-spacing:4px;margin-bottom:20px;}
.menu-name-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;}
.menu-name-badge{background:rgba(123,79,255,0.1);border:1px solid rgba(123,79,255,0.3);border-radius:20px;padding:6px 16px;font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:2px;color:var(--c2);}
.menu-name-change{background:none;border:1px solid rgba(0,212,255,0.2);border-radius:4px;padding:4px 10px;font-family:'Space Mono',monospace;font-size:0.55rem;letter-spacing:2px;color:#aaa;cursor:none;transition:all 0.2s;}
.menu-name-change:hover{color:var(--c2);border-color:rgba(0,212,255,0.5);}
.menu-controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:18px;}
.ctrl-card{background:rgba(123,79,255,0.05);border:1px solid rgba(123,79,255,0.18);border-radius:6px;padding:11px 14px;text-align:left;}
.ctrl-card-label{font-family:'Space Mono',monospace;font-size:0.55rem;letter-spacing:3px;color:var(--c2);margin-bottom:5px;}
.ctrl-card-keys{font-family:'Space Mono',monospace;font-size:0.62rem;color:#bbb;line-height:1.8;}
.ctrl-card-keys b{background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);border-radius:3px;padding:1px 5px;color:#ddd;font-size:0.6rem;}
.menu-btn-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:10px;}
.play-btn{padding:12px 44px;background:linear-gradient(135deg,var(--c1),var(--c4));border:none;border-radius:5px;color:#fff;font-family:'Orbitron',sans-serif;font-size:1.05rem;font-weight:700;letter-spacing:4px;cursor:none;transition:all 0.25s;box-shadow:0 0 40px rgba(123,79,255,0.5);}
.play-btn:hover{transform:translateY(-2px);box-shadow:0 0 60px rgba(123,79,255,0.8);}
.icon-btn{padding:12px 20px;background:transparent;border:1px solid rgba(0,212,255,0.3);border-radius:5px;color:var(--c2);font-family:'Orbitron',sans-serif;font-size:0.85rem;font-weight:700;letter-spacing:3px;cursor:none;transition:all 0.25s;}
.icon-btn:hover{background:rgba(0,212,255,0.08);border-color:var(--c2);}
.menu-tagline{font-family:'Space Mono',monospace;font-size:0.55rem;color:#888;letter-spacing:2px;}

/* MINI LB */
#miniLB{position:fixed;top:16px;right:16px;z-index:210;background:rgba(3,2,15,0.9);border:1px solid rgba(123,79,255,0.25);border-radius:8px;padding:12px 16px;min-width:200px;backdrop-filter:blur(12px);}
.mini-lb-title{font-family:'Space Mono',monospace;font-size:0.52rem;letter-spacing:3px;color:var(--c2);margin-bottom:8px;}
.mini-lb-row{display:flex;gap:8px;align-items:center;margin-bottom:4px;}
.mini-lb-rank{font-family:'Space Mono',monospace;font-size:0.55rem;color:#888;width:14px;}
.mini-lb-name{font-family:'Space Mono',monospace;font-size:0.6rem;color:#ddd;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mini-lb-score{font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--gold);}
.mini-lb-me{color:var(--c2) !important;}

/* NAME MODAL */
#nameModal{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;background:rgba(3,2,10,0.95);backdrop-filter:blur(20px);}
#nameModal.hide{display:none;}
.name-modal-box{background:rgba(12,8,30,0.98);border:1px solid rgba(123,79,255,0.4);border-radius:12px;padding:36px 40px;max-width:420px;width:90%;text-align:center;}
.name-modal-title{font-size:1.6rem;font-weight:900;letter-spacing:5px;color:#fff;margin-bottom:6px;text-shadow:0 0 30px rgba(123,79,255,0.5);}
.name-modal-sub{font-family:'Space Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:3px;margin-bottom:24px;}
.name-input{width:100%;background:rgba(123,79,255,0.08);border:1px solid rgba(123,79,255,0.3);border-radius:6px;padding:12px 16px;color:#fff;font-family:'Orbitron',sans-serif;font-size:1rem;letter-spacing:3px;text-align:center;outline:none;transition:border-color 0.2s;margin-bottom:10px;}
.name-input:focus{border-color:var(--c1);box-shadow:0 0 20px rgba(123,79,255,0.3);}
.name-error{font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--c4);letter-spacing:2px;min-height:1.2rem;margin-bottom:10px;}
.name-confirm-btn{padding:12px 40px;background:linear-gradient(135deg,var(--c1),var(--c4));border:none;border-radius:5px;color:#fff;font-family:'Orbitron',sans-serif;font-size:0.9rem;font-weight:700;letter-spacing:4px;cursor:none;transition:all 0.25s;width:100%;}
.name-confirm-btn:hover{transform:translateY(-1px);box-shadow:0 0 30px rgba(123,79,255,0.6);}
.name-note{font-family:'Space Mono',monospace;font-size:0.52rem;color:#888;letter-spacing:1px;margin-top:12px;}

/* WORLDS */
#worldsScreen{position:fixed;inset:0;z-index:205;display:none;flex-direction:column;align-items:center;justify-content:flex-start;background:var(--dark);overflow-y:auto;padding:28px 20px 36px;}
#worldsScreen.show{display:flex;}
.worlds-title{font-size:2rem;font-weight:900;letter-spacing:6px;color:#fff;margin-bottom:4px;text-shadow:0 0 30px rgba(123,79,255,0.5);}
.worlds-sub{font-family:'Space Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:3px;}
.worlds-header{text-align:center;margin-bottom:20px;}
.worlds-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;max-width:860px;width:100%;margin:0 auto 20px;}
.world-card{background:rgba(123,79,255,0.05);border:1px solid rgba(123,79,255,0.18);border-radius:10px;padding:16px;cursor:none;transition:all 0.25s;position:relative;overflow:hidden;}
.world-card.unlocked:hover{transform:translateY(-2px);border-color:var(--c1);box-shadow:0 8px 30px rgba(123,79,255,0.25);}
.world-card.locked{opacity:0.35;filter:grayscale(0.7);}
.world-card-num{font-family:'Space Mono',monospace;font-size:0.5rem;color:var(--c2);letter-spacing:3px;margin-bottom:4px;}
.world-card-name{font-size:0.95rem;font-weight:700;letter-spacing:3px;color:#fff;margin-bottom:2px;}
.world-card-theme{font-family:'Space Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:2px;margin-bottom:8px;}
.world-card-stages{display:flex;gap:3px;margin-bottom:6px;}
.stage-dot{width:16px;height:4px;border-radius:2px;background:rgba(255,255,255,0.08);}
.stage-dot.done{background:linear-gradient(90deg,var(--c1),var(--c2));}
.world-card-stars{font-size:0.85rem;letter-spacing:3px;color:var(--gold);min-height:1rem;}
.world-card-coins{font-family:'Space Mono',monospace;font-size:0.55rem;color:var(--coin);letter-spacing:1px;}
.world-card-action{font-family:'Space Mono',monospace;font-size:0.55rem;color:var(--c2);letter-spacing:2px;margin-top:4px;}
.world-card-lock{position:absolute;top:12px;right:14px;font-size:0.95rem;opacity:0.4;}
.world-card-bar{position:absolute;bottom:0;left:0;height:2px;width:0%;background:linear-gradient(90deg,var(--c1),var(--c2));transition:width 0.35s;}
.world-card.unlocked:hover .world-card-bar{width:100%;}
.back-btn{font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:3px;color:#aaa;background:none;border:none;cursor:none;transition:color 0.2s;padding:8px 16px;}
.back-btn:hover{color:var(--c2);}

/* LEADERBOARD */
#lbScreen{position:fixed;inset:0;z-index:206;display:none;flex-direction:column;align-items:center;background:var(--dark);overflow-y:auto;padding:24px 20px 36px;}
#lbScreen.show{display:flex;}
.lb-title{font-size:2rem;font-weight:900;letter-spacing:6px;color:#fff;margin-bottom:4px;}
.lb-sub{font-family:'Space Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:3px;}
.lb-header{text-align:center;margin-bottom:18px;}
.lb-cat-tabs{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:16px;}
.lb-cat-btn{padding:8px 18px;background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.2);border-radius:4px;color:#aaa;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:2px;cursor:none;transition:all 0.2s;}
.lb-cat-btn.active{background:rgba(123,79,255,0.2);border-color:var(--c1);color:var(--c2);}
.lb-world-tabs{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;max-width:800px;}
.lb-world-btn{padding:5px 11px;background:rgba(0,0,0,0.3);border:1px solid rgba(123,79,255,0.15);border-radius:3px;color:#aaa;font-family:'Space Mono',monospace;font-size:0.52rem;letter-spacing:1px;cursor:none;transition:all 0.2s;}
.lb-world-btn.active{border-color:var(--c2);color:var(--c2);}
.lb-table{max-width:660px;width:100%;background:rgba(3,2,15,0.7);border:1px solid rgba(123,79,255,0.15);border-radius:8px;overflow:hidden;}
.lb-table-head{display:grid;grid-template-columns:40px 1fr 120px 80px;background:rgba(123,79,255,0.1);padding:10px 16px;font-family:'Space Mono',monospace;font-size:0.52rem;letter-spacing:3px;color:#aaa;}
.lb-row{display:grid;grid-template-columns:40px 1fr 120px 80px;padding:10px 16px;border-top:1px solid rgba(255,255,255,0.03);transition:background 0.2s;}
.lb-row:hover{background:rgba(123,79,255,0.06);}
.lb-row.me{background:rgba(0,212,255,0.05);border-left:2px solid var(--c2);}
.lb-rank{font-family:'Space Mono',monospace;font-size:0.65rem;color:#aaa;}
.lb-rank.gold{color:#FFD700;font-weight:700;}
.lb-rank.silver{color:#C0C0C0;font-weight:700;}
.lb-rank.bronze{color:#CD7F32;font-weight:700;}
.lb-name{font-family:'Space Mono',monospace;font-size:0.65rem;color:#ddd;}
.lb-name.me{color:var(--c2);font-weight:700;}
.lb-score{font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--gold);text-align:right;}
.lb-date{font-family:'Space Mono',monospace;font-size:0.5rem;color:#aaa;text-align:right;}
.lb-empty{padding:30px;text-align:center;font-family:'Space Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:3px;}
.lb-loading{padding:30px;text-align:center;font-family:'Space Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:3px;animation:blink 1s ease infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}

/* SHOP 3D */
#shopScreen{position:fixed;inset:0;z-index:207;display:none;background:#000;}
#shopScreen.show{display:block;}
#shopCanvas{position:absolute;inset:0;display:block;width:100%;height:100%;}

/* Shop top bar */
#shopTopBar{position:absolute;top:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:8px;padding:8px 14px;background:rgba(3,2,15,0.92);border-bottom:1px solid rgba(123,79,255,0.2);backdrop-filter:blur(14px);}
.s3d-tab{padding:7px 18px;background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.2);border-radius:4px;color:#aaa;font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:2px;cursor:none;transition:all 0.2s;}
.s3d-tab.active{background:rgba(123,79,255,0.22);border-color:var(--c1);color:var(--c2);}
.s3d-tab:hover:not(.active){color:#ddd;}
#shopCoins{margin-left:auto;font-family:'Space Mono',monospace;font-size:0.78rem;color:var(--coin);background:rgba(255,204,0,0.07);border:1px solid rgba(255,204,0,0.2);border-radius:4px;padding:5px 12px;letter-spacing:2px;}
.shop-back-btn{padding:7px 14px;background:transparent;border:1px solid rgba(255,255,255,0.12);border-radius:4px;color:#aaa;font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:2px;cursor:none;transition:all 0.2s;margin-left:8px;}
.shop-back-btn:hover{color:#fff;border-color:rgba(255,255,255,0.4);}

/* Shop nav arrows */
.shop-nav{position:absolute;top:50%;z-index:10;width:50px;height:50px;background:rgba(6,4,22,0.92);border:1px solid rgba(123,79,255,0.4);border-radius:50%;color:var(--c2);font-size:1.3rem;cursor:none;display:flex;align-items:center;justify-content:center;transition:all 0.2s;transform:translateY(-50%);backdrop-filter:blur(10px);}
.shop-nav:hover{background:rgba(123,79,255,0.28);border-color:var(--c1);box-shadow:0 0 18px rgba(123,79,255,0.45);}
.shop-nav:disabled{opacity:0.18;pointer-events:none;}
#shopNavL{left:18px;}
#shopNavR{right:18px;}

/* Shop bottom info panel */
#shopInfoPanel{position:absolute;bottom:0;left:0;right:0;z-index:10;display:flex;align-items:center;gap:14px;padding:12px 72px;background:rgba(4,2,18,0.95);border-top:1px solid rgba(123,79,255,0.2);backdrop-filter:blur(18px);}
.s3d-emoji{font-size:2.4rem;flex-shrink:0;filter:drop-shadow(0 0 8px rgba(123,79,255,0.7));}
.s3d-info{flex:1;min-width:0;}
.s3d-name{font-size:0.95rem;font-weight:700;letter-spacing:3px;color:#fff;margin-bottom:3px;}
.s3d-desc{font-family:'Space Mono',monospace;font-size:0.54rem;color:#ccc;line-height:1.55;letter-spacing:0.5px;}
.s3d-price{font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--coin);margin-top:3px;}
.s3d-btn{flex-shrink:0;padding:10px 22px;border-radius:5px;font-family:'Orbitron',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:2px;cursor:none;border:none;transition:all 0.2s;white-space:nowrap;}
.s3d-btn.buy{background:linear-gradient(135deg,var(--c1),var(--c4));color:#fff;box-shadow:0 0 20px rgba(123,79,255,0.4);}
.s3d-btn.buy:hover{box-shadow:0 0 35px rgba(123,79,255,0.7);transform:translateY(-1px);}
.s3d-btn.equip{background:rgba(0,212,255,0.1);color:var(--c2);border:1px solid rgba(0,212,255,0.3);}
.s3d-btn.equip:hover{background:rgba(0,212,255,0.2);}
.s3d-btn.equipped{background:rgba(255,208,0,0.1);color:var(--gold);border:1px solid rgba(255,208,0,0.3);}
.s3d-btn.broke{background:rgba(60,40,80,0.3);color:#666;border:1px solid rgba(123,79,255,0.15);}
#shopDotRow{position:absolute;bottom:105px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:5px;}
.shop-dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.15);transition:background 0.2s,transform 0.2s;}
.shop-dot.on{background:var(--c2);transform:scale(1.35);}

/* Save button */
#saveBtn{position:fixed;bottom:14px;right:16px;z-index:211;padding:7px 16px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.3);border-radius:5px;color:var(--c2);font-family:'Space Mono',monospace;font-size:0.6rem;letter-spacing:2px;cursor:none;transition:all 0.25s;display:none;}
#saveBtn.show{display:block;}
#saveBtn:hover{background:rgba(0,212,255,0.18);border-color:var(--c2);box-shadow:0 0 14px rgba(0,212,255,0.3);}
#saveBtn.saving{color:var(--gold);border-color:var(--gold);animation:savepulse 0.8s ease infinite;}
@keyframes savepulse{0%,100%{opacity:1;}50%{opacity:0.5;}}

/* TOAST */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:400;background:rgba(3,2,15,0.95);border:1px solid rgba(0,212,255,0.4);border-radius:6px;padding:10px 20px;font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--c2);letter-spacing:3px;pointer-events:none;opacity:0;transition:opacity 0.3s;}
#toast.show{opacity:1;}

/* PAUSE */
#pauseScreen{position:fixed;inset:0;z-index:190;background:rgba(3,2,10,0.95);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center;}
#pauseScreen.show{display:flex;}
.pause-title{font-size:3rem;font-weight:900;letter-spacing:8px;color:#fff;text-shadow:0 0 40px rgba(123,79,255,0.5);margin-bottom:10px;}
.pause-sub{font-family:'Space Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:4px;margin-bottom:28px;text-align:center;}

/* DEATH */
#deathScreen{position:fixed;inset:0;z-index:201;display:none;align-items:center;justify-content:center;background:rgba(3,2,10,0.97);}
#deathScreen.show{display:flex;animation:dfade 0.5s ease;}
@keyframes dfade{from{opacity:0;transform:scale(1.02);}to{opacity:1;transform:scale(1);}}
.death-inner{text-align:center;max-width:480px;padding:0 20px;}
.death-title{font-size:clamp(2.5rem,6vw,3.8rem);font-weight:900;letter-spacing:6px;color:var(--c4);text-shadow:0 0 50px rgba(255,34,85,0.7);margin-bottom:6px;animation:dpulse 2s ease infinite;}
@keyframes dpulse{0%,100%{text-shadow:0 0 50px rgba(255,34,85,0.7);}50%{text-shadow:0 0 80px rgba(255,34,85,1);}}
.death-sub{font-family:'Space Mono',monospace;font-size:0.6rem;color:#aaa;letter-spacing:3px;margin-bottom:24px;}
.death-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:24px;}
.death-stat{background:rgba(255,34,85,0.05);border:1px solid rgba(255,34,85,0.18);border-radius:6px;padding:11px;}
.death-stat-label{font-family:'Space Mono',monospace;font-size:0.5rem;color:#ccc;letter-spacing:3px;margin-bottom:4px;}
.death-stat-val{font-size:1.5rem;color:#fff;font-weight:700;}
.btn-row{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}
.btn-retry{padding:10px 28px;background:linear-gradient(135deg,var(--c4),var(--c3));border:none;border-radius:4px;color:#fff;font-family:'Orbitron',sans-serif;font-size:0.85rem;font-weight:700;letter-spacing:3px;cursor:none;transition:all 0.25s;}
.btn-retry:hover{transform:translateY(-2px);}
.btn-menu{padding:10px 18px;background:transparent;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:#ccc;font-family:'Orbitron',sans-serif;font-size:0.8rem;letter-spacing:3px;cursor:none;transition:all 0.25s;}
.btn-menu:hover{color:#fff;border-color:rgba(255,255,255,0.4);}

/* WIN */
#winScreen{position:fixed;inset:0;z-index:202;display:none;align-items:center;justify-content:center;background:rgba(3,2,10,0.97);}
#winScreen.show{display:flex;animation:wfade 0.6s ease;}
@keyframes wfade{from{opacity:0;transform:scale(1.03);}to{opacity:1;transform:scale(1);}}
.win-inner{text-align:center;max-width:520px;padding:0 20px;}
.win-title{font-size:clamp(2.2rem,5vw,3.2rem);font-weight:900;letter-spacing:6px;color:var(--gold);text-shadow:0 0 50px rgba(255,208,0,0.8);margin-bottom:4px;animation:wpulse 1.8s ease infinite;}
@keyframes wpulse{0%,100%{text-shadow:0 0 50px rgba(255,208,0,0.7);}50%{text-shadow:0 0 90px rgba(255,208,0,1);}}
.win-world{font-family:'Space Mono',monospace;font-size:0.62rem;color:#ccc;letter-spacing:5px;margin-bottom:18px;}
.win-stars{font-size:2.4rem;letter-spacing:8px;margin-bottom:6px;min-height:3rem;}
.win-coins-earned{font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--coin);letter-spacing:3px;margin-bottom:18px;}
.win-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:20px;}
.win-stat{background:rgba(255,208,0,0.05);border:1px solid rgba(255,208,0,0.15);border-radius:6px;padding:10px;}
.win-stat-label{font-family:'Space Mono',monospace;font-size:0.5rem;color:#ccc;letter-spacing:3px;margin-bottom:4px;}
.win-stat-val{font-size:1.4rem;color:#fff;font-weight:700;}
.btn-next{padding:10px 32px;background:linear-gradient(135deg,var(--gold),#FF9900);border:none;border-radius:4px;color:#111;font-family:'Orbitron',sans-serif;font-size:0.85rem;font-weight:700;letter-spacing:3px;cursor:none;transition:all 0.25s;box-shadow:0 0 25px rgba(255,208,0,0.3);}
.btn-next:hover{transform:translateY(-2px);box-shadow:0 0 40px rgba(255,208,0,0.6);}

/* HUD */
#hud{position:fixed;top:0;left:0;right:0;z-index:100;padding:7px 12px;display:none;align-items:center;gap:6px;background:rgba(3,2,15,0.88);backdrop-filter:blur(18px);border-bottom:1px solid rgba(123,79,255,0.18);}
#hud.show{display:flex;}
.hud-stat{background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.15);border-radius:5px;padding:5px 10px;min-width:64px;}
.hud-label{font-family:'Space Mono',monospace;font-size:0.48rem;letter-spacing:3px;color:rgba(0,212,255,0.7);margin-bottom:1px;}
.hud-value{font-size:1.3rem;color:#fff;font-weight:700;line-height:1;letter-spacing:1px;}
.hud-coins{background:rgba(255,204,0,0.06);border:1px solid rgba(255,204,0,0.15);}
.hud-coins .hud-value{color:var(--coin);}
.stamina-wrap{background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.15);border-radius:5px;padding:5px 10px;flex:1;max-width:170px;}
.stamina-track{height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-top:4px;}
.stamina-bar{height:100%;width:100%;background:linear-gradient(90deg,var(--c1),var(--c2));border-radius:2px;transition:width 0.1s;}
.stamina-bar.low{animation:sblink 0.4s ease infinite;}
@keyframes sblink{0%,100%{opacity:1;}50%{opacity:0.2;}}
.height-bar-wrap{background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.15);border-radius:5px;padding:5px 9px;width:80px;}
.height-track{height:52px;width:7px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;position:relative;margin:3px auto 0;}
.height-fill{width:100%;background:linear-gradient(0deg,var(--c1),var(--gold));border-radius:4px;position:absolute;bottom:0;transition:height 0.3s;}
.stage-badge{margin-left:auto;background:rgba(123,79,255,0.06);border:1px solid rgba(123,79,255,0.15);border-radius:5px;padding:5px 10px;text-align:right;}
.stage-name{font-size:0.72rem;letter-spacing:4px;color:var(--c1);font-weight:700;}
.stage-progress{font-family:'Space Mono',monospace;font-size:0.48rem;color:#aaa;letter-spacing:2px;margin-top:1px;}
#launchGauge{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);z-index:100;display:none;flex-direction:column;align-items:center;gap:4px;pointer-events:none;}
#launchGauge.show{display:flex;}
.launch-label{font-family:'Space Mono',monospace;font-size:0.58rem;letter-spacing:3px;color:var(--gold);text-shadow:0 0 8px var(--gold);}
.launch-track{width:140px;height:8px;background:rgba(255,255,255,0.07);border-radius:4px;overflow:hidden;border:1px solid rgba(255,208,0,0.25);}
.launch-fill{height:100%;width:0%;background:linear-gradient(90deg,#44FF99,#FFD000,#FF4444);border-radius:4px;transition:width 0.04s;}
#grabHints{position:fixed;bottom:68px;left:50%;transform:translateX(-50%);z-index:100;display:flex;gap:12px;pointer-events:none;}
.grab-chip{background:rgba(3,2,15,0.92);border:1px solid rgba(0,212,255,0.3);border-radius:16px;padding:4px 11px;font-family:'Space Mono',monospace;font-size:0.62rem;letter-spacing:3px;color:var(--gold);opacity:0;transform:translateY(6px);transition:opacity 0.2s,transform 0.2s;}
.grab-chip.show{opacity:1;transform:translateY(0);}
#finishHint{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:110;pointer-events:none;font-size:1rem;letter-spacing:5px;font-weight:700;color:var(--gold);text-shadow:0 0 20px var(--gold);opacity:0;transition:opacity 0.4s;text-align:center;font-family:'Space Mono',monospace;}
#strip{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:100;background:rgba(3,2,15,0.92);backdrop-filter:blur(16px);border:1px solid rgba(123,79,255,0.22);border-radius:40px;padding:6px 18px;display:none;align-items:center;gap:10px;font-family:'Space Mono',monospace;font-size:0.55rem;color:#aaa;letter-spacing:1px;}
#strip.show{display:flex;}
.sk{background:rgba(123,79,255,0.1);border:1px solid rgba(123,79,255,0.25);border-radius:3px;padding:1px 5px;color:#ddd;font-size:0.55rem;}
#lockMsg{position:fixed;inset:0;z-index:189;background:rgba(3,2,10,0.92);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;font-family:'Space Mono',monospace;font-size:0.72rem;color:#ccc;letter-spacing:3px;text-align:center;}
#lockMsg.show{display:flex;}
#camModeLabel{position:fixed;top:48%;left:50%;transform:translate(-50%,-50%);z-index:110;pointer-events:none;font-size:1.2rem;letter-spacing:6px;font-weight:700;color:#fff;text-shadow:0 0 20px rgba(0,212,255,0.8);opacity:0;transition:opacity 0.4s;}
</style>
</head>
<body>
<div id="cursor"></div>
<div id="vignette"></div>
<div id="scanlines"></div>
<div id="flash"></div>
<div id="cpFlash"></div>
<div id="winFlash"></div>
<div id="cpMsg">CHECKPOINT</div>
<div id="finishHint"></div>
<div id="toast"></div>

<!-- NAME MODAL -->
<div id="nameModal">
  <div class="name-modal-box">
    <div class="name-modal-title">WHO ARE YOU?</div>
    <div class="name-modal-sub">SET YOUR GLOBAL IDENTITY</div>
    <input class="name-input" id="nameInput" type="text" maxlength="16" placeholder="ENTER NAME" autocomplete="off" spellcheck="false">
    <div class="name-error" id="nameError"></div>
    <button class="name-confirm-btn" onclick="submitName()">CONFIRM IDENTITY</button>
    <div class="name-note">‚ö† Names are unique globally. Once claimed, yours forever.</div>
  </div>
</div>

<!-- MENU -->
<div id="menu" class="hide">
  <div class="menu-bg"></div><div class="menu-grid"></div>
  <div id="miniLB">
    <div class="mini-lb-title">üèÜ TOP SPEEDRUNS</div>
    <div id="miniLBRows"><div class="mini-lb-row"><span class="mini-lb-name" style="color:#888">LOADING...</span></div></div>
  </div>
  <div class="menu-inner">
    <div class="menu-eyebrow">STICKGAMES ¬∑ GALAXY EDITION</div>
    <div class="menu-title">STICK<br><span class="accent">CLIMB</span></div>
    <div class="menu-sub">10 Worlds ¬∑ 40 Stages ¬∑ Physics-Based</div>
    <div class="menu-name-row">
      <div class="menu-name-badge" id="menuNameBadge">üë§ ‚Äî</div>
      <button class="menu-name-change" onclick="openNameModal(true)">CHANGE NAME</button>
    </div>
    <div class="menu-controls-grid">
      <div class="ctrl-card"><div class="ctrl-card-label">üîµ Left Arm</div><div class="ctrl-card-keys">Move: <b>W</b><b>A</b><b>S</b><b>D</b> ¬∑ Hook: <b>SHIFT</b></div></div>
      <div class="ctrl-card"><div class="ctrl-card-label">üî¥ Right Arm</div><div class="ctrl-card-keys">Move: <b>‚Üë</b><b>‚Üê</b><b>‚Üì</b><b>‚Üí</b> ¬∑ Hook: <b>ENTER</b></div></div>
      <div class="ctrl-card"><div class="ctrl-card-label">üöÄ Boost Launch</div><div class="ctrl-card-keys">Both hooked ‚Üí hold <b>SPACE</b> ‚Üí release</div></div>
      <div class="ctrl-card"><div class="ctrl-card-label">üì∑ Camera / Tools</div><div class="ctrl-card-keys">Look: <b>MOUSE</b> ¬∑ Cam: <b>V</b> ¬∑ Recall: <b>G</b></div></div>
    </div>
    <div class="menu-btn-row">
      <button class="play-btn" onclick="startGame()">LAUNCH</button>
      <button class="icon-btn" onclick="showWorlds()">WORLDS</button>
      <button class="icon-btn" onclick="showShop()">SHOP üõí</button>
      <button class="icon-btn" onclick="showLeaderboard()">RANKS üèÜ</button>
    </div>
    <div class="menu-tagline">EARN COINS ¬∑ BUY SKINS ¬∑ CLIMB THE RANKS</div>
  </div>
</div>

<!-- WORLDS -->
<div id="worldsScreen">
  <div class="worlds-header"><div class="worlds-title">WORLDS</div><div class="worlds-sub">COMPLETE A WORLD TO UNLOCK THE NEXT</div></div>
  <div class="worlds-grid" id="worldsGrid"></div>
  <button class="back-btn" onclick="hideWorlds()">‚Üê BACK</button>
</div>

<!-- LEADERBOARD -->
<div id="lbScreen">
  <div class="lb-header"><div class="lb-title">RANKINGS</div><div class="lb-sub">GLOBAL LEADERBOARD ¬∑ ALL PLAYERS</div></div>
  <div class="lb-cat-tabs">
    <button class="lb-cat-btn active" onclick="setLBCat('worlds')">üåç WORLD TIMES</button>
    <button class="lb-cat-btn" onclick="setLBCat('speedrun')">‚ö° FULL RUN</button>
    <button class="lb-cat-btn" onclick="setLBCat('coins')">ü™ô RICHEST</button>
    <button class="lb-cat-btn" onclick="setLBCat('skins')">‚ú® COLLECTORS</button>
  </div>
  <div id="lbWorldTabs" class="lb-world-tabs"></div>
  <div id="lbTableWrap" class="lb-table"></div>
  <button class="back-btn" style="margin-top:20px" onclick="hideLeaderboard()">‚Üê BACK</button>
</div>

<!-- SHOP 3D -->
<div id="shopScreen">
  <canvas id="shopCanvas"></canvas>
  <div id="shopTopBar">
    <button class="s3d-tab active" id="sTabCrowbar" onclick="setShopTab('crowbar')">‚öí CROWBARS</button>
    <button class="s3d-tab" id="sTabChar" onclick="setShopTab('char')">üßç CHARACTERS</button>
    <div id="shopCoins">ü™ô <span id="shopCoinsVal">0</span></div>
    <button class="shop-back-btn" onclick="hideShop()">‚úï CLOSE</button>
  </div>
  <button class="shop-nav" id="shopNavL" onclick="shopNav(-1)">‚óÑ</button>
  <button class="shop-nav" id="shopNavR" onclick="shopNav(1)">‚ñ∫</button>
  <div id="shopDotRow"></div>
  <div id="shopInfoPanel">
    <div class="s3d-emoji" id="sEmoji">üî©</div>
    <div class="s3d-info">
      <div class="s3d-name" id="sName">IRON HOOK</div>
      <div class="s3d-desc" id="sDesc">Basically spawning in naked.</div>
      <div class="s3d-price" id="sPrice">FREE</div>
    </div>
    <button class="s3d-btn" id="sBtn" onclick="shopAction()">EQUIPPED</button>
  </div>
  <!-- Keeper speech bubble lives in 3D scene as a mesh ‚Äî hidden DOM nodes track typing state -->
  <span id="keeperTyped" style="display:none"></span>
  <span id="keeperCursor" style="display:none"></span>
  <div id="keeperDots" style="display:none"><span id="keeperProgress"></span></div>
  <div id="saveBtn" onclick="manualSave()">üíæ SAVE</div>
</div>

<!-- PAUSE -->
<div id="pauseScreen">
  <div style="text-align:center">
    <div class="pause-title">PAUSED</div>
    <div class="pause-sub">PRESS ESC TO RESUME</div>
    <button class="play-btn" onclick="resumeGame()">RESUME</button>
  </div>
</div>

<!-- DEATH -->
<div id="deathScreen">
  <div class="death-inner">
    <div class="death-title">YOU FELL</div>
    <div class="death-sub">THE VOID CLAIMS ANOTHER</div>
    <div class="death-grid">
      <div class="death-stat"><div class="death-stat-label">Height</div><div class="death-stat-val" id="dHeight">0m</div></div>
      <div class="death-stat"><div class="death-stat-label">Time</div><div class="death-stat-val" id="dTime">0:00</div></div>
      <div class="death-stat"><div class="death-stat-label">Grabs</div><div class="death-stat-val" id="dGrabs">0</div></div>
    </div>
    <div class="btn-row">
      <button class="btn-retry" onclick="restartGame()">RESTART</button>
      <button class="btn-retry" style="background:linear-gradient(135deg,#1a5c3a,#2a8855)" onclick="respawnAtCheckpoint()">‚Ü© CHECKPOINT</button>
      <button class="btn-menu" onclick="showMenu()">MENU</button>
    </div>
  </div>
</div>

<!-- WIN -->
<div id="winScreen">
  <div class="win-inner">
    <div class="win-title">WORLD CLEAR!</div>
    <div class="win-world" id="winWorldName">NEBULA DAWN ¬∑ WORLD 1</div>
    <div class="win-stars" id="winStars">‚≠ê‚≠ê‚≠ê</div>
    <div class="win-coins-earned" id="winCoinsEarned">+250 ü™ô</div>
    <div class="win-grid">
      <div class="win-stat"><div class="win-stat-label">Time</div><div class="win-stat-val" id="wTime">0:00</div></div>
      <div class="win-stat"><div class="win-stat-label">Grabs</div><div class="win-stat-val" id="wGrabs">0</div></div>
      <div class="win-stat"><div class="win-stat-label">Total ü™ô</div><div class="win-stat-val" id="wTotalCoins">0</div></div>
    </div>
    <div class="btn-row">
      <button class="btn-next" id="btnNextWorld" onclick="nextWorld()">NEXT WORLD ‚Üí</button>
      <button class="btn-retry" onclick="restartGame()">RETRY</button>
      <button class="btn-menu" onclick="showMenu()">MENU</button>
    </div>
  </div>
</div>

<!-- LOCK -->
<div id="lockMsg"><div>CLICK TO LOCK CURSOR</div><div style="color:#aaa;font-size:0.55rem;letter-spacing:2px;margin-top:4px;">ESC TO PAUSE</div></div>

<!-- HUD -->
<div id="hud">
  <div class="hud-stat"><div class="hud-label">Height</div><div class="hud-value" id="hHeight">0m</div></div>
  <div class="hud-stat"><div class="hud-label">Time</div><div class="hud-value" id="hTime">0:00</div></div>
  <div class="hud-stat hud-coins"><div class="hud-label">Coins</div><div class="hud-value" id="hCoins">0</div></div>
  <div class="stamina-wrap"><div class="hud-label">Stamina</div><div class="stamina-track"><div class="stamina-bar" id="stBar"></div></div></div>
  <div class="height-bar-wrap"><div class="hud-label" style="text-align:center">PROGRESS</div><div class="height-track"><div class="height-fill" id="heightFill"></div></div></div>
  <div class="stage-badge"><div class="stage-name" id="stageName">STAGE</div><div class="stage-progress" id="stageProgress">W1¬∑S1/4</div></div>
</div>
<div id="launchGauge"><div class="launch-label">BOOST CHARGING</div><div class="launch-track"><div class="launch-fill" id="launchFill"></div></div></div>
<div id="grabHints"><div class="grab-chip" id="chipL">SHIFT TO HOOK</div><div class="grab-chip" id="chipR">ENTER TO HOOK</div></div>
<div id="strip">
  <span>üîµ<span class="sk">WASD</span><span class="sk">SHIFT</span></span>
  <span style="color:#2a2a3a">|</span>
  <span>üî¥<span class="sk">ARROWS</span><span class="sk">ENTER</span></span>
  <span style="color:#2a2a3a">|</span>
  <span>üöÄ<span class="sk">SPACE</span></span>
  <span style="color:#2a2a3a">|</span>
  <span><span class="sk">G</span>RECALL<span class="sk">V</span>CAM<span class="sk">ESC</span>PAUSE</span>
</div>
<div id="camModeLabel">üé• THIRD PERSON</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';
const $=id=>document.getElementById(id);
const PI=Math.PI,TWO_PI=PI*2;
const V3=(x=0,y=0,z=0)=>new THREE.Vector3(x,y,z);
const clamp=(v,mn,mx)=>Math.max(mn,Math.min(mx,v));

/* ‚îÄ‚îÄ FAVICON ‚îÄ‚îÄ */
(()=>{
  const c=document.createElement('canvas');c.width=c.height=32;
  const x=c.getContext('2d');
  x.fillStyle='#03020A';x.beginPath();x.roundRect(0,0,32,32,5);x.fill();
  x.strokeStyle='#7B4FFF';x.lineWidth=2;x.lineCap='round';
  x.beginPath();x.arc(16,8,3,0,Math.PI*2);x.stroke();
  x.beginPath();x.moveTo(16,11);x.lineTo(16,20);x.stroke();
  x.beginPath();x.moveTo(16,14);x.lineTo(9,11);x.stroke();
  x.beginPath();x.moveTo(16,14);x.lineTo(23,11);x.stroke();
  x.beginPath();x.moveTo(16,20);x.lineTo(11,27);x.stroke();
  x.beginPath();x.moveTo(16,20);x.lineTo(21,27);x.stroke();
  x.strokeStyle='#FFD000';x.lineWidth=1.8;
  x.beginPath();x.moveTo(22,6);x.lineTo(22,13);x.arc(21,13,1.4,0,PI*1.2,false);x.stroke();
  const l=document.createElement('link');l.rel='icon';l.href=c.toDataURL();
  document.head.appendChild(l);
})();

/* ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ */
const AC=new(window.AudioContext||window.webkitAudioContext)();
function playSFX(freq,dur=0.1,type='square',vol=0.12,detune=0){
  try{const o=AC.createOscillator(),g=AC.createGain(),f=AC.createBiquadFilter();
  f.type='bandpass';f.frequency.value=freq*2;f.Q.value=0.8;o.type=type;
  o.frequency.value=freq;if(detune)o.detune.value=detune;g.gain.value=vol;
  o.connect(f);f.connect(g);g.connect(AC.destination);o.start();
  g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+dur);
  setTimeout(()=>o.stop(),dur*1000+50);}catch(e){}
}
function playGrab(){playSFX(300+Math.random()*120,0.09,'sawtooth',0.18);}
function playFall(){playSFX(80,0.5,'sawtooth',0.2);playSFX(120,0.3,'sine',0.12);}
function playCheckpoint(){playSFX(880,0.15,'sine',0.2);setTimeout(()=>playSFX(1320,0.2,'sine',0.18),120);}
function playWin(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>playSFX(f,0.3,'sine',0.2),i*120));}
function playBuy(){playSFX(660,0.12,'sine',0.15);setTimeout(()=>playSFX(990,0.1,'sine',0.12),80);}
function playLow(){playSFX(160+Math.random()*40,0.12,'sawtooth',0.1);}
function playSlip(){playSFX(200,0.15,'sawtooth',0.15,-200);}

/* ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ */
const cursor=$('cursor');
document.addEventListener('mousemove',e=>{cursor.style.left=e.clientX+'px';cursor.style.top=e.clientY+'px';});

/* ‚îÄ‚îÄ MAIN THREE.JS ‚îÄ‚îÄ */
let scene,camera,renderer;
function initThree(){
  scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0x05030A,0.008);
  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.05,1200);
  camera.rotation.order='YXZ';
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  renderer.outputEncoding=THREE.sRGBEncoding;renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=1.1;document.body.appendChild(renderer.domElement);
  window.addEventListener('resize',onResize);
}
function onResize(){
  camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  if(sRenderer){sCamera.aspect=innerWidth/innerHeight;sCamera.updateProjectionMatrix();sRenderer.setSize(innerWidth,innerHeight);}
}
initThree();

/* ‚îÄ‚îÄ SKIN DEFINITIONS ‚îÄ‚îÄ */
const CROWBAR_SKINS=[
  {id:0,name:'Iron Hook',    emoji:'üî©',desc:'Basically spawning into the world naked.',           price:0,   shaftCol:0x2a2a2a,hookCol:0x444444,glowCol:0xFFD000,emi:0.2},
  {id:1,name:'Gold Rush',    emoji:'ü•á',desc:'I bought this from my grandmommy. Dont judge',             price:200, shaftCol:0xAA8800,hookCol:0xFFD000,glowCol:0xFFFF00,emi:0.6},
  {id:2,name:'Neon Zap',     emoji:'‚ö°',desc:'My eyes are stuck shut because I woke up and looked at this',             price:250, shaftCol:0x001133,hookCol:0x00AAFF,glowCol:0x00D4FF,emi:0.8},
  {id:3,name:'Magma Core',   emoji:'üåã',desc:'I warm my showers with this. Tell me if you find any hairs.',                     price:300, shaftCol:0x330800,hookCol:0xFF4400,glowCol:0xFF6600,emi:0.9},
  {id:4,name:'Crystal Edge', emoji:'üíé',desc:'This made me permanently blind even if I could open my eyes',       price:350, shaftCol:0x88BBCC,hookCol:0xAAEEFF,glowCol:0x00FFEE,emi:0.7},
  {id:5,name:'Void Reaper',  emoji:'‚ò†Ô∏è',desc:'The guy who made this is a really chill dude who sleeps with plushies',                    price:450, shaftCol:0x080010,hookCol:0x8800FF,glowCol:0xFF00FF,emi:1.0},
  {id:6,name:'Rainbow',      emoji:'üåà',desc:'For people who want everyone to know. Also for Arjun Nayak',                  price:750, shaftCol:0x222222,hookCol:0xFFFFFF,glowCol:0xFFFFFF,emi:0.8,rainbow:true},
  {id:7,name:'Plasma Cutter',emoji:'üî•',desc:"Why it looks like toilet paper nobody will know",          price:900, shaftCol:0xFFFFFF,hookCol:0xFFFFFF,glowCol:0xFFFFFF,emi:1.0,plasma:true},
  {id:8,name:'Rusty Relic',  emoji:'ü¶Ä',desc:'Ancient. Worn. Has history. Smells weird. ',             price:1250, shaftCol:0x553311,hookCol:0x774422,glowCol:0xFF8844,emi:0.3},
  {id:9,name:'Cosmic Legend',emoji:'üå†',desc:' If my crowbar turns golden, run: ahh crowbar',             price:1500, shaftCol:0x110022,hookCol:0xFFCC00,glowCol:0xFFFFFF,emi:1.0,rainbow:true,plasma:true},
];
const CHAR_SKINS=[
  {id:0,name:'Worker',       emoji:'üë∑',desc:'My collars blue, but my neck is red',                    price:0,   torso:0x222244,head:0xFFCC99,hat:0xFFCC00,hatType:'hardhat',leg:0x1a1a3a,boot:0x553300,eyeCol:0x111111},
  {id:1,name:'Astronaut',    emoji:'üë®‚ÄçüöÄ',desc:'Bros gonna be happy to the moon trust',          price:200, torso:0xDDEEFF,head:0xCCDDEE,hat:0xAAAAAA,hatType:'dome',  leg:0xBBCCDD,boot:0x888899,eyeCol:0x0066AA},
  {id:2,name:'Shadow Ninja', emoji:'ü•∑',desc:'Creature of the night. Deyontae liked it.',          price:300, torso:0x0a0a0a,head:0x111111,hat:0x000000,hatType:'ninja',  leg:0x050505,boot:0x111100,eyeCol:0xFF0000},
  {id:3,name:'Viking',       emoji:'ü™ì',desc:'SBSD VIKINGS! Also good climber.',          price:350, torso:0x7B3B00,head:0xFFAA77,hat:0x554400,hatType:'horn',   leg:0x3a2200,boot:0x442200,eyeCol:0x4488FF},
  {id:4,name:'Steel Bot',    emoji:'ü§ñ',desc:'Check important info. AI can make mistakes.',            price:400, torso:0x444455,head:0x556677,hat:0x334455,hatType:'antenna',leg:0x333344,boot:0x222233,eyeCol:0x00FF88},
  {id:5,name:'Arcane Wizard',emoji:'üßô',desc:'This lowkey reminds me of wizard of Zo. Dorp approved',     price:450, torso:0x330066,head:0xFFCCAA,hat:0x220044,hatType:'wizard',  leg:0x220055,boot:0x110033,eyeCol:0xFF88FF},
  {id:6,name:'Sea Pirate',   emoji:'üè¥‚Äç‚ò†Ô∏è',desc:'Sack Jarrow, Jack Sparrow, same same different font',          price:350, torso:0x7B0000,head:0xFFAA88,hat:0x111111,hatType:'pirate',  leg:0x2a1500,boot:0x330000,eyeCol:0x33AA66},
  {id:7,name:'Iron Knight',  emoji:'‚öîÔ∏è',desc:'Sadly not Golden Knight but a crazy tank. Ifykyk.',             price:500, torso:0x778899,head:0xAABBCC,hat:0x556677,hatType:'helm',    leg:0x445566,boot:0x334455,eyeCol:0xCCEEFF},
  {id:8,name:'Xenomorph',    emoji:'üëΩ',desc:'Probably from mars. Crazy good posture.',       price:600, torso:0x004422,head:0x003311,hat:0x002200,hatType:'alien',   leg:0x002211,boot:0x001100,eyeCol:0x00FF44},
  {id:9,name:'Golden God',   emoji:'‚ú®',desc:'JOJO GOLDEN WIND GIORNO GOLDEN EXPERIENCE YESSIR.',               price:1000,torso:0xAA8800,head:0xFFCC44,hat:0xFFDD00,hatType:'crown',   leg:0x886600,boot:0x664400,eyeCol:0xFFFF00},
];

const KEEPER_LINES=[
  "Welcome, climber. These skins wont buy themselves. Well... you can. That's literally what this is.",
  "I heard Cosmic Legend was forged in a dying star. You da real star.",
  "Every great climber has great style. That's why you're here. You look ugly",
  "The Golden God skin? Makes you faster. (It doesnt. But it FEELS like it does.)",
  "My prices are criminally fair. There is no complaints department. Womp Womp",
  "Void Reaper absorbs SOULS. The guy who used it sleeps with a plushie named Bookie Bear",
  "You came to SHOP? In this economy? That's crazy",
  "I've been standing here since Stage 1. BUY. SOMETHING.",
  "I really like my shop. I found everything in a dumpster yesterday",
  "Rainbow crowbar: for people who want everyone else to know they're REALLY different.",
  "No refunds. No exchanges. No regrets. (The Rusty Relic smells though.)",
  "Iron Knight has a lot of HP. HP doesnt matter in space though",
  "Shadow Ninja ‚Äî STILL visible. Just... to your enemies. Who are gravity.",
  "Xenomorph gives snickers to childer. (The van has red paint stains)",
  "I'm not mean, I'm just different. Why does nobody ever understand me :[",
];
/* ‚îÄ‚îÄ WORLDS DATA ‚îÄ‚îÄ */
const WORLDS=[
  {id:0,name:'NEBULA DAWN',  theme:'Swirling purple nebula',bgCol:0x04010C,fogCol:0x04010E,fogD:0.008,
   stages:[{name:'DUST CLOUD',yMin:0,yMax:75,ambCol:0x7B4FFF,ambInt:0.5,sunCol:0x9966FF,sunInt:1.4,wallCol:0x060215},{name:'NEBULA CORE',yMin:75,yMax:150,ambCol:0x9944FF,ambInt:0.55,sunCol:0xAA44FF,sunInt:1.5,wallCol:0x080218},{name:'ION STREAM',yMin:150,yMax:225,ambCol:0xCC44FF,ambInt:0.6,sunCol:0xFF66FF,sunInt:1.6,wallCol:0x0A021A},{name:'STAR BIRTH',yMin:225,yMax:300,ambCol:0xFF44FF,ambInt:0.7,sunCol:0xFF88FF,sunInt:1.8,wallCol:0x0C021C}],
   holdPalette:[[0x7B4FFF,0xCC00FF,0xFF66FF,0xFFAA00,0xFF4466]],finishCol:0xCC44FF,starColor:[0x8866FF,0x9966FF,0xBB88FF],envFx:'nebula'},
  {id:1,name:'STELLAR DRIFT',theme:'Blue star nursery',bgCol:0x010610,fogCol:0x010810,fogD:0.009,
   stages:[{name:'COLD SPACE',yMin:0,yMax:75,ambCol:0x0066AA,ambInt:0.4,sunCol:0x0088FF,sunInt:1.4,wallCol:0x020A18},{name:'ICE BELT',yMin:75,yMax:150,ambCol:0x00AACC,ambInt:0.5,sunCol:0x00CCFF,sunInt:1.5,wallCol:0x030C1A},{name:'COMET TRAIL',yMin:150,yMax:225,ambCol:0x00D4FF,ambInt:0.55,sunCol:0x44EEFF,sunInt:1.6,wallCol:0x040E1C},{name:'NOVA BLOOM',yMin:225,yMax:300,ambCol:0x44FFFF,ambInt:0.6,sunCol:0x88FFFF,sunInt:1.8,wallCol:0x05101E}],
   holdPalette:[[0x0088FF,0x00D4FF,0x4488FF,0x88CCFF,0x0044AA]],finishCol:0x00D4FF,starColor:[0x4488FF,0x88CCFF,0x00D4FF],envFx:'comet'},
  {id:2,name:'VOLCANIC CORE',theme:'Molten lava ascent',bgCol:0x08020A,fogCol:0x0A0305,fogD:0.010,
   stages:[{name:'ASH FIELDS',yMin:0,yMax:75,ambCol:0x882200,ambInt:0.5,sunCol:0xCC3300,sunInt:1.5,wallCol:0x120505},{name:'LAVA TUBES',yMin:75,yMax:150,ambCol:0xAA3300,ambInt:0.6,sunCol:0xFF4400,sunInt:1.6,wallCol:0x160606},{name:'MAGMA SEA',yMin:150,yMax:225,ambCol:0xFF4400,ambInt:0.65,sunCol:0xFF6600,sunInt:1.8,wallCol:0x180707},{name:'ERUPTION',yMin:225,yMax:300,ambCol:0xFF6600,ambInt:0.7,sunCol:0xFF9900,sunInt:2.0,wallCol:0x1A0808}],
   holdPalette:[[0xFF4400,0xFF2200,0xFF6600,0xFF8800,0xCC3300]],finishCol:0xFF6600,starColor:[0xFF4400,0xFF6600,0xFFAA00],envFx:'lava'},
  {id:3,name:'CRYSTAL SPIRE',theme:'Gemstone caverns',bgCol:0x02060A,fogCol:0x030810,fogD:0.009,
   stages:[{name:'GEM CAVES',yMin:0,yMax:75,ambCol:0x00AA88,ambInt:0.5,sunCol:0x00FFCC,sunInt:1.4,wallCol:0x030A10},{name:'QUARTZ HALLS',yMin:75,yMax:150,ambCol:0x44FFAA,ambInt:0.55,sunCol:0x66FFCC,sunInt:1.5,wallCol:0x040C12},{name:'DIAMOND PEAK',yMin:150,yMax:225,ambCol:0x88FFDD,ambInt:0.6,sunCol:0xAAFFEE,sunInt:1.6,wallCol:0x050E14},{name:'PRISMATIC',yMin:225,yMax:300,ambCol:0xFFFFAA,ambInt:0.65,sunCol:0xFFFFCC,sunInt:1.8,wallCol:0x060F16}],
   holdPalette:[[0x00FFCC,0x44FFAA,0x00DDAA,0xFF44CC,0x88FF88]],finishCol:0x00FFCC,starColor:[0x00FFCC,0x44FFAA,0x88FFDD],envFx:'crystal'},
  {id:4,name:'STORM VORTEX', theme:'Electric tempest',bgCol:0x04040A,fogCol:0x05050C,fogD:0.008,
   stages:[{name:'THUNDER HEAD',yMin:0,yMax:75,ambCol:0x555500,ambInt:0.5,sunCol:0xAAAA00,sunInt:1.4,wallCol:0x080808},{name:'LIGHTNING BAND',yMin:75,yMax:150,ambCol:0xAAAA00,ambInt:0.55,sunCol:0xFFFF00,sunInt:1.5,wallCol:0x0A0A08},{name:'EYE WALL',yMin:150,yMax:225,ambCol:0xFFFF00,ambInt:0.6,sunCol:0xFFFF44,sunInt:1.7,wallCol:0x0C0C08},{name:'APEX STORM',yMin:225,yMax:300,ambCol:0xFFFF88,ambInt:0.65,sunCol:0xFFFFAA,sunInt:2.0,wallCol:0x0E0E08}],
   holdPalette:[[0xFFFF00,0xFFCC00,0xFFFF44,0xFFEE00,0xFFAA00]],finishCol:0xFFFF00,starColor:[0xFFFF00,0xFFCC00,0xFFFF88],envFx:'storm'},
  {id:5,name:'ABYSSAL DEEP', theme:'Bioluminescent ocean',bgCol:0x000510,fogCol:0x000816,fogD:0.012,
   stages:[{name:'HADAL ZONE',yMin:0,yMax:75,ambCol:0x003366,ambInt:0.4,sunCol:0x004488,sunInt:1.3,wallCol:0x020810},{name:'DARK CURRENT',yMin:75,yMax:150,ambCol:0x0044AA,ambInt:0.45,sunCol:0x0055CC,sunInt:1.4,wallCol:0x030A14},{name:'BIOLUME',yMin:150,yMax:225,ambCol:0x0088FF,ambInt:0.5,sunCol:0x00AAFF,sunInt:1.5,wallCol:0x040C18},{name:'SURFACE GLOW',yMin:225,yMax:300,ambCol:0x44AAFF,ambInt:0.55,sunCol:0x66CCFF,sunInt:1.6,wallCol:0x050E1C}],
   holdPalette:[[0x0088FF,0x00FFCC,0x0044AA,0x00DDFF,0x4466FF]],finishCol:0x00FFCC,starColor:[0x0088FF,0x00D4FF,0x44FFEE],envFx:'ocean'},
  {id:6,name:'SOLAR CROWN',  theme:'Solar surface inferno',bgCol:0x080400,fogCol:0x0A0500,fogD:0.009,
   stages:[{name:'CORONA',yMin:0,yMax:75,ambCol:0xAA6600,ambInt:0.6,sunCol:0xFFAA00,sunInt:1.6,wallCol:0x100800},{name:'SOLAR WIND',yMin:75,yMax:150,ambCol:0xFFAA00,ambInt:0.65,sunCol:0xFFCC00,sunInt:1.8,wallCol:0x140A00},{name:'PROMINENCE',yMin:150,yMax:225,ambCol:0xFFCC00,ambInt:0.7,sunCol:0xFFDD00,sunInt:2.0,wallCol:0x180C00},{name:'SOLAR APEX',yMin:225,yMax:300,ambCol:0xFFFFAA,ambInt:0.8,sunCol:0xFFFFDD,sunInt:2.2,wallCol:0x1C0E00}],
   holdPalette:[[0xFFAA00,0xFFCC00,0xFF8800,0xFFFF00,0xFF6600]],finishCol:0xFFFF00,starColor:[0xFFAA00,0xFFCC00,0xFFFF88],envFx:'solar'},
  {id:7,name:'VOID RIFT',    theme:'Dark dimension neon',bgCol:0x000000,fogCol:0x010003,fogD:0.006,
   stages:[{name:'NULL SPACE',yMin:0,yMax:75,ambCol:0x220044,ambInt:0.3,sunCol:0x440088,sunInt:1.2,wallCol:0x050008},{name:'RIFT ZONE',yMin:75,yMax:150,ambCol:0x440088,ambInt:0.35,sunCol:0x6600CC,sunInt:1.4,wallCol:0x07000C},{name:'DARK MATTER',yMin:150,yMax:225,ambCol:0x6600CC,ambInt:0.4,sunCol:0x8800FF,sunInt:1.5,wallCol:0x09000F},{name:'VOID APEX',yMin:225,yMax:300,ambCol:0x8800FF,ambInt:0.45,sunCol:0xAA00FF,sunInt:1.6,wallCol:0x0B0012}],
   holdPalette:[[0x8800FF,0xFF00FF,0x00FFFF,0xFF0088,0x8800AA]],finishCol:0xFF00FF,starColor:[0x8800FF,0xFF00FF,0x00FFFF],envFx:'void'},
  {id:8,name:'ANCIENT GATE', theme:'Mystical temple ruins',bgCol:0x030802,fogCol:0x040A03,fogD:0.009,
   stages:[{name:'STONE FOYER',yMin:0,yMax:75,ambCol:0x446633,ambInt:0.5,sunCol:0x558844,sunInt:1.4,wallCol:0x080A05},{name:'VINE TOWER',yMin:75,yMax:150,ambCol:0x558844,ambInt:0.55,sunCol:0x66AA55,sunInt:1.5,wallCol:0x0A0C06},{name:'RUNE CHAMBER',yMin:150,yMax:225,ambCol:0x77AA66,ambInt:0.6,sunCol:0x88CC77,sunInt:1.6,wallCol:0x0C0E07},{name:'SACRED PEAK',yMin:225,yMax:300,ambCol:0xAACC88,ambInt:0.65,sunCol:0xCCEEAA,sunInt:1.8,wallCol:0x0E1008}],
   holdPalette:[[0x66AA44,0xAACC55,0x448833,0xCCDD88,0x77BB55]],finishCol:0x88CC66,starColor:[0x66AA44,0x88CC66,0xCCEE77],envFx:'ruins'},
  {id:9,name:'QUANTUM NEXUS',theme:'Interdimensional portal',bgCol:0x000000,fogCol:0x020002,fogD:0.005,
   stages:[{name:'PHASE ALPHA',yMin:0,yMax:75,ambCol:0xFF0044,ambInt:0.5,sunCol:0xFF0088,sunInt:1.5,wallCol:0x080008},{name:'PHASE BETA',yMin:75,yMax:150,ambCol:0x00FF88,ambInt:0.5,sunCol:0x00FFCC,sunInt:1.5,wallCol:0x000808},{name:'PHASE GAMMA',yMin:150,yMax:225,ambCol:0xFFFF00,ambInt:0.5,sunCol:0xFF8800,sunInt:1.6,wallCol:0x080800},{name:'PHASE OMEGA',yMin:225,yMax:300,ambCol:0xFF88FF,ambInt:0.6,sunCol:0xFFFFFF,sunInt:2.0,wallCol:0x080808}],
   holdPalette:[[0xFF0044,0x00FF88,0xFFFF00,0x00AAFF,0xFF00FF]],finishCol:0xFFFFFF,starColor:[0xFF0044,0x00FF88,0xFFFF00],envFx:'quantum'},
];

const WORLD_HEIGHT=300,FINISH_Y=285;
const HOLD_TYPES=['sphere','pipe','slab','crystal'];
const ARM_LENGTH=9.0,GRAB_RADIUS=11.0,GRAVITY=0.22,DRAG=0.025;
function calcCoins(t,s){let c=100+(s*50);if(t<120)c+=100;else if(t<180)c+=60;else if(t<300)c+=25;return c;}
function calcStars(t){return t<180?3:t<300?2:1;}

/* ‚îÄ‚îÄ STORAGE & PROFILE ‚îÄ‚îÄ */
let profile={deviceId:'',name:'',coins:0,
  ownedCrowbars:[true,...Array(9).fill(false)],
  ownedChars:[true,...Array(9).fill(false)],
  activeCrowbar:0,activeChar:0,
  worldProgress:{},speedrunStart:null,speedrunWorlds:[]};

function genId(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
async function loadProfile(){
  try{const r=await window.storage.get('profile');if(r){Object.assign(profile,JSON.parse(r.value));}}catch(e){}
  if(!profile.deviceId)profile.deviceId=genId();
  return profile;
}
async function saveProfile(){
  const s=JSON.stringify(profile);
  try{await window.storage.set('profile',s);}catch(e){}
  try{localStorage.setItem('stickclimb_profile',s);}catch(e){}
}

async function loadNames(){try{const r=await window.storage.get('names:v2',true);if(r)return JSON.parse(r.value);}catch(e){}return{};}
async function saveNames(reg){try{await window.storage.set('names:v2',JSON.stringify(reg),true);}catch(e){}}
async function claimName(raw){
  const n=raw.trim().toUpperCase().replace(/[^A-Z0-9_]/g,'');
  if(n.length<2)return{ok:false,msg:'Min 2 characters'};
  if(n.length>16)return{ok:false,msg:'Max 16 characters'};
  const reg=await loadNames();
  if(reg[n]&&reg[n]!==profile.deviceId)return{ok:false,msg:'Name taken'};
  if(profile.name&&reg[profile.name]===profile.deviceId)delete reg[profile.name];
  reg[n]=profile.deviceId;await saveNames(reg);
  profile.name=n;await saveProfile();return{ok:true};
}

/* ‚îÄ‚îÄ LEADERBOARD (deferred ‚Äî only called on win/back-to-menu) ‚îÄ‚îÄ */
async function getLB(key){try{const r=await window.storage.get('lb:'+key,true);if(r)return JSON.parse(r.value);}catch(e){}return[];}
async function setLB(key,arr){try{await window.storage.set('lb:'+key,JSON.stringify(arr),true);}catch(e){}}
async function pushWorldLB(wi,t,stars,coins){
  if(!profile.name)return;let lb=await getLB('w:'+wi);
  lb=lb.filter(e=>e.name!==profile.name);
  lb.push({name:profile.name,time:t,stars,coins,date:new Date().toLocaleDateString('en',{month:'short',day:'numeric'})});
  lb.sort((a,b)=>a.time-b.time);await setLB('w:'+wi,lb.slice(0,10));
}
async function pushSpeedrunLB(t){
  if(!profile.name)return;let lb=await getLB('speedrun');
  lb=lb.filter(e=>e.name!==profile.name);
  lb.push({name:profile.name,time:t,date:new Date().toLocaleDateString('en',{month:'short',day:'numeric'})});
  lb.sort((a,b)=>a.time-b.time);await setLB('speedrun',lb.slice(0,10));
}
async function pushCoinsLB(){
  if(!profile.name)return;let lb=await getLB('coins');
  lb=lb.filter(e=>e.name!==profile.name);
  lb.push({name:profile.name,coins:profile.coins,date:new Date().toLocaleDateString('en',{month:'short',day:'numeric'})});
  lb.sort((a,b)=>b.coins-a.coins);await setLB('coins',lb.slice(0,10));
}
async function pushSkinsLB(){
  if(!profile.name)return;
  const count=profile.ownedCrowbars.filter(Boolean).length+profile.ownedChars.filter(Boolean).length;
  let lb=await getLB('skins');
  lb=lb.filter(e=>e.name!==profile.name);
  lb.push({name:profile.name,count,date:new Date().toLocaleDateString('en',{month:'short',day:'numeric'})});
  lb.sort((a,b)=>b.count-a.count);await setLB('skins',lb.slice(0,10));
}

/* ‚îÄ‚îÄ NAME MODAL ‚îÄ‚îÄ */
let nameChanging=false;
function openNameModal(changing=false){
  nameChanging=changing;$('nameModal').classList.remove('hide');
  $('nameInput').value=changing?profile.name:'';$('nameError').textContent='';
  setTimeout(()=>$('nameInput').focus(),100);
}
async function submitName(){
  $('nameError').textContent='Checking...';
  const res=await claimName($('nameInput').value);
  if(res.ok){
    $('nameModal').classList.add('hide');$('menuNameBadge').textContent='üë§ '+profile.name;
    $('saveBtn').classList.add('show');
    try{localStorage.setItem('stickclimb_profile',JSON.stringify(profile));}catch(e){}
    if(!nameChanging){$('menu').classList.remove('hide');loadMiniLB();}
  }else $('nameError').textContent=res.msg;
}
$('nameInput').addEventListener('keydown',e=>{if(e.key==='Enter')submitName();});

/* ‚îÄ‚îÄ LB UI ‚îÄ‚îÄ */
let lbCat='worlds',lbWI=0;
function showLeaderboard(){$('menu').classList.add('hide');$('lbScreen').classList.add('show');renderLBWorldTabs();loadLBData();}
function hideLeaderboard(){$('lbScreen').classList.remove('show');$('menu').classList.remove('hide');}
function setLBCat(cat){
  lbCat=cat;
  document.querySelectorAll('.lb-cat-btn').forEach((b,i)=>b.classList.toggle('active',['worlds','speedrun','coins','skins'][i]===cat));
  $('lbWorldTabs').style.display=cat==='worlds'?'flex':'none';loadLBData();
}
function renderLBWorldTabs(){
  let h='';for(let i=0;i<WORLDS.length;i++)h+=`<button class="lb-world-btn${i===lbWI?' active':''}" onclick="setLBWorld(${i})">W${i+1}</button>`;
  $('lbWorldTabs').innerHTML=h;$('lbWorldTabs').style.display='flex';
}
function setLBWorld(i){lbWI=i;document.querySelectorAll('.lb-world-btn').forEach((b,j)=>b.classList.toggle('active',j===i));loadLBData();}
async function loadLBData(){
  const w=$('lbTableWrap');w.innerHTML='<div class="lb-loading">LOADING...</div>';
  let lb=[],sc='TIME';
  if(lbCat==='worlds')lb=await getLB('w:'+lbWI);
  else if(lbCat==='speedrun'){lb=await getLB('speedrun');sc='TOTAL TIME';}
  else if(lbCat==='coins'){lb=await getLB('coins');sc='COINS';}
  else{lb=await getLB('skins');sc='SKINS';}
  if(!lb.length){w.innerHTML='<div class="lb-empty">NO ENTRIES YET ¬∑ BE FIRST!</div>';return;}
  const rk=['ü•á','ü•à','ü•â'];
  let h=`<div class="lb-table-head"><div>#</div><div>PLAYER</div><div style="text-align:right">${sc}</div><div style="text-align:right">DATE</div></div>`;
  lb.forEach((e,i)=>{
    const me=e.name===profile.name;
    let sc2='';
    if(lbCat==='worlds'||lbCat==='speedrun'){const m=Math.floor(e.time/60),s=Math.floor(e.time%60).toString().padStart(2,'0');sc2=`${m}:${s}`;}
    else if(lbCat==='coins')sc2=e.coins+'ü™ô';
    else sc2=e.count+' skins';
    h+=`<div class="lb-row${me?' me':''}"><div class="lb-rank${i<3?' '+['gold','silver','bronze'][i]:''}">${i<3?rk[i]:i+1}</div><div class="lb-name${me?' me':''}">${e.name}${me?' ‚óÄ':''}</div><div class="lb-score">${sc2}</div><div class="lb-date">${e.date||''}</div></div>`;
  });
  w.innerHTML=h;
}
async function loadMiniLB(){
  const lb=await getLB('speedrun');const w=$('miniLBRows');
  if(!lb.length){w.innerHTML='<div class="mini-lb-row"><span class="mini-lb-name" style="color:#888">NO ENTRIES YET</span></div>';return;}
  w.innerHTML=lb.slice(0,3).map((e,i)=>{
    const m=Math.floor(e.time/60),s=Math.floor(e.time%60).toString().padStart(2,'0');
    const me=e.name===profile.name;
    return `<div class="mini-lb-row"><span class="mini-lb-rank">${['ü•á','ü•à','ü•â'][i]}</span><span class="mini-lb-name${me?' mini-lb-me':''}">${e.name}</span><span class="mini-lb-score">${m}:${s}</span></div>`;
  }).join('');
}

/* ‚îÄ‚îÄ WORLDS SCREEN ‚îÄ‚îÄ */
function showWorlds(){$('menu').classList.add('hide');$('worldsScreen').classList.add('show');renderWorldsGrid();}
function hideWorlds(){$('worldsScreen').classList.remove('show');$('menu').classList.remove('hide');}
function renderWorldsGrid(){
  let h='';
  for(let i=0;i<WORLDS.length;i++){
    const w=WORLDS[i],ul=i===0||(profile.worldProgress[i-1]?.cleared);
    const p=profile.worldProgress[i],cl=p?.cleared;
    const stars=cl?p.stars:0;
    let dots='<div class="world-card-stages">';
    for(let s=0;s<4;s++)dots+=`<div class="stage-dot${cl?' done':''}"></div>`;dots+='</div>';
    h+=`<div class="world-card ${ul?'unlocked':'locked'}" ${ul?`onclick="startFromWorld(${i})"`:''}>
      <div class="world-card-num">WORLD ${i+1} / 10</div>
      <div class="world-card-name">${w.name}</div>
      <div class="world-card-theme">${w.theme}</div>
      ${dots}
      <div class="world-card-stars">${cl?'‚òÖ'.repeat(stars)+'‚òÜ'.repeat(3-stars):''}</div>
      <div class="world-card-coins">${cl?p.coins+'ü™ô':''}</div>
      ${ul?'<div class="world-card-action">‚ñ∂ PLAY</div>':''}
      <div class="world-card-lock">${ul?'':'üîí'}</div>
      <div class="world-card-bar"></div>
    </div>`;
  }
  $('worldsGrid').innerHTML=h;
}
function startFromWorld(i){$('worldsScreen').classList.remove('show');startGame(i);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3D SHOP SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let sScene,sCamera,sRenderer,sAmbient,sSun,sAnimId;
let sItemMeshes=[],sKeeperGroup=null,sStallGroup=null;
let shopTabMode='crowbar',shopIdx=0,shopAnimating=false;
let sDotRow=$('shopDotRow');

function initShopRenderer(){
  if(sRenderer)return;
  const cvs=$('shopCanvas');
  sScene=new THREE.Scene();
  sScene.background=new THREE.Color(0x05030f);
  sScene.fog=new THREE.Fog(0x05030f,25,80);
  sCamera=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,200);
  sCamera.position.set(0,3.5,18);sCamera.lookAt(0,2,0);
  sRenderer=new THREE.WebGLRenderer({canvas:cvs,antialias:true});
  sRenderer.setSize(innerWidth,innerHeight);
  sRenderer.setPixelRatio(Math.min(devicePixelRatio,2));
  sRenderer.shadowMap.enabled=true;
  sRenderer.outputEncoding=THREE.sRGBEncoding;
  sRenderer.toneMapping=THREE.ACESFilmicToneMapping;
  sRenderer.toneMappingExposure=1.2;
  // Lights
  sAmbient=new THREE.AmbientLight(0x4422aa,0.8);sScene.add(sAmbient);
  sSun=new THREE.DirectionalLight(0x9966ff,1.8);sSun.position.set(5,12,8);sSun.castShadow=true;sScene.add(sSun);
  const fill=new THREE.PointLight(0x00d4ff,1.2,40);fill.position.set(-6,5,5);sScene.add(fill);
  const back=new THREE.PointLight(0xff2255,0.8,30);back.position.set(8,3,-5);sScene.add(back);
  // Floor
  const floor=new THREE.Mesh(new THREE.PlaneGeometry(80,80),new THREE.MeshPhongMaterial({color:0x060215,emissive:0x060215}));
  floor.rotation.x=-PI/2;floor.position.y=-1.2;floor.receiveShadow=true;sScene.add(floor);
  // Grid lines on floor
  const gridHelper=new THREE.GridHelper(40,20,0x1a0a33,0x0d0520);gridHelper.position.y=-1.18;sScene.add(gridHelper);
  // Stars bg
  const sv=[];for(let i=0;i<2000;i++)sv.push((Math.random()-0.5)*200,Math.random()*60-10,(Math.random()-0.5)*200);
  const sg=new THREE.BufferGeometry();sg.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  sScene.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xaaaaff,size:0.35,transparent:true,opacity:0.6})));
  buildStall();
  buildShopkeeper();
  buildKeeperSign3D();
}

function buildStall(){
  sStallGroup=new THREE.Group();
  const woodMat=new THREE.MeshPhongMaterial({color:0x1a0a2e,emissive:0x0a0518,shininess:40});
  const trimMat=new THREE.MeshPhongMaterial({color:0x7B4FFF,emissive:0x3a1a88,emissiveIntensity:0.6,shininess:100});
  const glowMat=new THREE.MeshBasicMaterial({color:0x7B4FFF,transparent:true,opacity:0.55});
  // Counter top
  const counter=new THREE.Mesh(new THREE.BoxGeometry(16,0.5,4),woodMat);counter.position.set(0,0.25,-2);counter.castShadow=true;counter.receiveShadow=true;sStallGroup.add(counter);
  // Counter front panel
  const front=new THREE.Mesh(new THREE.BoxGeometry(16,2.2,0.3),woodMat);front.position.set(0,-0.85,-4);sStallGroup.add(front);
  // Counter trim top edge
  const ctrim=new THREE.Mesh(new THREE.BoxGeometry(16.4,0.12,0.12),trimMat);ctrim.position.set(0,0.52,-2);sStallGroup.add(ctrim);
  // Back wall
  const bwall=new THREE.Mesh(new THREE.BoxGeometry(18,12,0.4),woodMat);bwall.position.set(0,5,-7);bwall.receiveShadow=true;sStallGroup.add(bwall);
  // Back wall trim
  for(let i=-1;i<=1;i+=2){const bt=new THREE.Mesh(new THREE.BoxGeometry(0.15,12,0.5),trimMat);bt.position.set(i*9,5,-6.8);sStallGroup.add(bt);}
  // Roof
  const roof=new THREE.Mesh(new THREE.BoxGeometry(20,0.5,9),woodMat);roof.position.set(0,11.5,-3);sStallGroup.add(roof);
  // Roof front overhang
  const rof=new THREE.Mesh(new THREE.BoxGeometry(20,0.3,2),woodMat);rof.position.set(0,11.5,1.5);sStallGroup.add(rof);
  // Roof trim glow
  const rtrim=new THREE.Mesh(new THREE.BoxGeometry(20.2,0.18,0.18),new THREE.MeshBasicMaterial({color:0x9966ff}));rtrim.position.set(0,11.38,2.6);sStallGroup.add(rtrim);
  // Side poles
  for(let s of[-1,1]){
    const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,12.5,12),woodMat);pole.position.set(s*8.8,5.5,-6.8);sStallGroup.add(pole);
    const ptrim=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,0.3,12),trimMat);ptrim.position.set(s*8.8,11.2,-6.8);sStallGroup.add(ptrim);
  }
  // Hanging banner
  const bannerMat=new THREE.MeshPhongMaterial({color:0x3a0088,emissive:0x1a0044,side:THREE.DoubleSide});
  const banner=new THREE.Mesh(new THREE.PlaneGeometry(12,2.5),bannerMat);banner.position.set(0,9,-6.7);sStallGroup.add(banner);
  const bglowMat=new THREE.MeshBasicMaterial({color:0x7B4FFF,transparent:true,opacity:0.3,side:THREE.DoubleSide});
  const bglow=new THREE.Mesh(new THREE.PlaneGeometry(12,2.5),bglowMat);bglow.position.set(0,9,-6.6);sStallGroup.add(bglow);
  // Glowing hooks rack (decorative)
  for(let i=0;i<7;i++){
    const rack=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.5,8),new THREE.MeshBasicMaterial({color:0x9966ff}));
    rack.position.set(-7.5+i*2.5,10.5,-6.8);rack.rotation.z=PI/2;sStallGroup.add(rack);
  }
  // Neon sign
  const signGeo=new THREE.TorusGeometry(1.2,0.07,8,40);
  const signMat=new THREE.MeshBasicMaterial({color:0x00d4ff});
  const sign=new THREE.Mesh(signGeo,signMat);sign.position.set(0,10.5,-6.6);sStallGroup.add(sign);
  // Lens flares/glow orbs on corners
  for(let s of[-1,1]){
    const orb=new THREE.Mesh(new THREE.SphereGeometry(0.25,12,12),new THREE.MeshBasicMaterial({color:0x7B4FFF}));
    orb.position.set(s*9,11.5,-6.5);sStallGroup.add(orb);
  }
  // Counter items (decorative coin stacks)
  for(let i=0;i<3;i++){
    const coinStack=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.2*(i+1)+0.3,16),new THREE.MeshPhongMaterial({color:0xFFCC00,emissive:0x886600,emissiveIntensity:0.5}));
    coinStack.position.set(5+i*1.5,0.65,-2);sStallGroup.add(coinStack);
  }
  sStallGroup.position.set(0,0,0);
  sScene.add(sStallGroup);
}

function buildShopkeeper(){
  sKeeperGroup=new THREE.Group();

  const coat  =new THREE.MeshPhongMaterial({color:0x5522aa,emissive:0x1a0044,shininess:60});
  const skin  =new THREE.MeshPhongMaterial({color:0xFFCC99,emissive:0x110800,shininess:80});
  const dark  =new THREE.MeshPhongMaterial({color:0x0d0020,shininess:30});
  const gold  =new THREE.MeshPhongMaterial({color:0xFFD000,emissive:0x664400,emissiveIntensity:0.5,shininess:120});
  const white =new THREE.MeshBasicMaterial({color:0xffffff});
  const black =new THREE.MeshBasicMaterial({color:0x111111});
  const lapel =new THREE.MeshPhongMaterial({color:0x2a0055,shininess:50});

  // ‚îÄ‚îÄ Body (torso) centred at y=0 ‚îÄ‚îÄ
  const torso=new THREE.Mesh(new THREE.CylinderGeometry(0.62,0.58,1.5,16),coat);
  torso.position.set(0,0.75,0);torso.castShadow=true;sKeeperGroup.add(torso);

  // Lapels
  for(const s of[-1,1]){
    const lp=new THREE.Mesh(new THREE.BoxGeometry(0.22,0.9,0.18),lapel);
    lp.position.set(s*0.28,0.8,0.56);lp.rotation.z=s*0.18;sKeeperGroup.add(lp);
  }

  // Gold badge
  const badge=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.07,16),gold);
  badge.rotation.x=PI/2;badge.position.set(0,1.0,0.65);sKeeperGroup.add(badge);

  // ‚îÄ‚îÄ Neck ‚îÄ‚îÄ
  const neck=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.25,0.3,12),skin);
  neck.position.set(0,1.65,0);sKeeperGroup.add(neck);

  // ‚îÄ‚îÄ Head ‚îÄ‚îÄ
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.52,20,20),skin);
  head.position.set(0,2.3,0);head.castShadow=true;sKeeperGroup.add(head);

  // Eyes
  for(const s of[-1,1]){
    const ew=new THREE.Mesh(new THREE.SphereGeometry(0.11,10,10),white);ew.position.set(s*0.19,2.37,0.46);sKeeperGroup.add(ew);
    const ep=new THREE.Mesh(new THREE.SphereGeometry(0.055,8,8),black);ep.position.set(s*0.19,2.37,0.51);sKeeperGroup.add(ep);
  }

  // Eyebrows
  for(const s of[-1,1]){
    const br=new THREE.Mesh(new THREE.BoxGeometry(0.18,0.04,0.04),black);
    br.position.set(s*0.19,2.52,0.48);br.rotation.z=s*0.18;sKeeperGroup.add(br);
  }

  // Smile (arc of dots)
  for(let i=0;i<5;i++){
    const a=-0.5+i*0.25;
    const sm=new THREE.Mesh(new THREE.SphereGeometry(0.035,6,6),new THREE.MeshBasicMaterial({color:0x884422}));
    sm.position.set(Math.sin(a)*0.2,2.18+Math.cos(a)*0.06,0.49);sKeeperGroup.add(sm);
  }

  // ‚îÄ‚îÄ Hat ‚îÄ‚îÄ
  const brim=new THREE.Mesh(new THREE.CylinderGeometry(0.72,0.72,0.1,20),dark);
  brim.position.set(0,2.72,0);sKeeperGroup.add(brim);
  const crown=new THREE.Mesh(new THREE.CylinderGeometry(0.48,0.54,0.78,20),dark);
  crown.position.set(0,3.17,0);sKeeperGroup.add(crown);
  const band=new THREE.Mesh(new THREE.CylinderGeometry(0.49,0.49,0.14,20),gold);
  band.position.set(0,2.84,0);sKeeperGroup.add(band);
  const starOct=new THREE.Mesh(new THREE.OctahedronGeometry(0.12,0),new THREE.MeshBasicMaterial({color:0xFFD000}));
  starOct.position.set(0,3.58,0.46);sKeeperGroup.add(starOct);

  // ‚îÄ‚îÄ Arms ‚Äî natural hang at sides, leaning on counter ‚îÄ‚îÄ
  // Right arm (from viewer): rests on counter, elbow bent forward
  const armR_upper=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.16,0.82,12),coat);
  armR_upper.position.set(0.78,0.72,0);armR_upper.rotation.z=-0.25;armR_upper.rotation.x=0.1;sKeeperGroup.add(armR_upper);
  const armR_lower=new THREE.Mesh(new THREE.CylinderGeometry(0.14,0.13,0.78,12),skin);
  armR_lower.position.set(1.12,0.28,0.32);armR_lower.rotation.z=-0.15;armR_lower.rotation.x=0.7;sKeeperGroup.add(armR_lower);
  const handR=new THREE.Mesh(new THREE.SphereGeometry(0.16,10,10),skin);
  handR.position.set(1.22,-0.05,0.72);sKeeperGroup.add(handR);

  // Left arm: slightly raised, pointing toward wares
  const armL_upper=new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.16,0.82,12),coat);
  armL_upper.position.set(-0.78,0.82,0);armL_upper.rotation.z=0.35;armL_upper.rotation.x=-0.05;sKeeperGroup.add(armL_upper);
  const armL_lower=new THREE.Mesh(new THREE.CylinderGeometry(0.14,0.13,0.78,12),skin);
  armL_lower.position.set(-1.18,0.55,0.18);armL_lower.rotation.z=0.55;armL_lower.rotation.x=0.25;sKeeperGroup.add(armL_lower);
  const handL=new THREE.Mesh(new THREE.SphereGeometry(0.16,10,10),skin);
  handL.position.set(-1.48,0.32,0.34);sKeeperGroup.add(handL);

  // ‚îÄ‚îÄ Legs ‚îÄ‚îÄ
  for(const s of[-1,1]){
    const leg=new THREE.Mesh(new THREE.CylinderGeometry(0.19,0.17,1.05,12),dark);
    leg.position.set(s*0.24,-0.53,0);sKeeperGroup.add(leg);
    const boot=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.2,0.52),new THREE.MeshPhongMaterial({color:0x0a0500}));
    boot.position.set(s*0.24,-1.12,0.1);sKeeperGroup.add(boot);
  }

  // Place keeper behind and to the left of counter, fully above floor
  sKeeperGroup.position.set(-5.2, 2.2, -5.2);
  sKeeperGroup.rotation.y = 0.55; // faces toward camera+right (toward items)
  sScene.add(sKeeperGroup);
}

/* ‚îÄ‚îÄ 3D KEEPER SPEECH SIGN ‚îÄ‚îÄ */
let sSignGroup=null,sSignTexture=null,sSignCanvas=null;
const SIGN_W=5.4,SIGN_H=3.0,SIGN_D=0.28;
const SIGN_CV_W=512,SIGN_CV_H=280;

function buildKeeperSign3D(){
  sSignCanvas=document.createElement('canvas');
  sSignCanvas.width=SIGN_CV_W;sSignCanvas.height=SIGN_CV_H;
  sSignTexture=new THREE.CanvasTexture(sSignCanvas);

  sSignGroup=new THREE.Group();

  // ‚îÄ‚îÄ Main extruded box ‚îÄ‚îÄ
  const darkPurp=new THREE.MeshPhongMaterial({color:0x06031a,emissive:0x04021a,shininess:40});
  const frontMat=new THREE.MeshBasicMaterial({map:sSignTexture,side:THREE.FrontSide});

  // Use 6-material box: sides=darkPurp, front(+Z face index 4)=canvas, back=darkPurp
  const boxMats=[darkPurp,darkPurp,darkPurp,darkPurp,frontMat,darkPurp];
  const signBox=new THREE.Mesh(new THREE.BoxGeometry(SIGN_W,SIGN_H,SIGN_D,1,1,1),boxMats);
  signBox.castShadow=true;sSignGroup.add(signBox);

  // ‚îÄ‚îÄ Glowing edge trim ‚îÄ‚îÄ
  const trimMat=new THREE.MeshBasicMaterial({color:0x7B4FFF,transparent:true,opacity:0.9});
  const crnMat=new THREE.MeshBasicMaterial({color:0x00D4FF});
  const hw=SIGN_W/2+0.04,hh=SIGN_H/2+0.04,zf=SIGN_D/2+0.01;
  // 4 edge bars
  [[0,hh],[0,-hh]].forEach(([x,y])=>{
    const b=new THREE.Mesh(new THREE.BoxGeometry(SIGN_W+0.12,0.08,0.08),trimMat.clone());
    b.position.set(x,y,zf);sSignGroup.add(b);
  });
  [[-hw,0],[hw,0]].forEach(([x,y])=>{
    const b=new THREE.Mesh(new THREE.BoxGeometry(0.08,SIGN_H+0.12,0.08),trimMat.clone());
    b.position.set(x,y,zf);sSignGroup.add(b);
  });
  // 4 corner dots
  [[-hw,-hh],[-hw,hh],[hw,-hh],[hw,hh]].forEach(([x,y])=>{
    const c=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),crnMat);
    c.position.set(x,y,zf);sSignGroup.add(c);
  });
  // Corner glow point lights
  const gl=new THREE.PointLight(0x7B4FFF,0.8,6);gl.position.set(0,0,zf+0.3);sSignGroup.add(gl);
  sSignGroup.userData.glowLight=gl;

  // Tail: points from bottom-left of sign down toward keeper
  const tailGeo = new THREE.BufferGeometry();
  const lx = -SIGN_W / 2, ly = -SIGN_H / 2, zf2 = SIGN_D / 2 - 0.02;
  const tailVerts = new Float32Array([
    lx + 0.1,  ly,      zf2,   // A ‚Äì left edge of base
    lx + 0.9,  ly,      zf2,   // B ‚Äì right edge of base
    lx - 1.0,  ly - 1.0, zf2,  // C ‚Äì tip (Shorter: adjusted from -1.8, -2.0)
  ]);
  tailGeo.setAttribute('position', new THREE.Float32BufferAttribute(tailVerts, 3));
  tailGeo.setIndex([0, 2, 1]);
  tailGeo.computeVertexNormals();
  const tailMat = new THREE.MeshBasicMaterial({ color: 0x06031a, side: THREE.DoubleSide });
  const tail = new THREE.Mesh(tailGeo, tailMat);
  sSignGroup.add(tail);

  // Tail outline (Must match the new coordinates for the tip)
  const tailOutlineGeo = new THREE.BufferGeometry();
  tailOutlineGeo.setAttribute('position', new THREE.Float32BufferAttribute(new Float32Array([
    lx + 0.1, ly, zf2, 
    lx - 1.0, ly - 1.0, zf2, // Updated tip
    lx + 0.9, ly, zf2, 
    lx + 0.1, ly, zf2
  ]), 3));
  sSignGroup.add(new THREE.Line(tailOutlineGeo, new THREE.LineBasicMaterial({ color: 0x7B4FFF, transparent: true, opacity: 0.9 })));


  // Sign floats above-right of keeper, IN FRONT of back wall (z=-3 is in front of stall at z=-7)
  sSignGroup.position.set(-1.8, 7.0, -3.5);
  sSignGroup.rotation.y = 0.0;
  sSignGroup.userData.baseY = 7.0;
  sScene.add(sSignGroup);

  // Draw initial blank state
  drawKeeperSignCanvas('','','1 / '+KEEPER_LINES.length);
}

function drawKeeperSignCanvas(displayText,showCursor,progressText){
  if(!sSignCanvas||!sSignTexture)return;
  const ctx=sSignCanvas.getContext('2d');
  const W=SIGN_CV_W,H=SIGN_CV_H;

  // ‚îÄ‚îÄ Background ‚îÄ‚îÄ
  ctx.clearRect(0,0,W,H);
  // Deep background fill
  ctx.fillStyle='#070418';
  ctx.beginPath();roundRectPath(ctx,4,4,W-8,H-8,22);ctx.fill();

  // Subtle inner glow gradient
  const ig=ctx.createRadialGradient(W/2,H/2,10,W/2,H/2,W*0.65);
  ig.addColorStop(0,'rgba(123,79,255,0.08)');ig.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=ig;
  ctx.beginPath();roundRectPath(ctx,4,4,W-8,H-8,22);ctx.fill();

  // ‚îÄ‚îÄ Header bar ‚îÄ‚îÄ
  const hg=ctx.createLinearGradient(0,12,W,42);
  hg.addColorStop(0,'rgba(123,79,255,0.35)');hg.addColorStop(1,'rgba(0,212,255,0.15)');
  ctx.fillStyle=hg;
  ctx.beginPath();roundRectPath(ctx,14,12,W-28,36,8);ctx.fill();

  // Header text
  ctx.fillStyle='#a085ff';
  ctx.font='bold 15px Orbitron, monospace';
  ctx.letterSpacing='3px';
  ctx.textAlign='center';
  ctx.fillText('DORP THE SHOPKEEPER',W/2,33);

  // Live dot beside name
  const dotPulse=0.5+Math.sin(Date.now()*0.003)*0.5;
  ctx.fillStyle=`rgba(0,212,255,${0.5+dotPulse*0.5})`;
  ctx.beginPath();ctx.arc(24,28,4,0,Math.PI*2);ctx.fill();

  // ‚îÄ‚îÄ Divider ‚îÄ‚îÄ
  const dg=ctx.createLinearGradient(20,0,W-20,0);
  dg.addColorStop(0,'transparent');dg.addColorStop(0.3,'rgba(123,79,255,0.6)');dg.addColorStop(0.7,'rgba(0,212,255,0.4)');dg.addColorStop(1,'transparent');
  ctx.strokeStyle=dg;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(20,54);ctx.lineTo(W-20,54);ctx.stroke();

  // ‚îÄ‚îÄ Body text with word-wrap ‚îÄ‚îÄ
  ctx.fillStyle='#ede8ff';ctx.font='13px "Space Mono", monospace';ctx.textAlign='left';ctx.letterSpacing='0.5px';
  const words=(displayText||'').split(' ');const maxW=W-56,lineH=21;let line='',textY=80;
  for(const w of words){
    const test=line?line+' '+w:w;
    if(ctx.measureText(test).width>maxW&&line){
      ctx.fillText(line,28,textY);line=w;textY+=lineH;
      if(textY>H-52)break;
    }else line=test;
  }
  if(line&&textY<=H-52)ctx.fillText(line,28,textY);

  // Blinking cursor
  if(showCursor){
    const cursorX=28+ctx.measureText(line||'').width+3;
    if(Math.floor(Date.now()/500)%2===0){
      ctx.fillStyle='#00D4FF';ctx.fillRect(cursorX,textY-13,2,15);
    }
  }

  // ‚îÄ‚îÄ Progress bar at bottom ‚îÄ‚îÄ
  const barY=H-28;
  ctx.fillStyle='rgba(123,79,255,0.15)';
  ctx.beginPath();roundRectPath(ctx,24,barY,W-48,12,6);ctx.fill();

  // Parse progress
  const parts=(progressText||'1/15').replace(' ','').split('/');
  const cur=parseInt(parts[0])||1,tot=parseInt(parts[1])||KEEPER_LINES.length;
  const frac=cur/tot;
  const barGrad=ctx.createLinearGradient(24,0,24+(W-48)*frac,0);
  barGrad.addColorStop(0,'#7B4FFF');barGrad.addColorStop(1,'#00D4FF');
  ctx.fillStyle=barGrad;
  ctx.beginPath();roundRectPath(ctx,24,barY,(W-48)*frac,12,6);ctx.fill();

  // Progress text
  ctx.fillStyle='rgba(255,255,255,0.35)';ctx.font='10px "Space Mono",monospace';ctx.textAlign='right';ctx.letterSpacing='1px';
  ctx.fillText(cur+' / '+tot,W-24,barY-4);

  sSignTexture.needsUpdate=true;
}

function roundRectPath(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}


function buildCrowbarMesh(skin){
  const g=new THREE.Group();
  const sm=new THREE.MeshPhongMaterial({color:skin.shaftCol,emissive:skin.shaftCol,emissiveIntensity:skin.emi*0.5,shininess:120});
  const hm=new THREE.MeshPhongMaterial({color:skin.hookCol,emissive:skin.hookCol,emissiveIntensity:skin.emi*0.7,shininess:140});
  // Shaft
  const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.1,4.5,16),sm);shaft.position.y=0;g.add(shaft);
  // Hook arc
  const hook=new THREE.Mesh(new THREE.TorusGeometry(0.55,0.12,12,32,PI*1.2),hm);hook.position.y=2.5;hook.rotation.x=PI/2;g.add(hook);
  // Tip
  const tip=new THREE.Mesh(new THREE.ConeGeometry(0.1,0.45,10),hm);tip.position.set(0.52,2.9,0);tip.rotation.z=-PI/2;g.add(tip);
  // Flat end
  const flat=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.15,0.2),hm);flat.position.y=-2.3;g.add(flat);
  // Glow ring
  if(skin.glowCol){
    const gm=new THREE.MeshBasicMaterial({color:skin.glowCol,transparent:true,opacity:0.5,side:THREE.DoubleSide});
    const gr=new THREE.Mesh(new THREE.TorusGeometry(1.0,0.04,8,32),gm);gr.rotation.x=PI/2;g.add(gr);
    g.userData.glowRing=gr;
  }
  if(skin.rainbow)g.userData.rainbow=true;
  if(skin.plasma)g.userData.plasma=true;
  g.userData.shaftMat=sm;g.userData.hookMat=hm;
  return g;
}

function buildCharMesh(cs){
  const g=new THREE.Group();
  const torsoMat=new THREE.MeshPhongMaterial({color:cs.torso,emissive:cs.torso,emissiveIntensity:0.15,shininess:60});
  const headMat=new THREE.MeshPhongMaterial({color:cs.head,emissive:0x110800,shininess:80});
  const hatMat=new THREE.MeshPhongMaterial({color:cs.hat,emissive:cs.hat,emissiveIntensity:0.2,shininess:60});
  const legMat=new THREE.MeshPhongMaterial({color:cs.leg,shininess:40});
  const bootMat=new THREE.MeshPhongMaterial({color:cs.boot,shininess:30});
  const eyeMat=new THREE.MeshBasicMaterial({color:cs.eyeCol||0x111111});
  const whiteMat=new THREE.MeshBasicMaterial({color:0xffffff});
  // Torso
  const torso=new THREE.Mesh(new THREE.CylinderGeometry(0.65,0.6,1.4,16),torsoMat);torso.position.y=0;g.add(torso);
  // Head
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.58,20,20),headMat);head.position.y=1.35;g.add(head);
  // Eyes
  for(let s of[-1,1]){
    const ew=new THREE.Mesh(new THREE.SphereGeometry(0.12,10,10),whiteMat);ew.position.set(s*0.22,1.42,0.5);g.add(ew);
    const ep=new THREE.Mesh(new THREE.SphereGeometry(0.06,8,8),eyeMat);ep.position.set(s*0.22,1.42,0.54);g.add(ep);
  }
  // Legs
  for(let s of[-1,1]){
    const leg=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.18,1.0,12),legMat);leg.position.set(s*0.26,-1.1,0);g.add(leg);
    const boot=new THREE.Mesh(new THREE.BoxGeometry(0.32,0.22,0.55),bootMat);boot.position.set(s*0.26,-1.66,0.1);g.add(boot);
  }
  // Hat by type
  const ht=cs.hatType||'hardhat';
  if(ht==='hardhat'){
    const b=new THREE.Mesh(new THREE.CylinderGeometry(0.7,0.7,0.1,16),hatMat);b.position.y=1.72;g.add(b);
    const t=new THREE.Mesh(new THREE.SphereGeometry(0.55,16,8,0,TWO_PI,0,PI/2),hatMat);t.position.y=1.72;g.add(t);
  }else if(ht==='dome'){
    const d=new THREE.Mesh(new THREE.SphereGeometry(0.65,16,8,0,TWO_PI,0,PI/1.8),hatMat);d.position.y=1.55;g.add(d);
  }else if(ht==='ninja'){
    const w=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.85,16),hatMat);w.position.y=1.6;g.add(w);
  }else if(ht==='horn'){
    const b=new THREE.Mesh(new THREE.CylinderGeometry(0.65,0.65,0.15,16),hatMat);b.position.y=1.7;g.add(b);
    for(let s of[-1,1]){const h2=new THREE.Mesh(new THREE.ConeGeometry(0.16,0.7,8),hatMat);h2.position.set(s*0.52,2.0,0);h2.rotation.z=s*0.5;g.add(h2);}
  }else if(ht==='antenna'){
    const cap=new THREE.Mesh(new THREE.BoxGeometry(0.95,0.4,0.95),hatMat);cap.position.y=1.76;g.add(cap);
    const ant=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.65,8),new THREE.MeshPhongMaterial({color:cs.eyeCol||0x00FF88}));ant.position.y=2.18;g.add(ant);
    const ball=new THREE.Mesh(new THREE.SphereGeometry(0.11,8,8),new THREE.MeshBasicMaterial({color:cs.eyeCol||0x00FF88}));ball.position.y=2.52;g.add(ball);
  }else if(ht==='wizard'){
    const cone=new THREE.Mesh(new THREE.ConeGeometry(0.48,1.1,12),hatMat);cone.position.y=2.08;g.add(cone);
    const brim=new THREE.Mesh(new THREE.CylinderGeometry(0.75,0.75,0.1,16),hatMat);brim.position.y=1.57;g.add(brim);
  }else if(ht==='pirate'){
    const base=new THREE.Mesh(new THREE.BoxGeometry(0.95,0.35,0.72),hatMat);base.position.y=1.72;g.add(base);
    const peak=new THREE.Mesh(new THREE.ConeGeometry(0.3,0.55,4),hatMat);peak.position.set(0.42,1.98,0);g.add(peak);
  }else if(ht==='helm'){
    const helm=new THREE.Mesh(new THREE.SphereGeometry(0.62,16,8,0,TWO_PI,0,PI/1.6),hatMat);helm.position.y=1.5;g.add(helm);
    const visor=new THREE.Mesh(new THREE.BoxGeometry(0.62,0.15,0.1),new THREE.MeshPhongMaterial({color:cs.eyeCol||0xCCEEFF,emissive:cs.eyeCol||0xCCEEFF,emissiveIntensity:0.5}));visor.position.set(0,1.56,0.55);g.add(visor);
  }else if(ht==='alien'){
    const skull=new THREE.Mesh(new THREE.SphereGeometry(0.7,16,12,0,TWO_PI,0,PI*0.65),hatMat);skull.position.y=1.45;g.add(skull);
    for(let s of[-1,1]){const ant=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.55,6),hatMat);ant.position.set(s*0.38,2.08,0);ant.rotation.z=s*0.3;g.add(ant);}
  }else if(ht==='crown'){
    const ring=new THREE.Mesh(new THREE.CylinderGeometry(0.65,0.65,0.32,16),hatMat);ring.position.y=1.72;g.add(ring);
    for(let j=0;j<5;j++){const a=(j/5)*TWO_PI;const sp=new THREE.Mesh(new THREE.ConeGeometry(0.11,0.38,6),hatMat);sp.position.set(Math.cos(a)*0.48,2.0,Math.sin(a)*0.48);g.add(sp);}
  }
  return g;
}

/* ‚îÄ‚îÄ SHOP SCENE MANAGEMENT ‚îÄ‚îÄ */
function buildShopItems(){
  // Clear old
  sItemMeshes.forEach(m=>sScene.remove(m));sItemMeshes=[];
  const items=shopTabMode==='crowbar'?CROWBAR_SKINS:CHAR_SKINS;
  const SPREAD=7.5;
  items.forEach((item,i)=>{
    const mesh=shopTabMode==='crowbar'?buildCrowbarMesh(item):buildCharMesh(item);
    mesh.position.set((i-shopIdx)*SPREAD,shopTabMode==='crowbar'?2.8:1.5,-2);
    mesh.userData.itemIdx=i;
    mesh.userData.baseX=(i-shopIdx)*SPREAD;
    // Point light per item for glow
    const col=shopTabMode==='crowbar'?item.glowCol:item.hat;
    const pt=new THREE.PointLight(col||0x7B4FFF,0,10);pt.position.copy(mesh.position);mesh.userData.ptLight=pt;sScene.add(pt);
    sScene.add(mesh);sItemMeshes.push(mesh);
  });
  updateShopDots();
  updateShopInfo();
}

function updateShopPositions(instant=false){
  const SPREAD=7.5;
  sItemMeshes.forEach((m,i)=>{
    m.userData.baseX=(i-shopIdx)*SPREAD;
    if(instant)m.position.x=m.userData.baseX;
  });
}

function updateShopDots(){
  const items=shopTabMode==='crowbar'?CROWBAR_SKINS:CHAR_SKINS;
  sDotRow=$('shopDotRow');
  let h='';for(let i=0;i<items.length;i++)h+=`<div class="shop-dot${i===shopIdx?' on':''}"></div>`;
  sDotRow.innerHTML=h;
}

function updateShopInfo(){
  const items=shopTabMode==='crowbar'?CROWBAR_SKINS:CHAR_SKINS;
  const ownedArr=shopTabMode==='crowbar'?profile.ownedCrowbars:profile.ownedChars;
  const activeId=shopTabMode==='crowbar'?profile.activeCrowbar:profile.activeChar;
  const item=items[shopIdx];if(!item)return;
  $('sEmoji').textContent=item.emoji;
  $('sName').textContent=item.name;
  $('sDesc').textContent=item.desc;
  $('sPrice').textContent=item.price===0?'FREE':item.price+' ü™ô';
  const btn=$('sBtn');
  if(activeId===item.id){btn.textContent='EQUIPPED ‚úì';btn.className='s3d-btn equipped';}
  else if(ownedArr[item.id]){btn.textContent='EQUIP';btn.className='s3d-btn equip';}
  else if(profile.coins>=item.price){btn.textContent='BUY '+item.price+'ü™ô';btn.className='s3d-btn buy';}
  else{btn.textContent='NEED '+(item.price-profile.coins)+'ü™ô MORE';btn.className='s3d-btn broke';}
  // Update nav
  $('shopNavL').disabled=shopIdx===0;$('shopNavR').disabled=shopIdx===items.length-1;
  // Highlight active item point light
  sItemMeshes.forEach((m,i)=>{if(m.userData.ptLight)m.userData.ptLight.intensity=i===shopIdx?1.8:0;});
}

function shopNav(dir){
  const items=shopTabMode==='crowbar'?CROWBAR_SKINS:CHAR_SKINS;
  shopIdx=clamp(shopIdx+dir,0,items.length-1);
  updateShopPositions();updateShopDots();updateShopInfo();
}

function setShopTab(tab){
  shopTabMode=tab;shopIdx=0;
  $('sTabCrowbar').classList.toggle('active',tab==='crowbar');
  $('sTabChar').classList.toggle('active',tab==='char');
  buildShopItems();
}

/* ‚îÄ‚îÄ KEEPER CHATBOX TYPING SYSTEM ‚îÄ‚îÄ */
let keeperLine=0,keeperTypingTimer=null,keeperCycleTimer=null,keeperTypingIdx=0,keeperTypingActive=false;
let _keeperCurrentText='',_keeperShowCursor=false;

function keeperRenderDots(){
  // Progress is drawn onto 3D canvas ‚Äî just refresh it
  const p=$('keeperProgress');
  if(p)p.textContent=(keeperLine+1)+' / '+KEEPER_LINES.length;
  drawKeeperSignCanvas(_keeperCurrentText,_keeperShowCursor,(keeperLine+1)+' / '+KEEPER_LINES.length);
}

function keeperGoTo(idx){
  keeperLine=idx;startKeeperTyping();resetKeeperCycle();
}

function startKeeperTyping(){
  clearTimeout(keeperTypingTimer);keeperTypingActive=true;keeperTypingIdx=0;
  _keeperCurrentText='';_keeperShowCursor=true;
  drawKeeperSignCanvas('',true,(keeperLine+1)+' / '+KEEPER_LINES.length);

  function type(){
    const line=KEEPER_LINES[keeperLine];
    if(keeperTypingIdx<=line.length){
      _keeperCurrentText=line.slice(0,keeperTypingIdx);
      keeperTypingIdx++;
      drawKeeperSignCanvas(_keeperCurrentText,true,(keeperLine+1)+' / '+KEEPER_LINES.length);
      keeperTypingTimer=setTimeout(type,keeperTypingIdx===1?0:32);
    }else{
      keeperTypingActive=false;_keeperShowCursor=false;
      drawKeeperSignCanvas(_keeperCurrentText,false,(keeperLine+1)+' / '+KEEPER_LINES.length);
    }
  }
  type();
}

function resetKeeperCycle(){
  clearInterval(keeperCycleTimer);
  keeperCycleTimer=setInterval(()=>{
    keeperLine=(keeperLine+1)%KEEPER_LINES.length;startKeeperTyping();
  },9000); // 9 seconds between lines
}

function startKeeperSystem(){
  keeperLine=0;startKeeperTyping();resetKeeperCycle();
}
function stopKeeperSystem(){
  clearTimeout(keeperTypingTimer);clearInterval(keeperCycleTimer);keeperTypingActive=false;
  _keeperShowCursor=false;
}

function nextKeeperLine(){
  keeperLine=(keeperLine+1)%KEEPER_LINES.length;
  startKeeperTyping();resetKeeperCycle();
}

async function shopAction(){
  const items=shopTabMode==='crowbar'?CROWBAR_SKINS:CHAR_SKINS;
  const ownedArr=shopTabMode==='crowbar'?profile.ownedCrowbars:profile.ownedChars;
  const activeId=shopTabMode==='crowbar'?profile.activeCrowbar:profile.activeChar;
  const item=items[shopIdx];if(!item)return;
  if(activeId===item.id)return;
  if(ownedArr[item.id]){
    if(shopTabMode==='crowbar')profile.activeCrowbar=item.id;else profile.activeChar=item.id;
    await saveProfile();showToast('EQUIPPED: '+item.name);updateShopInfo();
  }else{
    if(profile.coins<item.price)return;
    profile.coins-=item.price;
    if(shopTabMode==='crowbar'){profile.ownedCrowbars[item.id]=true;profile.activeCrowbar=item.id;}
    else{profile.ownedChars[item.id]=true;profile.activeChar=item.id;}
    await saveProfile();
    playBuy();$('shopCoinsVal').textContent=profile.coins;
    showToast('‚ú® '+item.name+' UNLOCKED!');updateShopInfo();
  }
}

let sLoopRunning=false;
function shopRenderLoop(){
  if(!sLoopRunning)return;
  sAnimId=requestAnimationFrame(shopRenderLoop);
  const t=Date.now()*0.001;
  // Animate item meshes
  sItemMeshes.forEach((m,i)=>{
    const tx=m.userData.baseX;m.position.x+=(tx-m.position.x)*0.12;
    const isCurrent=i===shopIdx;
    const ty=shopTabMode==='crowbar'?2.8:1.5;
    const targetY=isCurrent?ty+0.25:ty-0.3;
    m.position.y+=(targetY-m.position.y)*0.1;
    m.rotation.y+=isCurrent?0.012:0.006;
    // Fade opacity by distance
    const dist=Math.abs(i-shopIdx);
    m.traverse(c=>{if(c.material&&c.material.transparent!==undefined){c.material.opacity=Math.max(0.25,1-dist*0.35);c.material.transparent=dist>0;}});
    // Rainbow/plasma
    if(m.userData.rainbow){
      const hue=(t*0.3+(i*0.1))%1;
      if(m.userData.shaftMat){m.userData.shaftMat.color.setHSL(hue,1,0.5);m.userData.hookMat.color.setHSL((hue+0.15)%1,1,0.6);}
    }
    if(m.userData.plasma){
      const pulse=0.5+Math.sin(t*7)*0.5;
      if(m.userData.shaftMat){m.userData.shaftMat.emissiveIntensity=pulse;if(m.userData.hookMat)m.userData.hookMat.emissiveIntensity=pulse;}
    }
    if(m.userData.glowRing)m.userData.glowRing.rotation.z+=0.02;
    // Float
    if(isCurrent)m.position.y+=Math.sin(t*1.8)*0.05;
  });
  // Keeper gentle bob
  if(sKeeperGroup){
    sKeeperGroup.rotation.y=0.55+Math.sin(t*0.5)*0.06;
    sKeeperGroup.position.y=2.2+Math.sin(t*0.9)*0.05;
  }
  // Stall sign pulse
  if(sStallGroup){
    sStallGroup.traverse(c=>{
      if(c.isMesh&&c.material&&c.material.color&&c.material.type==='MeshBasicMaterial'){
        if(c.geometry&&c.geometry.type==='TorusGeometry'){
          const pulse=0.6+Math.sin(t*2.5)*0.4;
          c.material.color.setRGB(pulse*0,pulse*0.85,pulse);
        }
      }
    });
  }
  // Animate 3D sign ‚Äî gentle float + glow pulse + cursor redraw
  if(sSignGroup){
    const baseY=sSignGroup.userData.baseY||7.2;
    sSignGroup.position.y=baseY+Math.sin(t*0.7)*0.12;
    sSignGroup.rotation.y=-0.10+Math.sin(t*0.4)*0.015;
    if(sSignGroup.userData.glowLight){
      sSignGroup.userData.glowLight.intensity=0.6+Math.sin(t*2.5)*0.25;
    }
    // Redraw canvas every 30 frames to animate cursor blink and dot live dot
    if(Math.floor(t*60)%30===0){
      drawKeeperSignCanvas(_keeperCurrentText,_keeperShowCursor,(keeperLine+1)+' / '+KEEPER_LINES.length);
    }
  }
  if(sRenderer&&sScene&&sCamera){sRenderer.render(sScene,sCamera);}
}

function showShop(){
  $('menu').classList.add('hide');
  $('shopScreen').classList.add('show');
  $('shopCoinsVal').textContent=profile.coins;
  initShopRenderer();
  shopTabMode='crowbar';shopIdx=profile.activeCrowbar;
  $('sTabCrowbar').classList.add('active');$('sTabChar').classList.remove('active');
  buildShopItems();
  sLoopRunning=true;shopRenderLoop();
  // Start keeper chatbox
  setTimeout(()=>startKeeperSystem(),300);
}

async function hideShop(){
  sLoopRunning=false;stopKeeperSystem();
  $('shopScreen').classList.remove('show');
  $('menu').classList.remove('hide');
  // Deferred LB updates on shop close
  await pushCoinsLB();
  await pushSkinsLB();
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let toastTimer=null;
function showToast(msg){
  const t=$('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME THREE.JS HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let ambientLight,sunLight,backLight,fillLight;
function setupLights(){
  ambientLight=new THREE.AmbientLight(0xFF6B00,0.4);scene.add(ambientLight);
  sunLight=new THREE.DirectionalLight(0xFF6B00,1.5);sunLight.position.set(20,200,30);sunLight.castShadow=true;
  sunLight.shadow.mapSize.set(2048,2048);sunLight.shadow.camera.left=-80;sunLight.shadow.camera.right=80;
  sunLight.shadow.camera.top=200;sunLight.shadow.camera.bottom=-30;sunLight.shadow.bias=-0.0003;scene.add(sunLight);
  backLight=new THREE.PointLight(0xFF2200,1.2,200);backLight.position.set(-20,200,-40);scene.add(backLight);
  fillLight=new THREE.PointLight(0x6622FF,0.6,150);fillLight.position.set(30,100,20);scene.add(fillLight);
}
function applyStageVisuals(world,si){
  const s=world.stages[si];
  scene.fog.color.set(world.fogCol);scene.fog.density=world.fogD;renderer.setClearColor(world.bgCol);
  ambientLight.color.set(s.ambCol);ambientLight.intensity=s.ambInt;
  sunLight.color.set(s.sunCol);sunLight.intensity=s.sunInt;
}
function makeNebCanvas(r,g,b){
  const c=document.createElement('canvas');c.width=c.height=256;
  const ctx=c.getContext('2d');
  const grd=ctx.createRadialGradient(128,128,0,128,128,128);
  grd.addColorStop(0,`rgba(${r},${g},${b},0.55)`);grd.addColorStop(0.4,`rgba(${r},${g},${b},0.18)`);grd.addColorStop(1,`rgba(${r},${g},${b},0)`);
  ctx.fillStyle=grd;ctx.fillRect(0,0,256,256);
  return new THREE.CanvasTexture(c);
}
function buildStarfield(world){
  // Reduced to ~11000 for performance
  {const v=[];for(let i=0;i<11000;i++)v.push((Math.random()-0.5)*3000,Math.random()*500-50,(Math.random()-0.5)*3000);
  const g=new THREE.BufferGeometry();g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));
  scene.add(new THREE.Points(g,new THREE.PointsMaterial({color:0xCCDDFF,size:0.9,transparent:true,opacity:0.7,sizeAttenuation:true})));}
  {const v=[],c=[];
  const hc=(world.starColor||[0x8866FF]).map(h=>[(h>>16)/255,((h>>8)&0xFF)/255,(h&0xFF)/255]);
  for(let i=0;i<500;i++){v.push((Math.random()-0.5)*1800,Math.random()*400,(Math.random()-0.5)*1800);const col=hc[i%hc.length];c.push(...col);}
  const g=new THREE.BufferGeometry();g.setAttribute('position',new THREE.Float32BufferAttribute(v,3));g.setAttribute('color',new THREE.Float32BufferAttribute(c,3));
  scene.add(new THREE.Points(g,new THREE.PointsMaterial({vertexColors:true,size:3.5,transparent:true,opacity:0.9,sizeAttenuation:true})));}
  const base=world.stages[0].ambCol,r=(base>>16)&0xFF,gv=(base>>8)&0xFF,b=base&0xFF;
  [[r,gv,b,50,-40,160],[r>>1,gv,Math.min(255,b*2),150,55,190],[r>>1,Math.min(255,gv*2),b,240,-50,150]].forEach(([nr,ng,nb,y,x,s])=>{
    const mesh=new THREE.Mesh(new THREE.PlaneGeometry(s,s),new THREE.MeshBasicMaterial({map:makeNebCanvas(nr,ng,nb),transparent:true,opacity:0.5,side:THREE.DoubleSide,depthWrite:false}));
    mesh.position.set(x,y,-70);mesh.rotation.z=Math.random()*PI;scene.add(mesh);
  });
}
function buildWall(world){
  const numSlabs=Math.ceil(WORLD_HEIGHT/5.5);
  for(let i=0;i<numSlabs;i++){
    const y=i*5.5,stI=Math.min(3,Math.floor(y/75));
    const col=world.stages[stI].wallCol;
    const mat=new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.12,flatShading:true});
    const mesh=new THREE.Mesh(new THREE.BoxGeometry(60,5.6,2.5),mat);mesh.position.set(0,y,-10);mesh.receiveShadow=true;scene.add(mesh);
  }
  for(let x=-4;x<=4;x++){
    const mesh=new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,WORLD_HEIGHT+20,12),new THREE.MeshPhongMaterial({color:0x333333,emissive:0x111111,shininess:80}));
    mesh.position.set(x*7,WORLD_HEIGHT/2,-10.5);mesh.castShadow=true;scene.add(mesh);
  }
  for(let s=1;s<4;s++){
    const y=s*75,col=world.stages[s].ambCol;
    const mesh=new THREE.Mesh(new THREE.BoxGeometry(62,1.5,3),new THREE.MeshPhongMaterial({color:0x111111,emissive:0x220022,emissiveIntensity:0.5}));mesh.position.set(0,y,-10);scene.add(mesh);
    const g=new THREE.Mesh(new THREE.BoxGeometry(62,0.3,0.3),new THREE.MeshBasicMaterial({color:col}));g.position.set(0,y+0.8,-8.5);scene.add(g);
  }
  const pf=new THREE.Mesh(new THREE.BoxGeometry(24,1.5,8),new THREE.MeshPhongMaterial({color:0x1a0a00,emissive:0x110800}));pf.position.set(0,-1,-5);pf.receiveShadow=true;scene.add(pf);
  const eg=new THREE.Mesh(new THREE.BoxGeometry(24,0.2,0.2),new THREE.MeshBasicMaterial({color:world.stages[0].ambCol}));eg.position.set(0,-0.2,-1);scene.add(eg);
}
function buildFinishPortal(world){
  const group=new THREE.Group();
  const col=world.finishCol,r=(col>>16)&0xFF,g=(col>>8)&0xFF,b=col&0xFF;
  const outer=new THREE.Mesh(new THREE.TorusGeometry(8,0.35,16,80),new THREE.MeshBasicMaterial({color:col,side:THREE.DoubleSide}));outer.rotation.x=PI/2;group.add(outer);
  const disc=new THREE.Mesh(new THREE.CircleGeometry(7.5,64),new THREE.MeshBasicMaterial({map:makeNebCanvas(r,g,b),transparent:true,opacity:0.45,side:THREE.DoubleSide,depthWrite:false}));disc.rotation.x=PI/2;group.add(disc);
  const pillMat=new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.8});
  for(let s of[-1,1]){const p=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.22,12,12),pillMat);p.position.set(s*8.5,-4,0);group.add(p);const cap=new THREE.Mesh(new THREE.SphereGeometry(0.55,16,16),new THREE.MeshBasicMaterial({color:col}));cap.position.set(s*8.5,2,0);group.add(cap);}
  group.position.set(0,FINISH_Y,-3);group.userData={col,disc,outer,triggered:false};
  scene.add(group);return group;
}
function holdColor(world,si){const p=world.holdPalette[0];return p[Math.floor(Math.random()*p.length)];}
function createHold(x,y,z,type,world,si,moving=false){
  const group=new THREE.Group();const col=holdColor(world,si);
  const emMat=new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.6,shininess:100});
  let mainMesh;
  if(type==='sphere'){mainMesh=new THREE.Mesh(new THREE.SphereGeometry(0.85,20,20),emMat.clone());
    const em=new THREE.MeshBasicMaterial({color:0xffffff}),pm=new THREE.MeshBasicMaterial({color:0x000000});
    for(let s of[-1,1]){const e=new THREE.Mesh(new THREE.SphereGeometry(0.18,12,12),em);e.position.set(s*0.28,0.1,0.78);const p=new THREE.Mesh(new THREE.SphereGeometry(0.09,8,8),pm);p.position.set(s*0.28,0.1,0.89);group.add(e,p);}
  }else if(type==='pipe'){mainMesh=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,3.5,16),emMat.clone());mainMesh.rotation.z=PI/2;
    for(let s of[-1,1]){const cap=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.2,16),emMat.clone());cap.rotation.z=PI/2;cap.position.x=s*1.85;group.add(cap);}
  }else if(type==='slab'){mainMesh=new THREE.Mesh(new THREE.BoxGeometry(3.2,0.55,0.7),emMat.clone());
    for(let s of[-1,1]){const bk=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.8,0.8),new THREE.MeshPhongMaterial({color:0x333333,emissive:0x111111}));bk.position.x=s*1.7;group.add(bk);}
  }else{mainMesh=new THREE.Mesh(new THREE.OctahedronGeometry(0.9,0),emMat.clone());mainMesh.rotation.x=Math.random()*PI;mainMesh.rotation.z=Math.random()*PI;}
  mainMesh.castShadow=true;group.add(mainMesh);
  const ringMat=new THREE.MeshBasicMaterial({color:0xFFD000,transparent:true,opacity:0,side:THREE.DoubleSide});
  const ring=new THREE.Mesh(new THREE.TorusGeometry(1.4,0.08,16,40),ringMat);ring.rotation.x=PI/2;group.add(ring);
  group.position.set(x,y,z);
  group.userData={type,col,grabbed:false,mainMesh,ring,moving,moveBase:new THREE.Vector3(x,y,z),
    moveAxis:moving?(['x','y'][Math.floor(Math.random()*2)]):'',moveAmp:2+Math.random()*4,
    moveFreq:0.3+Math.random()*0.6,movePhase:Math.random()*TWO_PI,si};
  scene.add(group);return group;
}
function createCheckpoint(y){
  const group=new THREE.Group();
  const ring=new THREE.Mesh(new THREE.TorusGeometry(5,0.25,16,60),new THREE.MeshBasicMaterial({color:0x00FFE5}));ring.rotation.x=PI/2;group.add(ring);
  for(let s of[-1,1]){
    const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.12,10,8),new THREE.MeshPhongMaterial({color:0x666666}));pole.position.set(s*5.5,-5,0);group.add(pole);
    const flag=new THREE.Mesh(new THREE.PlaneGeometry(1.8,1.1),new THREE.MeshBasicMaterial({color:0x00FFE5,side:THREE.DoubleSide}));flag.position.set(s*5.5+s*0.9,-0.5,0);group.add(flag);
  }
  group.position.set(0,y,-3);group.userData={triggered:false};scene.add(group);return group;
}
function createGear(x,y,z,world,si){
  const group=new THREE.Group();const col=holdColor(world,si);
  group.add(new THREE.Mesh(new THREE.TorusGeometry(3.5,0.35,16,60),new THREE.MeshPhongMaterial({color:0x333333,emissive:0x111111})));
  const tm=new THREE.MeshPhongMaterial({color:col,emissive:col,emissiveIntensity:0.4});
  for(let i=0;i<12;i++){const a=(i/12)*TWO_PI,t=new THREE.Mesh(new THREE.BoxGeometry(0.8,0.9,0.6),tm);t.position.set(Math.cos(a)*3.7,Math.sin(a)*3.7,0);t.rotation.z=a;group.add(t);}
  for(let i=0;i<6;i++){const a=(i/6)*TWO_PI,s=new THREE.Mesh(new THREE.BoxGeometry(7,0.3,0.3),new THREE.MeshPhongMaterial({color:0x555555}));s.rotation.z=a;group.add(s);}
  group.position.set(x,y,z);group.userData={type:'gear',rotSpeed:0.007+Math.random()*0.01,dir:Math.random()<0.5?1:-1};scene.add(group);return group;
}
const particles=[];
function spawnParticles(pos,col,count=8,speed=0.15){
  for(let i=0;i<count;i++){
    const mat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:1});
    const mesh=new THREE.Mesh(new THREE.SphereGeometry(0.1,4,4),mat);mesh.position.copy(pos);scene.add(mesh);
    particles.push({mesh,life:1.0,vel:V3((Math.random()-0.5)*speed*2,Math.random()*speed+0.05,(Math.random()-0.5)*speed)});
  }
}
function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.life-=0.04;p.vel.y-=0.008;p.mesh.position.add(p.vel);
    p.mesh.material.opacity=p.life;p.mesh.scale.setScalar(p.life*0.8+0.2);
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}

/* ‚îÄ‚îÄ SKIN-AWARE GAME HAND ‚îÄ‚îÄ */
function createHandObject(isLeft){
  const group=new THREE.Group();
  const skin=CROWBAR_SKINS[profile.activeCrowbar]||CROWBAR_SKINS[0];
  const bodyCol=isLeft?0x4488FF:0xFF3366;
  const bodyMat=new THREE.MeshPhongMaterial({color:bodyCol,emissive:bodyCol,emissiveIntensity:0.45,shininess:30});
  const body=new THREE.Mesh(new THREE.SphereGeometry(1.5,32,32),bodyMat);body.castShadow=true;group.add(body);
  const wm=new THREE.MeshBasicMaterial({color:0xFFFFFF}),pm=new THREE.MeshBasicMaterial({color:0x111111});
  for(let s of[-1,1]){const w=new THREE.Mesh(new THREE.CircleGeometry(0.32,24),wm);w.position.set(s*0.5,0.2,1.44);group.add(w);const p=new THREE.Mesh(new THREE.CircleGeometry(0.16,16),pm);p.position.set(s*0.5,0.2,1.46);group.add(p);}
  const shaftMat=new THREE.MeshPhongMaterial({color:skin.shaftCol,emissive:skin.shaftCol,emissiveIntensity:skin.emi*0.4,shininess:100});
  const hookMat=new THREE.MeshPhongMaterial({color:skin.hookCol,emissive:skin.hookCol,emissiveIntensity:skin.emi*0.6,shininess:120});
  const shaft=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,5.5,12),shaftMat);shaft.position.set(0,4.25,0);shaft.castShadow=true;group.add(shaft);
  const hook=new THREE.Mesh(new THREE.TorusGeometry(0.4,0.09,10,24,PI*1.15),hookMat);hook.position.set(0,7.0,0);hook.rotation.x=PI/2;group.add(hook);
  const tip=new THREE.Mesh(new THREE.ConeGeometry(0.09,0.4,8),hookMat);tip.position.set(0.4,7.35,0);tip.rotation.z=-PI/2;group.add(tip);
  const glowMat=new THREE.MeshBasicMaterial({color:skin.glowCol,transparent:true,opacity:0,side:THREE.DoubleSide});
  const glow=new THREE.Mesh(new THREE.TorusGeometry(1.9,0.08,12,40),glowMat);glow.rotation.x=PI/2;group.add(glow);
  group.userData={glow,shaftMat,hookMat,bodyMat,shaft,hook};
  scene.add(group);
  return{group,pos:V3(),vel:V3(),hooked:false,hookHold:null,nearHold:null,swingMom:V3()};
}
function createPlayerBody(){
  const group=new THREE.Group();
  const cs=CHAR_SKINS[profile.activeChar]||CHAR_SKINS[0];
  const torsoMat=new THREE.MeshPhongMaterial({color:cs.torso,emissive:cs.torso,emissiveIntensity:0.15,shininess:60});
  const headMat=new THREE.MeshPhongMaterial({color:cs.head,emissive:0x110800,shininess:80});
  const hatMat=new THREE.MeshPhongMaterial({color:cs.hat,emissive:cs.hat,emissiveIntensity:0.2,shininess:60});
  const eyeMat=new THREE.MeshBasicMaterial({color:cs.eyeCol||0x111111});
  const torso=new THREE.Mesh(new THREE.CylinderGeometry(0.55,0.55,1.2,16),torsoMat);torso.castShadow=true;group.add(torso);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.52,20,20),headMat);head.position.set(0,1.3,0);head.castShadow=true;group.add(head);
  for(let s of[-1,1]){const eye=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),eyeMat);eye.position.set(s*0.2,1.38,0.46);group.add(eye);}
  const ht=cs.hatType||'hardhat';
  if(ht==='hardhat'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.65,0.65,0.1,16),hatMat);b.position.set(0,1.72,0);group.add(b);const t=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,8,0,TWO_PI,0,PI/2),hatMat);t.position.set(0,1.73,0);group.add(t);}
  else if(ht==='dome'){const d=new THREE.Mesh(new THREE.SphereGeometry(0.6,16,8,0,TWO_PI,0,PI/1.8),hatMat);d.position.set(0,1.55,0);group.add(d);}
  else if(ht==='ninja'){const w=new THREE.Mesh(new THREE.CylinderGeometry(0.55,0.55,0.8,16),hatMat);w.position.set(0,1.55,0);group.add(w);}
  else if(ht==='horn'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.15,16),hatMat);b.position.set(0,1.7,0);group.add(b);for(let s of[-1,1]){const h=new THREE.Mesh(new THREE.ConeGeometry(0.15,0.6,8),hatMat);h.position.set(s*0.5,1.95,0);h.rotation.z=s*0.5;group.add(h);}}
  else if(ht==='antenna'){const c=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.4,0.9),hatMat);c.position.set(0,1.75,0);group.add(c);const a=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.6,8),new THREE.MeshPhongMaterial({color:cs.eyeCol||0x00FF88}));a.position.set(0,2.15,0);group.add(a);const ball=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),new THREE.MeshBasicMaterial({color:cs.eyeCol||0x00FF88}));ball.position.set(0,2.48,0);group.add(ball);}
  else if(ht==='wizard'){const c=new THREE.Mesh(new THREE.ConeGeometry(0.45,1.0,12),hatMat);c.position.set(0,2.0,0);group.add(c);const b=new THREE.Mesh(new THREE.CylinderGeometry(0.7,0.7,0.1,16),hatMat);b.position.set(0,1.55,0);group.add(b);}
  else if(ht==='pirate'){const b=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.35,0.7),hatMat);b.position.set(0,1.7,0);group.add(b);const p=new THREE.Mesh(new THREE.ConeGeometry(0.3,0.5,4),hatMat);p.position.set(0.4,1.95,0);group.add(p);}
  else if(ht==='helm'){const h=new THREE.Mesh(new THREE.SphereGeometry(0.58,16,8,0,TWO_PI,0,PI/1.6),hatMat);h.position.set(0,1.5,0);group.add(h);const v=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.15,0.1),new THREE.MeshPhongMaterial({color:cs.eyeCol||0xCCEEFF,emissive:cs.eyeCol||0xCCEEFF,emissiveIntensity:0.5}));v.position.set(0,1.55,0.52);group.add(v);}
  else if(ht==='alien'){const s2=new THREE.Mesh(new THREE.SphereGeometry(0.65,16,12,0,TWO_PI,0,PI*0.65),hatMat);s2.position.set(0,1.45,0);group.add(s2);for(let s of[-1,1]){const a=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.5,6),hatMat);a.position.set(s*0.35,2.05,0);a.rotation.z=s*0.3;group.add(a);}}
  else if(ht==='crown'){const r=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.3,16),hatMat);r.position.set(0,1.7,0);group.add(r);for(let j=0;j<5;j++){const a=(j/5)*TWO_PI;const sp=new THREE.Mesh(new THREE.ConeGeometry(0.1,0.35,6),hatMat);sp.position.set(Math.cos(a)*0.45,1.98,Math.sin(a)*0.45);group.add(sp);}}
  for(let s of[-1,1]){const leg=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.18,1.0,10),new THREE.MeshPhongMaterial({color:cs.leg}));leg.position.set(s*0.25,-1.1,0);group.add(leg);const boot=new THREE.Mesh(new THREE.BoxGeometry(0.32,0.22,0.55),new THREE.MeshPhongMaterial({color:cs.boot}));boot.position.set(s*0.25,-1.67,0.1);group.add(boot);}
  scene.add(group);return group;
}
function createArmLines(){
  function mkLine(){const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.Float32BufferAttribute([0,0,0,0,0,0],3));const line=new THREE.Line(geo,new THREE.LineBasicMaterial({color:0x888888,transparent:true,opacity:0.7}));scene.add(line);return line;}
  return{left:mkLine(),right:mkLine()};
}
function updateArmLine(line,a,b){const p=line.geometry.attributes.position;p.setXYZ(0,a.x,a.y,a.z);p.setXYZ(1,b.x,b.y,b.z);p.needsUpdate=true;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GAME STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let G=null;

function generateHolds(world){
  const BAND_H=7,numBands=Math.floor(FINISH_Y/BAND_H);let prevX=0;
  for(let b=0;b<numBands;b++){
    const baseY=12+b*BAND_H,stI=Math.min(3,Math.floor(baseY/75));
    const numH=3+Math.floor(Math.random()*3);const cx=clamp(prevX+(Math.random()-0.5)*9,-14,14);prevX=cx;
    for(let h=0;h<numH;h++){
      const x=cx+(Math.random()-0.5)*10,y=baseY+(Math.random()-0.3)*BAND_H*0.9,z=-7+Math.random()*2;
      const type=HOLD_TYPES[Math.floor(Math.random()*HOLD_TYPES.length)];
      G.holds.push(createHold(x,y,z,type,world,stI,Math.random()<stI*0.10));
    }
    if(b>0&&b%8===0&&stI>=1)G.gears.push(createGear((Math.random()-0.5)*30,baseY-3,-8,world,stI));
  }
  for(const y of[70,145,220])G.checkpoints.push(createCheckpoint(y));
}

function startGame(worldIdx=0){
  $('menu').classList.add('hide');$('worldsScreen').classList.remove('show');
  $('deathScreen').classList.remove('show');$('winScreen').classList.remove('show');
  $('hud').classList.add('show');$('strip').classList.add('show');
  if(AC.state==='suspended')AC.resume();
  scene.children.slice().forEach(c=>scene.remove(c));
  while(particles.length)particles.pop();
  const world=WORLDS[worldIdx];
  setupLights();buildStarfield(world);buildWall(world);
  let speedrunStart=null,speedrunWorlds=[];
  if(worldIdx===0){speedrunStart=Date.now();speedrunWorlds=[worldIdx];}
  else if(profile.speedrunStart&&profile.speedrunWorlds){
    speedrunStart=profile.speedrunStart;speedrunWorlds=profile.speedrunWorlds;
    if(speedrunWorlds.length>0&&speedrunWorlds[speedrunWorlds.length-1]===worldIdx-1)speedrunWorlds=speedrunWorlds.concat([worldIdx]);
    else{speedrunStart=null;speedrunWorlds=[];}
  }
  G={phase:'playing',worldIdx,world,
    camYaw:0,camPitch:-0.1,camDist:14,camTargetY:10,camMode:'third',
    fpYaw:0,fpPitch:0.6,mouseX:0,mouseY:0,keys:{},
    body:{pos:V3(0,8,2),vel:V3(),onGround:false},
    left:null,right:null,playerBody:null,armLines:null,
    holds:[],gears:[],checkpoints:[],checkpointIdx:0,respawnPos:V3(0,8,2),
    finishPortal:null,stamina:100,grabs:0,maxHeight:0,
    startTime:Date.now(),screenShake:0,launchCharge:0,launchCharging:false,
    stageIdx:0,dead:false,paused:false,won:false,
    envParticles:[],speedrunStart,speedrunWorlds,sessionCoins:0};
  G.left=createHandObject(true);G.right=createHandObject(false);
  G.playerBody=createPlayerBody();G.armLines=createArmLines();
  G.left.pos.set(-2.5,10,2);G.right.pos.set(2.5,10,2);
  G.left.group.position.copy(G.left.pos);G.right.group.position.copy(G.right.pos);
  G.camTargetY=10;generateHolds(world);G.finishPortal=buildFinishPortal(world);
  applyStageVisuals(world,0);
  renderer.domElement.requestPointerLock();
  requestAnimationFrame(gameLoop);
}

/* ‚îÄ‚îÄ POINTER LOCK ‚îÄ‚îÄ */
document.addEventListener('pointerlockchange',()=>{
  if(document.pointerLockElement===renderer.domElement){$('lockMsg').classList.remove('show');if(G&&G.paused)resumeGame();}
  else if(G&&!G.dead&&!G.won&&!G.paused&&G.phase==='playing'){G.paused=true;$('pauseScreen').classList.add('show');}
});
renderer.domElement.addEventListener('click',()=>{if(G&&!G.dead&&!G.won&&!document.pointerLockElement)renderer.domElement.requestPointerLock();});
document.addEventListener('mousemove',e=>{
  if(!G||G.paused||G.dead||G.won)return;
  if(document.pointerLockElement===renderer.domElement){G.mouseX+=e.movementX||0;G.mouseY+=e.movementY||0;}
});

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
document.addEventListener('keydown',e=>{
  if(!G)return;G.keys[e.key]=true;G.keys[e.code]=true;
  if(e.key==='Shift'){e.preventDefault();tryGrab(G.left);}
  if(e.key==='Enter'){e.preventDefault();tryGrab(G.right);}
  if(e.key==='Escape'&&!G.dead&&!G.won){G.paused?resumeGame():pauseGame();}
  if((e.key==='v'||e.key==='V')&&G.phase==='playing'){G.camMode=G.camMode==='third'?'first':'third';showLabel(G.camMode==='first'?'üëÅ FIRST PERSON':'üé• THIRD PERSON');}
  if((e.key==='g'||e.key==='G')&&G.phase==='playing')recallArms();
});
document.addEventListener('keyup',e=>{
  if(!G)return;G.keys[e.key]=false;G.keys[e.code]=false;
  if(e.key==='Shift')releaseGrab(G.left);
  if(e.key==='Enter')releaseGrab(G.right);
});
function showLabel(txt,dur=2000){$('camModeLabel').textContent=txt;$('camModeLabel').style.opacity='1';clearTimeout(G._ct);G._ct=setTimeout(()=>$('camModeLabel').style.opacity='0',dur);}
function pauseGame(){G.paused=true;document.exitPointerLock();$('pauseScreen').classList.add('show');}
function resumeGame(){G.paused=false;$('pauseScreen').classList.remove('show');renderer.domElement.requestPointerLock();}
function recallArms(){
  for(const hand of[G.left,G.right]){
    if(hand.hooked)continue;let best=null,bs=Infinity;
    for(const h of G.holds){if(h.userData.grabbed)continue;const dx=h.position.x-G.body.pos.x,dy=h.position.y-G.body.pos.y,dz=h.position.z-G.body.pos.z;const d=Math.sqrt(dx*dx+dy*dy+dz*dz);const sc=d-(dy>0?dy*0.4:0);if(d<28&&sc<bs){best=h;bs=sc;}}
    if(best)hand.pos.set(best.position.x,best.position.y,best.position.z+1.5);
    else{hand.pos.z=-5;hand.pos.y=G.body.pos.y+6;}
    hand.vel.set(0,0,0);hand.swingMom.set(0,0,0);
  }
  $('flash').style.opacity=0.2;setTimeout(()=>$('flash').style.opacity=0,100);
  playSFX(440,0.12,'sine',0.15);showLabel('ü™ù ARMS RECALLED',1200);
}
function tryGrab(hand){
  if(hand.hooked||G.stamina<4)return;
  let best=null,bd=GRAB_RADIUS;
  for(const h of G.holds){if(h.userData.grabbed)continue;const d=hand.pos.distanceTo(h.position);if(d<bd){best=h;bd=d;}}
  if(best){hand.hooked=true;hand.hookHold=best;best.userData.grabbed=true;
    best.userData.ring.material.opacity=1.0;hand.group.userData.glow.material.opacity=0.9;
    hand.swingMom.copy(V3().subVectors(best.position,hand.pos).normalize()).multiplyScalar(2.5);
    G.grabs++;playGrab();spawnParticles(hand.pos,best.userData.col,10,0.18);
    $('flash').style.opacity=0.25;setTimeout(()=>$('flash').style.opacity=0,100);
  }else playSlip();
}
function releaseGrab(hand){
  if(!hand.hooked)return;
  if(hand.hookHold){hand.hookHold.userData.grabbed=false;hand.hookHold.userData.ring.material.opacity=0;hand.hookHold=null;}
  hand.hooked=false;hand.group.userData.glow.material.opacity=0;
}
function updateCrowbarSkins(){
  const skin=CROWBAR_SKINS[profile.activeCrowbar]||CROWBAR_SKINS[0];
  if(!skin.rainbow&&!skin.plasma)return;
  const t=Date.now()*0.001;
  for(const hand of[G.left,G.right]){
    if(!hand.group.userData.shaftMat)continue;
    if(skin.rainbow){const hue=(t*0.3+(hand===G.left?0:0.5))%1;hand.group.userData.shaftMat.color.setHSL(hue,1,0.5);hand.group.userData.hookMat.color.setHSL((hue+0.15)%1,1,0.6);}
    if(skin.plasma){const pulse=0.5+Math.sin(t*8)*0.5;hand.group.userData.shaftMat.emissiveIntensity=pulse;hand.group.userData.hookMat.emissiveIntensity=pulse;}
  }
}

/* ‚îÄ‚îÄ PHYSICS ‚îÄ‚îÄ */
function updatePhysics(){
  if(G.won)return;
  const lowGrav=G.stageIdx>=3,grav=lowGrav?GRAVITY*0.35:GRAVITY;
  const lG=G.left.hooked,rG=G.right.hooked;
  if(!lG&&!rG)G.body.vel.y-=grav;
  else if(lG&&rG){G.body.vel.y*=0.88;G.body.vel.x*=0.92;G.body.vel.z*=0.92;}
  else G.body.vel.y-=grav*0.3;
  G.body.vel.multiplyScalar(1-DRAG);G.body.pos.add(G.body.vel);
  for(const hand of[G.left,G.right]){
    if(!hand.hooked)continue;const hPos=hand.hookHold.position;
    const toBody=V3().subVectors(G.body.pos,hPos);const dist=toBody.length();
    if(dist>ARM_LENGTH){const n=toBody.normalize();G.body.pos.copy(hPos).addScaledVector(n,ARM_LENGTH);const vd=G.body.vel.dot(n);if(vd>0)G.body.vel.addScaledVector(n,-vd*1.1);}
  }
  if(G.body.pos.y<0){G.body.pos.y=0;if(G.body.vel.y<-8){G.screenShake=Math.min(1.5,-G.body.vel.y*0.05);playLow();}G.body.vel.y=Math.max(0,G.body.vel.y);G.body.vel.x*=0.8;G.body.vel.z*=0.8;G.body.onGround=true;}else G.body.onGround=false;
  updateHand(G.left,'w','s','a','d',lG,rG,grav);
  updateHand(G.right,'ArrowUp','ArrowDown','ArrowLeft','ArrowRight',rG,lG,grav);
  const draining=lG||rG;
  if(draining){const drain=(lG&&rG)?0.06:0.11;G.stamina=Math.max(0,G.stamina-drain);if(G.stamina===0){if(lG){releaseGrab(G.left);playSlip();}if(rG){releaseGrab(G.right);playSlip();}}}
  else G.stamina=Math.min(100,G.stamina+0.18);
  if(G.body.pos.y<G.respawnPos.y-35){
    G.body.pos.copy(G.respawnPos);G.body.vel.set(0,0,0);G.left.vel.set(0,0,0);G.right.vel.set(0,0,0);
    releaseGrab(G.left);releaseGrab(G.right);G.stamina=Math.max(G.stamina,30);G.screenShake=1.0;
    $('flash').style.opacity=0.4;setTimeout(()=>$('flash').style.opacity=0,200);playSFX(120,0.3,'sawtooth',0.18);return;
  }
  G.maxHeight=Math.max(G.maxHeight,Math.floor(G.body.pos.y));
  const t=Date.now()*0.001;
  for(const h of G.holds){if(!h.userData.moving)continue;const ud=h.userData;const off=Math.sin(t*ud.moveFreq+ud.movePhase)*ud.moveAmp;if(ud.moveAxis==='x')h.position.x=ud.moveBase.x+off;else h.position.y=ud.moveBase.y+off;}
  for(const g of G.gears)g.rotation.z+=g.userData.rotSpeed*g.userData.dir;
  if(G.left.hooked&&G.left.hookHold){updateArmLine(G.armLines.left,G.body.pos,G.left.hookHold.position);G.armLines.left.material.opacity=0.8;}
  else{updateArmLine(G.armLines.left,G.body.pos,G.left.pos);G.armLines.left.material.opacity=0.35;}
  if(G.right.hooked&&G.right.hookHold){updateArmLine(G.armLines.right,G.body.pos,G.right.hookHold.position);G.armLines.right.material.opacity=0.8;}
  else{updateArmLine(G.armLines.right,G.body.pos,G.right.pos);G.armLines.right.material.opacity=0.35;}
  G.playerBody.position.lerp(G.body.pos,0.25);G.playerBody.rotation.y+=(G.body.vel.x*0.3-G.playerBody.rotation.y)*0.1;G.playerBody.rotation.z+=(-G.body.vel.x*0.15-G.playerBody.rotation.z)*0.12;
  const canCharge=G.left.hooked&&G.right.hooked;
  const chargingNow=canCharge&&(G.keys[' ']||G.keys['Space']);
  if(chargingNow){G.launchCharging=true;G.launchCharge=Math.min(100,G.launchCharge+1.0);if(G.launchCharge>5&&Math.random()<0.08)playSFX(200+G.launchCharge*2,0.04,'sawtooth',0.04);}
  else if(G.launchCharging){
    if(G.launchCharge>8){
      const pwr=G.launchCharge/100;G.body.vel.y=1.5+pwr*5;G.body.vel.x*=0.3;
      releaseGrab(G.left);releaseGrab(G.right);G.screenShake=0.3+pwr*1.2;
      spawnParticles(G.body.pos,pwr>0.6?0xFF4444:pwr>0.3?0xFFD000:0x44FF88,Math.floor(6+pwr*14),0.1+pwr*0.2);
      playSFX(300+pwr*400,0.15,'sine',0.15);$('flash').style.opacity=0.08+pwr*0.22;setTimeout(()=>$('flash').style.opacity=0,60+pwr*60);
    }
    G.launchCharge=0;G.launchCharging=false;
  }else{G.launchCharge=Math.max(0,G.launchCharge-4);if(!canCharge)G.launchCharging=false;}
  if(G.launchCharge>2){$('launchGauge').classList.add('show');$('launchFill').style.width=G.launchCharge+'%';}
  else $('launchGauge').classList.remove('show');
  updateEnvParticles();
  for(const cp of G.checkpoints){
    if(cp.userData.triggered)continue;
    if(Math.abs(G.body.pos.y-cp.position.y)<5&&Math.abs(G.body.pos.x-cp.position.x)<6){
      cp.userData.triggered=true;G.respawnPos=V3(0,cp.position.y+3,2);G.checkpointIdx++;
      playCheckpoint();showCPFlash();
    }
  }
  const si=Math.min(3,Math.floor(G.body.pos.y/75));
  if(si!==G.stageIdx){G.stageIdx=si;applyStageVisuals(G.world,si);sunLight.position.y=G.body.pos.y+100;backLight.position.y=G.body.pos.y+80;}
  if(!G.finishPortal.userData.triggered){
    const fp=G.finishPortal.position,dx=G.body.pos.x-fp.x,dy=G.body.pos.y-fp.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const fh=$('finishHint');
    if(dist<28){fh.textContent='üèÜ PORTAL! '+Math.max(0,Math.floor(fp.y-G.body.pos.y))+'m';fh.style.opacity=clamp(1-dist/28,0.1,0.9).toString();}
    else fh.style.opacity='0';
    if(dist<9&&Math.abs(G.body.pos.z-fp.z)<6){G.finishPortal.userData.triggered=true;triggerWin();}
  }
  if(G.finishPortal){const t2=Date.now()*0.001;G.finishPortal.rotation.y=t2*0.4;G.finishPortal.userData.disc.material.opacity=0.3+Math.sin(t2*2)*0.15;G.finishPortal.userData.outer.material.color.setHSL((t2*0.1)%1,1,0.6);}
}

function updateEnvParticles(){
  if(!G.envParticles)return;
  const bp=G.body.pos,ef=G.world.envFx;
  if(ef==='lava'&&Math.random()<0.25)spawnParticles(V3(bp.x+(Math.random()-0.5)*25,bp.y+(Math.random()-0.5)*18,-8+Math.random()*5),0xFF4400,3,0.2);
  if(ef==='storm'&&Math.random()<0.15){const d=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.8,4),new THREE.MeshBasicMaterial({color:0xFFFF00,transparent:true,opacity:0.8}));d.position.set(bp.x+(Math.random()-0.5)*40,bp.y+18+Math.random()*8,bp.z+(Math.random()-0.5)*5);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3(0,-0.9,0)});}
  if(ef==='ocean'&&Math.random()<0.18){const col=Math.random()<0.5?0x00FFCC:0x0088FF;const d=new THREE.Mesh(new THREE.SphereGeometry(0.15+Math.random()*0.2,6,6),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.7}));d.position.set(bp.x+(Math.random()-0.5)*35,bp.y+(Math.random()-0.5)*18,-10+Math.random()*5);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.04,0.05,0)});}
  if(ef==='void'&&Math.random()<0.1){const col=Math.random()<0.5?0xFF00FF:0x00FFFF;const d=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.6}));d.position.set(bp.x+(Math.random()-0.5)*50,bp.y+(Math.random()-0.5)*28,-20+Math.random()*10);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.06,-0.02,0)});}
  if(ef==='crystal'&&Math.random()<0.12){const col=Math.random()<0.5?0x00FFCC:0xFF44CC;const d=new THREE.Mesh(new THREE.OctahedronGeometry(0.2,0),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.7}));d.position.set(bp.x+(Math.random()-0.5)*30,bp.y+(Math.random()-0.5)*18,-8+Math.random()*4);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.05,0.06,0)});}
  if(ef==='quantum'&&Math.random()<0.15){const cols=[0xFF0044,0x00FF88,0xFFFF00,0x00AAFF];const d=new THREE.Mesh(new THREE.SphereGeometry(0.18,4,4),new THREE.MeshBasicMaterial({color:cols[Math.floor(Math.random()*4)],transparent:true,opacity:0.8}));d.position.set(bp.x+(Math.random()-0.5)*40,bp.y+(Math.random()-0.5)*22,-12+Math.random()*8);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.12,(Math.random()-0.5)*0.08,0)});}
  if(ef==='solar'&&Math.random()<0.2)spawnParticles(V3(bp.x+(Math.random()-0.5)*30,bp.y+(Math.random()-0.5)*22,-8+Math.random()*5),0xFFAA00,2,0.18);
  if(ef==='nebula'&&Math.random()<0.08){const col=Math.random()<0.5?0x7B4FFF:0xFF44FF;const d=new THREE.Mesh(new THREE.SphereGeometry(0.25+Math.random()*0.35,5,5),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.5}));d.position.set(bp.x+(Math.random()-0.5)*40,bp.y+(Math.random()-0.5)*20,-15+Math.random()*8);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.04,(Math.random()-0.5)*0.03,0)});}
  if(ef==='comet'&&Math.random()<0.1){const d=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.01,0.8,4),new THREE.MeshBasicMaterial({color:0x88FFFF,transparent:true,opacity:0.7}));d.position.set(bp.x+(Math.random()-0.5)*50,bp.y+20+Math.random()*10,bp.z+(Math.random()-0.5)*5);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3(0.2,-0.3,0)});}
  if(ef==='ruins'&&Math.random()<0.06){const d=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2),new THREE.MeshBasicMaterial({color:0xAACC88,transparent:true,opacity:0.5}));d.position.set(bp.x+(Math.random()-0.5)*30,bp.y+15+Math.random()*8,bp.z+(Math.random()-0.5)*5);scene.add(d);G.envParticles.push({mesh:d,life:1.0,vel:V3((Math.random()-0.5)*0.03,-0.06,0)});}
  for(let i=G.envParticles.length-1;i>=0;i--){const p=G.envParticles[i];p.life-=0.012;p.mesh.position.add(p.vel);p.mesh.material.opacity=p.life*0.8;if(p.life<=0||Math.abs(p.mesh.position.y-bp.y)>40){scene.remove(p.mesh);G.envParticles.splice(i,1);}}
}

function updateHand(hand,ku,kd,kl,kr,isHooked,otherHooked,grav){
  const speed=isHooked?0.12:0.28;
  if(!isHooked){
    if(G.keys[ku])hand.vel.y+=speed;if(G.keys[kd])hand.vel.y-=speed;
    if(G.keys[kl])hand.vel.x-=speed;if(G.keys[kr])hand.vel.x+=speed;
    hand.vel.y-=grav*0.15;hand.vel.multiplyScalar(0.84);hand.pos.add(hand.vel);hand.pos.add(hand.swingMom);hand.swingMom.multiplyScalar(0.93);
    hand.pos.x=clamp(hand.pos.x,-28,28);hand.pos.y=clamp(hand.pos.y,G.body.pos.y-3,G.body.pos.y+22);hand.pos.z=clamp(hand.pos.z,-8,10);
    if(hand.nearHold){const toH=V3().subVectors(hand.nearHold.position,hand.pos);const d=toH.length();if(d<9)hand.pos.addScaledVector(toH.normalize(),(1-d/9)*0.018);}
    else hand.pos.z+=(-6-hand.pos.z)*0.012;
  }else{
    const hp=hand.hookHold.position;hand.pos.lerp(hp,0.3);hand.vel.set(0,0,0);
    if(G.keys[ku])G.body.vel.y+=0.04;if(G.keys[kd])G.body.vel.y-=0.015;
    if(G.keys[kl])G.body.vel.x-=0.03;if(G.keys[kr])G.body.vel.x+=0.03;
  }
  hand.group.position.lerp(hand.pos,0.35);
  if(isHooked&&hand.hookHold){const tgt=hand.hookHold.position.clone().sub(hand.pos).normalize();hand.group.rotation.z=-Math.atan2(tgt.x,tgt.y)*0.5;hand.group.rotation.y=Math.atan2(-tgt.x,tgt.z)*0.3;}
  else{hand.group.rotation.z*=0.9;hand.group.rotation.y*=0.9;}
  hand.group.rotation.x=Math.sin(Date.now()*0.002)*0.05;
  hand.nearHold=null;let nd=GRAB_RADIUS;
  for(const h of G.holds){if(h.userData.grabbed)continue;const d=hand.pos.distanceTo(h.position);if(d<nd){hand.nearHold=h;nd=d;}}
}

function updateCamera(){
  const sens=0.0018,shake=G.screenShake;
  const sx=(Math.random()-0.5)*shake*0.4,sy=(Math.random()-0.5)*shake*0.4;G.screenShake*=0.88;
  if(G.camMode==='first'){
    G.fpYaw-=G.mouseX*sens;G.fpPitch-=G.mouseY*sens;G.fpPitch=clamp(G.fpPitch,-0.1,PI*0.48);G.mouseX=0;G.mouseY=0;
    camera.position.set(G.body.pos.x+sx,G.body.pos.y+2.0+sy,G.body.pos.z+1.5);
    camera.rotation.order='YXZ';camera.rotation.y=G.fpYaw;camera.rotation.x=G.fpPitch;
    if(G.playerBody)G.playerBody.visible=false;
  }else{
    G.camYaw-=G.mouseX*sens;G.camPitch-=G.mouseY*sens;G.camPitch=clamp(G.camPitch,-PI*0.4,PI*0.35);G.mouseX=0;G.mouseY=0;
    G.camTargetY+=(G.body.pos.y-G.camTargetY)*0.08;
    const cy=G.camYaw,cp=G.camPitch,dist=G.camDist;
    camera.position.set(G.body.pos.x+Math.sin(cy)*Math.cos(cp)*dist+sx,G.camTargetY+Math.sin(cp)*dist+2+sy,G.body.pos.z+Math.cos(cy)*Math.cos(cp)*dist);
    camera.rotation.order='YXZ';camera.rotation.y=cy;camera.rotation.x=cp;
    if(G.playerBody)G.playerBody.visible=true;
  }
  sunLight.position.set(20,G.body.pos.y+120,30);backLight.position.set(-25,G.body.pos.y+80,-40);fillLight.position.set(30,G.body.pos.y+50,30);
}

function updateHUD(){
  $('hHeight').textContent=G.maxHeight+'m';$('hCoins').textContent=profile.coins;
  const t=(Date.now()-G.startTime)/1000;
  $('hTime').textContent=`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
  $('stBar').style.width=G.stamina+'%';$('stBar').classList.toggle('low',G.stamina<22);
  $('stageName').textContent=G.world.stages[G.stageIdx].name;$('stageProgress').textContent=`W${G.worldIdx+1}¬∑S${G.stageIdx+1}/4`;
  $('heightFill').style.height=Math.min(100,(G.body.pos.y/FINISH_Y)*100)+'%';
  $('chipL').classList.toggle('show',!!G.left.nearHold&&!G.left.hooked);
  $('chipR').classList.toggle('show',!!G.right.nearHold&&!G.right.hooked);
}

function showCPFlash(){$('cpFlash').style.opacity=1;$('cpMsg').style.opacity=1;setTimeout(()=>{$('cpFlash').style.opacity=0;$('cpMsg').style.opacity=0;},1200);}

/* ‚îÄ‚îÄ WIN (all LB updates happen HERE, deferred from gameplay) ‚îÄ‚îÄ */
async function triggerWin(){
  G.won=true;G.phase='won';document.exitPointerLock();
  $('hud').classList.remove('show');$('strip').classList.remove('show');
  $('launchGauge').classList.remove('show');$('finishHint').style.opacity='0';
  for(let i=0;i<25;i++)setTimeout(()=>spawnParticles(G.body.pos,G.world.finishCol,10,0.3),i*60);
  $('winFlash').style.opacity=1;setTimeout(()=>$('winFlash').style.opacity=0,500);
  playWin();
  const elapsed=(Date.now()-G.startTime)/1000;
  const stars=calcStars(elapsed);const coinsEarned=calcCoins(elapsed,stars);
  profile.coins+=coinsEarned;G.sessionCoins=coinsEarned;
  profile.worldProgress[G.worldIdx]={cleared:true,stars,coins:coinsEarned,time:elapsed};
  let speedrunFinished=false;
  if(G.speedrunStart&&G.speedrunWorlds&&G.speedrunWorlds.length===10&&G.speedrunWorlds[G.speedrunWorlds.length-1]===G.worldIdx){
    const totalTime=(Date.now()-G.speedrunStart)/1000;
    await pushSpeedrunLB(totalTime);speedrunFinished=true;
  }
  profile.speedrunStart=G.speedrunStart;profile.speedrunWorlds=G.speedrunWorlds;
  await saveProfile();
  // ALL leaderboard updates deferred to here (end of round only)
  await pushWorldLB(G.worldIdx,elapsed,stars,coinsEarned);
  await pushCoinsLB();
  await pushSkinsLB();
  const m=Math.floor(elapsed/60),s=Math.floor(elapsed%60).toString().padStart(2,'0');
  $('winWorldName').textContent=G.world.name+' ¬∑ WORLD '+(G.worldIdx+1);
  $('winStars').textContent='‚òÖ'.repeat(stars)+'‚òÜ'.repeat(3-stars);
  $('winCoinsEarned').textContent='+'+coinsEarned+'ü™ô'+(speedrunFinished?' üèÅ SPEEDRUN COMPLETE!':'');
  $('wTime').textContent=`${m}:${s}`;$('wGrabs').textContent=G.grabs;$('wTotalCoins').textContent=profile.coins;
  $('btnNextWorld').style.display=G.worldIdx+1<WORLDS.length?'':'none';
  setTimeout(()=>$('winScreen').classList.add('show'),1000);
}
function nextWorld(){const next=G.worldIdx+1;$('winScreen').classList.remove('show');if(next<WORLDS.length)startGame(next);else showMenu();}

/* ‚îÄ‚îÄ DEATH & RESTART ‚îÄ‚îÄ */
function die(){
  G.dead=true;G.phase='dead';document.exitPointerLock();
  $('hud').classList.remove('show');$('strip').classList.remove('show');$('finishHint').style.opacity='0';
  $('dHeight').textContent=G.maxHeight+'m';
  const t=(Date.now()-G.startTime)/1000;$('dTime').textContent=`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
  $('dGrabs').textContent=G.grabs;$('deathScreen').classList.add('show');
  playFall();G.screenShake=2.5;
}
function restartGame(){
  $('deathScreen').classList.remove('show');$('winScreen').classList.remove('show');
  const wIdx=G?G.worldIdx:0;scene.children.slice().forEach(c=>scene.remove(c));G=null;startGame(wIdx);
}
function respawnAtCheckpoint(){
  G.dead=false;G.phase='playing';G.body.pos.copy(G.respawnPos);G.body.vel.set(0,0,0);
  G.left.pos.copy(G.respawnPos).add(V3(-2.5,2,0));G.right.pos.copy(G.respawnPos).add(V3(2.5,2,0));
  G.left.hooked=false;G.left.hookHold=null;G.right.hooked=false;G.right.hookHold=null;
  G.stamina=100;G.screenShake=0;$('deathScreen').classList.remove('show');
  $('hud').classList.add('show');$('strip').classList.add('show');renderer.domElement.requestPointerLock();
}
function showMenu(){
  $('deathScreen').classList.remove('show');$('winScreen').classList.remove('show');
  $('hud').classList.remove('show');$('strip').classList.remove('show');$('menu').classList.remove('hide');
  $('finishHint').style.opacity='0';
  scene.children.slice().forEach(c=>scene.remove(c));G=null;
  $('menuNameBadge').textContent='üë§ '+profile.name;
  buildStarfield(WORLDS[0]);loadMiniLB();
}

/* ‚îÄ‚îÄ MAIN GAME LOOP ‚îÄ‚îÄ */
let lastTime=0;
function gameLoop(ts=0){
  requestAnimationFrame(gameLoop);
  const dt=Math.min((ts-lastTime)/16.67,3);lastTime=ts;
  if(!G){renderer.render(scene,camera);return;}
  if(G.paused||G.dead||G.won){renderer.render(scene,camera);return;}
  updatePhysics();updateCamera();updateParticles();updateHUD();updateCrowbarSkins();
  const t=Date.now()*0.002;
  for(const h of G.holds){
    if(h.userData.type==='crystal'&&h.userData.mainMesh){h.userData.mainMesh.rotation.y+=0.008;h.userData.mainMesh.rotation.x+=0.004;}
    if(h.userData.mainMesh&&h.userData.mainMesh.material){const pulse=0.4+Math.sin(t+h.position.y*0.1)*0.45;h.userData.mainMesh.material.emissiveIntensity=pulse;}
  }
  renderer.render(scene,camera);
}

/* ‚îÄ‚îÄ MANUAL SAVE ‚îÄ‚îÄ */
async function manualSave(){
  const btn=$('saveBtn');btn.textContent='üíæ SAVING...';btn.classList.add('saving');
  try{
    await saveProfile();
    // Also flush leaderboards
    if(profile.name){await pushCoinsLB();await pushSkinsLB();}
    btn.textContent='‚úì SAVED';btn.classList.remove('saving');btn.style.color='#44FF88';btn.style.borderColor='#44FF88';
    showToast('PROGRESS SAVED ‚úì');
    setTimeout(()=>{btn.textContent='üíæ SAVE';btn.style.color='';btn.style.borderColor='';},2000);
  }catch(e){btn.textContent='‚úó FAILED';btn.classList.remove('saving');btn.style.color='#FF4455';setTimeout(()=>{btn.textContent='üíæ SAVE';btn.style.color='';},2000);}
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
async function init(){
  // Try to restore identity from localStorage first (so name is never lost)
  try{
    const lsData=localStorage.getItem('stickclimb_profile');
    if(lsData){const ls=JSON.parse(lsData);if(ls.deviceId&&!profile.deviceId)Object.assign(profile,ls);}
  }catch(e){}
  await loadProfile();
  // Mirror to localStorage for next-session recall
  try{localStorage.setItem('stickclimb_profile',JSON.stringify(profile));}catch(e){}
  if(!profile.name){openNameModal(false);}
  else{
    $('nameModal').classList.add('hide');
    $('menu').classList.remove('hide');
    $('menuNameBadge').textContent='üë§ '+profile.name;
    $('saveBtn').classList.add('show');
    loadMiniLB();
  }
  buildStarfield(WORLDS[0]);renderer.setClearColor(0x05030A);renderer.render(scene,camera);
  (function menuLoop(){
    if(G)return;requestAnimationFrame(menuLoop);renderer.render(scene,camera);
    scene.children.forEach(c=>{
      if(c.type==='Points')c.rotation.y+=0.00015;
      if(c.isMesh&&c.material&&c.material.map&&c.material.transparent&&c.geometry&&c.geometry.type==='PlaneGeometry'){c.rotation.z+=0.00008;c.material.opacity=0.45+Math.sin(Date.now()*0.0001+c.position.y*0.01)*0.12;}
    });
  })();
}
init();
</script>
</body>
</html>
