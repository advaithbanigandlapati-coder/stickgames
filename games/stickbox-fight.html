<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>StickBox Fight ULTIMATE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Orbitron',sans-serif;background:#000;overflow:hidden;color:#fff;}
canvas{position:fixed;inset:0;}
#c1,#c2{position:fixed;width:32px;height:32px;pointer-events:none;z-index:10001;transform:translate(-50%,-50%);}
.menu{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.97);}
.menu.hide{display:none;}
.panel{background:linear-gradient(135deg,rgba(8,8,24,0.98),rgba(14,10,32,0.98));backdrop-filter:blur(40px);border:1px solid rgba(80,120,255,0.25);border-radius:24px;padding:28px;max-width:1440px;width:96%;max-height:92vh;overflow-y:auto;box-shadow:0 0 80px rgba(65,105,225,0.15),inset 0 1px 0 rgba(255,255,255,0.05);}
.panel::-webkit-scrollbar{width:5px;}.panel::-webkit-scrollbar-track{background:rgba(0,0,0,0.3);}.panel::-webkit-scrollbar-thumb{background:rgba(65,105,225,0.5);border-radius:3px;}
h1{font-size:3rem;text-align:center;margin-bottom:6px;background:linear-gradient(135deg,#4169E1,#a78bfa,#FF1493);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:6px;}
.sub{text-align:center;color:rgba(139,157,195,0.6);margin-bottom:22px;font-size:0.75rem;letter-spacing:3px;font-family:'Rajdhani',sans-serif;}
.sect{font-size:0.65rem;letter-spacing:3px;margin-bottom:8px;text-transform:uppercase;color:#8B9DC3;}
.row{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
.btn{flex:1;min-width:120px;padding:13px 8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:rgba(139,157,195,0.8);font-family:'Orbitron',sans-serif;font-weight:700;font-size:0.7rem;letter-spacing:1.5px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;text-align:center;box-shadow:4px 4px 8px rgba(0,0,0,0.4);}
.btn:hover{border-color:rgba(65,105,225,0.5);background:rgba(65,105,225,0.1);color:#fff;transform:translateY(-2px);}
.btn.on{border-color:rgba(65,105,225,0.7);background:rgba(65,105,225,0.18);color:#fff;box-shadow:0 0 18px rgba(65,105,225,0.3);}
.cbtn{min-width:100px;padding:15px 6px;display:flex;flex-direction:column;align-items:center;gap:4px;}
.cbtn .ci{font-size:1.6rem;}.cbtn .cn{font-size:0.6rem;letter-spacing:1px;}.cbtn .cs{font-size:0.55rem;color:#555;font-family:'Rajdhani',sans-serif;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(82px,1fr));gap:6px;margin:10px 0;}
.ab{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:8px 4px;cursor:pointer;text-align:center;transition:all 0.18s;position:relative;}
.ab:hover{border-color:rgba(255,255,255,0.3);transform:translateY(-2px);}
.ab.sel{border-color:var(--pc,#4169E1);background:rgba(65,105,225,0.12);box-shadow:0 0 14px rgba(65,105,225,0.3);}
.ab.dis{opacity:0.22;pointer-events:none;}
.ab.sp{border-color:rgba(255,215,0,0.5);border-width:2px;}
.ab .ai{font-size:0.9rem;font-weight:900;font-family:'Orbitron',sans-serif;margin-bottom:3px;}
.ab .an{font-size:0.58rem;font-weight:700;letter-spacing:0.5px;font-family:'Rajdhani',sans-serif;text-transform:uppercase;}
.disp{display:flex;gap:6px;flex-wrap:wrap;min-height:34px;padding:7px;background:rgba(0,0,0,0.4);border-radius:9px;border:1px solid rgba(255,255,255,0.05);align-items:center;}
.chip{padding:4px 9px;border-radius:7px;font-size:0.68rem;font-weight:700;font-family:'Rajdhani',sans-serif;background:rgba(65,105,225,0.15);border:1px solid rgba(65,105,225,0.35);}
.chip.p2{background:rgba(255,20,147,0.15);border-color:rgba(255,20,147,0.35);}
.chip.sp{border-color:rgba(255,215,0,0.6);background:rgba(255,215,0,0.08);}
.rand{padding:6px 12px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.3);border-radius:7px;color:#FFD700;font-weight:800;font-size:0.65rem;cursor:pointer;font-family:'Orbitron',sans-serif;transition:all 0.2s;margin-left:auto;}
.rand:hover{background:rgba(255,215,0,0.18);transform:scale(1.05);}
.big{width:100%;padding:14px;background:linear-gradient(135deg,#4169E1,#7c3aed);border:none;border-radius:13px;color:#fff;font-family:'Orbitron',sans-serif;font-size:1rem;font-weight:900;letter-spacing:3px;cursor:pointer;transition:all 0.3s;text-transform:uppercase;box-shadow:0 8px 28px rgba(65,105,225,0.4);margin-top:10px;}
.big:hover{background:linear-gradient(135deg,#7c3aed,#FF1493);transform:scale(1.02);}
/* HUD */
.hud{position:fixed;top:0;left:0;right:0;padding:12px 16px;z-index:50;pointer-events:none;display:flex;justify-content:space-between;align-items:flex-start;}
.hud.hide{display:none!important;}
.hp-panel{background:rgba(0,0,0,0.82);backdrop-filter:blur(20px);border-radius:14px;padding:11px 13px;min-width:255px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 30px rgba(0,0,0,0.7);}
.hp-panel.p1{border-color:rgba(65,105,225,0.4);}
.hp-panel.p2{border-color:rgba(255,20,147,0.4);}
.hn{display:flex;align-items:center;gap:5px;margin-bottom:6px;flex-wrap:wrap;}
.hname{font-size:0.65rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;font-family:'Rajdhani',sans-serif;}
.minirow{display:flex;gap:3px;align-items:center;}
.minidot{width:19px;height:19px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:7px;font-weight:900;font-family:'Orbitron',sans-serif;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.12);}
.minidot.sp{border-color:rgba(255,215,0,0.6);}
.mino{position:absolute;inset:0;background:rgba(0,0,0,0.8);bottom:0;top:auto;border-radius:4px;}
.hpbar{height:11px;background:rgba(0,0,0,0.55);border-radius:6px;overflow:hidden;margin-bottom:7px;border:1px solid rgba(255,255,255,0.05);}
.hpfill{height:100%;border-radius:5px;transition:width 0.2s;}
.hpfill.p1{background:linear-gradient(90deg,#2554c7,#3b82f6,#06b6d4);}
.hpfill.p2{background:linear-gradient(90deg,#be185d,#ec4899,#f97316);}
.abrow{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;}
.ha{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.ha.sp{border-color:rgba(255,215,0,0.45);}
.halbl{position:relative;z-index:2;font-size:0.5rem;font-weight:900;font-family:'Orbitron',sans-serif;text-align:center;}
.cdo{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.88);top:auto;transition:height 0.05s;}
.cdt{position:absolute;font-size:8px;font-weight:800;color:#fff;z-index:3;font-family:'Rajdhani',sans-serif;}
.spbar{height:6px;background:rgba(0,0,0,0.5);border-radius:3px;overflow:hidden;border:1px solid rgba(255,215,0,0.18);}
.spfill{height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24,#fde68a);transition:width 0.15s;box-shadow:0 0 6px rgba(251,191,36,0.6);}
.chud{flex:1;text-align:center;padding-top:2px;}
.rnd{font-size:1.25rem;font-weight:900;letter-spacing:4px;text-shadow:0 4px 14px rgba(0,0,0,0.9);margin-bottom:5px;}
.combo{font-size:2.2rem;font-weight:900;color:#FFD700;text-shadow:0 4px 18px rgba(255,215,0,0.9);}
.hide{display:none!important;}
.statsbar{position:fixed;bottom:12px;right:12px;z-index:51;background:rgba(0,0,0,0.75);padding:8px 12px;border-radius:9px;font-size:0.62rem;border:1px solid rgba(255,255,255,0.08);pointer-events:none;font-family:'Rajdhani',sans-serif;letter-spacing:1px;}
.backbtn{position:fixed;bottom:12px;left:12px;z-index:60;background:rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.12);border-radius:9px;padding:8px 13px;color:#fff;font-weight:800;font-size:0.7rem;cursor:pointer;transition:all 0.25s;font-family:'Orbitron',sans-serif;text-decoration:none;}
.backbtn:hover{border-color:rgba(65,105,225,0.5);transform:translateY(-2px);}
.vig{position:fixed;inset:0;pointer-events:none;z-index:49;background:radial-gradient(circle at center,transparent 40%,rgba(255,0,0,0.35) 100%);opacity:0;transition:opacity 0.3s;}
.vig.on{opacity:1;}
.tip{position:fixed;background:rgba(4,4,16,0.98);border:1px solid rgba(65,105,225,0.4);border-radius:11px;padding:11px;font-size:0.7rem;pointer-events:none;z-index:300;max-width:200px;box-shadow:0 10px 28px rgba(0,0,0,0.9);display:none;}
.tip .tl{font-weight:900;color:#60a5fa;margin-bottom:4px;}.tip .td{color:#777;line-height:1.4;font-family:'Rajdhani',sans-serif;margin-bottom:4px;}.tip .tv{color:#f87171;font-weight:700;font-family:'Rajdhani',sans-serif;}
</style>
</head>
<body>
<div id="c1"></div><div id="c2"></div>
<canvas id="bg"></canvas><canvas id="game"></canvas><canvas id="fx"></canvas>
<div class="vig" id="vig"></div>

<!-- MAIN MENU -->
<div class="menu" id="menu">
<div class="panel">
  <h1>STICKBOX FIGHT</h1>
  <p class="sub">ULTIMATE Â· v3 Â· best music ever (i made it)</p>

  <p class="sect" style="color:#4169E1">GAME MODE</p>
  <div class="row" id="modeSel">
    <div class="btn on" onclick="setMode('vs')">VS PLAYER</div>
    <div class="btn" onclick="setMode('ai')">VS AI</div>
    <div class="btn" onclick="setMode('practice')">PRACTICE</div>
  </div>

  <div id="aiDiv" class="hide">
    <p class="sect" style="color:#a78bfa">AI DIFFICULTY</p>
    <div class="row" id="aiSel">
      <div class="btn" onclick="setDiff('easy')">EASY</div>
      <div class="btn on" onclick="setDiff('medium')">MEDIUM</div>
      <div class="btn" onclick="setDiff('hard')">HARD</div>
    </div>
  </div>

  <p class="sect" style="color:#4169E1">ROUNDS</p>
  <div class="row" id="rndSel">
    <div class="btn" onclick="setRounds(1)">1 ROUND</div>
    <div class="btn on" onclick="setRounds(3)">BEST OF 3</div>
    <div class="btn" onclick="setRounds(5)">BEST OF 5</div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px;">
    <div>
      <p class="sect" style="color:#4169E1">P1 CHARACTER</p>
      <div class="row" id="p1ch" style="flex-wrap:wrap;gap:7px;"></div>
    </div>
    <div id="p2chWrap">
      <p class="sect" style="color:#FF1493">P2 CHARACTER</p>
      <div class="row" id="p2ch" style="flex-wrap:wrap;gap:7px;"></div>
    </div>
  </div>

  <p class="sect" style="color:#FFD700">STAGE</p>
  <div class="row" id="stageDiv" style="flex-wrap:wrap;gap:7px;margin-bottom:16px;"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:14px;">
    <div>
      <div style="display:flex;align-items:center;margin-bottom:7px;">
        <p class="sect" style="color:#4169E1;margin:0">P1 ABILITIES</p>
        <button class="rand" onclick="randomize('p1')">RANDOM</button>
      </div>
      <div class="disp" id="p1disp"></div>
      <div class="grid" id="p1grid"></div>
    </div>
    <div id="p2pick">
      <div style="display:flex;align-items:center;margin-bottom:7px;">
        <p class="sect" style="color:#FF1493;margin:0">P2 ABILITIES</p>
        <button class="rand" onclick="randomize('p2')">RANDOM</button>
      </div>
      <div class="disp" id="p2disp"></div>
      <div class="grid" id="p2grid"></div>
    </div>
  </div>

  <p style="text-align:center;color:rgba(139,157,195,0.45);font-size:0.65rem;margin-bottom:8px;font-family:'Rajdhani',sans-serif;letter-spacing:1.2px;">
    P1: WASD Â· SPACE=PUNCH Â· Q=SUPER Â· 1/2/3=ABILITIES Â· F=SELECT &nbsp;|&nbsp; P2: ARROWS Â· L=PUNCH Â· P=SUPER Â· U/I/O=ABILITIES Â· L=SELECT
  </p>
  <button class="big" onclick="startGame()">âš¡ FIGHT</button>
  <div style="text-align:center;margin-top:12px;font-size:0.62rem;color:#444;font-family:'Rajdhani',sans-serif;letter-spacing:1px;">
    W: <span id="ww" style="color:#4169E1">0</span> &nbsp;|&nbsp; L: <span id="ll" style="color:#FF1493">0</span>
  </div>
</div>
</div>

<!-- WIN MENU -->
<div class="menu hide" id="winMenu">
<div class="panel" style="text-align:center;max-width:440px;">
  <div id="winIco" style="font-size:3.8rem;margin-bottom:10px;"></div>
  <h1 id="winTxt" style="font-size:2rem;margin-bottom:8px;"></h1>
  <p id="winSub" style="color:#8B9DC3;margin-bottom:16px;font-family:'Rajdhani',sans-serif;letter-spacing:2px;font-size:0.8rem;"></p>
  <div id="winStats" style="background:rgba(0,0,0,0.4);padding:14px;border-radius:11px;margin-bottom:18px;font-family:'Rajdhani',sans-serif;font-size:0.82rem;color:#aaa;line-height:1.8;border:1px solid rgba(255,255,255,0.06);"></div>
  <button class="big" onclick="rematch()">REMATCH</button>
</div>
</div>

<!-- HUD -->
<div class="hud hide" id="hud">
  <div class="hp-panel p1">
    <div class="hn">
      <span class="hname" id="n1" style="color:#4169E1">P1</span>
      <div class="minirow" id="mini1"></div>
    </div>
    <div class="hpbar"><div class="hpfill p1" id="hp1" style="width:100%"></div></div>
    <div class="abrow" id="abs1"></div>
    <div class="spbar"><div class="spfill" id="sp1" style="width:0%"></div></div>
  </div>
  <div class="chud">
    <div class="rnd" id="rndTxt">ROUND 1</div>
    <div class="combo hide" id="comboTxt"></div>
  </div>
  <div class="hp-panel p2">
    <div class="hn">
      <span class="hname" id="n2" style="color:#FF1493">P2</span>
      <div class="minirow" id="mini2"></div>
    </div>
    <div class="hpbar"><div class="hpfill p2" id="hp2" style="width:100%"></div></div>
    <div class="abrow" id="abs2"></div>
    <div class="spbar"><div class="spfill" id="sp2" style="width:0%"></div></div>
  </div>
</div>

<div class="statsbar">W: <span id="ws" style="color:#4169E1">0</span> | L: <span id="ls" style="color:#FF1493">0</span> &nbsp;|&nbsp; Combo: <span id="mc" style="color:#FFD700">0</span>X &nbsp;|&nbsp; Dmg: <span id="td" style="color:#f87171">0</span></div>
<a href="../index.html" class="backbtn">â† MENU</a>
<div class="tip" id="tip"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARS=[
  {id:'blue',  name:'SONIC', icon:'ğŸ”µ',col:'#4169E1',hp:100,spd:1.3,dmg:0.9, desc:'Fast & agile'},
  {id:'red',   name:'TITAN', icon:'ğŸ”´',col:'#FF1493',hp:120,spd:0.8,dmg:1.3, desc:'Heavy hitter'},
  {id:'green', name:'VIPER', icon:'ğŸŸ¢',col:'#00ff88',hp:90, spd:1.1,dmg:1.1, desc:'Balanced'},
  {id:'yellow',name:'BLITZ', icon:'ğŸŸ¡',col:'#FFD700',hp:85, spd:1.4,dmg:0.8, desc:'Speed king'},
  {id:'purple',name:'TANK',  icon:'ğŸŸ£',col:'#9370DB',hp:140,spd:0.7,dmg:1.2, desc:'Max HP'},
  {id:'orange',name:'FURY',  icon:'ğŸŸ ',col:'#FF8C00',hp:95, spd:1.0,dmg:1.4, desc:'Max DMG'}
];
const STAGES=[
  {id:'arena', name:'ARENA',    icon:'ğŸŸï¸',hazard:'none',       desc:'Classic',      bg:['#0d0d1a','#2a1a50']},
  {id:'void',  name:'VOID',     icon:'ğŸŒŒ',hazard:'gravity',    desc:'Low gravity',  bg:['#0a0a20','#1a1a40']},
  {id:'lava',  name:'LAVA PIT', icon:'ğŸŒ‹',hazard:'lava',       desc:'Floor damage', bg:['#200a0a','#401a1a']},
  {id:'storm', name:'STORM',    icon:'âš¡',hazard:'lightning',  desc:'Random bolts', bg:['#0a1020','#1a2040']},
  {id:'cyber', name:'CYBER',    icon:'ğŸ™ï¸',hazard:'platforms',  desc:'Moving floor', bg:['#0a2020','#1a4040']}
];
const ABS=[
  // Regular
  {id:'fire',   abbr:'FR',name:'Fire',    dmg:20,cd:90, col:'#ff4444'},
  {id:'ice',    abbr:'IC',name:'Ice',     dmg:15,cd:120,col:'#44ddff'},
  {id:'bomb',   abbr:'BM',name:'Bomb',    dmg:35,cd:150,col:'#ff9900'},
  {id:'bolt',   abbr:'BT',name:'Bolt',    dmg:25,cd:110,col:'#ffff00'},
  {id:'shield', abbr:'SH',name:'Shield',  dmg:0, cd:180,col:'#4488ff'},
  {id:'dash',   abbr:'DS',name:'Dash',    dmg:0, cd:60, col:'#88ff88'},
  {id:'slam',   abbr:'SL',name:'Slam',    dmg:30,cd:130,col:'#ff8844'},
  {id:'heal',   abbr:'HL',name:'Heal',    dmg:0, cd:200,col:'#44ff88'},
  {id:'meteor', abbr:'MT',name:'Meteor',  dmg:40,cd:180,col:'#ff6644'},
  {id:'gravity',abbr:'GV',name:'Vortex',  dmg:0, cd:140,col:'#8844ff'},
  {id:'tele',   abbr:'TL',name:'Blink',   dmg:0, cd:120,col:'#ff44ff'},
  {id:'clone',  abbr:'CL',name:'Decoy',   dmg:0, cd:170,col:'#44ffff'},
  {id:'laser',  abbr:'LZ',name:'Beam',    dmg:18,cd:160,col:'#ff4488'},
  {id:'poison', abbr:'PX',name:'Toxic',   dmg:15,cd:150,col:'#88ff44'},
  {id:'wind',   abbr:'WN',name:'Wind',    dmg:0, cd:140,col:'#44ff44'},
  {id:'rock',   abbr:'RK',name:'Rock',    dmg:35,cd:100,col:'#886644'},
  {id:'chain',  abbr:'CH',name:'Chain',   dmg:0, cd:130,col:'#aaaaaa'},
  {id:'smoke',  abbr:'SK',name:'Smoke',   dmg:0, cd:190,col:'#999999'},
  {id:'spike',  abbr:'SP',name:'Spike',   dmg:30,cd:110,col:'#ff8888'},
  {id:'swap',   abbr:'SW',name:'Swap',    dmg:0, cd:200,col:'#ff88ff'},
  {id:'magnet', abbr:'MG',name:'Magnet',  dmg:0, cd:120,col:'#ff4444'},
  {id:'wave',   abbr:'WV',name:'Wave',    dmg:12,cd:150,col:'#4488ff'},
  {id:'quake',  abbr:'QK',name:'Quake',   dmg:28,cd:140,col:'#aa6633'},
  {id:'mirror', abbr:'MR',name:'Mirror',  dmg:0, cd:170,col:'#ccccff'},
  {id:'speed',  abbr:'ST',name:'Haste',   dmg:0, cd:130,col:'#ffff88'},
  {id:'wall',   abbr:'WL',name:'Wall',    dmg:0, cd:160,col:'#8899aa'},
  {id:'drain',  abbr:'DR',name:'Drain',   dmg:22,cd:180,col:'#aa0000'},
  {id:'curse',  abbr:'CU',name:'Curse',   dmg:0, cd:200,col:'#8800ff'},
  {id:'jump',   abbr:'JP',name:'Leap',    dmg:0, cd:90, col:'#88ffff'},
  {id:'mini',   abbr:'MI',name:'Mini',    dmg:0, cd:140,col:'#ff88cc'},
  // Specials
  {id:'nova',   abbr:'NV',name:'NOVA',    dmg:70,cd:300,col:'#ffaa00',sp:1},
  {id:'time',   abbr:'FZ',name:'FREEZE',  dmg:0, cd:350,col:'#4444ff',sp:1},
  {id:'rage',   abbr:'RG',name:'RAGE',    dmg:0, cd:280,col:'#ff0000',sp:1},
  {id:'ghost',  abbr:'GH',name:'GHOST',   dmg:0, cd:320,col:'#ccccff',sp:1},
  {id:'hole',   abbr:'BH',name:'HOLE',    dmg:0, cd:400,col:'#0000aa',sp:1},
  {id:'god',    abbr:'GD',name:'GOD',     dmg:0, cd:500,col:'#ffdd00',sp:1}
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MENU STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let p1Picks=[],p2Picks=[],p1Char=CHARS[0],p2Char=CHARS[1];
let curStage=STAGES[0],gameMode='vs',diff='medium',maxRounds=3;
let roundWins={p1:0,p2:0};
let stats={wins:0,losses:0,dmg:0,combo:0};
try{if(localStorage.sbStats)stats=JSON.parse(localStorage.sbStats);}catch(e){}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CURSORS (Doc 1 faces)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C1=document.getElementById('c1'),C2=document.getElementById('c2');
C1.innerHTML=`<svg width="32" height="32"><circle cx="16" cy="16" r="14" fill="#4169E1" stroke="#fff" stroke-width="2"/><circle cx="11" cy="13" r="2.5" fill="#fff"/><circle cx="21" cy="13" r="2.5" fill="#fff"/></svg>`;
C2.innerHTML=`<svg width="32" height="32"><circle cx="16" cy="16" r="14" fill="#FF1493" stroke="#fff" stroke-width="2"/><circle cx="11" cy="13" r="2.5" fill="#fff"/><circle cx="21" cy="13" r="2.5" fill="#fff"/></svg>`;
let cpos={p1:{x:window.innerWidth/3,y:window.innerHeight/2},p2:{x:window.innerWidth*2/3,y:window.innerHeight/2}};
const mkeys={};
document.addEventListener('keydown',e=>{mkeys[e.key]=mkeys[e.key.toLowerCase()]=true;});
document.addEventListener('keyup',e=>{mkeys[e.key]=mkeys[e.key.toLowerCase()]=false;});
function updateCursors(){
  const inMenu=!document.getElementById('menu').classList.contains('hide');
  C1.style.display=inMenu?'block':'none';C2.style.display=inMenu?'block':'none';
  if(!inMenu)return;
  const sp=7;
  if(mkeys['w'])cpos.p1.y-=sp;if(mkeys['s'])cpos.p1.y+=sp;
  if(mkeys['a'])cpos.p1.x-=sp;if(mkeys['d'])cpos.p1.x+=sp;
  if(mkeys['ArrowUp'])cpos.p2.y-=sp;if(mkeys['ArrowDown'])cpos.p2.y+=sp;
  if(mkeys['ArrowLeft'])cpos.p2.x-=sp;if(mkeys['ArrowRight'])cpos.p2.x+=sp;
  ['p1','p2'].forEach(p=>{
    cpos[p].x=Math.max(16,Math.min(window.innerWidth-16,cpos[p].x));
    cpos[p].y=Math.max(16,Math.min(window.innerHeight-16,cpos[p].y));
  });
  C1.style.left=cpos.p1.x+'px';C1.style.top=cpos.p1.y+'px';
  C2.style.left=cpos.p2.x+'px';C2.style.top=cpos.p2.y+'px';
}
setInterval(updateCursors,16);
let _lf=false,_ll=false;
setInterval(()=>{
  const f=mkeys['f'],l=mkeys['l'];
  if(f&&!_lf){click4cursor('p1');}if(l&&!_ll){click4cursor('p2');}
  _lf=f;_ll=l;
},16);
function click4cursor(p){
  const c=cpos[p];
  document.querySelectorAll('.btn,.ab,.rand,.cbtn').forEach(el=>{
    const r=el.getBoundingClientRect();
    if(c.x>=r.left&&c.x<=r.right&&c.y>=r.top&&c.y<=r.bottom)el.click();
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BUILD MENU
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMenu(){
  const p1c=document.getElementById('p1ch'),p2c=document.getElementById('p2ch');
  p1c.innerHTML=CHARS.map((c,i)=>`<div class="btn cbtn${i===0?' on':''}" onclick="selChar(${i},'p1')"><div class="ci">${c.icon}</div><div class="cn">${c.name}</div><div class="cs">${c.desc}</div></div>`).join('');
  p2c.innerHTML=CHARS.map((c,i)=>`<div class="btn cbtn${i===1?' on':''}" onclick="selChar(${i},'p2')"><div class="ci">${c.icon}</div><div class="cn">${c.name}</div><div class="cs">${c.desc}</div></div>`).join('');
  document.getElementById('stageDiv').innerHTML=STAGES.map((s,i)=>`<div class="btn cbtn${i===0?' on':''}" onclick="selStage(${i})"><div class="ci">${s.icon}</div><div class="cn">${s.name}</div><div class="cs">${s.desc}</div></div>`).join('');
  ['p1','p2'].forEach(p=>{
    const g=document.getElementById(p+'grid');
    g.innerHTML=ABS.map((a,i)=>`<div class="ab${a.sp?' sp':''}" onclick="toggle('${p}',${i})" onmouseenter="showTip(event,${i})" onmouseleave="hideTip()"><div class="ai" style="color:${a.col};text-shadow:0 0 7px ${a.col}88;">${a.abbr}</div><div class="an">${a.name}</div></div>`).join('');
  });
  updSel();
  document.getElementById('ww').textContent=stats.wins;document.getElementById('ll').textContent=stats.losses;
  document.getElementById('ws').textContent=stats.wins;document.getElementById('ls').textContent=stats.losses;
}
function selChar(i,p){
  document.querySelectorAll(`#${p}ch .cbtn`).forEach((b,j)=>b.classList.toggle('on',j===i));
  if(p==='p1')p1Char=CHARS[i];else p2Char=CHARS[i];
}
function selStage(i){
  document.querySelectorAll('#stageDiv .cbtn').forEach((b,j)=>b.classList.toggle('on',j===i));
  curStage=STAGES[i];
}
function setMode(m){
  gameMode=m;
  const ms=document.getElementById('modeSel').querySelectorAll('.btn');
  ms.forEach((b,i)=>b.classList.toggle('on',i===(m==='vs'?0:m==='ai'?1:2)));
  document.getElementById('aiDiv').classList.toggle('hide',m!=='ai');
  document.getElementById('p2pick').style.display=m==='ai'?'none':'block';
  document.getElementById('p2chWrap').style.display=m==='ai'?'none':'block';
  if(m==='ai')randomize('p2');
}
function setDiff(d){
  diff=d;
  document.querySelectorAll('#aiSel .btn').forEach((b,i)=>b.classList.toggle('on',['easy','medium','hard'][i]===d));
}
function setRounds(r){
  maxRounds=r;
  document.querySelectorAll('#rndSel .btn').forEach((b,i)=>b.classList.toggle('on',[1,3,5][i]===r));
}
function randomize(p){
  const pk=p==='p1'?p1Picks:p2Picks;pk.length=0;
  const sps=ABS.filter(a=>a.sp);pk.push(sps[Math.floor(Math.random()*sps.length)]);
  const reg=ABS.filter(a=>!a.sp);
  while(pk.length<3){const a=reg[Math.floor(Math.random()*reg.length)];if(!pk.includes(a))pk.push(a);}
  updSel();
}
function toggle(p,i){
  const pk=p==='p1'?p1Picks:p2Picks,oth=p==='p1'?p2Picks:p1Picks,a=ABS[i],idx=pk.indexOf(a);
  if(idx>-1)pk.splice(idx,1);
  else if(pk.length<3&&!oth.includes(a)&&!(a.sp&&pk.some(x=>x.sp)))pk.push(a);
  updSel();
}
function updSel(){
  ['p1','p2'].forEach(p=>{
    const pk=p==='p1'?p1Picks:p2Picks,oth=p==='p1'?p2Picks:p1Picks;
    const dp=document.getElementById(p+'disp');
    dp.innerHTML=pk.length?pk.map(a=>`<div class="chip${p==='p2'?' p2':''}${a.sp?' sp':''}" style="color:${a.col}">${a.abbr} ${a.name}</div>`).join(''):'<span style="color:#444;font-size:0.72rem;font-family:Rajdhani,sans-serif">Select 3 abilities...</span>';
    document.querySelectorAll(`#${p}grid .ab`).forEach((b,i)=>{
      const a=ABS[i],sel=pk.includes(a),dis=oth.includes(a)||(a.sp&&pk.some(x=>x.sp)&&!sel)||(pk.length>=3&&!sel);
      b.classList.toggle('sel',sel);b.classList.toggle('dis',dis);
      b.style.setProperty('--pc',p==='p1'?'#4169E1':'#FF1493');
      if(sel)b.style.boxShadow=`0 0 14px ${a.col}66`;else b.style.boxShadow='';
    });
  });
}
function showTip(e,i){
  const a=ABS[i],t=document.getElementById('tip');
  t.innerHTML=`<div class="tl" style="color:${a.col}">${a.abbr} Â· ${a.name}</div><div class="td">${a.sp?'âœ¨ SPECIAL ABILITY':'Standard ability'}</div>${a.dmg?`<div class="tv">DMG: ${a.dmg}</div>`:`<div class="tv">Utility</div>`}<div class="tv" style="color:#60a5fa">CD: ${Math.ceil(a.cd/60)}s</div>`;
  t.style.left=e.clientX+14+'px';t.style.top=e.clientY+14+'px';t.style.display='block';
}
function hideTip(){document.getElementById('tip').style.display='none';}
function startGame(){
  if(p1Picks.length<3)return alert('P1 needs 3 abilities!');
  if(gameMode==='vs'&&p2Picks.length<3)return alert('P2 needs 3 abilities!');
  if(gameMode!=='vs'&&p2Picks.length<3)randomize('p2');
  document.getElementById('menu').classList.add('hide');
  document.getElementById('hud').classList.remove('hide');
  roundWins={p1:0,p2:0};
  initGame();startMusic();loop();
}
function rematch(){
  document.getElementById('winMenu').classList.add('hide');
  document.getElementById('menu').classList.remove('hide');
  document.getElementById('hud').classList.add('hide');
  p1Picks=[];p2Picks=[];buildMenu();stopMusic();G=null;
}
buildMenu();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MUSIC (Doc 1 â€” complete, untouched)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AC=new(window.AudioContext||window.webkitAudioContext)();
let music=null,intensity=1;
function startMusic(){
  if(music)return;
  const bass=AC.createOscillator(),bassG=AC.createGain();
  bass.type='sine';bassG.gain.value=0.04;bass.connect(bassG);bassG.connect(AC.destination);bass.start();
  const lead=AC.createOscillator(),leadG=AC.createGain(),leadF=AC.createBiquadFilter();
  lead.type='triangle';leadF.type='lowpass';leadF.frequency.value=2000;leadG.gain.value=0.025;
  lead.connect(leadF);leadF.connect(leadG);leadG.connect(AC.destination);lead.start();
  const pad=AC.createOscillator(),padG=AC.createGain();
  pad.type='sawtooth';padG.gain.value=0.015;pad.connect(padG);padG.connect(AC.destination);pad.start();
  const ch1=AC.createOscillator(),ch1G=AC.createGain();
  ch1.type='sine';ch1G.gain.value=0.018;ch1.connect(ch1G);ch1G.connect(AC.destination);ch1.start();
  const ch2=AC.createOscillator(),ch2G=AC.createGain();
  ch2.type='sine';ch2G.gain.value=0.018;ch2.connect(ch2G);ch2G.connect(AC.destination);ch2.start();
  music={bass,lead,pad,ch1,ch2,bassG,leadG,padG,ch1G,ch2G};
  const chords=[[262,330,392],[392,494,587],[440,523,659],[349,440,523]];
  const mels=[[523,587,659,784,880,784,659,587],[659,784,880,1047,880,784,659,523],[784,880,1047,880,784,659,587,523],[523,659,784,880,784,659,523,440]];
  let ci=0,mi=0,beat=0,cm=0;
  setInterval(()=>{
    if(!music)return;
    if(beat%32===0)cm=(cm+1)%mels.length;
    if(beat%8===0){const c=chords[ci];bass.frequency.value=c[0]*0.5;ch1.frequency.value=c[1];ch2.frequency.value=c[2];pad.frequency.value=c[0];ci=(ci+1)%chords.length;}
    if(beat%2===0){lead.frequency.value=mels[cm][mi%mels[cm].length]*intensity;mi++;leadG.gain.cancelScheduledValues(AC.currentTime);leadG.gain.setValueAtTime(0.005,AC.currentTime);leadG.gain.linearRampToValueAtTime(0.04*intensity,AC.currentTime+0.05);leadG.gain.linearRampToValueAtTime(0.025*intensity,AC.currentTime+0.4);}
    beat++;
  },400/intensity);
}
function stopMusic(){if(music){try{['bass','lead','pad','ch1','ch2'].forEach(k=>music[k].stop());}catch(e){}music=null;}}
function sfx(f,d=0.08,t='square',v=0.1){
  try{const o=AC.createOscillator(),g=AC.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(AC.destination);o.start();g.gain.exponentialRampToValueAtTime(0.01,AC.currentTime+d);setTimeout(()=>{try{o.stop();}catch(e){}},d*1000+50);}catch(e){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CANVAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BGC=document.getElementById('bg'),bgx=BGC.getContext('2d');
const CV=document.getElementById('game'),ctx=CV.getContext('2d');
const FXC=document.getElementById('fx'),fxx=FXC.getContext('2d');
BGC.width=CV.width=FXC.width=window.innerWidth;
BGC.height=CV.height=FXC.height=window.innerHeight;
const GY=CV.height-100;
let G=null,freeze=0,chrom=0;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARTICLES â€” Doc 2 shaped system
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Particle{
  constructor(x,y,vx,vy,col,life=30,r=5,glow=true,shape='spark'){
    this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.col=col;this.life=life;this.max=life;
    this.r=r;this.glow=glow;this.shape=shape;
    this.ang=Math.random()*Math.PI*2;this.spin=(Math.random()-0.5)*0.3;
  }
  update(){
    this.x+=this.vx;this.y+=this.vy;
    if(this.shape!=='ring'){this.vy+=0.25;this.vx*=0.97;}
    this.ang+=this.spin;this.life--;
  }
  draw(){
    const a=Math.pow(Math.max(0,this.life/this.max),0.5);
    ctx.globalAlpha=a*0.9;
    if(this.glow){ctx.shadowBlur=12;ctx.shadowColor=this.col;}
    ctx.fillStyle=this.col;ctx.strokeStyle=this.col;
    const s=this.shape;
    if(s==='spark'){
      const sr=this.r*(0.4+a*0.6);
      ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.ang);
      ctx.beginPath();ctx.moveTo(0,-sr*1.8);ctx.lineTo(sr*0.5,0);ctx.lineTo(0,sr*1.8);ctx.lineTo(-sr*0.5,0);ctx.closePath();ctx.fill();
      ctx.restore();
    }else if(s==='flame'){
      const fr=this.r*(0.4+a*0.6);
      ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.ang);
      const fg=ctx.createRadialGradient(0,fr*0.3,0,0,0,fr*1.4);
      fg.addColorStop(0,'#fff');fg.addColorStop(0.3,this.col);fg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=fg;ctx.beginPath();ctx.moveTo(0,-fr*2);ctx.bezierCurveTo(fr,0,fr*0.6,fr,0,fr*1.4);ctx.bezierCurveTo(-fr*0.6,fr,-fr,0,0,-fr*2);ctx.closePath();ctx.fill();
      ctx.restore();
    }else if(s==='crystal'){
      const cr=this.r*(0.5+a*0.5);
      ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.ang);
      ctx.beginPath();ctx.moveTo(0,-cr*2);ctx.lineTo(cr*0.7,-cr*0.5);ctx.lineTo(cr*0.5,cr*1.2);ctx.lineTo(-cr*0.5,cr*1.2);ctx.lineTo(-cr*0.7,-cr*0.5);ctx.closePath();ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.moveTo(0,-cr*2);ctx.lineTo(cr*0.7,-cr*0.5);ctx.lineTo(0,-cr*0.2);ctx.closePath();ctx.fill();
      ctx.restore();
    }else if(s==='debris'){
      const dr=this.r*(0.4+a*0.6);
      ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.ang);ctx.fillRect(-dr,-dr*0.7,dr*2,dr*1.4);ctx.restore();
    }else if(s==='cross'){
      const xr=this.r*(0.5+a*0.5);
      ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.ang);
      ctx.fillRect(-xr*0.3,-xr*1.2,xr*0.6,xr*2.4);ctx.fillRect(-xr*1.2,-xr*0.3,xr*2.4,xr*0.6);
      ctx.restore();
    }else if(s==='ring'){
      const prog=1-this.life/this.max,rr=Math.max(0,this.r*prog);
      ctx.globalAlpha=a*0.8;ctx.shadowBlur=18;ctx.shadowColor=this.col;
      ctx.lineWidth=Math.max(0.5,4*(1-prog)+1);ctx.beginPath();ctx.arc(this.x,this.y,rr,0,Math.PI*2);ctx.stroke();
    }else{
      ctx.beginPath();ctx.arc(this.x,this.y,this.r*(0.5+a*0.5),0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SPAWN HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pt(x,y,vx,vy,col,life,r,shape){G.parts.push(new Particle(x,y,vx,vy,col,life,r,true,shape));}
const N=n=>(Math.random()-0.5)*n;
function spawnFx(id,x,y,col,tgt){
  if(!G)return;
  switch(id){
    case'fire':
      for(let i=0;i<40;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*10;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-4,'#ff6600',28+Math.random()*20,4+Math.random()*5,'flame');}
      for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2,s=Math.random()*6;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-2,'#ffcc00',18+Math.random()*12,3,'spark');}
      break;
    case'ice':
      for(let i=0;i<36;i++){const a=i/36*Math.PI*2,s=3+Math.random()*9;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#88ddff',30+Math.random()*15,3+Math.random()*4,'crystal');}
      for(let i=0;i<12;i++){const a=i/12*Math.PI*2,s=8+Math.random()*12;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#fff',25,2,'spark');}
      break;
    case'bomb':
      G.parts.push(new Particle(x,y,0,0,'#ff6600',25,80,false,'ring'));
      for(let i=0;i<80;i++){const a=Math.random()*Math.PI*2,s=4+Math.random()*18;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-4,'#ff6600',30+Math.random()*25,4+Math.random()*7,'spark');}
      for(let i=0;i<40;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*12;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-2,'#ff2200',25+Math.random()*15,3+Math.random()*5,'debris');}
      for(let i=0;i<20;i++)pt(x,y,N(14),N(14)-2,'#333',40,5+Math.random()*8,'debris');
      break;
    case'bolt':
      for(let i=0;i<50;i++){const a=N(Math.PI*2),s=3+Math.random()*14;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ffff44',18+Math.random()*18,3+Math.random()*5,'spark');}
      G.parts.push(new Particle(x,y,0,0,'#ffff00',14,45,false,'ring'));
      break;
    case'meteor':
      for(let i=0;i<60;i++){const a=Math.random()*Math.PI*2,s=3+Math.random()*16;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ff4400',35+Math.random()*25,4+Math.random()*8,'flame');}
      G.parts.push(new Particle(x,y,0,0,'#ff6600',20,60,false,'ring'));
      break;
    case'nova':
      G.parts.push(new Particle(x,y,0,0,'#ffaa00',30,CV.width*0.7,false,'ring'));
      G.parts.push(new Particle(x,y,0,0,'#fff',18,CV.width*0.45,false,'ring'));
      for(let i=0;i<200;i++){const a=Math.random()*Math.PI*2,s=4+Math.random()*25;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ffaa00',60+Math.random()*30,5+Math.random()*10,'spark');}
      break;
    case'laser':
      if(tgt){const dx=tgt.x-x,dy=tgt.y-y,dist=Math.hypot(dx,dy),steps=Math.ceil(dist/12);
        for(let i=0;i<steps;i++){const t=i/steps;pt(x+dx*t+N(8),y+dy*t+N(8),N(3),N(3),'#ff4488',10+Math.random()*12,5+Math.random()*5,'spark');}
      }break;
    case'heal':
      for(let i=0;i<40;i++){const a=Math.random()*Math.PI*2,s=1+Math.random()*7;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-3,'#44ff88',40+Math.random()*30,4+Math.random()*6,'cross');}
      G.parts.push(new Particle(x,y,0,0,'#44ff88',18,35,false,'ring'));
      break;
    case'slam':
      G.parts.push(new Particle(x,GY,0,0,'#ff8844',20,80,false,'ring'));
      for(let i=0;i<80;i++){const a=Math.PI+N(0.8),s=5+Math.random()*18;pt(x,GY,Math.cos(a)*s,Math.sin(a)*s-2,'#ff8844',40+Math.random()*20,4+Math.random()*8,'debris');}
      break;
    case'quake':
      for(let i=0;i<120;i++)pt(Math.random()*CV.width,GY-Math.random()*20,N(8),-Math.random()*15,'#aa6633',40+Math.random()*20,5+Math.random()*8,'debris');
      break;
    case'tele':
      for(let i=0;i<60;i++){const a=Math.random()*Math.PI*2,s=1+Math.random()*10;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ff44ff',30+Math.random()*20,3+Math.random()*5,'spark');}
      G.parts.push(new Particle(x,y,0,0,'#ff44ff',16,40,false,'ring'));
      break;
    case'super':
      G.parts.push(new Particle(x,y,0,0,'#fff',20,CV.width,false,'ring'));
      G.parts.push(new Particle(x,y,0,0,'#ffd700',24,CV.width*0.6,false,'ring'));
      for(let i=0;i<400;i++){const a=Math.random()*Math.PI*2,s=3+Math.random()*30;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,'#ffd700',70+Math.random()*40,5+Math.random()*14,'spark');}
      break;
    case'rage':
      for(let i=0;i<60;i++){const a=Math.random()*Math.PI*2,s=1+Math.random()*9;pt(x,y,Math.cos(a)*s,Math.sin(a)*s-2,'#ff2200',45+Math.random()*30,3+Math.random()*5,'flame');}
      break;
    case'god':
      G.parts.push(new Particle(x,y,0,0,'#ffd700',30,55,false,'ring'));
      for(let i=0;i<80;i++){const a=i/80*Math.PI*2;pt(x,y,Math.cos(a)*22,Math.sin(a)*22,'#ffd700',50+Math.random()*30,4+Math.random()*6,'spark');}
      break;
    default:
      for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*10;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,col||'#aabbff',25+Math.random()*20,3+Math.random()*5,'spark');}
  }
}
function sparks(x,y,col,intense=1){
  const n=Math.round(18*intense);
  for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=3+Math.random()*14*intense;pt(x,y,Math.cos(a)*s,Math.sin(a)*s,col,18+Math.random()*16,3+Math.random()*5,'spark');}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DAMAGE NUMBER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class DmgNum{
  constructor(x,y,dmg,crit=false){this.x=x;this.y=y;this.dmg=dmg;this.life=65;this.vy=-2.2;this.crit=crit;}
  update(){this.y+=this.vy;this.vy+=0.07;this.life--;}
  draw(){
    const a=this.life/65;ctx.globalAlpha=a;
    ctx.font=`${this.crit?'900':'800'} ${this.crit?32:22}px Orbitron`;
    ctx.fillStyle=this.crit?'#FFD700':typeof this.dmg==='number'&&this.dmg>30?'#f87171':'#fff';
    ctx.strokeStyle='#000';ctx.lineWidth=4;ctx.lineJoin='round';ctx.textAlign='center';
    const txt=typeof this.dmg==='number'?Math.ceil(this.dmg):this.dmg;
    ctx.strokeText(txt,this.x,this.y);ctx.fillText(txt,this.x,this.y);ctx.globalAlpha=1;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PROJECTILE â€” Doc 2 styled rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Proj{
  constructor(x,y,vx,vy,ab,owner){
    this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.ab=ab;this.owner=owner;
    this.r=ab.sp?20:ab.dmg>30?15:10;this.col=ab.col;this.hit=false;this.life=300;this.trail=[];this.age=0;
  }
  update(){
    this.age++;
    if(this.life%3===0)this.trail.push({x:this.x,y:this.y,a:1});
    this.trail.forEach(t=>t.a*=0.82);this.trail=this.trail.filter(t=>t.a>0.04);
    this.x+=this.vx;this.y+=this.vy;
    if(this.ab.id==='fire'||this.ab.id==='ice'){
      const tgt=this.owner===G.p1?G.p2:G.p1;
      const dx=tgt.x-this.x,dy=tgt.y-this.y,d=Math.hypot(dx,dy);
      if(d>0){this.vx+=dx/d*0.4;this.vy+=dy/d*0.4;}
    }
    if(this.ab.id==='meteor')this.vy+=0.6;
    this.life--;
    return this.life>0&&this.x>-200&&this.x<CV.width+200&&this.y>-200&&this.y<CV.height+200;
  }
  draw(){
    const c=this.col;
    this.trail.forEach(t=>{
      ctx.globalAlpha=t.a*0.35;ctx.shadowBlur=6;ctx.shadowColor=c;
      const tg=ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,this.r*t.a*0.7);
      tg.addColorStop(0,'rgba(255,255,255,0.4)');tg.addColorStop(1,c+'00');
      ctx.fillStyle=tg;ctx.beginPath();ctx.arc(t.x,t.y,this.r*t.a*0.7,0,Math.PI*2);ctx.fill();
    });
    ctx.globalAlpha=1;ctx.shadowBlur=22;ctx.shadowColor=c;
    const id=this.ab.id,gr=ctx.createRadialGradient(this.x-this.r*0.3,this.y-this.r*0.3,0,this.x,this.y,this.r);
    if(id==='fire'){
      gr.addColorStop(0,'#fff');gr.addColorStop(0.2,'#ffee44');gr.addColorStop(0.6,'#ff4400');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.save();ctx.translate(this.x,this.y-this.r);ctx.rotate(Math.sin(this.age*0.2)*0.4);
      const ff=ctx.createRadialGradient(0,0,0,0,0,this.r*1.2);
      ff.addColorStop(0,'rgba(255,240,80,0.9)');ff.addColorStop(1,c+'00');
      ctx.fillStyle=ff;ctx.beginPath();ctx.ellipse(0,0,this.r*0.8,this.r*1.2,0,0,Math.PI*2);ctx.fill();ctx.restore();
    }else if(id==='ice'){
      gr.addColorStop(0,'#fff');gr.addColorStop(0.3,'#aaeeff');gr.addColorStop(0.7,'#0088cc');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(180,240,255,0.85)';ctx.lineWidth=1.8;
      for(let k=0;k<6;k++){const ang=k/6*Math.PI*2+this.age*0.05;ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(this.x+Math.cos(ang)*this.r*1.5,this.y+Math.sin(ang)*this.r*1.5);ctx.stroke();}
    }else if(id==='bomb'){
      gr.addColorStop(0,'#999');gr.addColorStop(0.4,'#444');gr.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#ffaa00';ctx.lineWidth=2.5;ctx.lineCap='round';ctx.shadowColor='#ffaa00';
      ctx.beginPath();ctx.moveTo(this.x+this.r*0.3,this.y-this.r*0.55);ctx.lineTo(this.x+this.r*0.1,this.y-this.r*1.15);ctx.stroke();
      ctx.fillStyle='#ffff44';ctx.shadowColor='#ffff00';ctx.shadowBlur=10;
      ctx.beginPath();ctx.arc(this.x+this.r*0.1,this.y-this.r*1.15,2.5+Math.sin(this.age*0.6)*1.5,0,Math.PI*2);ctx.fill();
    }else if(id==='bolt'){
      gr.addColorStop(0,'#fff');gr.addColorStop(0.2,'#ffff88');gr.addColorStop(0.6,'#ffcc00');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#ffffaa';ctx.lineWidth=2;
      for(let k=0;k<4;k++){const a=k/4*Math.PI*2+this.age*0.15;ctx.beginPath();ctx.moveTo(this.x+Math.cos(a)*this.r*0.4,this.y+Math.sin(a)*this.r*0.4);ctx.lineTo(this.x+Math.cos(a+0.22)*(this.r+9),this.y+Math.sin(a+0.22)*(this.r+9));ctx.lineTo(this.x+Math.cos(a+0.44)*this.r*0.8,this.y+Math.sin(a+0.44)*this.r*0.8);ctx.stroke();}
    }else if(id==='meteor'){
      gr.addColorStop(0,'#fff');gr.addColorStop(0.25,'#ff9900');gr.addColorStop(0.65,'#cc3300');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=0.3+Math.sin(this.age*0.3)*0.2;ctx.strokeStyle='#ff6600';ctx.lineWidth=4;
      ctx.beginPath();ctx.arc(this.x,this.y,this.r+5+Math.sin(this.age*0.5)*3,0,Math.PI*2);ctx.stroke();
    }else if(id==='rock'){
      gr.addColorStop(0,'#ddbb99');gr.addColorStop(0.45,'#8a6644');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();
      for(let k=0;k<9;k++){const a=k/9*Math.PI*2,r=this.r*(0.65+Math.sin(k*2.7)*0.35);k===0?ctx.moveTo(this.x+Math.cos(a)*r,this.y+Math.sin(a)*r):ctx.lineTo(this.x+Math.cos(a)*r,this.y+Math.sin(a)*r);}
      ctx.closePath();ctx.fill();
    }else if(id==='poison'){
      gr.addColorStop(0,'#ccffaa');gr.addColorStop(0.4,'#44ff44');gr.addColorStop(0.8,'#008800');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      for(let k=0;k<5;k++){const a=k/5*Math.PI*2+this.age*0.09,r=this.r*(0.4+Math.sin(this.age*0.1+k)*0.15);ctx.fillStyle='rgba(80,255,30,0.55)';ctx.beginPath();ctx.arc(this.x+Math.cos(a)*r*1.3,this.y+Math.sin(a)*r*1.3,2.5,0,Math.PI*2);ctx.fill();}
    }else if(id==='wave'){
      gr.addColorStop(0,'#aaddff');gr.addColorStop(0.4,'#2266cc');gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(100,180,255,0.65)';ctx.lineWidth=2.2;
      for(let k=0;k<3;k++){ctx.beginPath();ctx.arc(this.x,this.y,this.r*(0.45+k*0.28)+Math.sin(this.age*0.12+k)*3,0,Math.PI*2);ctx.stroke();}
    }else{
      gr.addColorStop(0,'#fff');gr.addColorStop(0.35,c);gr.addColorStop(1,c+'00');
      ctx.fillStyle=gr;ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=0.5+Math.sin(this.age*0.25)*0.3;
      const dg=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r*0.5);
      dg.addColorStop(0,'rgba(255,255,255,0.9)');dg.addColorStop(1,c+'00');
      ctx.fillStyle=dg;ctx.beginPath();ctx.arc(this.x,this.y,this.r*0.5,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PLAYER â€” Doc 1 character appearance
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Player{
  constructor(x,char,ctrl,abs,isAI){
    this.r=27;this.x=x;this.y=GY-this.r;this.vx=0;this.vy=0;
    this.char=char;this.col=char.col;this.hp=char.hp;this.maxHp=char.hp;
    this.super=0;this.combo=0;this.ctrl=ctrl;this.isAI=isAI;this.aiDiff=diff;
    this.abs=abs.map(a=>({...a,cd:0,maxCd:a.cd}));
    this.ground=true;this.facing=1;this.punch=0;this.inv=0;this.stun=0;
    this.buffs={};this.size=1;this.squash=1;this.canDodge=true;
  }
  fullReset(sx){
    this.x=sx;this.y=GY-this.r;this.vx=0;this.vy=0;
    this.inv=0;this.stun=0;this.punch=0;this.buffs={};this.size=1;this.squash=1;
    this.ground=true;this.hp=this.maxHp;this.abs.forEach(a=>a.cd=0);
  }
  resetCombo(){this.combo=0;}
  update(){
    const MAX=this.buffs.speed?16:12*this.char.spd;
    this.vx=Math.max(-MAX,Math.min(MAX,this.vx));this.vy=Math.max(-25,Math.min(25,this.vy));
    if(this.stun>0){
      this.stun--;this.vx*=0.92;this.vy+=0.6;this.x+=this.vx*0.5;this.y+=this.vy;
      if(this.y>=GY-this.r*this.size){this.y=GY-this.r*this.size;this.vy=0;this.ground=true;this.squash=1.35;}
      this.squash+=(1-this.squash)*0.15;return;
    }
    const acc=(this.buffs.speed?0.9:0.65)*this.char.spd;
    const jp=this.buffs.jump?-22:-16;
    if(this.isAI){
      const opp=this===G.p1?G.p2:G.p1,dist=opp.x-this.x;
      const sp=this.aiDiff==='easy'?0.5:this.aiDiff==='medium'?1:1.5;
      const rx=this.aiDiff==='easy'?0.01:this.aiDiff==='medium'?0.02:0.03;
      const ab=this.aiDiff==='easy'?0.002:this.aiDiff==='medium'?0.004:0.006;
      if(Math.abs(dist)>120){this.vx+=Math.sign(dist)*acc*sp;this.facing=Math.sign(dist);}
      if(Math.abs(dist)<90&&this.punch===0&&Math.random()<rx)this.punch=15;
      if(this.ground&&Math.random()<rx*0.5)this.vy=jp;
      if(this.super>=100&&Math.random()<ab*0.5)this.useSuper();
      this.abs.forEach(a=>{if(a.cd===0&&Math.random()<ab){this.useAb(a);a.cd=a.maxCd;}});
    }else{
      const K=G.keys;
      if(K[this.ctrl.left]){this.vx-=acc;this.facing=-1;}
      if(K[this.ctrl.right]){this.vx+=acc;this.facing=1;}
      if(K[this.ctrl.jump]&&this.ground&&!this._jmp){this.vy=jp;this.ground=false;this.squash=0.7;sfx(380,0.05,'sine',0.08);}
      this._jmp=K[this.ctrl.jump];
      if(K[this.ctrl.punch]&&this.punch===0&&!this._pnch){this.punch=15;sfx(280,0.06,'square',0.1);}
      this._pnch=K[this.ctrl.punch];
      if(K[this.ctrl.super]&&this.super>=100&&!this._sup)this.useSuper();
      this._sup=K[this.ctrl.super];
      this.abs.forEach((a,i)=>{
        const k=this.ctrl['ab'+(i+1)];
        if(K[k]&&a.cd===0&&!this['_ab'+i]){this.useAb(a);a.cd=a.maxCd;sfx(600,0.09,'triangle',0.09);}
        this['_ab'+i]=K[k];
      });
      if((K[this.ctrl.left]||K[this.ctrl.right])&&this.canDodge){
        const opp=this===G.p1?G.p2:G.p1;
        if(Math.hypot(this.x-opp.x,this.y-opp.y)<50&&opp.punch>10){
          this.inv=30;this.vx=this.facing*-15;G.dmgNums.push(new DmgNum(this.x,this.y-50,'DODGE'));
          sfx(800,0.1,'sine',0.12);this.canDodge=false;setTimeout(()=>this.canDodge=true,1000);
        }
      }
    }
    this.vy+=curStage.id==='void'?0.28:0.58;this.vx*=this.ground?0.88:0.96;
    this.x+=this.vx;this.y+=this.vy;
    const fy=GY-this.r*this.size;
    if(this.y>=fy){
      const wasAir=!this.ground,imp=this.vy;
      this.y=fy;this.vy=0;this.ground=true;
      if(wasAir&&imp>5){
        this.squash=1.4;
        for(let i=0;i<6;i++)G.parts.push(new Particle(this.x+N(20),GY,N(4),-Math.random()*3,'#555',15,3,false,'debris'));
        G.parts.push(new Particle(this.x,GY,0,0,this.col,12,this.r*1.5,false,'ring'));
      }
    }else this.ground=false;
    this.x=Math.max(this.r*this.size,Math.min(CV.width-this.r*this.size,this.x));
    if(this.punch>0)this.punch--;
    this.abs.forEach(a=>{if(a.cd>0)a.cd--;});
    if(this.inv>0)this.inv--;
    Object.keys(this.buffs).forEach(k=>{if(this.buffs[k]>0)this.buffs[k]--;else delete this.buffs[k];});
    if(this.buffs.mini)this.size+=(0.5-this.size)*0.1;else this.size+=(1-this.size)*0.1;
    this.squash+=(1-this.squash)*0.15;
    if(this.buffs.poison&&G.roundTime%60===0){
      this.hp=Math.max(0,this.hp-5);
      for(let i=0;i<10;i++)pt(this.x,this.y,N(5),N(5),'#8f4',25,4,'spark');
    }
  }

  // â”€â”€ Doc 2 MOVES â€” meteor fixed (own case), black hole fixed (owner stored) â”€â”€
  useAb(ab){
    const opp=this===G.p1?G.p2:G.p1;
    const dx=opp.x-this.x,dy=opp.y-this.y,dist=Math.hypot(dx,dy);
    const dmgM=(this.buffs.rage?3:1)*this.char.dmg;
    spawnFx(ab.id,this.x,this.y,ab.col,opp);
    switch(ab.id){
      case'fire':case'ice':case'bomb':case'poison':case'rock':case'wave':{
        const spd=ab.id==='rock'?6:ab.id==='bomb'?9:14;
        const ang=Math.atan2(dy,dx);
        G.projs.push(new Proj(this.x+Math.cos(ang)*38,this.y+Math.sin(ang)*38,Math.cos(ang)*spd,Math.sin(ang)*spd,ab,this));
        break;
      }
      // FIXED: meteor in own case â€” avoids variable conflict with above
      case'meteor':{
        const mx=opp.x+(Math.random()-0.5)*100;
        G.projs.push(new Proj(mx,-50,0,3,ab,this));
        break;
      }
      case'bolt':
        if(dist<550){this.hit(opp,ab.dmg*dmgM,true);opp.stun=18;G.shake=20;sparks(opp.x,opp.y,'#ffff44',2);sfx(850,0.18,'sawtooth',0.15);}
        break;
      case'shield':this.buffs.shield=120;this.inv=120;break;
      case'dash':
        this.vx=this.facing*26;
        for(let i=0;i<25;i++)pt(this.x,this.y,N(8),N(8),'#88ff88',28,6,'spark');
        break;
      case'slam':
        if(!this.ground)this.vy=32;
        else{if(dist<250)this.hit(opp,ab.dmg*dmgM);G.shake=30;sfx(140,0.25,'sawtooth',0.18);}
        break;
      case'heal':this.hp=Math.min(this.maxHp,this.hp+25);sfx(650,0.14,'sine',0.12);break;
      case'gravity':case'magnet':
        opp.vx+=(this.x-opp.x)*0.6;opp.vy+=(this.y-opp.y)*0.6;
        for(let i=0;i<30;i++)pt(opp.x,opp.y,N(12),N(12),ab.col,40,7,'spark');
        break;
      case'tele':
        this.x=Math.random()*(CV.width-500)+250;this.y=GY-this.r-100;this.vx=0;this.vy=0;this.inv=60;
        break;
      case'clone':G.decoys.push({x:this.x+this.facing*60,y:this.y,col:this.col,life:180,r:this.r});break;
      case'laser':
        for(let i=0;i<Math.ceil(dist/14);i++){const t=i*14/dist;pt(this.x+dx*t,this.y+dy*t,N(3),N(3),'#ff4488',10,6,'spark');}
        if(dist<600)this.hit(opp,ab.dmg*dmgM);sfx(1200,0.15,'sine',0.1);
        break;
      case'wind':
        if(dist<300){opp.vx+=(opp.x-this.x)/dist*20;opp.vy-=8;for(let i=0;i<40;i++)pt(this.x,this.y,(opp.x-this.x)/dist*12,N(6),'#44ff44',30,5,'spark');}
        break;
      case'chain':if(dist<400){opp.vx+=(this.x-opp.x)*0.7;opp.vy+=(this.y-opp.y)*0.7;opp.stun=30;}break;
      case'smoke':this.buffs.invis=150;break;
      case'spike':G.spikes.push({x:this.x+this.facing*80,y:GY,owner:this,life:300,done:false});break;
      case'swap':{const tx=this.x,ty=this.y;this.x=opp.x;this.y=opp.y;opp.x=tx;opp.y=ty;break;}
      case'quake':G.shake=45;if(dist<350)this.hit(opp,ab.dmg*dmgM);sfx(100,0.3,'sawtooth',0.16);break;
      case'mirror':G.mirrors.push({x:this.x+this.facing*70,y:GY-50,life:180,owner:this});break;
      case'speed':this.buffs.speed=200;break;
      case'wall':G.walls.push({x:this.x+this.facing*90,y:GY-60,w:20,h:120,life:250,owner:this});break;
      case'drain':{if(dist<400){const dd=Math.min(22,opp.hp);opp.hp=Math.max(0,opp.hp-dd);this.hp=Math.min(this.maxHp,this.hp+dd);opp.inv=25;}break;}
      case'curse':opp.buffs.cursed=240;opp.abs.forEach(a=>a.cd=Math.max(a.cd,120));break;
      case'jump':this.buffs.jump=200;break;
      case'mini':opp.buffs.mini=180;break;
      // Specials
      case'nova':G.shake=60;if(dist<CV.width*0.7)this.hit(opp,ab.dmg*dmgM,true);sfx(80,0.5,'sawtooth',0.2);break;
      case'time':opp.buffs.frozen=250;break;
      case'rage':this.buffs.rage=300;break;
      case'ghost':this.buffs.ghost=220;break;
      // FIXED: black hole stores owner â€” only pulls opponent
      case'hole':G.blackHole={x:CV.width/2,y:CV.height/2,life:200,str:1,owner:this};break;
      case'god':this.buffs.god=600;this.inv=600;break;
    }
  }

  useSuper(){
    this.super=0;const opp=this===G.p1?G.p2:G.p1;
    G.shake=80;chrom=30;freeze=15;spawnFx('super',this.x,this.y,'#ffd700',opp);
    this.hit(opp,100,true);opp.stun=80;sfx(50,0.8,'sawtooth',0.25);
    showCombo('SUPER!!!',2000);
  }

  hit(vic,dmg,crit=false){
    if(vic.inv>0||vic.buffs.god||vic.buffs.ghost)return;
    vic.hp=Math.max(0,vic.hp-dmg);vic.inv=32;
    this.super=Math.min(100,this.super+dmg*0.3);this.combo++;stats.dmg+=dmg;
    G.dmgNums.push(new DmgNum(vic.x,vic.y-50,dmg,crit));
    sparks(vic.x,vic.y,vic.col,crit?2:1);
    if(this.combo>1)showCombo(this.combo+'X COMBO!',1000);
    if(this.combo>stats.combo)stats.combo=this.combo;
    document.getElementById('mc').textContent=stats.combo;
    document.getElementById('td').textContent=Math.ceil(stats.dmg);
    freeze=crit?8:4;chrom=crit?15:8;G.shake+=dmg*0.5;sfx(220,0.12,'square',0.14);
  }

  draw(){
    const sz=this.r*this.size;
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.28)';ctx.beginPath();ctx.ellipse(this.x,GY+10,sz*0.8,sz*0.22,0,0,Math.PI*2);ctx.fill();
    if(this.buffs.invis)ctx.globalAlpha=0.25;
    if(this.buffs.ghost&&Math.floor(Date.now()/100)%2===0)ctx.globalAlpha*=0.4;
    if(this.inv>0&&Math.floor(this.inv/8)%2===0)ctx.globalAlpha*=0.55;
    if(this.buffs.god){
      ctx.shadowBlur=40;ctx.shadowColor='#fd0';
      for(let i=0;i<8;i++){const a=Date.now()*0.002+i/8*Math.PI*2;ctx.globalAlpha=0.85;ctx.fillStyle='rgba(255,221,0,0.3)';ctx.beginPath();ctx.arc(this.x+Math.cos(a)*(sz+20),this.y+Math.sin(a)*(sz+20),8,0,Math.PI*2);ctx.fill();}
      ctx.globalAlpha=0.9;
    }
    ctx.shadowBlur=26;ctx.shadowColor=this.buffs.rage?'#f00':this.col;
    ctx.fillStyle=this.buffs.rage?'#f00':this.col;
    ctx.save();ctx.translate(this.x,this.y);ctx.scale(1,this.squash);
    ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.strokeStyle='#fff';ctx.lineWidth=3.5;ctx.beginPath();ctx.arc(0,0,sz,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(-sz*0.3,-sz*0.2,sz*0.18,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(sz*0.3,-sz*0.2,sz*0.18,0,Math.PI*2);ctx.fill();
    ctx.restore();
    ctx.globalAlpha=1;ctx.shadowBlur=0;
    if(this.punch>10){
      const ext=(14-this.punch)*8;
      ctx.strokeStyle='#fff';ctx.lineWidth=12;ctx.lineCap='round';ctx.shadowBlur=10;ctx.shadowColor='#fff';
      ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(this.x+this.facing*ext,this.y);ctx.stroke();
      ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(this.x+this.facing*ext,this.y,14,0,Math.PI*2);ctx.fill();
    }
    if(this.buffs.shield){
      ctx.globalAlpha=0.3+Math.sin(Date.now()*0.012)*0.1;ctx.strokeStyle='#4488ff';ctx.lineWidth=3;ctx.shadowBlur=14;ctx.shadowColor='#4488ff';
      ctx.beginPath();ctx.arc(this.x,this.y,sz*1.35,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;ctx.globalAlpha=1;
    }
    if(this.buffs.frozen){
      ctx.globalAlpha=0.4;ctx.strokeStyle='#88ccff';ctx.lineWidth=4;ctx.shadowBlur=10;ctx.shadowColor='#88ccff';
      ctx.beginPath();ctx.arc(this.x,this.y,sz*1.4,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0;ctx.globalAlpha=1;
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGame(){
  G={
    p1:new Player(CV.width*0.25,p1Char,{left:'a',right:'d',jump:'w',punch:' ',super:'q',ab1:'1',ab2:'2',ab3:'3'},p1Picks,false),
    p2:new Player(CV.width*0.75,p2Char,{left:'ArrowLeft',right:'ArrowRight',jump:'ArrowUp',punch:'l',super:'p',ab1:'u',ab2:'i',ab3:'o'},p2Picks,gameMode==='ai'),
    parts:[],projs:[],dmgNums:[],decoys:[],walls:[],mirrors:[],spikes:[],powerups:[],
    blackHole:null,shake:0,round:1,over:false,roundTime:0,keys:{}
  };
  const kd=e=>{if(G){G.keys[e.key]=true;G.keys[e.key.toLowerCase()]=true;}};
  const ku=e=>{if(G){G.keys[e.key]=false;G.keys[e.key.toLowerCase()]=false;}};
  document.addEventListener('keydown',kd);document.addEventListener('keyup',ku);
  document.getElementById('n1').textContent=p1Char.name;
  document.getElementById('n2').textContent=gameMode==='ai'?'AIÂ·'+p2Char.name:p2Char.name;
  document.getElementById('rndTxt').textContent='ROUND 1';
  buildHudAbs();drawBG();
  setInterval(()=>{if(G&&!G.over)G.powerups.push({x:Math.random()*(CV.width-200)+100,y:GY-50,type:['hp','dmg','spd'][Math.floor(Math.random()*3)],life:600});},15000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HUD ABILITY BUILD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHudAbs(){
  ['p1','p2'].forEach((p,pi)=>{
    const pl=G[p];
    document.getElementById('abs'+(pi+1)).innerHTML=pl.abs.map((a,j)=>`
      <div class="ha${a.sp?' sp':''}" id="${p}ha${j}" style="border-color:${a.col}55;">
        <div class="halbl" style="color:${a.col};text-shadow:0 0 6px ${a.col};">${a.abbr}</div>
        <div class="cdo" id="${p}cd${j}"></div>
        <div class="cdt" id="${p}cdt${j}"></div>
      </div>`).join('');
    document.getElementById('mini'+(pi+1)).innerHTML=pl.abs.map((a,j)=>`
      <div class="minidot${a.sp?' sp':''}" id="${p}mn${j}" style="background:${a.col}22;border-color:${a.col}55;" title="${a.name}">
        <span style="position:relative;z-index:2;color:${a.col};">${a.abbr}</span>
        <div class="mino" id="${p}mno${j}"></div>
      </div>`).join('');
  });
}

function showCombo(txt,dur){
  const el=document.getElementById('comboTxt');
  el.textContent=txt;el.classList.remove('hide');
  clearTimeout(showCombo._t);showCombo._t=setTimeout(()=>el.classList.add('hide'),dur);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BACKGROUND
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBG(){
  const g=bgx.createLinearGradient(0,0,0,BGC.height);
  g.addColorStop(0,curStage.bg[0]);g.addColorStop(1,curStage.bg[1]);
  bgx.fillStyle=g;bgx.fillRect(0,0,BGC.width,BGC.height);
  bgx.globalAlpha=0.07;bgx.fillStyle='rgba(65,105,225,0.2)';
  for(let x=0;x<BGC.width;x+=200)bgx.fillRect(x,BGC.height*0.2,150,8);
  bgx.globalAlpha=1;
  bgx.fillStyle='#2a1a4a';bgx.fillRect(0,GY-20,BGC.width,30);
  bgx.fillStyle='#1f1535';bgx.fillRect(0,GY,BGC.width,25);
  const gr=bgx.createLinearGradient(0,GY+20,0,BGC.height);
  gr.addColorStop(0,'#2d2050');gr.addColorStop(1,'#1a1230');
  bgx.fillStyle=gr;bgx.fillRect(0,GY+20,BGC.width,BGC.height);
  bgx.strokeStyle='rgba(65,105,225,0.6)';bgx.lineWidth=5;bgx.shadowBlur=15;bgx.shadowColor='rgba(65,105,225,0.4)';
  bgx.beginPath();bgx.moveTo(0,GY);bgx.lineTo(BGC.width,GY);bgx.stroke();
  bgx.shadowBlur=0;bgx.strokeStyle='rgba(65,105,225,0.12)';bgx.lineWidth=1.5;
  for(let x=0;x<BGC.width;x+=100){bgx.beginPath();bgx.moveTo(x,GY);bgx.lineTo(x,BGC.height);bgx.stroke();}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MAIN GAME LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop(){
  if(!G){requestAnimationFrame(loop);return;}
  if(freeze>0){freeze--;requestAnimationFrame(loop);return;}
  G.roundTime++;
  ctx.clearRect(0,0,CV.width,CV.height);
  if(G.shake>0){ctx.save();ctx.translate(N(G.shake),N(G.shake));G.shake*=0.88;}

  // Stage hazards
  if(curStage.id==='lava'&&G.roundTime%120===0){
    [G.p1,G.p2].forEach(pl=>{if(pl.y>GY-pl.r-10){pl.hp=Math.max(0,pl.hp-5);for(let i=0;i<10;i++)pt(pl.x,GY,N(5),-Math.random()*8,'#f40',30,6,'flame');}});
  }
  if(curStage.id==='storm'&&G.roundTime%180===0&&Math.random()<0.3){
    const lx=Math.random()*CV.width;
    for(let i=0;i<80;i++)pt(lx,-50+N(20),0,Math.random()*20+10,'#ff4',40,8,'spark');
    [G.p1,G.p2].forEach(pl=>{if(Math.abs(pl.x-lx)<60){pl.hp=Math.max(0,pl.hp-15);pl.stun=20;}});
  }

  // Black hole â€” FIXED: only pulls opponent of owner
  if(G.blackHole){
    const bh=G.blackHole;bh.life--;bh.str+=0.02;
    const victim=bh.owner===G.p1?G.p2:G.p1;
    const bhdx=bh.x-victim.x,bhdy=bh.y-victim.y,bhd=Math.hypot(bhdx,bhdy);
    if(bhd>50){victim.vx+=bhdx/bhd*bh.str;victim.vy+=bhdy/bhd*bh.str;}else victim.hp=Math.max(0,victim.hp-0.5);
    G.projs.forEach(p=>{const dx2=bh.x-p.x,dy2=bh.y-p.y,d2=Math.hypot(dx2,dy2);if(d2>0){p.vx+=dx2/d2*bh.str*0.5;p.vy+=dy2/d2*bh.str*0.5;}});
    for(let i=0;i<5;i++){const a=Math.random()*Math.PI*2,r=Math.random()*200+100;pt(bh.x+Math.cos(a)*r,bh.y+Math.sin(a)*r,-Math.cos(a)*8,-Math.sin(a)*8,'#00f',30,10,'spark');}
    ctx.shadowBlur=50;ctx.shadowColor='#008';ctx.fillStyle='rgba(0,0,80,0.9)';
    ctx.beginPath();ctx.arc(bh.x,bh.y,40+Math.sin(Date.now()*0.01)*10,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    if(bh.life<=0)G.blackHole=null;
  }

  // Walls
  G.walls=G.walls.filter(w=>{
    w.life--;const a=Math.min(1,w.life/30);
    ctx.globalAlpha=a*0.7;ctx.fillStyle='#88a';ctx.shadowBlur=15;ctx.shadowColor='#88a';
    ctx.fillRect(w.x-w.w/2,w.y-w.h/2,w.w,w.h);ctx.shadowBlur=0;ctx.globalAlpha=1;return w.life>0;
  });
  // Mirrors
  G.mirrors=G.mirrors.filter(m=>{
    m.life--;const a=Math.min(1,m.life/30);
    ctx.globalAlpha=a*0.8;ctx.fillStyle='rgba(204,204,255,0.25)';ctx.strokeStyle='#ccf';ctx.lineWidth=4;ctx.shadowBlur=20;ctx.shadowColor='#ccf';
    ctx.fillRect(m.x-30,m.y-60,60,120);ctx.strokeRect(m.x-30,m.y-60,60,120);ctx.shadowBlur=0;ctx.globalAlpha=1;return m.life>0;
  });
  // Spikes
  G.spikes=G.spikes.filter(s=>{
    s.life--;[G.p1,G.p2].forEach(pl=>{if(pl!==s.owner&&!s.done&&Math.abs(pl.x-s.x)<30&&pl.y>GY-pl.r-20){s.done=true;s.owner.hit(pl,30);pl.vy=-12;pl.stun=20;sparks(s.x,s.y,'#f88',1.5);}});
    ctx.fillStyle=s.done?'#f00':'#f88';ctx.shadowBlur=12;ctx.shadowColor='#f88';
    ctx.beginPath();ctx.moveTo(s.x-15,s.y);ctx.lineTo(s.x,s.y-30);ctx.lineTo(s.x+15,s.y);ctx.fill();ctx.shadowBlur=0;
    return s.life>0&&!s.done;
  });
  // Decoys
  G.decoys=G.decoys.filter(d=>{
    d.life--;const a=d.life/180;
    ctx.globalAlpha=a*0.7;ctx.shadowBlur=20;ctx.shadowColor=d.col;ctx.fillStyle=d.col;
    ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(d.x-d.r*0.3,d.y-d.r*0.2,d.r*0.17,0,Math.PI*2);ctx.arc(d.x+d.r*0.3,d.y-d.r*0.2,d.r*0.17,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;return d.life>0;
  });
  // Powerups
  G.powerups=G.powerups.filter(pu=>{
    pu.life--;const fy=pu.y+Math.sin(Date.now()*0.005)*0.5;
    const c=pu.type==='hp'?'#44ff88':pu.type==='dmg'?'#ff4444':'#ffff44';
    const lbl=pu.type==='hp'?'HP':pu.type==='dmg'?'DMG':'SPD';
    ctx.shadowBlur=18;ctx.shadowColor=c;ctx.fillStyle=c;ctx.beginPath();ctx.arc(pu.x,fy,12,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';ctx.font='bold 9px Orbitron';ctx.textAlign='center';ctx.fillText(lbl,pu.x,fy+4);ctx.shadowBlur=0;
    [G.p1,G.p2].forEach(pl=>{if(Math.hypot(pl.x-pu.x,pl.y-pu.y)<40){
      if(pu.type==='hp')pl.hp=Math.min(pl.maxHp,pl.hp+30);
      else if(pu.type==='dmg')pl.buffs.rage=120;else pl.buffs.speed=120;
      pu.life=0;sfx(700,0.1,'sine',0.12);
    }});
    return pu.life>0;
  });

  // Particles
  G.parts=G.parts.filter(p=>{p.update();p.draw();return p.life>0;});
  // Projectiles
  G.projs=G.projs.filter(p=>{
    if(!p.update())return false;
    for(let w of G.walls)if(Math.abs(p.x-w.x)<w.w/2&&Math.abs(p.y-w.y)<w.h/2){spawnFx(p.ab.id,p.x,p.y,p.ab.col);return false;}
    for(let m of G.mirrors)if(Math.abs(p.x-m.x)<35&&Math.abs(p.y-m.y)<65&&!p.reflected){p.vx*=-1.5;p.vy*=-1.5;p.owner=p.owner===G.p1?G.p2:G.p1;p.reflected=true;sfx(700,0.08,'sine',0.1);}
    [G.p1,G.p2].forEach(pl=>{
      if(p.owner===pl||p.hit)return;
      if(Math.hypot(p.x-pl.x,p.y-pl.y)<pl.r*pl.size+p.r){
        p.hit=true;
        if(pl.buffs.shield&&pl.inv>0){p.vx*=-1.8;p.vy*=-1.8;p.owner=pl;p.hit=false;G.shake=12;sfx(750,0.08,'square',0.12);}
        else if(pl.inv===0&&!pl.buffs.god&&!pl.buffs.ghost){
          const dm=p.ab.dmg*p.owner.char.dmg*(p.owner.buffs.rage?3:1);
          p.owner.hit(pl,dm,dm>40);
          if(p.ab.id==='ice')pl.stun=70;
          if(p.ab.id==='poison')pl.buffs.poison=300;
          if(p.ab.id==='rock')pl.stun=40;
          if(p.ab.id==='wave'){pl.vx+=(pl.x-p.owner.x)*0.8;pl.vy=-10;}
          if(p.ab.id==='bomb')spawnFx('bomb',p.x,p.y,'#ff6600');
        }
      }
    });
    p.draw();return !p.hit;
  });

  // Players
  if(!G.over){
    if(!G.p1.buffs.frozen)G.p1.update();
    if(!G.p2.buffs.frozen)G.p2.update();
    [G.p1,G.p2].forEach(att=>{
      const vic=att===G.p1?G.p2:G.p1;
      if(att.punch>10&&att.punch<14){
        if(Math.hypot(att.x-vic.x,att.y-vic.y)<(att.r+vic.r)*1.5+30&&vic.inv===0&&!vic.buffs.god&&!vic.buffs.ghost){
          att.hit(vic,15*att.char.dmg);vic.vx+=(vic.x-att.x)*0.7;vic.vy-=7;vic.stun=10;
        }
      }
    });
  }
  G.p1.draw();G.p2.draw();
  G.dmgNums=G.dmgNums.filter(d=>{d.update();d.draw();return d.life>0;});
  if(G.shake>0)ctx.restore();

  // HUD update
  document.getElementById('hp1').style.width=Math.max(0,G.p1.hp/G.p1.maxHp*100)+'%';
  document.getElementById('hp2').style.width=Math.max(0,G.p2.hp/G.p2.maxHp*100)+'%';
  document.getElementById('sp1').style.width=G.p1.super+'%';
  document.getElementById('sp2').style.width=G.p2.super+'%';
  ['p1','p2'].forEach(p=>{
    G[p].abs.forEach((a,j)=>{
      const pct=a.cd/a.maxCd*100;
      const cd=document.getElementById(p+'cd'+j),cdt=document.getElementById(p+'cdt'+j);
      const mno=document.getElementById(p+'mno'+j),ico=document.getElementById(p+'ha'+j);
      if(cd)cd.style.height=pct+'%';
      if(cdt)cdt.textContent=a.cd>0?Math.ceil(a.cd/60)+'s':'';
      if(mno)mno.style.height=pct+'%';
      if(ico)ico.style.boxShadow=a.cd===0?`0 0 10px ${a.col},0 0 22px ${a.col}66`:'none';
    });
  });

  // Low HP effects
  const lh=Math.min(G.p1.hp/G.p1.maxHp,G.p2.hp/G.p2.maxHp);
  if(lh<0.3){intensity=1.5;document.getElementById('vig').classList.add('on');if(G.roundTime%60===0)sfx(100,0.05,'sine',0.04);}
  else{intensity=1;document.getElementById('vig').classList.remove('on');}

  // Chromatic aberration
  if(chrom>0){
    fxx.clearRect(0,0,FXC.width,FXC.height);fxx.globalCompositeOperation='screen';
    fxx.globalAlpha=chrom/30;fxx.drawImage(CV,chrom*0.5,0);
    fxx.globalAlpha=chrom/30;fxx.drawImage(CV,-chrom*0.5,0);
    fxx.globalCompositeOperation='source-over';chrom--;
  }else fxx.clearRect(0,0,FXC.width,FXC.height);

  // â”€â”€ WIN / ROUND CHECK â€” G.over set IMMEDIATELY to prevent repeat fires â”€â”€
  if(!G.over&&(G.p1.hp<=0||G.p2.hp<=0)){
    G.over=true;
    const winner=G.p1.hp>0?'p1':'p2';
    roundWins[winner]++;
    if(roundWins[winner]>=Math.ceil(maxRounds/2)){
      // Match over
      if(winner==='p1')stats.wins++;else stats.losses++;
      try{localStorage.sbStats=JSON.stringify(stats);}catch(e){}
      setTimeout(()=>{
        document.getElementById('hud').classList.add('hide');
        document.getElementById('winMenu').classList.remove('hide');
        const wc=winner==='p1'?p1Char:p2Char;
        document.getElementById('winIco').textContent=wc.icon;
        document.getElementById('winTxt').textContent=wc.name+' WINS!';
        document.getElementById('winSub').textContent=`${roundWins.p1} â€” ${roundWins.p2} | ${gameMode==='ai'?(winner==='p1'?'AI DEFEATED!':'AI WINS!'):'Great battle!'}`;
        document.getElementById('winStats').innerHTML=`Total Damage: ${Math.ceil(stats.dmg)}<br>Max Combo: ${stats.combo}X<br>W / L: ${stats.wins} / ${stats.losses}`;
        stopMusic();sfx(200,0.3,'sine',0.15);setTimeout(()=>sfx(300,0.4,'sine',0.15),200);setTimeout(()=>sfx(400,0.5,'sine',0.15),400);
      },1200);
    }else{
      // Next round â€” fullReset clears velocity, buffs, stun, cooldowns
      setTimeout(()=>{
        G.round++;document.getElementById('rndTxt').textContent='ROUND '+G.round;
        G.p1.fullReset(CV.width*0.25);G.p2.fullReset(CV.width*0.75);
        G.p1.resetCombo();G.p2.resetCombo();
        G.parts=[];G.projs=[];G.dmgNums=[];G.blackHole=null;
        G.walls=[];G.mirrors=[];G.spikes=[];G.decoys=[];G.powerups=[];
        G.shake=0;G.roundTime=0;G.over=false;
      },1500);
    }
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
