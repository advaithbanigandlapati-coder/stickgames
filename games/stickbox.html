<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StickBox 3.0 — Elemental Arena</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap');
:root{
  --bg0:#010305;--bg1:#030810;--bg2:#060e1a;--bg3:#0a1524;
  --gold:#c8a84b;--gold2:#ffe87a;--gold3:#7a5a1a;
  --silver:#4a6a8a;--dim:#1a2c3e;--border:#0c1c2c;--border2:#142030;
  --text:#bcd0e8;--text2:#2a4a6a;--text3:#14283c;
  --ease:cubic-bezier(0.23,1,0.32,1);--spring:cubic-bezier(0.34,1.56,0.64,1);
}
*{margin:0;padding:0;box-sizing:border-box;outline:none;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg0);
  color:var(--text);font-family:'Rajdhani',sans-serif;user-select:none;}
button,select,input{font-family:'Rajdhani',sans-serif;}
body::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.01) 2px,rgba(0,0,0,.01) 3px);}
body::after{content:'';position:fixed;inset:0;z-index:9997;pointer-events:none;
  background:radial-gradient(ellipse at 50% 50%,transparent 50%,rgba(0,0,0,.75) 100%);}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg0);z-index:99999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity .7s var(--ease);}
#loading.done{opacity:0;pointer-events:none;}
.ld-logo{font-family:'Orbitron',sans-serif;font-size:76px;font-weight:900;
  background:linear-gradient(135deg,#7a5a1a 0%,#c8a84b 30%,#ffe87a 55%,#c8a84b 75%,#5a3a08 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-3px;filter:drop-shadow(0 0 50px rgba(200,168,75,.5));
  animation:lgf 4s ease-in-out infinite;}
@keyframes lgf{0%,100%{filter:drop-shadow(0 0 40px rgba(200,168,75,.4));}
  50%{filter:drop-shadow(0 0 90px rgba(200,168,75,.8));}}
.ld-sub{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:8px;
  color:var(--silver);margin-bottom:50px;margin-top:8px;}
.ld-bar{width:240px;height:1px;background:rgba(200,168,75,.08);margin-bottom:10px;}
.ld-fill{height:100%;background:linear-gradient(90deg,var(--gold3),var(--gold),var(--gold2));width:0;transition:width .3s var(--ease);}
.ld-msg{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;color:var(--text2);}

/* PAGES */
.page{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;opacity:0;pointer-events:none;
  transition:opacity .4s var(--ease),transform .4s var(--ease);transform:translateY(8px);}
.page.active{opacity:1;pointer-events:all;transform:translateY(0);}

/* MENU */
#page-menu{background:radial-gradient(ellipse at 50% 60%,#080e18 0%,var(--bg0) 70%);}
#menu-canvas{position:absolute;inset:0;z-index:0;}
.menu-wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;}
.m-logo{font-family:'Orbitron',sans-serif;font-size:100px;font-weight:900;
  background:linear-gradient(160deg,#6a4a08 0%,#c8a84b 25%,#ffe87a 50%,#c8a84b 75%,#7a5010 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-4px;line-height:1;filter:drop-shadow(0 0 70px rgba(200,168,75,.4));
  animation:lfl 7s ease-in-out infinite;}
@keyframes lfl{0%,100%{transform:translateY(0);}50%{transform:translateY(-9px);}}
.m-ver{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:4px;
  color:rgba(200,168,75,.45);margin-top:5px;margin-bottom:42px;}
.m-nav{display:flex;flex-direction:column;gap:6px;width:290px;}
.mbtn{position:relative;padding:14px 22px;
  background:linear-gradient(135deg,rgba(8,16,28,.97),rgba(2,6,12,.99));
  border:1px solid rgba(200,168,75,.15);border-radius:3px;
  font-size:14px;font-weight:700;letter-spacing:5px;color:var(--text2);
  cursor:pointer;overflow:hidden;transition:all .22s var(--ease);
  text-transform:uppercase;text-align:left;}
.mbtn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:var(--gold);transform:scaleY(0);transition:transform .22s var(--ease);transform-origin:bottom;}
.mbtn:hover::before{transform:scaleY(1);}
.mbtn:hover{border-color:rgba(200,168,75,.55);color:var(--gold);transform:translateX(5px);}
.mbtn.primary{font-size:17px;border-color:rgba(200,168,75,.3);color:var(--text);}
.mbtn-arr{position:absolute;right:18px;top:50%;transform:translateY(-50%);
  opacity:0;transition:all .2s;color:var(--gold);font-size:9px;}
.mbtn:hover .mbtn-arr{opacity:1;right:14px;}
.m-sep{width:160px;height:1px;background:linear-gradient(90deg,transparent,rgba(200,168,75,.18),transparent);margin:12px auto;}
.m-footer{position:absolute;bottom:16px;display:flex;gap:7px;}
.m-util{padding:5px 13px;border:1px solid rgba(200,168,75,.14);border-radius:3px;
  background:rgba(2,6,12,.85);font-size:10px;font-weight:600;letter-spacing:2px;
  color:var(--text2);cursor:pointer;transition:all .2s;}
.m-util:hover{border-color:var(--gold);color:var(--gold);}

/* GAME */
#page-game{flex-direction:column;background:#000;}
#game-canvas{display:block;flex:1;cursor:crosshair;}

/* TOP HUD */
#hud-top{position:fixed;top:0;left:0;right:0;height:44px;z-index:30;pointer-events:all;
  background:linear-gradient(180deg,rgba(1,3,5,.97) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;padding:0 10px;
  border-bottom:1px solid rgba(200,168,75,.05);}
.hbrand{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;
  color:var(--gold);letter-spacing:5px;opacity:.6;}
.hud-btns{display:flex;gap:4px;}
.hbtn{padding:5px 12px;border:1px solid rgba(200,168,75,.16);border-radius:3px;
  background:rgba(2,6,12,.9);font-size:10px;font-weight:700;letter-spacing:2px;
  color:var(--text2);cursor:pointer;transition:all .16s;text-transform:uppercase;}
.hbtn:hover{border-color:var(--gold);color:var(--gold);}
.hbtn.lit{border-color:rgba(200,168,75,.6);color:var(--gold);background:rgba(200,168,75,.07);}
.hbtn.red{border-color:rgba(255,60,60,.25);color:rgba(255,80,80,.6);}
.hbtn.red:hover{border-color:#ff4444;color:#ff4444;}

/* LEFT PANEL - player cards */
#hud-left{position:fixed;left:6px;top:52px;width:178px;z-index:25;pointer-events:all;
  display:flex;flex-direction:column;gap:4px;max-height:calc(100vh - 100px);overflow-y:auto;}
.plcard{background:rgba(2,5,10,.93);border:1px solid var(--border2);border-radius:5px;
  padding:8px 9px;cursor:pointer;transition:all .16s var(--ease);}
.plcard:hover{border-color:var(--silver);}
.plcard.active{border-color:var(--gold);background:rgba(200,168,75,.05);}
.plcard.dead{opacity:.45;border-color:rgba(255,50,50,.2);}
.pc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.pc-name{font-size:12px;font-weight:700;letter-spacing:1px;}
.pc-role-tag{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;
  padding:2px 5px;border-radius:2px;font-weight:700;}
.pc-bars{display:flex;flex-direction:column;gap:2px;}
.pc-brow{display:flex;align-items:center;gap:4px;}
.pc-blbl{font-family:'Share Tech Mono',monospace;font-size:6px;width:7px;color:var(--text3);}
.pc-bbg{flex:1;height:2.5px;background:rgba(255,255,255,.04);border-radius:2px;overflow:hidden;}
.pc-bfg{height:100%;border-radius:2px;transition:width .18s;}
.pc-bval{font-family:'Share Tech Mono',monospace;font-size:6px;color:var(--text2);width:20px;text-align:right;}
.pc-tags{display:flex;gap:2px;margin-top:4px;flex-wrap:wrap;}
.pc-etag{font-family:'Share Tech Mono',monospace;font-size:6px;font-weight:700;
  padding:1px 4px;border-radius:2px;}
.pc-sfx-row{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;}
.pc-sfx{font-family:'Share Tech Mono',monospace;font-size:5.5px;
  padding:1px 3px;border-radius:2px;letter-spacing:.3px;}
.pc-rm{font-size:8px;color:rgba(255,60,60,.4);cursor:pointer;padding:1px 4px;transition:color .15s;}
.pc-rm:hover{color:#ff4444;}

/* ELEMENT BAR - BOTTOM */
#elem-bar{position:fixed;bottom:0;left:0;right:0;height:52px;z-index:30;pointer-events:all;
  background:linear-gradient(0deg,rgba(1,3,5,.98) 70%,transparent 100%);
  border-top:1px solid rgba(200,168,75,.07);
  display:flex;align-items:center;padding:0 8px 3px;gap:2px;
  overflow-x:auto;overflow-y:hidden;}
#elem-bar::-webkit-scrollbar{height:2px;}
.eb-sep{width:1px;height:30px;background:rgba(200,168,75,.09);flex-shrink:0;margin:0 3px;}
.eb-btn{position:relative;flex-shrink:0;width:38px;height:34px;border-radius:5px;
  border:1.5px solid transparent;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
  transition:all .14s var(--ease);}
.eb-btn:hover{transform:translateY(-5px);}
.eb-btn.sel{border-color:rgba(255,255,255,.9)!important;
  box-shadow:0 0 14px rgba(255,255,255,.2),0 -6px 16px rgba(255,255,255,.08);}
.eb-abbr{font-family:'Share Tech Mono',monospace;font-size:7.5px;font-weight:700;pointer-events:none;}
.eb-dot{width:4px;height:4px;border-radius:50%;pointer-events:none;}
.eb-tip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
  font-family:'Share Tech Mono',monospace;font-size:8px;white-space:nowrap;
  background:rgba(2,5,10,.97);border:1px solid var(--border2);
  padding:3px 8px;border-radius:3px;pointer-events:none;opacity:0;transition:opacity .12s;
  z-index:100;color:var(--text);}
.eb-btn:hover .eb-tip{opacity:1;}

/* RIGHT PANEL - controls */
#hud-right{position:fixed;right:6px;top:52px;width:160px;z-index:25;pointer-events:all;}
.ctrl-panel{background:rgba(2,5,10,.9);border:1px solid var(--border2);border-radius:5px;padding:9px 10px;}
.ctrl-hd{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;
  color:var(--gold);margin-bottom:7px;opacity:.7;}
.ctrl-line{font-family:'Share Tech Mono',monospace;font-size:7.5px;color:var(--text2);
  line-height:1.9;letter-spacing:.3px;}
.ctrl-k{color:var(--gold);}

/* OVERLAYS */
#combo-hud{position:fixed;top:58px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',sans-serif;font-size:52px;font-weight:900;color:#fff;
  text-shadow:0 0 40px var(--gold),0 0 80px rgba(200,168,75,.5);
  opacity:0;pointer-events:none;text-align:center;letter-spacing:3px;
  transition:opacity .25s;}
#combo-hud.show{opacity:1;}
#combo-sub{font-family:'Rajdhani',sans-serif;font-size:10px;letter-spacing:6px;
  color:var(--gold);display:block;margin-top:-6px;font-weight:700;}
#slowmo-bar{position:fixed;top:0;left:0;right:0;height:2px;z-index:200;
  background:linear-gradient(90deg,var(--gold3),var(--gold),var(--gold2),var(--gold),var(--gold3));
  opacity:0;transition:opacity .3s;pointer-events:none;}
#slowmo-bar.show{opacity:.85;animation:smpulse 1.5s ease-in-out infinite;}
@keyframes smpulse{0%,100%{opacity:.6;}50%{opacity:1;}}
#cine-flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:9996;}
#dmg-layer{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:35;}
.dmg-num{position:absolute;font-family:'Orbitron',sans-serif;font-weight:900;pointer-events:none;
  animation:dmgup .85s var(--ease) forwards;}
@keyframes dmgup{0%{transform:translateY(0) scale(1.1);opacity:1;}
  60%{transform:translateY(-48px) scale(1.05);opacity:1;}
  100%{transform:translateY(-80px) scale(.75);opacity:0;}}
#notif{position:fixed;bottom:60px;left:50%;
  transform:translateX(-50%) translateY(50px);
  background:rgba(2,5,12,.97);border:1px solid var(--gold);border-radius:4px;
  padding:8px 20px;font-size:12px;font-weight:700;letter-spacing:2px;
  color:var(--gold);z-index:50000;opacity:0;pointer-events:none;
  transition:transform .35s var(--ease),opacity .35s;}
#notif.show{transform:translateX(-50%) translateY(0);opacity:1;}

/* EDITOR PAGE */
#page-editor{flex-direction:row;align-items:stretch;background:#000;}
#ed-left{width:230px;background:rgba(3,7,14,.98);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;}
#ed-main{flex:1;display:flex;flex-direction:column;align-items:center;
  padding:14px;overflow-y:auto;background:var(--bg1);}
#ed-right{width:230px;background:rgba(3,7,14,.98);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;}
.ed-back{padding:10px 12px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;cursor:pointer;transition:background .18s;}
.ed-back:hover{background:rgba(200,168,75,.04);}
.ed-back-arr{color:var(--gold);font-size:12px;}
.ed-back-lbl{font-size:12px;font-weight:700;letter-spacing:3px;color:var(--text2);text-transform:uppercase;}
.ed-sec{padding:12px;border-bottom:1px solid var(--border);}
.ed-shd{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:3px;
  color:var(--gold);margin-bottom:9px;opacity:.8;}
.char-card{padding:8px 10px;border:1px solid var(--border);border-radius:4px;
  cursor:pointer;margin-bottom:4px;display:flex;align-items:center;gap:7px;transition:all .16s;}
.char-card:hover{border-color:var(--silver);}
.char-card.active{border-color:var(--gold);background:rgba(200,168,75,.06);}
.role-card{padding:8px 10px;border:1px solid var(--border);border-radius:4px;
  cursor:pointer;margin-bottom:4px;display:flex;align-items:center;gap:7px;transition:all .16s;}
.role-card:hover{border-color:var(--silver);}
.role-card.sel{border-color:var(--gold);background:rgba(200,168,75,.06);}
.role-abbr-box{font-family:'Share Tech Mono',monospace;font-size:9px;font-weight:700;
  width:28px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.role-info-name{font-size:12px;font-weight:700;letter-spacing:1px;}
.role-info-desc{font-size:9px;color:var(--text2);}
.srow{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.slbl{font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text2);width:28px;}
.sslider{flex:1;-webkit-appearance:none;height:2px;border-radius:1px;
  background:var(--border2);outline:none;cursor:pointer;}
.sslider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;
  border-radius:50%;background:var(--gold);cursor:pointer;
  box-shadow:0 0 6px rgba(200,168,75,.6);}
.sval{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--gold);width:24px;text-align:right;}
.attr-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px;}
.attr-btn{padding:5px 3px;border:1px solid var(--border);border-radius:3px;cursor:pointer;
  text-align:center;font-family:'Share Tech Mono',monospace;font-size:8px;font-weight:700;
  transition:all .16s;letter-spacing:.3px;}
.attr-btn:hover{border-color:var(--silver);}
.attr-btn.on{border-color:currentColor!important;
  box-shadow:0 0 10px currentColor,inset 0 0 6px rgba(255,255,255,.04);}
.spec-row{display:flex;gap:4px;margin-bottom:4px;align-items:center;}
.spec-lbl{font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text2);flex:1;}
.togbtn{padding:4px 10px;border:1px solid var(--border);border-radius:3px;
  font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;
  transition:all .16s;color:var(--text2);background:transparent;text-transform:uppercase;}
.togbtn:hover{border-color:var(--silver);}
.togbtn.on{border-color:var(--gold);color:var(--gold);background:rgba(200,168,75,.08);}
.kb-row{display:flex;gap:4px;}
.kbbtn{flex:1;padding:6px;border:1px solid var(--border);border-radius:3px;
  font-size:9px;font-weight:700;letter-spacing:1px;cursor:pointer;
  transition:all .16s;color:var(--text2);background:transparent;text-transform:uppercase;text-align:center;}
.kbbtn:hover{border-color:var(--silver);}
.kbbtn.on{border-color:var(--gold);color:var(--gold);}
.aura-prev{width:68px;height:68px;border-radius:50%;margin:6px auto;
  display:flex;align-items:center;justify-content:center;
  font-family:'Share Tech Mono',monospace;font-size:13px;font-weight:700;transition:all .3s;}
.aura-lbl{text-align:center;font-family:'Share Tech Mono',monospace;font-size:8px;
  color:var(--text2);letter-spacing:1px;margin-top:4px;}
.ab-card{padding:7px 9px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;}
.ab-type{font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;margin-bottom:2px;}
.ab-name{font-size:11px;font-weight:700;letter-spacing:1px;}
.ab-desc{font-size:9px;color:var(--text2);line-height:1.4;margin-top:2px;}
#ed-preview{border:1px solid var(--border);border-radius:5px;display:block;
  margin:0 auto 12px;background:var(--bg0);}
.skin-tools{display:flex;gap:4px;margin-bottom:7px;flex-wrap:wrap;justify-content:center;}
.sk-tool{padding:5px 11px;border:1px solid var(--border);border-radius:3px;
  font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text2);
  cursor:pointer;transition:all .16s;text-transform:uppercase;}
.sk-tool:hover,.sk-tool.on{border-color:var(--gold);color:var(--gold);}
.skin-pal{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin-bottom:7px;}
.sk-col{width:22px;height:22px;border-radius:4px;border:2px solid transparent;
  cursor:pointer;transition:all .16s;}
.sk-col:hover{transform:scale(1.2);}
.sk-col.on{border-color:#fff;}
#skin-canvas{border:1px solid var(--border);border-radius:4px;cursor:crosshair;
  display:block;margin:0 auto 8px;image-rendering:pixelated;}
.ed-action-row{display:flex;gap:5px;justify-content:center;margin-top:4px;}
.ed-act{padding:5px 12px;border:1px solid var(--border);border-radius:3px;
  font-size:10px;font-weight:700;letter-spacing:2px;cursor:pointer;
  transition:all .16s;color:var(--text2);background:transparent;text-transform:uppercase;}
.ed-act:hover{border-color:var(--silver);color:var(--text);}
.ed-act.gold{border-color:var(--gold);color:var(--gold);background:rgba(200,168,75,.07);}
.ed-newchar{width:100%;margin-top:5px;padding:7px;border:1px dashed var(--border);
  border-radius:3px;background:transparent;color:var(--text2);
  font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
.ed-newchar:hover{border-color:var(--silver);color:var(--text);}

/* CHANGELOG */
#page-changelog{background:var(--bg0);padding:20px;overflow-y:auto;justify-content:flex-start;}
.cl-wrap{max-width:680px;width:100%;margin:0 auto;padding:20px 0;}
.cl-title{font-family:'Orbitron',sans-serif;font-size:30px;font-weight:900;
  color:var(--gold);letter-spacing:4px;margin-bottom:8px;text-align:center;}
.cl-sub{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:4px;
  color:var(--silver);text-align:center;margin-bottom:30px;}
.cl-back{display:inline-flex;align-items:center;gap:8px;padding:7px 16px;
  border:1px solid var(--border);border-radius:3px;color:var(--text2);
  font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;
  transition:all .2s;margin-bottom:24px;text-transform:uppercase;}
.cl-back:hover{border-color:var(--gold);color:var(--gold);}
.cl-entry{margin-bottom:18px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.cl-hd{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.cl-ver{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;color:var(--gold);}
.cl-date{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--silver);}
.cl-badge{margin-left:auto;padding:2px 8px;border-radius:2px;
  font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;}
.cl-badge.new{background:rgba(200,168,75,.15);border:1px solid var(--gold);color:var(--gold);}
.cl-items{padding:12px 16px;display:flex;flex-direction:column;gap:6px;}
.cl-item{display:flex;align-items:flex-start;gap:9px;}
.cl-dot{width:4px;height:4px;border-radius:50%;flex-shrink:0;margin-top:7px;}
.cl-dot.f{background:var(--gold);}
.cl-dot.x{background:#4af;}
.cl-dot.c{background:#f84;}
.cl-txt{font-size:12px;line-height:1.5;}
.cl-tag{font-family:'Share Tech Mono',monospace;font-size:7px;padding:1px 5px;
  border-radius:2px;margin-right:4px;vertical-align:middle;}
.cl-tag.f{background:rgba(200,168,75,.14);color:var(--gold);}
.cl-tag.x{background:rgba(68,170,255,.14);color:#4af;}
.cl-tag.c{background:rgba(255,136,68,.14);color:#f84;}

.gtt{position:fixed;background:rgba(2,5,12,.97);border:1px solid var(--border);
  border-radius:3px;padding:4px 9px;font-family:'Share Tech Mono',monospace;font-size:8px;
  color:var(--text2);pointer-events:none;z-index:50000;opacity:0;transition:opacity .12s;
  max-width:180px;line-height:1.5;}
.gtt.show{opacity:1;}
</style>
</head>
<body>
<div id="loading">
  <div class="ld-logo">StickBox</div>
  <div class="ld-sub">ELEMENTAL ARENA 3.0</div>
  <div class="ld-bar"><div class="ld-fill" id="ld-fill"></div></div>
  <div class="ld-msg" id="ld-msg">INITIALIZING...</div>
</div>
<div id="notif"></div>
<div class="gtt" id="gtt"></div>
<audio id="bgm" loop></audio>

<!-- MENU -->
<div class="page active" id="page-menu">
  <canvas id="menu-canvas"></canvas>
  <div class="menu-wrap">
    <div class="m-logo">StickBox</div>
    <div class="m-ver">VERSION 3.0 · ELEMENTAL ARENA</div>
    <nav class="m-nav">
      <button class="mbtn primary" onclick="showPage('game')">PLAY<span class="mbtn-arr">▶</span></button>
      <button class="mbtn" onclick="showPage('editor')">EDITOR<span class="mbtn-arr">▶</span></button>
      <button class="mbtn" onclick="showPage('changelog')">CHANGELOG<span class="mbtn-arr">▶</span></button>
    </nav>
    <div class="m-sep"></div>
  </div>
  <div class="m-footer">
    <button class="m-util" id="bgm-btn" onclick="toggleBGM()">♪ MUSIC</button>
    <input type="file" id="bgm-file" accept=".mp3,.wav,.ogg" style="display:none" onchange="loadBGM(event)">
    <button class="m-util" onclick="document.getElementById('bgm-file').click()">LOAD BGM</button>
  </div>
</div>

<!-- GAME -->
<div class="page" id="page-game">
  <canvas id="game-canvas"></canvas>
  <div id="hud-top">
    <div class="hbrand">STICKBOX</div>
    <div class="hud-btns">
      <button class="hbtn" onclick="spawnPlayer()">+ SPAWN</button>
      <button class="hbtn" onclick="openEditorFromGame()">EDITOR</button>
      <button class="hbtn" id="btn-slowmo" onclick="toggleSlowmo()">SLOWMO</button>
      <button class="hbtn" id="btn-ai" onclick="toggleAI()">AI BOTS</button>
      <button class="hbtn red" onclick="clearAll()">CLEAR</button>
      <button class="hbtn" onclick="showPage('menu')">MENU</button>
    </div>
    <div style="width:80px;"></div>
  </div>
  <div id="hud-left"></div>
  <div id="hud-right">
    <div class="ctrl-panel">
      <div class="ctrl-hd">CONTROLS</div>
      <div class="ctrl-line"><span class="ctrl-k">WASD</span> · MOVE / JUMP</div>
      <div class="ctrl-line"><span class="ctrl-k">Q</span> · LIGHT ATTACK</div>
      <div class="ctrl-line"><span class="ctrl-k">E</span> · HEAVY ATTACK</div>
      <div class="ctrl-line"><span class="ctrl-k">R/T</span> · ABILITIES</div>
      <div class="ctrl-line"><span class="ctrl-k">F</span> · ULTIMATE</div>
      <div class="ctrl-line"><span class="ctrl-k">SHIFT</span> · BLOCK</div>
      <div class="ctrl-line"><span class="ctrl-k">V</span> · DASH</div>
      <div class="ctrl-line"><span class="ctrl-k">G</span> · GRAVITY WELL</div>
      <div class="ctrl-line"><span class="ctrl-k">1–4</span> · FIRE MOVE</div>
      <div class="ctrl-line"><span class="ctrl-k">TAB</span> · CYCLE ELEM</div>
      <div class="ctrl-line"><span class="ctrl-k">X</span> · RESPAWN</div>
      <div class="ctrl-line"><span class="ctrl-k">CLICK</span> · PLACE ELEM</div>
      <div class="ctrl-line"><span class="ctrl-k">RCLICK</span> · SELECT</div>
    </div>
  </div>
  <div id="elem-bar"></div>
  <div id="combo-hud"><span id="combo-sub">COMBO</span><span id="combo-num">0</span>×</div>
  <div id="slowmo-bar"></div>
  <div id="cine-flash"></div>
  <div id="dmg-layer"></div>
</div>

<!-- EDITOR -->
<div class="page" id="page-editor">
  <div id="ed-left">
    <div class="ed-back" onclick="showPage('menu')">
      <span class="ed-back-arr">◂</span><span class="ed-back-lbl">Back</span></div>
    <div class="ed-sec">
      <div class="ed-shd">CHARACTERS</div>
      <div id="ed-char-list"></div>
      <button class="ed-newchar" onclick="edNewChar()">+ NEW CHARACTER</button>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">ROLE</div>
      <div id="role-list"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">BASE STATS</div>
      <div class="srow"><div class="slbl">HP</div><input type="range" class="sslider" id="sl-hp" min="20" max="260" value="100" oninput="edStat('hp',+this.value)"><div class="sval" id="sv-hp">100</div></div>
      <div class="srow"><div class="slbl">ATK</div><input type="range" class="sslider" id="sl-atk" min="1" max="65" value="15" oninput="edStat('atk',+this.value)"><div class="sval" id="sv-atk">15</div></div>
      <div class="srow"><div class="slbl">DEF</div><input type="range" class="sslider" id="sl-def" min="0" max="55" value="5" oninput="edStat('def',+this.value)"><div class="sval" id="sv-def">5</div></div>
      <div class="srow"><div class="slbl">SPD</div><input type="range" class="sslider" id="sl-spd" min="1" max="13" value="4" oninput="edStat('spd',+this.value)"><div class="sval" id="sv-spd">4</div></div>
      <div class="srow"><div class="slbl">STA</div><input type="range" class="sslider" id="sl-sta" min="30" max="220" value="100" oninput="edStat('sta',+this.value)"><div class="sval" id="sv-sta">100</div></div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">KEYBIND</div>
      <div class="kb-row" id="kb-row"></div>
    </div>
  </div>
  <div id="ed-main">
    <div style="font-family:'Orbitron',sans-serif;font-size:13px;color:var(--gold);letter-spacing:5px;margin-bottom:12px;">CHARACTER EDITOR</div>
    <canvas id="ed-preview" width="200" height="290"></canvas>
    <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--silver);letter-spacing:3px;text-align:center;margin-bottom:7px;">SKIN PAINTER</div>
    <canvas id="skin-canvas" width="150" height="150"></canvas>
    <div class="skin-pal" id="skin-pal"></div>
    <div class="skin-tools">
      <button class="sk-tool on" id="skt-brush" onclick="setSkinTool('brush')">BRUSH</button>
      <button class="sk-tool" id="skt-fill" onclick="setSkinTool('fill')">FILL</button>
      <button class="sk-tool" id="skt-erase" onclick="setSkinTool('erase')">ERASE</button>
    </div>
    <div class="ed-action-row">
      <button class="ed-act" onclick="edResetSkin()">RESET</button>
      <button class="ed-act gold" onclick="edSaveSkin()">SAVE SKIN</button>
      <button class="ed-act" onclick="edExport()">EXPORT</button>
    </div>
  </div>
  <div id="ed-right">
    <div class="ed-sec">
      <div class="ed-shd">ELEMENTS (MAX 3)</div>
      <div class="attr-grid" id="attr-grid"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">AURA PREVIEW</div>
      <div class="aura-prev" id="aura-prev">—</div>
      <div class="aura-lbl" id="aura-lbl">NO ELEMENT</div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">ROLE ABILITIES</div>
      <div id="ab-list"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">SPECIALS</div>
      <div class="spec-row"><div class="spec-lbl">ABSORB</div>
        <button class="togbtn on" id="ab-off" onclick="edAbsorb(false)">OFF</button>
        <button class="togbtn" id="ab-on" onclick="edAbsorb(true)">ON</button></div>
      <div class="spec-row"><div class="spec-lbl">LIFESTEAL</div>
        <button class="togbtn on" id="ls-off" onclick="edSpec('lifesteal',false)">OFF</button>
        <button class="togbtn" id="ls-on" onclick="edSpec('lifesteal',true)">ON</button></div>
      <div class="spec-row"><div class="spec-lbl">SHIELD REGEN</div>
        <button class="togbtn on" id="sr-off" onclick="edSpec('shieldRegen',false)">OFF</button>
        <button class="togbtn" id="sr-on" onclick="edSpec('shieldRegen',true)">ON</button></div>
    </div>
    <div class="ed-sec">
      <div class="ed-shd">BOUND MOVES</div>
      <div id="move-list" style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text2);line-height:2.2;"></div>
      <div style="font-size:9px;color:var(--text3);margin-top:5px;">Moves bound via in-game 1–4 keys</div>
    </div>
  </div>
</div>

<!-- CHANGELOG -->
<div class="page" id="page-changelog">
  <div class="cl-wrap">
    <div class="cl-title">CHANGELOG</div>
    <div class="cl-sub">STICKBOX 3.0 — DEVELOPMENT HISTORY</div>
    <div class="cl-back" onclick="showPage('menu')">◂ BACK</div>
    <div class="cl-entry">
      <div class="cl-hd"><div class="cl-ver">v3.0.0</div><div class="cl-date">2025-01-01</div><div class="cl-badge new">LATEST</div></div>
      <div class="cl-items">
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Complete engine rewrite — 4-part modular architecture</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Dense particle systems — 500+ simultaneous particles, no flickering</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Redesigned character with capsule limbs, skeletal IK, smooth animation</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Frame-data attack system — windup, active, recovery, hitstop frames</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Elements moved to bottom bar — cleaner game area</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Hidden move paths — executed as invisible precision moves</div></div>
        <div class="cl-item"><div class="cl-dot f"></div><div class="cl-txt"><span class="cl-tag f">FEAT</span>Moves disabled on player death</div></div>
        <div class="cl-item"><div class="cl-dot x"></div><div class="cl-txt"><span class="cl-tag x">FIX</span>Eliminated all duplicate function definitions</div></div>
        <div class="cl-item"><div class="cl-dot x"></div><div class="cl-txt"><span class="cl-tag x">FIX</span>Particle cap prevents memory-crash after prolonged sessions</div></div>
        <div class="cl-item"><div class="cl-dot x"></div><div class="cl-txt"><span class="cl-tag x">FIX</span>Ground collision consistent across all depths</div></div>
        <div class="cl-item"><div class="cl-dot c"></div><div class="cl-txt"><span class="cl-tag c">CHANGE</span>Simplified controls panel — only essentials shown</div></div>
        <div class="cl-item"><div class="cl-dot c"></div><div class="cl-txt"><span class="cl-tag c">CHANGE</span>Player list on left, controls on right</div></div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
// ═══════════════════════════ ELEMENTS ════════════════════════════════
const ELEM={
  fire:     {abbr:'FIR',name:'Fire',     col:'#ff4d1a',glow:'#ff8844',dark:'#6e1500',ps:['tear','shard'],    grav:-.15,drag:.97,dmg:14,eff:'burn',       cnt:22,group:'classic'},
  water:    {abbr:'WTR',name:'Water',    col:'#1ab4ff',glow:'#7dd4ff',dark:'#003d6e',ps:['circle','tear'],   grav:.05, drag:.985,dmg:8, eff:'slow',       cnt:18,group:'classic'},
  lightning:{abbr:'LTN',name:'Lightning',col:'#ffe01a',glow:'#fff07a',dark:'#806000',ps:['bolt','shard'],    grav:-.05,drag:.93, dmg:18,eff:'stun_brief', cnt:28,group:'classic'},
  ice:      {abbr:'ICE',name:'Ice',      col:'#a0e8ff',glow:'#e8f8ff',dark:'#1a5a80',ps:['snow','diamond'],  grav:.02, drag:.99, dmg:10,eff:'slow_heavy', cnt:20,group:'classic'},
  void:     {abbr:'VOD',name:'Void',     col:'#9b1aff',glow:'#cc6fff',dark:'#2a003a',ps:['ring','star'],     grav:-.01,drag:.996,dmg:22,eff:'pull',       cnt:16,group:'dark'},
  plasma:   {abbr:'PLS',name:'Plasma',   col:'#ff1a8c',glow:'#ff80c8',dark:'#5a0030',ps:['star','bolt'],     grav:-.1, drag:.96, dmg:20,eff:'burn_aoe',   cnt:24,group:'dark'},
  earth:    {abbr:'ETH',name:'Earth',    col:'#c8a060',glow:'#e8c878',dark:'#3a2000',ps:['diamond','shard'], grav:.2,  drag:.93, dmg:16,eff:'knockdown',  cnt:14,group:'classic'},
  wind:     {abbr:'WND',name:'Wind',     col:'#b0ffcc',glow:'#e8fff2',dark:'#206040',ps:['ring','tear'],     grav:-.12,drag:.98, dmg:8, eff:'knockback',  cnt:18,group:'classic'},
  shadow:   {abbr:'SDW',name:'Shadow',   col:'#8844cc',glow:'#bb77ff',dark:'#0a0010',ps:['ring','star'],     grav:0,   drag:.99, dmg:18,eff:'blind',      cnt:16,group:'dark'},
  light:    {abbr:'LGT',name:'Light',    col:'#fffaaa',glow:'#ffffff',dark:'#c8a820',ps:['star','cross'],    grav:-.2, drag:.96, dmg:12,eff:'reveal',     cnt:22,group:'holy'},
  poison:   {abbr:'PSN',name:'Poison',   col:'#44ff44',glow:'#88ff88',dark:'#004400',ps:['tear','shard'],    grav:.1,  drag:.97, dmg:6, eff:'dot_6s',     cnt:16,group:'nature'},
  magma:    {abbr:'MGM',name:'Magma',    col:'#ff6600',glow:'#ff9944',dark:'#660000',ps:['shard','diamond'], grav:.15, drag:.95, dmg:20,eff:'burn_heavy', cnt:14,group:'dark'},
  storm:    {abbr:'STM',name:'Storm',    col:'#2288cc',glow:'#66aaff',dark:'#001144',ps:['bolt','ring'],     grav:-.08,drag:.96, dmg:22,eff:'chain',      cnt:24,group:'classic'},
  frost:    {abbr:'FRS',name:'Frost',    col:'#88ddff',glow:'#cceeff',dark:'#003366',ps:['snow','diamond'],  grav:.03, drag:.996,dmg:12,eff:'freeze_3s',  cnt:18,group:'classic'},
  arcane:   {abbr:'ARC',name:'Arcane',   col:'#cc44ff',glow:'#ee88ff',dark:'#440066',ps:['star','ring'],     grav:-.05,drag:.97, dmg:24,eff:'curse',      cnt:18,group:'dark'},
  blood:    {abbr:'BLD',name:'Blood',    col:'#cc0022',glow:'#ff4466',dark:'#440000',ps:['tear','shard'],    grav:.1,  drag:.97, dmg:16,eff:'bleed_5s',   cnt:16,group:'dark'},
  time:     {abbr:'TIM',name:'Time',     col:'#88ccaa',glow:'#aaffcc',dark:'#224433',ps:['ring','circle'],   grav:0,   drag:.999,dmg:15,eff:'haste_self', cnt:12,group:'cosmic'},
  space:    {abbr:'SPC',name:'Space',    col:'#3344cc',glow:'#6688ff',dark:'#000022',ps:['star','ring'],     grav:-.02,drag:.998,dmg:20,eff:'warp',       cnt:14,group:'cosmic'},
  crystal:  {abbr:'CRY',name:'Crystal', col:'#88ffff',glow:'#ccffff',dark:'#004444',ps:['diamond','shard'], grav:.05, drag:.97, dmg:14,eff:'shard_burst',cnt:18,group:'nature'},
  metal:    {abbr:'MTL',name:'Metal',   col:'#aabbcc',glow:'#ddeeff',dark:'#223344',ps:['diamond','cross'], grav:.15, drag:.94, dmg:18,eff:'armor_pen',  cnt:16,group:'classic'},
  nature:   {abbr:'NAT',name:'Nature',  col:'#44aa22',glow:'#88cc66',dark:'#004400',ps:['tear','ring'],     grav:-.05,drag:.98, dmg:8, eff:'heal_dot',   cnt:16,group:'nature'},
  acid:     {abbr:'ACD',name:'Acid',    col:'#aaff00',glow:'#ccff44',dark:'#334400',ps:['tear','shard'],    grav:.08, drag:.97, dmg:12,eff:'armor_shred',cnt:18,group:'nature'},
  gravity:  {abbr:'GRV',name:'Gravity', col:'#6644aa',glow:'#9977dd',dark:'#110022',ps:['ring','circle'],   grav:.05, drag:1,   dmg:20,eff:'pull_strong',cnt:12,group:'cosmic'},
  sonic:    {abbr:'SON',name:'Sonic',   col:'#44ffff',glow:'#88ffff',dark:'#004444',ps:['ring','cross'],    grav:-.03,drag:.97, dmg:14,eff:'stun_mid',   cnt:20,group:'classic'},
  radiation:{abbr:'RAD',name:'Radiation',col:'#ccff22',glow:'#eeff88',dark:'#224400',ps:['star','ring'],    grav:0,   drag:.98, dmg:8, eff:'dot_heavy',  cnt:16,group:'nature'},
  magnet:   {abbr:'MAG',name:'Magnet',  col:'#6688cc',glow:'#88aaee',dark:'#112244',ps:['cross','ring'],    grav:0,   drag:.97, dmg:12,eff:'attract',    cnt:16,group:'cosmic'},
  aether:   {abbr:'AET',name:'Aether',  col:'#ffd080',glow:'#ffe8aa',dark:'#442200',ps:['star','diamond'], grav:-.15,drag:.97, dmg:18,eff:'dispel',     cnt:16,group:'holy'},
  chaos:    {abbr:'CHS',name:'Chaos',   col:'#ff4488',glow:'#ff88bb',dark:'#440011',ps:['shard','bolt'],    grav:-.05,drag:.95, dmg:30,eff:'random_all', cnt:26,group:'dark'},
  order:    {abbr:'ORD',name:'Order',   col:'#e8e8ff',glow:'#ffffff',dark:'#334466',ps:['cross','diamond'], grav:0,   drag:.98, dmg:10,eff:'parry_break',cnt:14,group:'holy'},
  nether:   {abbr:'NTH',name:'Nether', col:'#6600aa',glow:'#9933cc',dark:'#000000',ps:['ring','shard'],    grav:.05, drag:.999,dmg:35,eff:'doom',       cnt:12,group:'dark'},
};
const EKEYS=Object.keys(ELEM);

// ═══════════════════════════ COMBOS ══════════════════════════════════
const COMBOS={};
function RC(e1,e2,n,re,d,ef,aoe,fc){
  const k=`${e1}+${e2}`;
  COMBOS[k]=COMBOS[`${e2}+${e1}`]={name:n,result:re,dmg:d,eff:ef,aoe:aoe||0,flash:fc||'#fff',key:k};
}
RC('fire','water','Steam Burst','water',18,'steam_cloud',110,'#aaccff');
RC('fire','wind','Firestorm','fire',30,'tornado_fire',140,'#ff8844');
RC('fire','earth','Magma Surge','magma',34,'magma_slow',110,'#ff6600');
RC('fire','ice','Supercool Burst','water',44,'freeze_pop',95,'#ccffff');
RC('fire','shadow','Hellfire','fire',50,'unblockable',75,'#ff0044');
RC('fire','lightning','Plasma Arc','plasma',38,'chain_dmg',115,'#ff44ff');
RC('fire','blood','Infernal Drain','blood',54,'lifesteal',85,'#ff0022');
RC('fire','magma','Volcanic Burst','magma',62,'knockup',150,'#ff6600');
RC('fire','chaos','Wildfire','chaos',46,'random_burn',160,'#ff44aa');
RC('fire','nature','Primal Flame','magma',38,'burn_regen',115,'#ff8844');
RC('water','ice','Blizzard','frost',24,'freeze_zone',170,'#aaeeff');
RC('water','lightning','Electrolysis','storm',34,'stun_chain',105,'#44ffff');
RC('water','poison','Toxic Flood','acid',28,'dot_spread',150,'#44ff44');
RC('water','earth','Mudslide','earth',20,'slow_heavy',140,'#88aa44');
RC('water','wind','Vortex Wave','wind',24,'pull_wave',160,'#aaffcc');
RC('water','nature','Life Surge','nature',0,'heal_all',140,'#44ff88');
RC('water','acid','Acid Rain','acid',30,'aoe_dot',190,'#aaff00');
RC('lightning','ice','Frostbolt','frost',50,'pierce_freeze',65,'#88ddff');
RC('lightning','earth','Quake','earth',44,'stun_ground',180,'#c8a060');
RC('lightning','metal','Railgun','metal',90,'pierce_all',45,'#ccddff');
RC('lightning','storm','Thunderclap','storm',40,'aoe_stun',220,'#6699ff');
RC('lightning','shadow','Dark Charge','shadow',60,'blind_chain',95,'#6633cc');
RC('lightning','sonic','Shockwave','sonic',42,'push_all',210,'#44ffff');
RC('lightning','void','Arc Singularity','void',57,'micro_pull',125,'#9933ff');
RC('ice','crystal','Diamond Dust','crystal',34,'slow_shard',125,'#88ffff');
RC('ice','wind','Polar Vortex','frost',30,'freeze_pull',200,'#cceeff');
RC('ice','shadow','Frozen Soul','shadow',40,'stun_long',85,'#4444aa');
RC('ice','metal','Cryosteel','metal',32,'armor_freeze',95,'#88bbdd');
RC('void','plasma','Singularity','void',67,'pull_all',270,'#9b1aff');
RC('void','gravity','Black Hole','gravity',87,'crush_all',220,'#6644aa');
RC('void','shadow','Abyss','shadow',110,'doom_zone',140,'#000066');
RC('void','space','Dimensional Rift','space',74,'teleport_dmg',0,'#3344ff');
RC('void','nether','Oblivion Gate','nether',97,'doom_aoe',190,'#440066');
RC('plasma','chaos','Reality Shatter','chaos',97,'chaos_burst',330,'#ff44ff');
RC('shadow','blood','Vampiric Drain','blood',44,'lifesteal_aoe',115,'#880022');
RC('shadow','arcane','Death Curse','arcane',57,'dot_curse',90,'#8800cc');
RC('shadow','nether','Soul Devour','nether',92,'drain_soul',85,'#440066');
RC('light','shadow','Annihilation','aether',135,'annihilate',170,'#ffffff');
RC('light','order','Divine Judgment','order',90,'stun_holy',150,'#ffffaa');
RC('light','arcane','Celestial Bolt','aether',77,'dispel_burst',115,'#ffeedd');
RC('time','space','Temporal Rift','space',54,'slow_time_zone',220,'#88ccff');
RC('time','order','Chronostasis','time',0,'stop_all',460,'#aaffcc');
RC('chaos','order','Reality Break','chaos',165,'reality_break',620,'#ff88ff');
RC('earth','metal','Iron Fortress','metal',22,'shield_create',0,'#aabbcc');
RC('earth','crystal','Gem Storm','crystal',40,'pierce_shard',140,'#88ffff');
RC('earth','nature','Overgrowth','nature',14,'root_bind',170,'#44aa22');
RC('earth','gravity','Seismic Crush','gravity',52,'ground_pound',160,'#6644aa');
RC('wind','lightning','Hurricane Bolt','storm',50,'push_stun',150,'#2288cc');
RC('wind','arcane','Arcane Gale','arcane',44,'push_curse',180,'#cc44ff');
RC('blood','arcane','Blood Magic','arcane',60,'lifesteal_curse',100,'#cc00cc');
RC('poison','acid','Corrosion','acid',34,'dot_armor',110,'#88ff00');
RC('poison','nature','Plague Bloom','poison',30,'spread_dot',160,'#44cc44');
RC('sonic','metal','Resonance Break','sonic',60,'armor_shatter',135,'#88ccff');
RC('radiation','acid','Meltdown','acid',67,'heavy_dot',140,'#ccff00');
RC('gravity','magnet','Polar Collapse','gravity',74,'crush_metal',170,'#6688cc');
RC('aether','arcane','Celestial Burst','aether',80,'heal_dmg_burst',115,'#ffd080');
RC('nether','void','Oblivion','nether',118,'doom_aoe',200,'#220033');
RC('magma','nature','Primordial Surge','magma',47,'burn_heal',125,'#ff7722');
RC('crystal','magnet','Magnetic Shards','crystal',40,'pull_pierce',180,'#88eeff');
RC('metal','order','Absolute Defense','metal',0,'full_shield',0,'#e8e8ff');
RC('chaos','shadow','Nightmare','chaos',72,'fear_debuff',155,'#ff2266');
RC('storm','wind','Tempest','storm',57,'mega_push',230,'#4499ff');

// ═══════════════════════════ ROLES ═══════════════════════════════════
const ROLES={
  fighter:    {name:'Fighter',   abbr:'FGT',col:'#ff8844',hp:100,atk:20,def:5, spd:4,sta:100,a1:'triple_slash',a2:'war_cry',      ult:'blade_storm',    desc:'Balanced melee combatant'},
  tank:       {name:'Tank',      abbr:'TNK',col:'#4488ff',hp:180,atk:8, def:20,spd:2,sta:150,a1:'shield_bash', a2:'taunt',         ult:'iron_fortress',  desc:'Immovable defense master'},
  assassin:   {name:'Assassin',  abbr:'ASN',col:'#cc44ff',hp:60, atk:35,def:2, spd:9,sta:80, a1:'shadow_step', a2:'backstab',      ult:'death_mark',     desc:'Glass cannon speed killer'},
  support:    {name:'Support',   abbr:'SUP',col:'#44ff88',hp:80, atk:5, def:5, spd:5,sta:120,a1:'barrier',     a2:'rally',         ult:'mass_heal',      desc:'Healer and team buffer'},
  mage:       {name:'Mage',      abbr:'MGE',col:'#8844ff',hp:70, atk:28,def:3, spd:5,sta:90, a1:'elem_bolt',   a2:'mana_shield',   ult:'elem_nova',      desc:'Elemental power master'},
  berserker:  {name:'Berserker', abbr:'BRK',col:'#ff2222',hp:120,atk:30,def:3, spd:6,sta:200,a1:'frenzy',      a2:'blood_lust',    ult:'berserker_rage', desc:'Stronger as HP drops'},
  paladin:    {name:'Paladin',   abbr:'PLD',col:'#fffaaa',hp:130,atk:14,def:14,spd:3,sta:130,a1:'consecrate',  a2:'holy_shield',   ult:'divine_judgment',desc:'Holy warrior and guardian'},
  rogue:      {name:'Rogue',     abbr:'RGU',col:'#cc8844',hp:75, atk:22,def:4, spd:8,sta:85, a1:'smoke_bomb',  a2:'cheap_shot',    ult:'assassination',  desc:'Crit and evasion specialist'},
  necromancer:{name:'Necromancer',abbr:'NCR',col:'#6633aa',hp:75,atk:18,def:5, spd:4,sta:100,a1:'bone_spear', a2:'life_drain',    ult:'death_wave',     desc:'Death and blood magic wielder'},
  druid:      {name:'Druid',     abbr:'DRD',col:'#44aa22',hp:95, atk:12,def:8, spd:5,sta:110,a1:'entangle',    a2:'animal_form',   ult:'nature_wrath',   desc:'Nature and earth shaper'},
  templar:    {name:'Templar',   abbr:'TPL',col:'#e8e8ff',hp:110,atk:16,def:12,spd:3,sta:120,a1:'judgement',   a2:'reflect',       ult:'divine_wrath',   desc:'Order and counter specialist'},
  summoner:   {name:'Summoner',  abbr:'SMN',col:'#44ccff',hp:65, atk:12,def:3, spd:5,sta:95, a1:'summon_shade',a2:'elem_familiar', ult:'summon_legion',  desc:'Controls summoned entities'},
};
const RKEYS=Object.keys(ROLES);

// ═══════════════════════════ ABILITIES ═══════════════════════════════
const ABIL={
  triple_slash: {type:'a',name:'Triple Slash',  cd:55, cost:20,desc:'3 rapid slashes, final hit launches'},
  shield_bash:  {type:'a',name:'Shield Bash',   cd:90, cost:25,desc:'Stun and push enemy back hard'},
  shadow_step:  {type:'a',name:'Shadow Step',   cd:45, cost:15,desc:'Teleport behind nearest enemy'},
  barrier:      {type:'a',name:'Barrier',       cd:180,cost:40,desc:'Create protective barrier 5s'},
  elem_bolt:    {type:'a',name:'Elem Bolt',     cd:30, cost:15,desc:'Fire 3-burst elemental bolts'},
  frenzy:       {type:'a',name:'Frenzy',        cd:120,cost:50,desc:'Attack speed ×2 for 3 seconds'},
  consecrate:   {type:'a',name:'Consecrate',    cd:150,cost:35,desc:'Sanctify ground, damages enemies'},
  smoke_bomb:   {type:'a',name:'Smoke Bomb',    cd:90, cost:20,desc:'Create smoke, become invisible briefly'},
  bone_spear:   {type:'a',name:'Bone Spear',    cd:40, cost:20,desc:'Launch piercing bone projectile'},
  entangle:     {type:'a',name:'Entangle',      cd:120,cost:30,desc:'Root enemies in place 2 seconds'},
  judgement:    {type:'a',name:'Judgement',     cd:80, cost:25,desc:'Strike with order energy + status bonus'},
  war_cry:      {type:'a',name:'War Cry',       cd:180,cost:30,desc:'Buff nearby ally ATK 20% for 5s'},
  taunt:        {type:'a',name:'Taunt',         cd:120,cost:20,desc:'Force all enemies to target you'},
  backstab:     {type:'a',name:'Backstab',      cd:60, cost:25,desc:'3× damage from behind target'},
  rally:        {type:'a',name:'Rally',         cd:200,cost:45,desc:'Restore 30 HP to all allies'},
  mana_shield:  {type:'a',name:'Mana Shield',   cd:120,cost:35,desc:'Absorb next hit with element energy'},
  blood_lust:   {type:'a',name:'Blood Lust',    cd:90, cost:40,desc:'Drain HP from all nearby enemies'},
  holy_shield:  {type:'a',name:'Holy Shield',   cd:150,cost:30,desc:'Immune to next 3 hits'},
  cheap_shot:   {type:'a',name:'Cheap Shot',    cd:60, cost:20,desc:'Stun enemy 1.5 seconds'},
  elem_familiar:{type:'a',name:'Elem Familiar', cd:180,cost:40,desc:'Summon an elemental familiar'},
  life_drain:   {type:'a',name:'Life Drain',    cd:80, cost:25,desc:'Steal HP from nearest target'},
  animal_form:  {type:'a',name:'Animal Form',   cd:240,cost:60,desc:'Transform: +SPD +ATK for 5s'},
  reflect:      {type:'a',name:'Reflect',       cd:100,cost:30,desc:'Reflect next projectile or spell'},
  summon_shade: {type:'a',name:'Summon Shade',  cd:200,cost:50,desc:'Summon shade minion to fight'},
  blade_storm:  {type:'u',name:'Blade Storm',   cost:100,desc:'Rapid spinning attacks on all nearby'},
  iron_fortress:{type:'u',name:'Iron Fortress', cost:100,desc:'Invincible 4s, reflect all damage back'},
  death_mark:   {type:'u',name:'Death Mark',    cost:100,desc:'Mark enemy: 5s to kill or die together'},
  mass_heal:    {type:'u',name:'Mass Heal',     cost:100,desc:'Fully heal all allies instantly'},
  elem_nova:    {type:'u',name:'Elem Nova',     cost:100,desc:'Giant elemental explosion from self'},
  berserker_rage:{type:'u',name:'Berserker Rage',cost:100,desc:'3× ATK, unlimited stamina, stun immunity 6s'},
  divine_judgment:{type:'u',name:'Divine Judgment',cost:100,desc:'Call holy fire on all enemies'},
  assassination:{type:'u',name:'Assassination', cost:100,desc:'Instant kill <30% HP, else 80% dmg'},
  death_wave:   {type:'u',name:'Death Wave',    cost:100,desc:'Wave drains HP from all enemies'},
  nature_wrath: {type:'u',name:'Nature Wrath',  cost:100,desc:'Massive roots and nature explosion'},
  divine_wrath: {type:'u',name:'Divine Wrath',  cost:100,desc:'Judge all enemies by their sins'},
  summon_legion:{type:'u',name:'Summon Legion', cost:100,desc:'Summon 3 powerful minions'},
};

// ═══════════════════════════ KEYBIND SETS ════════════════════════════
const KB={
  wasd:   {left:'a',right:'d',up:'w',down:'s',lt:'q',hy:'e',a1:'r',a2:'t',ult:'f',blk:'shift',dsh:'v',m1:'1',m2:'2',m3:'3',m4:'4',grav:'g',rx:'x'},
  arrows: {left:'arrowleft',right:'arrowright',up:'arrowup',down:'arrowdown',lt:'j',hy:'k',a1:'l',a2:';',ult:"'",blk:'altright',dsh:'/',m1:'numpad1',m2:'numpad2',m3:'numpad3',m4:'numpad4',grav:'m',rx:'n'},
  num:    {left:'numpad4',right:'numpad6',up:'numpad8',down:'numpad5',lt:'numpad7',hy:'numpad9',a1:'numpad1',a2:'numpad3',ult:'numpad0',blk:'numpadenter',dsh:'numpaddecimal',m1:'f5',m2:'f6',m3:'f7',m4:'f8',grav:'f9',rx:'f10'},
};

// ═══════════════════════════ STATE ═══════════════════════════════════
const S={
  page:'menu',frame:0,
  selElem:'fire',
  selPlayer:null,
  editPlayer:null,

  players:[],
  particles:[],
  elements:[],
  hazards:[],
  gravWells:[],
  projectiles:[],
  effects:[],
  hitstops:[],

  moves:{}, // pid -> {key -> {pts,elem,type}}

  slowmo:false,sm:1,
  combo:0,comboTimer:null,
  aiOn:false,
  musicOn:false,

  skinTool:'brush',skinColor:'#4488ff',skinBrushSize:5,
  keys:{},
  mouseX:0,mouseY:0,
};

// ═══════════════════════════ UTIL ════════════════════════════════════
const dist=(ax,ay,bx,by)=>Math.sqrt((ax-bx)**2+(ay-by)**2);
const lerp=(a,b,t)=>a+(b-a)*t;
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const rnd=(a,b)=>a+Math.random()*(b-a);
const rndOf=a=>a[Math.floor(Math.random()*a.length)];
const rndInt=(a,b)=>Math.floor(rnd(a,b+1));

function hexToRgb(hex){
  if(hex.startsWith('rgb'))return hex;
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}
function hexA(hex,a){
  if(!hex)return `rgba(128,128,128,${a})`;
  if(hex.startsWith('rgba'))return hex.replace(/[\d.]+\)$/,`${a})`);
  if(hex.startsWith('rgb'))return hex.replace('rgb','rgba').replace(')',`,${a})`);
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function lighten(hex,t){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgb(${Math.round(r+(255-r)*t)},${Math.round(g+(255-g)*t)},${Math.round(b+(255-b)*t)})`;
}
function darken(hex,t){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgb(${Math.round(r*(1-t))},${Math.round(g*(1-t))},${Math.round(b*(1-t))})`;
}
function catmull(pts,tension=0.5,segs=8){
  if(pts.length<2)return pts;
  const res=[];
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(pts.length-1,i+2)];
    for(let s=0;s<segs;s++){
      const t=s/segs,t2=t*t,t3=t2*t;
      const h0=-tension*t3+2*tension*t2-tension*t;
      const h1=(2-tension)*t3+(tension-3)*t2+1;
      const h2=(tension-2)*t3+(3-2*tension)*t2+tension*t;
      const h3=tension*t3-tension*t2;
      res.push({x:h0*p0.x+h1*p1.x+h2*p2.x+h3*p3.x,y:h0*p0.y+h1*p1.y+h2*p2.y+h3*p3.y});
    }
  }
  res.push(pts[pts.length-1]);
  return res;
}

// ═══════════════════════════ NOTIFY / TIP ════════════════════════════
let _nT;
function notify(msg,col){
  const el=document.getElementById('notif');
  el.textContent=msg;el.style.borderColor=col||'var(--gold)';el.style.color=col||'var(--gold)';
  el.classList.add('show');clearTimeout(_nT);_nT=setTimeout(()=>el.classList.remove('show'),2200);
}
const _gtt=document.getElementById('gtt');
function showTip(e,txt){_gtt.textContent=txt;_gtt.classList.add('show');
  _gtt.style.left=(e.clientX+12)+'px';_gtt.style.top=(e.clientY-8)+'px';}
function moveTip(e){_gtt.style.left=(e.clientX+12)+'px';_gtt.style.top=(e.clientY-8)+'px';}
function hideTip(){_gtt.classList.remove('show');}

// ═══════════════════════════ CINEMATIC ═══════════════════════════════
function flash(intensity=.3,dur=80){
  const f=document.getElementById('cine-flash');
  f.style.transition='none';f.style.opacity=String(intensity);
  setTimeout(()=>{f.style.transition='opacity .15s';f.style.opacity='0';},dur);
}
function dmgNum(x,y,val,col,isCrit=false){
  const layer=document.getElementById('dmg-layer');
  const el=document.createElement('div');
  el.className='dmg-num';
  const label=val>0?`-${val}`:val<0?`+${-val}`:'MISS';
  el.textContent=label;
  el.style.color=val>0?(col||'#ff4444'):'#44ff88';
  el.style.fontSize=isCrit?'22px':'16px';
  el.style.left=Math.round(x)+'px';el.style.top=Math.round(y)+'px';
  el.style.textShadow=`0 0 12px ${el.style.color}`;
  if(isCrit)el.style.fontStyle='italic';
  layer.appendChild(el);
  setTimeout(()=>el.remove(),900);
}

// ═══════════════════════════ PLAYER FACTORY ══════════════════════════
let _pid=0;
function mkPlayer(x,y,opts={}){
  const id=++_pid;
  const role=opts.role||'fighter';
  const rs=ROLES[role];
  const sc=opts.skinColor||'#4488ff';
  return {
    id,name:opts.name||`P${id}`,
    x,y,vx:0,vy:0,onGround:false,facing:1,
    maxHp:opts.hp||rs.hp,hp:opts.hp||rs.hp,
    atk:opts.atk||rs.atk,def:opts.def||rs.def,
    spd:opts.spd||rs.spd,
    maxSta:opts.sta||rs.sta,sta:opts.sta||rs.sta,
    shield:0,maxShield:60,
    stagger:0,maxStagger:100,
    ultMeter:0,maxUlt:100,
    role,attrs:opts.attrs?[...opts.attrs]:[],
    activeElem:null,
    skinColor:sc,skinColor2:darken(sc,.35),
    keybind:opts.keybind||'wasd',
    abils:{a1:rs.a1,a2:rs.a2,ult:rs.ult},
    cds:{a1:0,a2:0,ult:0,dash:0},
    absorbOn:false,absorbedElem:null,
    specials:{lifesteal:false,shieldRegen:false},
    statusFX:[],
    cstate:'idle',
    atkType:null,atkFrame:0,atkMax:0,
    activeFrames:[0,0],hitSet:new Set(),
    hitstopTimer:0,
    blockFrames:0,
    invFrames:0,
    comboStep:0,lastLightAt:0,
    frenzied:false,
    animTime:0,depth:opts.depth||(0.85+Math.random()*.3),
    isDead:false,isHurt:false,hurtTimer:0,
    isAI:false,aiOwner:null,
    _moves:{}, // key -> {pts,elem,type}
  };
}

// ═══════════════════════════ LOADING ═════════════════════════════════
const LOAD_STEPS=['LOADING ENGINE...','COMPILING ELEMENTS...','BUILDING COMBOS...','SPAWNING FIGHTERS...','READY!'];
let _lStep=0;
function doLoad(){
  const fill=document.getElementById('ld-fill'),msg=document.getElementById('ld-msg');
  const iv=setInterval(()=>{
    _lStep++;
    fill.style.width=Math.min(100,_lStep/LOAD_STEPS.length*100)+'%';
    msg.textContent=LOAD_STEPS[Math.min(_lStep,LOAD_STEPS.length-1)];
    if(_lStep>=LOAD_STEPS.length){
      clearInterval(iv);
      setTimeout(()=>{
        document.getElementById('loading').classList.add('done');
        startMenuFX();buildElemBar();buildEditorUI();
      },400);
    }
  },280);
}

// ═══════════════════════════ MUSIC ═══════════════════════════════════
const bgm=document.getElementById('bgm');
function toggleBGM(){
  const btn=document.getElementById('bgm-btn');
  if(S.musicOn){bgm.pause();S.musicOn=false;btn.textContent='♪ MUSIC';}
  else{bgm.play().catch(()=>{});S.musicOn=true;btn.textContent='■ MUSIC';}
}
function loadBGM(e){
  const f=e.target.files[0];if(!f)return;
  bgm.src=URL.createObjectURL(f);bgm.load();
  bgm.play().catch(()=>{});S.musicOn=true;
  document.getElementById('bgm-btn').textContent='■ MUSIC';
  notify('MUSIC LOADED');
}
</script>



<script>'use strict';
// stickbox_p2.js — RENDERING ENGINE
// ═══════════════════════════════════════════════════════════════════
const gc=document.getElementById('game-canvas');
const ctx=gc.getContext('2d');
const PARTICLE_CAP=1800;

function resizeGame(){
  gc.width=window.innerWidth;
  gc.height=window.innerHeight;
}
window.addEventListener('resize',resizeGame);
resizeGame();
const GY=()=>gc.height-90;

// ═══════════════════════════ SHAPE RENDERER ═══════════════════════
function drawShape(c,shape,x,y,sz,col,a,rot=0){
  if(a<=0.01)return;
  c.save();c.globalAlpha=Math.min(1,a);c.translate(x,y);c.rotate(rot);
  c.fillStyle=col;c.strokeStyle=col;
  c.shadowBlur=sz*2.5;c.shadowColor=col;
  switch(shape){
    case'tear':
      c.beginPath();c.arc(0,-sz*.35,sz*.72,0,Math.PI*2);c.fill();
      c.beginPath();c.moveTo(-sz*.52,-sz*.35);c.quadraticCurveTo(0,sz*1.65,sz*.52,-sz*.35);c.fill();
      break;
    case'diamond':
      c.beginPath();c.moveTo(0,-sz*1.45);c.lineTo(sz*.85,0);c.lineTo(0,sz*1.45);c.lineTo(-sz*.85,0);c.closePath();c.fill();
      break;
    case'shard':
      c.beginPath();c.moveTo(0,-sz*2.1);c.lineTo(sz*.42,-sz*.55);c.lineTo(sz*.22,sz*1.05);
      c.lineTo(-sz*.22,sz*1.05);c.lineTo(-sz*.42,-sz*.55);c.closePath();c.fill();
      break;
    case'bolt':
      c.beginPath();c.moveTo(sz*.32,-sz*1.55);c.lineTo(-sz*.22,0);c.lineTo(sz*.3,0);
      c.lineTo(-sz*.32,sz*1.55);c.lineTo(sz*.22,0);c.lineTo(-sz*.3,0);c.closePath();c.fill();
      break;
    case'star':
      c.beginPath();
      for(let i=0;i<5;i++){
        const ang=(i/5)*Math.PI*2-Math.PI/2,ia=ang+Math.PI/5;
        i===0?c.moveTo(Math.cos(ang)*sz,Math.sin(ang)*sz):c.lineTo(Math.cos(ang)*sz,Math.sin(ang)*sz);
        c.lineTo(Math.cos(ia)*sz*.42,Math.sin(ia)*sz*.42);
      }c.closePath();c.fill();
      break;
    case'ring':
      c.beginPath();c.arc(0,0,sz,0,Math.PI*2);c.lineWidth=sz*.38;c.stroke();
      break;
    case'cross':
      c.lineWidth=sz*.42;c.lineCap='round';
      c.beginPath();c.moveTo(0,-sz*1.4);c.lineTo(0,sz*1.4);c.stroke();
      c.beginPath();c.moveTo(-sz*1.4,0);c.lineTo(sz*1.4,0);c.stroke();
      break;
    case'snow':
      c.lineWidth=sz*.22;
      for(let i=0;i<6;i++){const ang=(i/6)*Math.PI*2;c.beginPath();c.moveTo(0,0);c.lineTo(Math.cos(ang)*sz,Math.sin(ang)*sz);c.stroke();}
      break;
    case'circle':default:
      c.beginPath();c.arc(0,0,sz,0,Math.PI*2);c.fill();
      break;
  }
  c.restore();
}

// ═══════════════════════════ PARTICLE POOL ════════════════════════
function mkParticle(x,y,vx,vy,sz,col,glow,shape,alpha,decay,grav,drag,rot,rspd,scaleUp=false,scaleRate=0){
  return{x,y,vx,vy,sz,col,glow,shape,alpha,decay,grav,drag,rot,rspd,scaleUp,scaleRate};
}

function spawnEP(x,y,elemKey,count=null,scale=1){
  const e=ELEM[elemKey];if(!e)return;
  const n=count!==null?count:e.cnt;
  const cap=PARTICLE_CAP-S.particles.length;
  const actual=Math.min(n,cap);
  for(let i=0;i<actual;i++){
    const ang=Math.random()*Math.PI*2;
    const spd=rnd(.7,3.8)*scale;
    const sz=rnd(e.cnt>18?1.8:2.5,e.cnt>18?5.5:8.5)*scale;
    const p=mkParticle(
      x+rnd(-4,4)*scale,y+rnd(-4,4)*scale,
      Math.cos(ang)*spd,Math.sin(ang)*spd+(e.grav<0?-2.2:-.4),
      sz,e.col,e.glow,
      rndOf(e.ps),
      rnd(.78,.97),
      rnd(.008,.018),
      e.grav,e.drag,
      Math.random()*Math.PI*2,
      (Math.random()-.5)*.16,
      false,0
    );
    S.particles.push(p);
  }
}

function spawnImpact(x,y,elemKey,scale=1){
  flash(.18*scale,60);
  const e=ELEM[elemKey];if(!e)return;
  const cnt=Math.floor((e.cnt||14)*2.2*scale);
  spawnEP(x,y,elemKey,cnt,scale);
  // Ring burst
  if(S.particles.length<PARTICLE_CAP){
    S.particles.push(mkParticle(x,y,0,0,3.5,e.col,e.glow,'ring',.92,.035,0,1,0,0,true,4.5*scale));
    S.particles.push(mkParticle(x,y,0,0,2,e.glow||e.col,'#fff','ring',.75,.045,0,1,0,0,true,6*scale));
  }
}

// ═══════════════════════════ BACKGROUND ═══════════════════════════
const STARS=Array.from({length:90},()=>({
  x:Math.random(),y:Math.random(),
  sz:.15+Math.random()*1.1,
  phase:Math.random()*Math.PI*2,
  speed:.02+Math.random()*.04,
}));

function drawBG(){
  const W=gc.width,H=gc.height;
  // Sky gradient
  const sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#010305');sky.addColorStop(.5,'#030810');sky.addColorStop(1,'#05090f');
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  // Stars
  ctx.save();
  STARS.forEach(s=>{
    const tw=.5+.5*Math.sin(S.frame*s.speed+s.phase);
    ctx.globalAlpha=tw*.35;
    ctx.fillStyle='#ffffff';
    ctx.beginPath();ctx.arc(s.x*W,s.y*H*.74,s.sz,0,Math.PI*2);ctx.fill();
  });
  ctx.restore();
  // Horizon glow
  const hg=ctx.createLinearGradient(0,H-140,0,H-80);
  hg.addColorStop(0,'transparent');hg.addColorStop(.5,'rgba(200,168,75,.12)');hg.addColorStop(1,'transparent');
  ctx.fillStyle=hg;ctx.fillRect(0,H-140,W,60);
  // Ground
  const grd=ctx.createLinearGradient(0,GY()-10,0,H);
  grd.addColorStop(0,'#0c1a12');grd.addColorStop(.4,'#081008');grd.addColorStop(1,'#040806');
  ctx.fillStyle=grd;
  ctx.beginPath();ctx.moveTo(0,GY());ctx.lineTo(W,GY());ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
  // Ground edge glow
  const ge=ctx.createLinearGradient(0,GY()-4,0,GY()+4);
  ge.addColorStop(0,'transparent');ge.addColorStop(.5,'rgba(200,168,75,.22)');ge.addColorStop(1,'transparent');
  ctx.fillStyle=ge;ctx.fillRect(0,GY()-4,W,8);
  // Perspective grid on ground
  ctx.strokeStyle='rgba(200,168,75,.025)';ctx.lineWidth=1;
  for(let i=0;i<20;i++){
    const gx=(i/20)*W;
    ctx.beginPath();ctx.moveTo(gx,GY());ctx.lineTo(W/2+(gx-W/2)*.06,H);ctx.stroke();
  }
  for(let d=0;d<5;d++){
    const dy=GY()+((H-GY())*(d/5));
    ctx.beginPath();ctx.moveTo(0,dy);ctx.lineTo(W,dy);ctx.stroke();
  }
}

// ═══════════════════════════ CAPSULE RENDERER ══════════════════════
function drawCapsule(c,x1,y1,x2,y2,r,col1,col2,glow,glowStr=8){
  const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1;
  const ux=dx/len,uy=dy/len,nx=-uy,ny=ux;
  const ang=Math.atan2(dy,dx);
  const grd=c.createLinearGradient(
    x1-nx*r*1.4,y1-ny*r*1.4,
    x1+nx*r*1.4,y1+ny*r*1.4
  );
  grd.addColorStop(0,lighten(col1,.45));
  grd.addColorStop(.35,col1);
  grd.addColorStop(1,col2);
  if(glow){c.shadowBlur=glowStr;c.shadowColor=glow;}
  c.beginPath();
  c.moveTo(x1+nx*r,y1+ny*r);
  c.lineTo(x2+nx*r,y2+ny*r);
  c.arc(x2,y2,r,ang-Math.PI*.5,ang+Math.PI*.5);
  c.lineTo(x1-nx*r,y1-ny*r);
  c.arc(x1,y1,r,ang+Math.PI*.5,ang-Math.PI*.5);
  c.closePath();
  c.fillStyle=grd;c.fill();
  if(glow)c.shadowBlur=0;
}

function drawJoint(c,x,y,r,col,glow){
  const grd=c.createRadialGradient(x-r*.4,y-r*.4,0,x,y,r*1.2);
  grd.addColorStop(0,'rgba(255,255,255,.95)');
  grd.addColorStop(.3,col);
  grd.addColorStop(1,hexA(col,.3));
  if(glow){c.shadowBlur=r*3.5;c.shadowColor=glow;}
  c.beginPath();c.arc(x,y,r,0,Math.PI*2);c.fillStyle=grd;c.fill();
  if(glow)c.shadowBlur=0;
}

function drawHead(c,cx,cy,r,col,glow,eyeDir=1,dead=false){
  // Head sphere
  const grd=c.createRadialGradient(cx-r*.35,cy-r*.35,0,cx,cy,r*1.15);
  grd.addColorStop(0,lighten(col,.55));grd.addColorStop(.4,col);grd.addColorStop(1,darken(col,.5));
  if(glow){c.shadowBlur=r*2.8;c.shadowColor=glow;}
  c.beginPath();c.arc(cx,cy,r,0,Math.PI*2);c.fillStyle=grd;c.fill();
  c.strokeStyle=hexA(col,.45);c.lineWidth=.8;c.stroke();
  if(glow)c.shadowBlur=0;
  if(dead){
    c.strokeStyle='rgba(20,5,5,.9)';c.lineWidth=1.8;c.lineCap='round';
    [[-r*.32],[r*.18]].forEach(([ex])=>{
      const ey=cy-r*.22;
      c.beginPath();c.moveTo(cx+ex-r*.12,ey-r*.12);c.lineTo(cx+ex+r*.12,ey+r*.12);c.stroke();
      c.beginPath();c.moveTo(cx+ex+r*.12,ey-r*.12);c.lineTo(cx+ex-r*.12,ey+r*.12);c.stroke();
    });return;
  }
  // Eye white
  c.fillStyle='rgba(255,255,255,.92)';
  c.beginPath();c.ellipse(cx-r*.3,cy-r*.2,r*.22,r*.17,0,0,Math.PI*2);c.fill();
  // Pupil
  c.fillStyle='rgba(5,5,15,.9)';
  c.beginPath();c.arc(cx-r*.3+r*.06*eyeDir,cy-r*.2,r*.1,0,Math.PI*2);c.fill();
  // Pupil highlight
  c.fillStyle='rgba(255,255,255,.88)';
  c.beginPath();c.arc(cx-r*.32+r*.06*eyeDir,cy-r*.24,r*.036,0,Math.PI*2);c.fill();
  // Mouth
  c.strokeStyle='rgba(0,0,0,.32)';c.lineWidth=1.1;c.lineCap='round';
  c.beginPath();c.arc(cx,cy+r*.23,r*.25,.22,Math.PI-.22);c.stroke();
}

// ═══════════════════════════ POSE CALCULATOR ═════════════════════
function getPose(p,fr){
  const{cstate,animTime,onGround,facing,isDead,isHurt,atkType,atkFrame,atkMax}=p;
  const wk=onGround?Math.sin(animTime*.19)*.58:0;
  const br=Math.sin(fr*.038)*.7;
  const pose={
    headY:-66+br*.45,
    torsoY1:-56,torsoY2:-27,
    shldrX:9,shldrY:-52,hipY:-27,
    ulL:.55+wk*.75,flL:.28+wk*.38,
    ulR:-.55-wk*.75,flR:-.28-wk*.38,
    ullL:.38+wk*.65,shnL:-.18+Math.max(0,wk)*.48,
    ullR:-.38-wk*.65,shnR:.18+Math.max(0,-wk)*.48,
  };
  if(isDead){
    pose.headY=-16;pose.torsoY1=-8;pose.torsoY2=2;
    pose.ulL=1.85;pose.flL=1.25;pose.ulR=2.3;pose.flR=1.7;
    pose.ullL=.85;pose.shnL=1.25;pose.ullR=-.28;pose.shnR=.55;
    return pose;
  }
  if(isHurt){
    pose.ulL=1.55;pose.ulR=-1.55;pose.headY=-60;
    return pose;
  }
  if(cstate==='blocking'){
    pose.ulL=1.65;pose.flL=.32;pose.ulR=1.45;pose.flR=.38;
    return pose;
  }
  if(cstate==='dashing'){
    pose.ulL=2.5;pose.flL=.45;pose.ulR=-.25;pose.flR=-.75;
    pose.ullL=-1.25;pose.shnL=.38;pose.ullR=.85;pose.shnR=-.18;
    return pose;
  }
  if(cstate==='stunned'){pose.ulL=1.8;pose.ulR=-1.8;pose.headY=-58;return pose;}
  const progress=atkMax>0?atkFrame/atkMax:0;
  if(atkType==='light'){
    const swing=Math.sin(progress*Math.PI)*2.1;
    pose.ulR=-.75+swing;pose.flR=-.32+swing*.48;
  } else if(atkType==='heavy'){
    if(progress<.38){
      pose.ulR=-1.9+progress*2.2;pose.flR=-.85+progress*1.1;pose.ulL=1.25-progress*1.1;
    } else {
      const s=1-(progress-.38)/.62;
      pose.ulR=1.95-s*3.8;pose.flR=.52-s*1.1;pose.ulL=-.18+s*1.5;
    }
  } else if(atkType==='special'){
    const t=Math.sin(progress*Math.PI);
    pose.ulL=1.9+t*.6;pose.flL=1.4+t*.3;pose.ulR=1.7-t*.5;pose.flR=1.2;
  } else if(atkType==='ult'){
    const pulse=Math.sin(progress*Math.PI*4);
    pose.ulL=1.85+pulse*.4;pose.flL=.75+pulse*.25;
    pose.ulR=1.85-pulse*.4;pose.flR=.75-pulse*.25;
  }
  if(!onGround){pose.ullL=-.45;pose.shnL=.82;pose.ullR=.35;pose.shnR=.28;}
  return pose;
}

// ═══════════════════════════ WEAPON RENDERER ═════════════════════
function drawWeapon(c,role,hx,hy,facing,elemCol,fr){
  c.save();c.translate(hx,hy);c.scale(facing,1);
  const ec=elemCol||'#aabbcc';
  c.shadowBlur=10;c.shadowColor=ec;
  switch(role){
    case'fighter':case'berserker':{
      // Broad sword
      const sg=c.createLinearGradient(0,-1.5,22,1.5);
      sg.addColorStop(0,lighten(ec,.5));sg.addColorStop(.6,ec);sg.addColorStop(1,hexA(ec,.5));
      c.fillStyle=sg;
      c.beginPath();c.moveTo(22,-1.5);c.lineTo(5,-2.5);c.lineTo(2,-1.5);c.lineTo(2,1.5);c.lineTo(5,2.5);c.lineTo(22,1.5);c.closePath();c.fill();
      c.fillStyle='#8a7a60';c.fillRect(-2,-1,7,2);
      c.strokeStyle=lighten(ec,.3);c.lineWidth=.5;c.stroke();
      break;
    }
    case'assassin':case'rogue':{
      // Twin daggers look
      c.fillStyle=lighten(ec,.3);c.fillRect(4,-1.3,14,2.6);
      c.fillStyle='#6a5a70';c.fillRect(0,-2,5,4);
      c.fillStyle='#3a2a3a';c.fillRect(-8,-1,9,2);
      break;
    }
    case'mage':case'summoner':case'necromancer':{
      // Staff with orbiting gem
      c.strokeStyle='#886633';c.lineWidth=3;c.lineCap='round';
      c.beginPath();c.moveTo(0,0);c.lineTo(18,-14);c.stroke();
      const pulse=.45+.55*Math.sin(fr*.12);
      const og=c.createRadialGradient(20,-16,0,20,-16,7);
      og.addColorStop(0,'rgba(255,255,255,.95)');og.addColorStop(.38,ec);og.addColorStop(1,hexA(ec,0));
      c.fillStyle=og;c.globalAlpha=.65+pulse*.35;
      c.beginPath();c.arc(20,-16,5.5+pulse*2.5,0,Math.PI*2);c.fill();
      c.globalAlpha=1;
      break;
    }
    case'tank':case'paladin':{
      // Shield
      c.fillStyle=hexA(ec,.82);
      c.strokeStyle=lighten(ec,.3);c.lineWidth=1.5;
      c.beginPath();c.roundRect(-3,-11,20,20,3);c.fill();c.stroke();
      // Cross emblem
      c.strokeStyle='rgba(255,255,255,.55)';c.lineWidth=2;
      c.beginPath();c.moveTo(8,-7);c.lineTo(8,7);c.stroke();
      c.beginPath();c.moveTo(2,0);c.lineTo(14,0);c.stroke();
      break;
    }
    case'druid':{
      // Nature staff with leaves
      c.strokeStyle='#556622';c.lineWidth=3.5;c.lineCap='round';
      c.beginPath();c.moveTo(0,0);c.lineTo(16,-12);c.stroke();
      c.fillStyle=ec;c.shadowBlur=12;c.shadowColor=ec;
      for(let i=0;i<3;i++){
        const a=(i/3)*Math.PI*2+fr*.06;
        c.beginPath();c.ellipse(16+Math.cos(a)*6,-12+Math.sin(a)*4,3,5,a,0,Math.PI*2);c.fill();
      }
      break;
    }
    default:{
      c.fillStyle=ec;c.fillRect(4,-1.5,12,3);
      break;
    }
  }
  c.restore();
}

// ═══════════════════════════ AURA RENDERER ════════════════════════
function drawAura(c,p,fr){
  if(!p.attrs||!p.attrs.length)return;
  const ae=ELEM[p.attrs[0]];if(!ae)return;
  const col=ae.col,glow=ae.glow;
  const pulse=.5+.5*Math.sin(fr*.065+p.id*.5);
  c.save();c.globalCompositeOperation='screen';
  const eff=ae.eff||'';

  // Primary aura glow
  const rg=c.createRadialGradient(0,-35,0,0,-35,50+pulse*12);
  rg.addColorStop(0,hexA(col,0));rg.addColorStop(.45,hexA(col,.16+pulse*.08));rg.addColorStop(1,hexA(col,0));
  c.fillStyle=rg;c.globalAlpha=1;c.beginPath();c.arc(0,-35,55+pulse*12,0,Math.PI*2);c.fill();

  // Element-specific effect
  if(col.includes('ff4d')||eff.includes('burn')){
    // Fire: rising flame licks
    for(let i=0;i<7;i++){
      const a=(i/7)*Math.PI*2+fr*.08+i*.6;const r=24+pulse*8;
      c.globalAlpha=.3+pulse*.2;
      const sz=rnd(2.5,5);
      drawShape(c,'tear',Math.cos(a)*r,Math.sin(a)*r+Math.sin(fr*.15+i)*3,sz,col,1,a+Math.PI*.5);
    }
  } else if(eff.includes('stun')||ae.abbr==='LTN'||ae.abbr==='STM'){
    // Lightning corona
    c.globalAlpha=.42+pulse*.3;
    for(let i=0;i<8;i++){
      const a=(i/8)*Math.PI*2+fr*.14;
      c.strokeStyle=glow;c.lineWidth=1.5;c.shadowBlur=8;c.shadowColor=glow;
      c.beginPath();c.moveTo(Math.cos(a)*18,Math.sin(a)*18);
      c.lineTo(Math.cos(a)*(30+pulse*8)+rnd(-3,3),Math.sin(a)*(30+pulse*8)+rnd(-3,3));c.stroke();
    }
  } else if(ae.abbr==='ICE'||ae.abbr==='FRS'){
    // Ice crystals orbiting
    for(let i=0;i<5;i++){
      const a=(i/5)*Math.PI*2+fr*.022+i*.4;const r=26+i*3+pulse*6;
      c.globalAlpha=.55+pulse*.2;
      drawShape(c,'diamond',Math.cos(a)*r,Math.sin(a)*r,3.5+pulse,col,1,a+fr*.02);
    }
  } else if(ae.abbr==='VOD'||ae.abbr==='NTH'){
    // Void spiral
    for(let i=0;i<14;i++){
      const a=(i/14)*Math.PI*2+fr*.07;const r=16+i*2.5+pulse*10;
      c.globalAlpha=.28+pulse*.18;
      drawShape(c,'ring',Math.cos(a)*r,Math.sin(a)*r,2+i*.28,col,1);
    }
  } else if(ae.abbr==='SDW'){
    // Shadow tendrils
    for(let i=0;i<6;i++){
      const base=(i/6)*Math.PI*2,wave=Math.sin(fr*.09+i)*.85;
      c.globalAlpha=.52+pulse*.2;c.strokeStyle=col;c.lineWidth=2.5;c.lineCap='round';
      c.shadowBlur=10;c.shadowColor=col;
      c.beginPath();c.moveTo(0,0);
      const mx=Math.cos(base+wave)*18,my=Math.sin(base+wave)*18;
      c.quadraticCurveTo(mx,my,Math.cos(base+wave*1.5)*35,Math.sin(base+wave*1.5)*35);c.stroke();
      c.shadowBlur=0;
    }
  } else if(ae.abbr==='LGT'||ae.abbr==='AET'){
    // Holy nimbus above head
    const ng=c.createRadialGradient(0,-68,0,0,-68,40+pulse*12);
    ng.addColorStop(0,hexA(col,.45));ng.addColorStop(.55,hexA(col,.15));ng.addColorStop(1,hexA(col,0));
    c.fillStyle=ng;c.globalAlpha=1;
    c.beginPath();c.ellipse(0,-68,38+pulse*10,28+pulse*6,0,0,Math.PI*2);c.fill();
  } else if(ae.abbr==='CHO'||ae.abbr==='CHS'){
    // Chaos fractals
    const cols=['#ff4488','#8844ff','#44ffff','#ff8844'];
    for(let i=0;i<12;i++){
      const a=(i/12)*Math.PI*2+fr*.12;const r=18+rnd(-4,4)+pulse*8;
      c.globalAlpha=.38;
      drawShape(c,rndOf(['shard','bolt','star']),Math.cos(a)*r,Math.sin(a)*r,2.5+pulse,cols[i%4],1,a*2);
    }
  } else if(ae.abbr==='NAT'||ae.abbr==='DRD'){
    // Nature vine wrap
    c.globalAlpha=.55+pulse*.18;c.strokeStyle=col;c.lineWidth=2.5;c.lineCap='round';c.shadowBlur=8;c.shadowColor=col;
    for(let i=0;i<3;i++){
      const phase=(i/3)*Math.PI*2+fr*.05;
      c.beginPath();
      for(let t=0;t<Math.PI*2;t+=.18){
        const r=24+Math.sin(t*3+phase)*8+pulse*5;
        t===0?c.moveTo(Math.cos(t)*r,Math.sin(t)*r):c.lineTo(Math.cos(t)*r,Math.sin(t)*r);
      }c.stroke();
    }c.shadowBlur=0;
  } else if(ae.abbr==='BLD'){
    // Blood swirl
    for(let i=0;i<8;i++){
      const a=(i/8)*Math.PI*2+fr*.08;const r=22+pulse*10;
      c.globalAlpha=.52+pulse*.2;
      drawShape(c,'tear',Math.cos(a)*r,Math.sin(a)*r,2.8+pulse*.8,col,1,a+Math.PI);
    }
  } else if(ae.abbr==='ARC'){
    // Arcane sigil orbit
    for(let i=0;i<4;i++){
      const a=(i/4)*Math.PI*2+fr*.034;const r=32+pulse*6;
      c.globalAlpha=.6+pulse*.2;
      drawShape(c,'star',Math.cos(a)*r,Math.sin(a)*r,5.5,col,1,a+fr*.05);
    }
  } else {
    // Generic ring pulse
    for(let ri=0;ri<2;ri++){
      const rr=22+ri*14+pulse*8;
      c.globalAlpha=(.28-ri*.08)+pulse*.15;
      c.strokeStyle=col;c.lineWidth=1.5;
      c.beginPath();c.arc(0,-35,rr,0,Math.PI*2);c.stroke();
    }
  }

  // Secondary element orbits
  for(let ai=1;ai<Math.min(p.attrs.length,3);ai++){
    const ae2=ELEM[p.attrs[ai]];if(!ae2)continue;
    const a0=(ai/p.attrs.length)*Math.PI*2+fr*.038*ai;
    const r2=44+ai*8+pulse*6;
    c.globalAlpha=.28;
    drawShape(c,'ring',Math.cos(a0)*r2,Math.sin(a0)*r2-35,6,ae2.col,1,a0);
  }

  // Ult meter ring above head
  if(p.ultMeter>5){
    c.globalAlpha=(p.ultMeter/p.maxUlt)*.45;
    c.strokeStyle=p.ultMeter>=p.maxUlt?'#fff':'#c8a84b';
    c.lineWidth=2;c.shadowBlur=p.ultMeter>=p.maxUlt?10:0;c.shadowColor='#ffe87a';
    c.beginPath();c.arc(0,-66,14,-Math.PI*.5,-Math.PI*.5+(p.ultMeter/p.maxUlt)*Math.PI*2);c.stroke();
    c.shadowBlur=0;
  }

  // Frenzy flames
  if(p.frenzied){
    for(let i=0;i<10;i++){
      const a=(i/10)*Math.PI*2+fr*.18;
      c.globalAlpha=.55+pulse*.3;
      drawShape(c,'shard',Math.cos(a)*32,Math.sin(a)*32,4+pulse,'#ff2200',1,a);
    }
  }
  c.restore();
}

// ═══════════════════════════ STICKMAN ═══════════════════════════════
function drawStickman(p,fr){
  const{x,y,facing,depth:d,role,attrs,isDead,isHurt,hurtTimer,cstate}=p;
  const sc=p.skinColor||'#4488ff';
  const sc2=p.skinColor2||darken(sc,.35);
  const glow=attrs.length>0?ELEM[attrs[0]]?.glow:null;
  const eCol=attrs.length>0?ELEM[attrs[0]]?.col:null;

  ctx.save();ctx.translate(x,y);
  drawAura(ctx,p,fr);
  ctx.scale(d,d);
  if(isDead){ctx.rotate(facing*.52);ctx.translate(0,8);}

  // Hurt flash
  if(isHurt&&Math.floor(hurtTimer)%3===0){ctx.filter='brightness(3.5) saturate(0)';}

  // Absorb glow
  if(p.absorbedElem){
    ctx.shadowBlur=18;ctx.shadowColor=ELEM[p.absorbedElem]?.glow||'#fff';
  }

  const pose=getPose(p,fr);
  const LR=4.6,TR=5.6;

  // === BACK LAYER ===
  const bLegA=facing>0?pose.ullR:pose.ullL;
  const bShnA=facing>0?pose.shnR:pose.shnL;
  const bHipX=facing>0?4:-4;
  const bKnX=bHipX+Math.sin(bLegA*facing)*20,bKnY=pose.hipY+Math.cos(bLegA*facing)*20;
  const bFtX=bKnX+Math.sin((bLegA+bShnA)*facing)*18,bFtY=bKnY+Math.cos((bLegA+bShnA)*facing)*18;
  drawCapsule(ctx,bHipX,pose.hipY,bKnX,bKnY,LR,sc,sc2,null);
  drawCapsule(ctx,bKnX,bKnY,bFtX,bFtY,LR-.9,sc,sc2,null);
  drawJoint(ctx,bKnX,bKnY,LR*.85,sc,null);

  const bArmA=facing>0?pose.ulR:pose.ulL;
  const bFArmA=facing>0?pose.flR:pose.flL;
  const bShX=facing>0?pose.shldrX:-pose.shldrX;
  const bElX=bShX+Math.sin(bArmA*facing)*18,bElY=pose.shldrY+Math.cos(bArmA*facing)*18;
  const bHdX=bElX+Math.sin((bArmA+bFArmA)*facing)*15,bHdY=bElY+Math.cos((bArmA+bFArmA)*facing)*15;
  drawCapsule(ctx,bShX,pose.shldrY,bElX,bElY,LR-.6,sc,sc2,null);
  drawCapsule(ctx,bElX,bElY,bHdX,bHdY,LR-1.1,sc,sc2,null);
  drawJoint(ctx,bElX,bElY,LR*.78,sc,null);

  // === TORSO ===
  const isBlocking=cstate==='blocking';
  drawCapsule(ctx,0,pose.torsoY1,0,pose.torsoY2,TR,
    isBlocking?lighten(sc,.22):sc,sc2,glow,glow?12:0);
  drawCapsule(ctx,0,pose.torsoY1,0,pose.headY+11,3.8,sc,sc2,glow,glow?7:0);

  // === FRONT LAYER ===
  const fLegA=facing>0?pose.ullL:pose.ullR;
  const fShnA=facing>0?pose.shnL:pose.shnR;
  const fHipX=facing>0?-4:4;
  const fKnX=fHipX+Math.sin(fLegA*facing)*20,fKnY=pose.hipY+Math.cos(fLegA*facing)*20;
  const fFtX=fKnX+Math.sin((fLegA+fShnA)*facing)*18,fFtY=fKnY+Math.cos((fLegA+fShnA)*facing)*18;
  drawCapsule(ctx,fHipX,pose.hipY,fKnX,fKnY,LR,sc,sc2,glow,glow?5:0);
  drawCapsule(ctx,fKnX,fKnY,fFtX,fFtY,LR-.9,sc,sc2,glow,glow?4:0);
  drawJoint(ctx,fKnX,fKnY,LR,sc,glow);
  // Foot
  ctx.fillStyle=sc2;
  ctx.beginPath();ctx.ellipse(fFtX+facing*4,fFtY,7.5,4.2,0,0,Math.PI*2);ctx.fill();

  const fArmA=facing>0?pose.ulL:pose.ulR;
  const fFArmA=facing>0?pose.flL:pose.flR;
  const fShX=facing>0?-pose.shldrX:pose.shldrX;
  const fElX=fShX+Math.sin(fArmA*facing)*18,fElY=pose.shldrY+Math.cos(fArmA*facing)*18;
  const fHdX=fElX+Math.sin((fArmA+fFArmA)*facing)*15,fHdY=fElY+Math.cos((fArmA+fFArmA)*facing)*15;
  drawCapsule(ctx,fShX,pose.shldrY,fElX,fElY,LR-.6,sc,sc2,glow,glow?6:0);
  drawCapsule(ctx,fElX,fElY,fHdX,fHdY,LR-1.1,sc,sc2,glow,glow?5:0);
  drawJoint(ctx,fElX,fElY,LR*.88,sc,glow);

  // Shoulders
  drawJoint(ctx,bShX,pose.shldrY,LR-.55,sc,null);
  drawJoint(ctx,fShX,pose.shldrY,LR,sc,glow);

  // Head
  drawHead(ctx,0,pose.headY,12.5,sc,glow,facing,isDead);

  // Weapon
  drawWeapon(ctx,role,fHdX,fHdY,facing,eCol,fr);

  // Block shield arc
  if(isBlocking){
    ctx.save();
    const sf=p.blockFrames<6?'#ffffff':hexA(sc,.88);
    ctx.shadowBlur=22;ctx.shadowColor=sf;ctx.strokeStyle=sf;ctx.lineWidth=3.2;
    ctx.beginPath();ctx.arc(-facing*10,-44,24,Math.PI*.58,Math.PI*1.42);ctx.stroke();
    // Shield shimmer
    if(p.blockFrames<4){
      ctx.globalAlpha=.5*(1-p.blockFrames/4);ctx.strokeStyle='#ffffff';ctx.lineWidth=5;
      ctx.beginPath();ctx.arc(-facing*10,-44,24,Math.PI*.58,Math.PI*1.42);ctx.stroke();
    }
    ctx.restore();
  }

  // Absorbed element badge
  if(p.absorbedElem){
    const ae=ELEM[p.absorbedElem];
    ctx.fillStyle=hexA(ae.col,.88);ctx.strokeStyle=ae.glow;ctx.lineWidth=1;
    ctx.shadowBlur=10;ctx.shadowColor=ae.glow;
    ctx.beginPath();ctx.roundRect(fHdX-6,fHdY-9,22,13,3);ctx.fill();ctx.stroke();
    ctx.shadowBlur=0;ctx.font='bold 7px Share Tech Mono';ctx.textAlign='center';
    ctx.textBaseline='middle';ctx.fillStyle='#fff';ctx.fillText(ae.abbr,fHdX+5,fHdY-2);
  }

  ctx.filter='none';ctx.restore();

  // === HEALTH BARS (world space) ===
  if(!isDead){
    const bW=46*d,bH=3.5,bX=x-bW/2,bY=y-95*d;
    const hp=Math.max(0,p.hp/p.maxHp);
    const sta=Math.max(0,p.sta/p.maxSta);
    const hpCol=hp>.62?'#44ff88':hp>.3?'#ffcc00':'#ff4444';

    // HP
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(bX-1,bY-1,bW+2,bH+2);
    ctx.fillStyle=hpCol;ctx.fillRect(bX,bY,bW*hp,bH);
    if(p.shield>0){
      ctx.fillStyle='rgba(68,153,255,.85)';ctx.fillRect(bX,bY,bW*Math.min(1,p.shield/p.maxShield)*hp,bH*.45);
    }
    // STA
    ctx.fillStyle='rgba(0,0,0,.38)';ctx.fillRect(bX,bY+bH+1.5,bW,bH-1);
    ctx.fillStyle='#ffcc44';ctx.fillRect(bX,bY+bH+1.5,bW*sta,bH-1);
    // ULT
    ctx.fillStyle='rgba(0,0,0,.3)';ctx.fillRect(bX,bY+bH*2+3,bW,1.8);
    ctx.fillStyle=p.ultMeter>=p.maxUlt?'#fff':'#c8a84b';
    ctx.fillRect(bX,bY+bH*2+3,bW*(p.ultMeter/p.maxUlt),1.8);
    if(p.ultMeter>=p.maxUlt){
      ctx.globalAlpha=.6+.4*Math.sin(S.frame*.12);
      ctx.shadowBlur=8;ctx.shadowColor='#ffe87a';
      ctx.fillStyle='#ffe87a';ctx.fillRect(bX,bY+bH*2+3,bW,1.8);
      ctx.shadowBlur=0;ctx.globalAlpha=1;
    }

    // Name
    ctx.font=`bold ${Math.round(11*d)}px Rajdhani,sans-serif`;
    ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillText(p.name,x+1,bY-1);
    ctx.fillStyle='rgba(255,255,255,.72)';ctx.fillText(p.name,x,bY-2);

    // Role tag
    const r=ROLES[p.role];
    if(r){
      ctx.font=`bold ${Math.round(8*d)}px Share Tech Mono`;
      ctx.fillStyle=hexA(r.col,.72);ctx.fillText(r.abbr,x,bY-13*d);
    }
  }
}

// ═══════════════════════════ EFFECTS RENDERER ════════════════════
function drawEffects(){
  S.effects.forEach(ef=>{
    ctx.save();
    const t=ef.life/ef.maxLife;
    switch(ef.type){
      case'slash':{
        ctx.globalAlpha=t*.85;ctx.strokeStyle=ef.col;ctx.lineWidth=3.5*(0.5+t*.5);
        ctx.lineCap='round';ctx.shadowBlur=12;ctx.shadowColor=ef.col;
        ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*t,ef.ang-.72,ef.ang+.72);ctx.stroke();
        break;
      }
      case'hit_spark':{
        ctx.globalAlpha=t;
        for(let i=0;i<8;i++){
          const sa=(i/8)*Math.PI*2,sl=24*(1-t)+4;
          ctx.strokeStyle=ef.col;ctx.lineWidth=1.8;ctx.lineCap='round';
          ctx.shadowBlur=8;ctx.shadowColor=ef.col;
          ctx.beginPath();ctx.moveTo(ef.x+Math.cos(sa)*4,ef.y+Math.sin(sa)*4);
          ctx.lineTo(ef.x+Math.cos(sa)*sl,ef.y+Math.sin(sa)*sl);ctx.stroke();
        }
        break;
      }
      case'ring_expand':{
        ctx.globalAlpha=t*.75;ctx.strokeStyle=ef.col;ctx.lineWidth=2.2;
        ctx.shadowBlur=10;ctx.shadowColor=ef.col;
        ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(1-t*.85),0,Math.PI*2);ctx.stroke();
        break;
      }
      case'shield_ring':{
        ctx.globalAlpha=t*.65;ctx.strokeStyle=ef.col;ctx.lineWidth=3;
        ctx.shadowBlur=14;ctx.shadowColor=ef.col;
        ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(2-t)*.6,0,Math.PI*2);ctx.stroke();
        break;
      }
      case'text_float':{
        ctx.globalAlpha=t;ctx.font=`900 ${ef.fs||14}px Orbitron,sans-serif`;
        ctx.textAlign='center';ctx.fillStyle=ef.col;
        ctx.shadowBlur=10;ctx.shadowColor=ef.col;
        ctx.fillText(ef.text,ef.x,ef.y-(ef.maxLife-ef.life)*.45);
        break;
      }
      case'ground_pound':{
        const prog=1-t;
        ctx.globalAlpha=t*.5;ctx.strokeStyle=ef.col;ctx.lineWidth=1.5;
        ctx.shadowBlur=8;ctx.shadowColor=ef.col;
        for(let i=0;i<3;i++){
          ctx.beginPath();ctx.ellipse(ef.x,ef.y,ef.r*(prog+i*.12),ef.r*(prog+i*.12)*.3,0,0,Math.PI*2);ctx.stroke();
        }
        break;
      }
      case'shockwave':{
        ctx.globalAlpha=t*.6;ctx.strokeStyle=ef.col;ctx.lineWidth=3;
        ctx.shadowBlur=15;ctx.shadowColor=ef.col;
        ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(1-t),0,Math.PI*2);ctx.stroke();
        ctx.globalAlpha=t*.2;ctx.fillStyle=ef.col;
        ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(1-t),0,Math.PI*2);ctx.fill();
        break;
      }
    }
    ctx.restore();
  });
}

// ═══════════════════════════ HAZARDS / WELLS / BLOBS ═════════════
function drawHazards(){
  S.hazards.forEach(hz=>{
    const p2=.5+.5*Math.sin(S.frame*.08);
    const ec=ELEM[hz.elem]?.col||'#ff0000';
    ctx.save();ctx.globalAlpha=.42+p2*.18;
    ctx.strokeStyle=ec;ctx.lineWidth=2;ctx.shadowBlur=12;ctx.shadowColor=ec;
    ctx.beginPath();ctx.arc(hz.x,hz.y,hz.radius+p2*6,0,Math.PI*2);ctx.stroke();
    ctx.globalAlpha=.06+p2*.04;ctx.fillStyle=ec;
    ctx.beginPath();ctx.arc(hz.x,hz.y,hz.radius,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=.65+p2*.28;ctx.font=`bold ${hz.radius*.5}px Share Tech Mono`;
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=ec;ctx.shadowBlur=6;
    ctx.fillText(ELEM[hz.elem]?.abbr||'HZ',hz.x,hz.y);
    ctx.restore();
  });
}

function drawGravWells(){
  S.gravWells.forEach(w=>{
    const t=w.life/w.maxLife;
    ctx.save();
    const rg=ctx.createRadialGradient(w.x,w.y,0,w.x,w.y,w.radius);
    rg.addColorStop(0,`rgba(100,68,170,${t*.65})`);rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.beginPath();ctx.arc(w.x,w.y,w.radius,0,Math.PI*2);ctx.fill();
    for(let i=0;i<3;i++){
      const ang=S.frame*.06*(i%2===0?1:-1)+i*1.1;
      ctx.strokeStyle=`rgba(155,26,255,${t*(.75-i*.2)})`;ctx.lineWidth=2;
      ctx.shadowBlur=8;ctx.shadowColor='#9b1aff';
      ctx.beginPath();ctx.arc(w.x,w.y,w.radius*(.28+i*.24),ang,ang+Math.PI*1.45);ctx.stroke();
    }
    ctx.restore();
  });
}

function drawElemBlobs(){
  S.elements.forEach(e=>{
    const life=e.life/e.maxLife;
    const col=ELEM[e.elem]?.col||'#fff';
    ctx.save();ctx.globalAlpha=life*.35;
    const rg=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.radius);
    rg.addColorStop(0,col);rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.beginPath();ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

// ═══════════════════════════ PROJECTILES ═════════════════════════
function drawProjectiles(){
  S.projectiles.forEach(pr=>{
    const col=ELEM[pr.elem]?.col||'#fff';
    const glo=ELEM[pr.elem]?.glow||col;
    ctx.save();ctx.shadowBlur=16;ctx.shadowColor=glo;
    const ang=Math.atan2(pr.vy,pr.vx);
    ctx.translate(pr.x,pr.y);ctx.rotate(ang);
    ctx.fillStyle=col;ctx.globalAlpha=.92;
    ctx.beginPath();ctx.moveTo(pr.sz*2.8,0);ctx.lineTo(-pr.sz,pr.sz*.75);ctx.lineTo(-pr.sz,-pr.sz*.75);ctx.closePath();ctx.fill();
    // Trail glow
    const tg=ctx.createLinearGradient(0,0,-pr.sz*3.5,0);
    tg.addColorStop(0,hexA(glo,.45));tg.addColorStop(1,hexA(glo,0));
    ctx.fillStyle=tg;ctx.beginPath();ctx.ellipse(-pr.sz*2,0,pr.sz*3.5,pr.sz*.55,0,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

// ═══════════════════════════ PARTICLES ═══════════════════════════
function drawParticles(){
  // Batch by color to reduce state changes
  S.particles.forEach(p=>{
    if(p.alpha<=.015)return;
    drawShape(ctx,p.shape,p.x,p.y,p.sz,p.col,p.alpha,p.rot);
  });
}

// ═══════════════════════════ MENU CANVAS ═════════════════════════
const mc=document.getElementById('menu-canvas');
const mCtx=mc.getContext('2d');
let menuParts=[];

function startMenuFX(){
  mc.width=window.innerWidth;mc.height=window.innerHeight;
  window.addEventListener('resize',()=>{mc.width=window.innerWidth;mc.height=window.innerHeight;});
  menuParts=Array.from({length:100},mkMenuP);
  menuLoop();
}

function mkMenuP(){
  const k=rndOf(EKEYS);const e=ELEM[k];
  return{
    x:Math.random()*mc.width,y:Math.random()*mc.height,
    vx:(Math.random()-.5)*.42,vy:-Math.random()*.5-.06,
    sz:rnd(1.8,5.5),col:e.col,glow:e.glow,shape:rndOf(e.ps),
    alpha:rnd(.08,.45),decay:0,grav:-.008,drag:.99,
    rot:Math.random()*Math.PI*2,rspd:(Math.random()-.5)*.03,
    age:Math.random()*220,maxLife:rnd(130,380),
  };
}

function menuLoop(){
  if(S.page!=='menu'){requestAnimationFrame(menuLoop);return;}
  mCtx.clearRect(0,0,mc.width,mc.height);
  for(let i=menuParts.length-1;i>=0;i--){
    const p=menuParts[i];
    p.age++;p.x+=p.vx;p.y+=p.vy+p.grav*p.age*.01;p.rot+=p.rspd;
    const life=1-p.age/p.maxLife;
    if(p.age>p.maxLife){menuParts[i]=mkMenuP();menuParts[i].y=mc.height+10;continue;}
    drawShape(mCtx,p.shape,p.x,p.y,p.sz,p.col,p.alpha*life,p.rot);
  }
  requestAnimationFrame(menuLoop);
}

// ═══════════════════════════ EDITOR PREVIEW ══════════════════════
let _edFr=0,_edRunning=false;
const epc=document.getElementById('ed-preview');
const eCtx=epc?epc.getContext('2d'):null;

function startEdPreview(){
  if(_edRunning||!eCtx)return;
  _edRunning=true;edPreviewLoop();
}

function edPreviewLoop(){
  if(S.page!=='editor'){_edRunning=false;return;}
  _edFr++;
  eCtx.clearRect(0,0,epc.width,epc.height);
  // Background
  const bg=eCtx.createLinearGradient(0,0,0,epc.height);
  bg.addColorStop(0,'#020810');bg.addColorStop(1,'#08121e');
  eCtx.fillStyle=bg;eCtx.fillRect(0,0,epc.width,epc.height);
  // Grid
  eCtx.strokeStyle='rgba(200,168,75,.04)';eCtx.lineWidth=1;
  for(let i=0;i<epc.width;i+=16){eCtx.beginPath();eCtx.moveTo(i,0);eCtx.lineTo(i,epc.height);eCtx.stroke();}
  for(let i=0;i<epc.height;i+=16){eCtx.beginPath();eCtx.moveTo(0,i);eCtx.lineTo(epc.width,i);eCtx.stroke();}
  // Ground
  eCtx.strokeStyle='rgba(200,168,75,.15)';eCtx.lineWidth=1;
  eCtx.beginPath();eCtx.moveTo(0,epc.height-30);eCtx.lineTo(epc.width,epc.height-30);eCtx.stroke();

  const p=S.editPlayer;
  if(p){
    const px=p.x,py=p.y,pd=p.depth,pAT=p.animTime;
    p.x=epc.width/2;p.y=epc.height-30;p.depth=1;p.onGround=true;
    p.animTime=_edFr*.55;p.isDead=false;p.isHurt=false;p.cstate='idle';p.atkType=null;

    // Temporarily override ctx to draw into eCtx
    drawEdChar(eCtx,p,_edFr);

    p.x=px;p.y=py;p.depth=pd;p.animTime=pAT;
  }
  requestAnimationFrame(edPreviewLoop);
}

// Minimal stickman draw for editor canvas using eCtx
function drawEdChar(c,p,fr){
  const sc=p.skinColor||'#4488ff';
  const sc2=p.skinColor2||darken(sc,.35);
  const glow=p.attrs.length>0?ELEM[p.attrs[0]]?.glow:null;
  const eCol=p.attrs.length>0?ELEM[p.attrs[0]]?.col:null;
  const cx=p.x,cy=p.y;
  c.save();c.translate(cx,cy);
  // Aura glow
  if(p.attrs.length>0){
    const col=ELEM[p.attrs[0]]?.col;
    const pulse=.5+.5*Math.sin(fr*.065);
    const rg=c.createRadialGradient(0,-35,4,0,-35,52+pulse*10);
    rg.addColorStop(0,hexA(col,0));rg.addColorStop(.5,hexA(col,.18+pulse*.1));rg.addColorStop(1,hexA(col,0));
    c.fillStyle=rg;c.globalAlpha=1;c.beginPath();c.arc(0,-35,52+pulse*10,0,Math.PI*2);c.fill();
  }
  const pose=getPose(p,fr);
  const LR=4.6,TR=5.6;
  function cap(x1,y1,x2,y2,r,c1,c2,gl){
    c.save();if(gl){c.shadowBlur=7;c.shadowColor=gl;}
    const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1,ux=dx/len,uy=dy/len,nx=-uy,ny=ux,ang=Math.atan2(dy,dx);
    const grd=c.createLinearGradient(x1-nx*r*1.3,y1-ny*r*1.3,x1+nx*r*1.3,y1+ny*r*1.3);
    grd.addColorStop(0,lighten(c1,.4));grd.addColorStop(1,c2);
    c.beginPath();c.moveTo(x1+nx*r,y1+ny*r);c.lineTo(x2+nx*r,y2+ny*r);
    c.arc(x2,y2,r,ang-Math.PI*.5,ang+Math.PI*.5);c.lineTo(x1-nx*r,y1-ny*r);
    c.arc(x1,y1,r,ang+Math.PI*.5,ang-Math.PI*.5);c.closePath();c.fillStyle=grd;c.fill();
    if(gl)c.shadowBlur=0;c.restore();
  }
  // Back limbs
  cap(4,pose.hipY,4+Math.sin(pose.ullR)*20,pose.hipY+Math.cos(pose.ullR)*20,LR,sc,sc2,null);
  cap(pose.shldrX,pose.shldrY,pose.shldrX+Math.sin(pose.ulR)*18,pose.shldrY+Math.cos(pose.ulR)*18,LR-.6,sc,sc2,null);
  // Torso
  cap(0,pose.torsoY1,0,pose.torsoY2,TR,sc,sc2,glow,glow?10:0);
  cap(0,pose.torsoY1,0,pose.headY+11,3.6,sc,sc2,glow,glow?6:0);
  // Front limbs
  cap(-4,pose.hipY,-4+Math.sin(pose.ullL)*20,pose.hipY+Math.cos(pose.ullL)*20,LR,sc,sc2,glow,glow?4:0);
  cap(-pose.shldrX,pose.shldrY,-pose.shldrX+Math.sin(pose.ulL)*18,pose.shldrY+Math.cos(pose.ulL)*18,LR-.6,sc,sc2,glow,glow?5:0);
  // Head
  drawHead(c,0,pose.headY,12.5,sc,glow,1,false);
  c.restore();
}
</script>
<script>'use strict';
// stickbox_p3.js — PHYSICS · COMBAT · AI · PATHS
// ═══════════════════════════════════════════════════════════════════
const GRAVITY=0.54;

// ═══════════════════════════ TICK PARTICLES ════════════════════════
function tickParticles(){
  const sm=S.sm;
  S.particles=S.particles.filter(p=>{
    p.alpha-=p.decay*sm;
    if(p.scaleUp){p.sz+=p.scaleRate*sm;p.alpha-=.018*sm;}
    p.vx*=p.drag;p.vy*=p.drag;
    p.vy+=p.grav*sm;
    p.x+=p.vx*sm;p.y+=p.vy*sm;
    p.rot+=p.rspd*sm;
    return p.alpha>.015;
  });
  // Hard cap
  if(S.particles.length>PARTICLE_CAP)
    S.particles.splice(0,S.particles.length-PARTICLE_CAP);
}

// ═══════════════════════════ TICK PROJECTILES ══════════════════════
function tickProjectiles(){
  const sm=S.sm;
  S.projectiles=S.projectiles.filter(pr=>{
    pr.x+=pr.vx*sm;pr.y+=pr.vy*sm;pr.vy+=.05*sm;pr.life-=sm;
    // Light trail
    if(Math.random()<.55&&S.particles.length<PARTICLE_CAP){
      const e=ELEM[pr.elem];
      S.particles.push(mkParticle(pr.x,pr.y,rnd(-.3,.3),rnd(-.3,.3),
        rnd(1.5,3.5),e?.col||'#fff',e?.glow||'#fff','circle',
        .65,.025,0,1,0,0));
    }
    // Check player collision
    let hit=false;
    S.players.forEach(t=>{
      if(t.id===pr.owner||t.isDead||hit)return;
      if(Math.abs(t.x-pr.x)<28&&Math.abs(t.y-40-pr.y)<45){
        dealDmg(t,pr.dmg,pr.elem,pr.x,pr.y);
        spawnImpact(pr.x,pr.y,pr.elem,.75);hit=true;
      }
    });
    return !hit&&pr.life>0&&pr.y<gc.height+60;
  });
}

// ═══════════════════════════ TICK EFFECTS ════════════════════════
function tickEffects(){
  const sm=S.sm;
  S.effects=S.effects.filter(ef=>{ef.life-=sm;return ef.life>0;});
}

// ═══════════════════════════ TICK ELEMENTS ════════════════════════
function tickElements(){
  const sm=S.sm;
  S.elements=S.elements.filter(e=>{
    e.life-=sm;
    // Ambient particles from active blobs
    if(e.life>0&&Math.random()<.04&&S.particles.length<PARTICLE_CAP-5)
      spawnEP(e.x+(Math.random()-.5)*e.radius,e.y+(Math.random()-.5)*e.radius,e.elem,2);
    return e.life>0;
  });
}

// ═══════════════════════════ TICK GRAVITY WELLS ═══════════════════
function tickGravWells(){
  const sm=S.sm;
  S.gravWells=S.gravWells.filter(w=>{
    w.life-=sm;
    if(w.life>0&&Math.random()<.25&&S.particles.length<PARTICLE_CAP-3)
      spawnEP(w.x+(Math.random()-.5)*w.radius*.5,w.y+(Math.random()-.5)*w.radius*.5,'void',2);
    S.players.forEach(p=>{
      if(p.isDead)return;
      const dx=w.x-p.x,dy=w.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<w.radius&&d>4){p.vx+=(dx/d)*w.str*.12*sm;p.vy+=(dy/d)*w.str*.12*sm;}
    });
    return w.life>0;
  });
}

// ═══════════════════════════ TICK STATUS EFFECTS ══════════════════
function tickStatus(){
  const sm=S.sm,fr=S.frame;
  S.players.forEach(p=>{
    if(!p.statusFX)return;
    p.statusFX=p.statusFX.filter(fx=>{
      fx.dur-=sm;
      if(fx.dur<=0)return false;
      if(fx.type==='burn'&&fr%58<1)dealDmg(p,fx.str||3,'fire',p.x,p.y-30,true);
      if(fx.type==='bleed'&&fr%44<1)dealDmg(p,fx.str||4,'blood',p.x,p.y-30,true);
      if(fx.type==='dot'&&fr%30<1)dealDmg(p,fx.str||5,fx.elem||'poison',p.x,p.y-30,true);
      if(fx.type==='heal_dot'&&fr%40<1){p.hp=Math.min(p.maxHp,p.hp+(fx.str||6));spawnEP(p.x,p.y-30,'nature',3);}
      return true;
    });

    if(p.isDead)return;
    // Role passives
    if(p.role==='druid'&&fr%60<1)p.hp=Math.min(p.maxHp,p.hp+1);
    if(p.role==='paladin'&&fr%90<1)p.hp=Math.min(p.maxHp,p.hp+.55);
    if(p.role==='support'){
      S.players.forEach(t=>{
        if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<125)
          t.hp=Math.min(t.maxHp,t.hp+.01*sm);
      });
    }
    // Shield regen
    if(p.specials?.shieldRegen)p.shield=Math.min(p.maxShield,p.shield+.04*sm);
    // Stamina regen
    p.sta=Math.min(p.maxSta,p.sta+.28*sm);
    // Stagger decay
    if(p.stagger>0)p.stagger=Math.max(0,p.stagger-.42*sm);
    // Cooldowns
    for(const k in p.cds)if(p.cds[k]>0)p.cds[k]-=sm;
    // Hurt timer
    if(p.isHurt){p.hurtTimer-=sm;if(p.hurtTimer<=0){p.isHurt=false;p.hurtTimer=0;}}
    // Inv frames
    if(p.invFrames>0)p.invFrames-=sm;
    // Ult passive gain
    p.ultMeter=Math.min(p.maxUlt,p.ultMeter+.018*sm);
    // Berserker rage scaling
    if(p.role==='berserker'){
      const ratio=1-(p.hp/p.maxHp);p._rageAtk=p.atk*(1+ratio*2.2);
    }
  });
}

// ═══════════════════════════ TICK HAZARDS ════════════════════════
function tickHazards(){
  S.hazards.forEach(hz=>{
    S.players.forEach(p=>{
      if(p.isDead)return;
      if(dist(p.x,p.y,hz.x,hz.y)<hz.radius+22){
        p.hp=Math.max(0,p.hp-.07);
        if(Math.random()<.04)spawnEP(p.x,p.y-20,hz.elem,2);
        if(p.hp<=0&&!p.isDead)killPlayer(p);
      }
    });
  });
}

// ═══════════════════════════ STATUS HELPERS ═══════════════════════
function addStatus(target,fx){
  if(!target.statusFX)target.statusFX=[];
  target.statusFX=target.statusFX.filter(s=>s.type!==fx.type);
  target.statusFX.push({...fx});
}
function hasStatus(p,type){return p.statusFX&&p.statusFX.some(s=>s.type===type);}
function stunPlayer(p,dur){
  if(p.cstate==='stunned'){p.stunTimer=(p.stunTimer||0)+dur;}
  else{p.cstate='stunned';p.stunTimer=dur;}
}
function applyElemEffect(target,elemKey,dmg){
  const e=ELEM[elemKey];if(!e)return;
  switch(e.eff){
    case'burn':addStatus(target,{type:'burn',dur:180,str:Math.max(1,dmg*.14)});break;
    case'burn_heavy':addStatus(target,{type:'burn',dur:300,str:Math.max(2,dmg*.2)});break;
    case'slow':target.vx*=.3;target.spd=Math.max(1,target.spd*.62);setTimeout(()=>{if(target)target.spd=ROLES[target.role]?.spd||4;},2000);break;
    case'slow_heavy':addStatus(target,{type:'slow',dur:240});target.vx*=.25;break;
    case'stun_brief':stunPlayer(target,55);break;
    case'stun_mid':stunPlayer(target,115);break;
    case'freeze_3s':addStatus(target,{type:'freeze',dur:180});stunPlayer(target,180);spawnEP(target.x,target.y-40,'ice',14);break;
    case'knockdown':target.vy=-8;target.vx*=.45;target.onGround=false;break;
    case'knockback':target.vx+=(target.x>= gc.width/2?1:-1)*12;target.vy=-7;break;
    case'pull':target.vx*=.5;break;
    case'bleed_5s':addStatus(target,{type:'bleed',dur:300,str:Math.max(1,dmg*.1)});break;
    case'dot_6s':addStatus(target,{type:'dot',dur:360,str:2,elem:elemKey});break;
    case'dot_heavy':addStatus(target,{type:'dot',dur:420,str:4,elem:elemKey});break;
    case'armor_pen':target.def=Math.max(0,target.def-5);setTimeout(()=>{if(target)target.def=ROLES[target.role]?.def||5;},3000);break;
    case'armor_shred':target.def=Math.max(0,target.def-8);break;
    case'chain':chainLightning(target,dmg*.65,2);break;
    case'chain_dmg':chainLightning(target,dmg*.72,3);break;
    case'heal_dot':addStatus(target,{type:'heal_dot',dur:240,str:6});break;
    case'doom':addStatus(target,{type:'doom',dur:300,str:dmg*.5});spawnTextFX(target.x,target.y-75,'DOOM','#440066',22);break;
  }
}

function chainLightning(origin,dmg,jumps){
  if(jumps<=0)return;
  let near=null,nd=220;
  S.players.forEach(t=>{
    if(t.id===origin.id||t.isDead)return;
    const d=dist(origin.x,origin.y,t.x,t.y);if(d<nd){nd=d;near=t;}
  });
  if(!near)return;
  // Bolt particles
  for(let i=0;i<10;i++){
    const t=i/10;
    const bx=lerp(origin.x,near.x,t)+(Math.random()-.5)*22;
    const by=lerp(origin.y-40,near.y-40,t)+(Math.random()-.5)*22;
    if(S.particles.length<PARTICLE_CAP)
      S.particles.push(mkParticle(bx,by,0,0,2.2,'#ffe01a','#fff07a','circle',.95,.09,0,1,0,0));
  }
  dealDmg(near,Math.round(dmg),'lightning',near.x,near.y-40);
  setTimeout(()=>chainLightning(near,dmg*.62,jumps-1),75);
}

// ═══════════════════════════ DAMAGE ══════════════════════════════
function dealDmg(target,dmg,elemKey,fx,fy,isDot=false){
  if(target.isDead||target.invFrames>0)return;
  const e=ELEM[elemKey];
  let reduced=Math.max(1,Math.round(dmg-target.def));
  if(target.shield>0){const abs=Math.min(target.shield,reduced);target.shield-=abs;reduced-=abs;}
  target.hp=Math.max(0,target.hp-reduced);
  target.isHurt=true;target.hurtTimer=10;
  if(!isDot){
    dmgNum(fx,fy-10,reduced,e?.col);
    S.effects.push({type:'ring_expand',x:fx,y:fy,r:28,col:e?.col||'#fff',life:14,maxLife:14});
  }
  applyElemEffect(target,elemKey,reduced);
  if(target.hp<=0)killPlayer(target);
}

function killPlayer(p){
  if(p.isDead)return;
  p.isDead=true;p.cstate='dead';
  // Death burst
  for(let i=0;i<55;i++){
    const e=p.attrs[Math.floor(Math.random()*Math.max(1,p.attrs.length))]||'fire';
    spawnEP(p.x+(Math.random()-.5)*30,p.y-30+(Math.random()-.5)*30,e,2);
  }
  flash(.42);
  spawnTextFX(p.x,p.y-85,'KO!','#ff4444',28);
  notify(`${p.name} DEFEATED`,'#ff4444');
  // Necro passive
  S.players.forEach(pl=>{if(pl.role==='necromancer'&&pl.id!==p.id&&!pl.isDead)pl.ultMeter=Math.min(pl.maxUlt,pl.ultMeter+22);});
  refreshHUD();
}

function respawnPlayer(p){
  p.hp=p.maxHp;p.isDead=false;p.cstate='idle';
  p.x=80+Math.random()*(gc.width-160);p.y=GY()-60*p.depth;
  p.vx=0;p.vy=0;p.shield=0;p.stagger=0;p.statusFX=[];p.absorbedElem=null;
  spawnEP(p.x,p.y-30,p.attrs[0]||'wind',22);
  notify(`${p.name} RESPAWNED`);refreshHUD();
}

function spawnTextFX(x,y,text,col,fs=16){
  S.effects.push({type:'text_float',x,y,text,col,fs,life:58,maxLife:58});
}

// ═══════════════════════════ ATTACK SYSTEM ════════════════════════
function startAttack(p,type,dur){
  p.cstate='attacking';p.atkType=type;
  p.atkFrame=0;p.atkMax=dur;
  p.hitSet=new Set();
  switch(type){
    case'light': p.activeFrames=[4,10];break;
    case'heavy': p.activeFrames=[10,22];break;
    case'special':p.activeFrames=[6,20];break;
    case'ult':   p.activeFrames=[0,dur];break;
  }
  // Combo tracking
  const now=S.frame;
  if(type==='light'&&(now-p.lastLightAt)<38)p.comboStep=Math.min(p.comboStep+1,5);
  else p.comboStep=0;
  p.lastLightAt=now;

  const col=ELEM[p.attrs[0]||S.selElem]?.col||p.skinColor;
  S.effects.push({type:'slash',x:p.x+p.facing*32,y:p.y-40,r:30,col,ang:p.facing*.32,life:12,maxLife:12});
}

function doMeleeHit(attacker){
  const range=attacker.atkType==='heavy'?72:52;
  S.players.forEach(t=>{
    if(t.id===attacker.id||t.isDead||attacker.hitSet.has(t.id))return;
    if(Math.abs(attacker.x-t.x)>range+8||Math.abs(attacker.y-t.y)>52)return;
    attacker.hitSet.add(t.id);

    // Parry / block check
    const blocked=t.cstate==='blocking'&&(t.x-attacker.x)*attacker.facing>-18;
    if(blocked){
      if(t.role==='templar'&&t.blockFrames<8){
        const pdmg=Math.floor(attacker.atk*2.2);
        dealDmg(attacker,pdmg,t.attrs[0]||'order',attacker.x,attacker.y-40);
        notify(`${t.name} PERFECT PARRY — ${pdmg} REFLECTED`,'#e8e8ff');
        flash(.42);t.ultMeter=Math.min(t.maxUlt,t.ultMeter+28);
      } else {
        attacker.stagger=Math.min(attacker.maxStagger,attacker.stagger+35);
        spawnEP(t.x,t.y-40,'order',10);notify(`${t.name} BLOCKED!`,'#aabbff');
      }
      return;
    }

    // Base damage
    let baseDmg=attacker.atkType==='heavy'?attacker.atk*1.85:attacker.atk;
    if(attacker.role==='berserker'&&attacker._rageAtk)
      baseDmg=attacker._rageAtk*(attacker.atkType==='heavy'?1.65:1);
    if(attacker.role==='fighter')baseDmg*=(1+attacker.comboStep*.06);

    // Crit
    const isCrit=(attacker.role==='assassin'||attacker.role==='rogue')&&Math.random()<.22;
    if(isCrit){baseDmg*=2;flash(.3);}

    // Backstab (behind target)
    const behind=t.facing===attacker.facing;
    if(behind&&attacker.role==='assassin')baseDmg*=3;

    const elem=attacker.attrs[0]||S.selElem;
    dealDmg(t,Math.round(baseDmg),elem,t.x,t.y-40);

    // Knockback
    const kbForce=attacker.atkType==='heavy'?8.5:4.5;
    t.vx+=attacker.facing*kbForce;t.vy=-4.5;

    // Lifesteal
    if(attacker.specials?.lifesteal)attacker.hp=Math.min(attacker.maxHp,attacker.hp+baseDmg*.16);

    t.stagger=Math.min(t.maxStagger,t.stagger+22);
    attacker.ultMeter=Math.min(attacker.maxUlt,attacker.ultMeter+7);

    // Hitstop
    t.hitstopTimer=attacker.atkType==='heavy'?6:3;

    // Sparks
    const ec=ELEM[elem];
    S.effects.push({type:'hit_spark',x:t.x,y:t.y-40,col:ec?.glow||'#fff',life:12,maxLife:12});

    // Combo check
    const combo=checkCombo(attacker,t,elem);
    if(combo)triggerCombo(combo,(attacker.x+t.x)/2,(attacker.y+t.y)/2-38);

    if(isCrit)spawnTextFX(t.x,t.y-65,'CRIT!','#ffff44',20);
    if(behind&&attacker.role==='assassin')spawnTextFX(t.x,t.y-65,'BACKSTAB!','#cc44ff',18);
    incrCombo();
  });
}

function checkCombo(attacker,target,selElem){
  const elems=[selElem,...(attacker.attrs||[])];
  for(const ae of elems){
    for(const te of (target.attrs||[])){
      const c=COMBOS[`${ae}+${te}`];if(c)return c;
    }
  }
  return null;
}

function triggerCombo(combo,x,y){
  notify(`✦ ${combo.name.toUpperCase()}!`,'#c8a84b');
  flash(.42,80);
  if(combo.aoe>0){
    S.players.forEach(t=>{
      if(!t.isDead&&dist(t.x,t.y,x,y)<combo.aoe)
        dealDmg(t,combo.dmg,combo.result,t.x,t.y-40);
    });
  }
  spawnImpact(x,y,combo.result,1.6);
  // Special combo effects
  const eff=combo.eff||'';
  if(eff.includes('pull_all')||eff.includes('crush_all'))
    S.gravWells.push({x,y,radius:combo.aoe||200,str:7,life:130,maxLife:130});
  if(eff==='stop_all'){
    S.players.forEach(t=>{if(!t.isDead)stunPlayer(t,190);});
    S.sm=.12;setTimeout(()=>{S.sm=S.slowmo?.22:1;},3000);
  }
  if(eff.includes('chain'))chainLightning({x,y,id:-1},combo.dmg*.5,4);
  if(eff==='reality_break'){
    for(let i=0;i<7;i++)setTimeout(()=>{
      const rx=x+(Math.random()-.5)*420,ry=Math.random()*gc.height*.8;
      spawnImpact(rx,ry,'chaos',.85);
      S.players.forEach(t=>{if(!t.isDead&&dist(t.x,t.y,rx,ry)<85)dealDmg(t,42,'chaos',t.x,t.y-40);});
    },i*110);
  }
  spawnTextFX(x,y-45,combo.name,combo.flash||'#c8a84b',15);
  incrCombo(combo.name);
}

function incrCombo(name=null){
  S.combo++;clearTimeout(S.comboTimer);
  const el=document.getElementById('combo-hud');
  const num=document.getElementById('combo-num');
  if(S.combo>=2){
    num.textContent=S.combo;el.classList.add('show');
    const sc=Math.min(1+S.combo*.025,1.7);
    el.style.transform=`translateX(-50%) scale(${sc})`;
  }
  S.comboTimer=setTimeout(()=>{el.classList.remove('show');S.combo=0;},2000);
}

// ═══════════════════════════ ABILITIES ═══════════════════════════
function findNearest(p,maxD=320){
  let near=null,nd=maxD;
  S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){const d=dist(p.x,p.y,t.x,t.y);if(d<nd){nd=d;near=t;}}});
  return near;
}

function useAbility(p,slot){
  const key=p.abils[slot];if(!key)return;
  const ab=ABIL[key];if(!ab)return;
  const cost=ab.cost||0;
  if(p.sta<cost){notify(`${p.name}: LOW STAMINA`,'#ff8844');return;}
  p.sta-=cost;p.cds[slot]=ab.cd||60;
  const elem=p.attrs[0]||S.selElem;
  notify(`${p.name} — ${ab.name.toUpperCase()}`);
  spawnEP(p.x,p.y-35,elem,8);

  switch(key){
    case'triple_slash':
      startAttack(p,'special',28);
      setTimeout(()=>{if(!p.isDead)startAttack(p,'light',14);},180);
      setTimeout(()=>{if(!p.isDead)startAttack(p,'light',14);},340);
      break;
    case'shadow_step':{
      const nt=findNearest(p,500);
      if(nt){spawnEP(p.x,p.y-30,'shadow',14);p.x=nt.x-nt.facing*44;p.y=nt.y;p.invFrames=22;spawnEP(p.x,p.y-30,'shadow',14);}
      break;
    }
    case'barrier':
      p.shield=p.maxShield*1.5;
      S.effects.push({type:'shield_ring',x:p.x,y:p.y-40,r:52,col:ELEM[elem]?.col||'#4488ff',life:280,maxLife:280});
      spawnEP(p.x,p.y-40,elem,16);break;
    case'elem_bolt':
      for(let i=-1;i<=1;i++){
        S.projectiles.push({x:p.x,y:p.y-42,vx:p.facing*13+i*.5,vy:-1+i*.5,elem,dmg:p.atk*1.45,sz:5,owner:p.id,life:88});
      }break;
    case'frenzy':
      p.frenzied=true;setTimeout(()=>{if(p)p.frenzied=false;},3000);break;
    case'consecrate':{
      const hx=p.x+p.facing*60,hy=p.y;
      S.hazards.push({x:hx,y:hy,radius:58,elem:'light',life:320});spawnEP(hx,hy,'light',22);break;
    }
    case'shield_bash':{
      const t=findNearest(p,85);
      if(t){dealDmg(t,p.atk*.85,'order',t.x,t.y-40);stunPlayer(t,95);t.vx=p.facing*11;}
      spawnEP(p.x+p.facing*32,p.y-40,'metal',12);break;
    }
    case'smoke_bomb':
      for(let i=0;i<32;i++){
        if(S.particles.length<PARTICLE_CAP)
          S.particles.push(mkParticle(p.x+(Math.random()-.5)*80,p.y-20+(Math.random()-.5)*60,
            (Math.random()-.5)*1.4,-Math.random()*.9,rnd(7,15),'#888899','#aaaacc','circle',.52,.005,-0.018,.99,0,0));
      }
      p.invFrames=85;break;
    case'bone_spear':
      S.projectiles.push({x:p.x,y:p.y-42,vx:p.facing*17,vy:0,elem:'shadow',dmg:p.atk*2.3,sz:6,owner:p.id,life:72});break;
    case'entangle':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<135){stunPlayer(t,125);addStatus(t,{type:'slow',dur:125});spawnEP(t.x,t.y-20,'nature',10);}});break;
    case'backstab':{const bt=findNearest(p,72);if(bt){const d=p.atk*3.1;dealDmg(bt,d,'shadow',bt.x,bt.y-40);spawnTextFX(bt.x,bt.y-70,'BACKSTAB!','#cc44ff',18);}break;}
    case'judgement':{const jt=findNearest(p,115);if(jt){const jd=p.atk*2.1+(jt.statusFX?.length||0)*9;dealDmg(jt,jd,'light',jt.x,jt.y-40);spawnTextFX(jt.x,jt.y-70,'JUDGED','#fffaaa',16);}break;}
    case'war_cry':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<165){const oa=t.atk;t.atk=Math.round(t.atk*1.22);setTimeout(()=>{if(t)t.atk=oa;},5000);}});
      spawnEP(p.x,p.y-40,'fire',22);spawnTextFX(p.x,p.y-82,'WAR CRY!','#ff8844',18);break;
    case'life_drain':{const lt=findNearest(p,105);if(lt){const ld=p.atk*1.55;dealDmg(lt,ld,'blood',lt.x,lt.y-40);p.hp=Math.min(p.maxHp,p.hp+ld*.52);}break;}
    case'reflect':addStatus(p,{type:'reflect',dur:125});spawnTextFX(p.x,p.y-60,'REFLECT!','#e8e8ff',14);break;
    case'cheap_shot':{const ct=findNearest(p,82);if(ct){stunPlayer(ct,95);dealDmg(ct,p.atk,'sonic',ct.x,ct.y-40);}break;}
    case'rally':
      S.players.forEach(t=>{if(!t.isDead&&dist(p.x,p.y,t.x,t.y)<185){t.hp=Math.min(t.maxHp,t.hp+32);spawnEP(t.x,t.y-30,'nature',7);}});
      spawnTextFX(p.x,p.y-82,'RALLY!','#44ff88',18);break;
    case'blood_lust':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<125){const b=9;dealDmg(t,b,'blood',t.x,t.y-40);p.hp=Math.min(p.maxHp,p.hp+b*.52);}});break;
    case'holy_shield':p.shield=p.maxShield*2.2;addStatus(p,{type:'holy_shield',dur:185});spawnEP(p.x,p.y-40,'light',18);break;
    case'elem_familiar':S.projectiles.push({x:p.x,y:p.y-40,vx:p.facing*6,vy:-3,elem,dmg:p.atk*.85,sz:9,owner:p.id,life:130,isFam:true});break;
    case'mana_shield':addStatus(p,{type:'mana_shield',dur:250});p.shield=p.maxShield*1.6;break;
    case'animal_form':
      const oa=p.atk,os=p.spd;p.spd*=1.85;p.atk=Math.round(p.atk*1.45);
      addStatus(p,{type:'transformed',dur:300});spawnTextFX(p.x,p.y-72,'ANIMAL FORM!','#44aa22',16);
      setTimeout(()=>{if(p){p.spd=os;p.atk=oa;}},5000);break;
    case'summon_shade':spawnMinion(p,'SHADE',elem);break;
    default:break;
  }
}

function useUltimate(p){
  if(p.ultMeter<p.maxUlt)return;
  p.ultMeter=0;p.cds.ult=320;
  const key=p.abils.ult;
  const ab=ABIL[key];
  notify(`${p.name} — ${ab?.name?.toUpperCase()||'ULTIMATE'}!`,'#c8a84b');
  flash(.6);spawnEP(p.x,p.y-40,p.attrs[0]||S.selElem,28);
  const elem=p.attrs[0]||S.selElem;

  switch(key){
    case'blade_storm':
      startAttack(p,'ult',88);
      for(let i=0;i<18;i++)setTimeout(()=>{
        if(!p.isDead){
          const a=(i/18)*Math.PI*2;const sx=p.x+Math.cos(a)*72,sy=p.y-42+Math.sin(a)*42;
          spawnEP(sx,sy,elem,5);
          S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,sx,sy)<46)dealDmg(t,p.atk*.62,elem,t.x,t.y-40);});
        }
      },i*80);break;
    case'iron_fortress':
      p.invFrames=250;p.shield=p.maxShield*5.5;addStatus(p,{type:'fortress',dur:250});
      spawnTextFX(p.x,p.y-92,'IRON FORTRESS','#4488ff',18);
      for(let i=0;i<32;i++)spawnEP(p.x,p.y-40,'metal',2);break;
    case'death_mark':{
      const dt=findNearest(p,600);
      if(dt){addStatus(dt,{type:'doom',dur:300,str:dt.hp*.52});spawnTextFX(dt.x,dt.y-82,'DEATH MARK','#cc44ff',18);}
      break;
    }
    case'mass_heal':
      S.players.forEach(t=>{if(!t.isDead){t.hp=t.maxHp;spawnEP(t.x,t.y-32,'light',16);}});
      spawnTextFX(p.x,p.y-92,'MASS HEAL','#44ff88',20);break;
    case'elem_nova':
      for(let i=0;i<26;i++)setTimeout(()=>{
        const a=(i/26)*Math.PI*2,r=82+Math.random()*42;
        const sx=p.x+Math.cos(a)*r,sy=p.y-42+Math.sin(a)*r;
        spawnImpact(sx,sy,elem,.72);
        S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,sx,sy)<62)dealDmg(t,p.atk*1.45,elem,t.x,t.y-40);});
      },i*55);break;
    case'berserker_rage':
      const oa=p.atk;p.frenzied=true;p.invFrames=32;p.atk=Math.round(p.atk*3.2);
      addStatus(p,{type:'berserk',dur:360});spawnTextFX(p.x,p.y-92,'BERSERKER RAGE','#ff2200',18);
      setTimeout(()=>{if(p){p.frenzied=false;p.atk=oa;}},6000);break;
    case'divine_judgment':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){const jd=p.atk*3.2+(t.statusFX?.length||0)*14;dealDmg(t,jd,'light',t.x,t.y-40);for(let i=0;i<8;i++)setTimeout(()=>spawnEP(t.x,t.y-40,'light',5),i*38);}});
      flash(.72);break;
    case'assassination':{
      const at=findNearest(p,650);
      if(at){if(at.hp/at.maxHp<.3){killPlayer(at);spawnTextFX(at.x,at.y-92,'EXECUTED','#cc44ff',24);}else dealDmg(at,Math.round(at.maxHp*.82),'shadow',at.x,at.y-40);}
      break;
    }
    case'death_wave':
      for(let w=0;w<gc.width;w+=18){setTimeout(()=>{const wy=GY();S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&Math.abs(t.x-w)<28)dealDmg(t,p.atk*1.65,'shadow',t.x,t.y-40);});spawnEP(w,wy,'shadow',3);},(w/gc.width)*1300);}break;
    case'nature_wrath':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){dealDmg(t,p.atk*2.1,'nature',t.x,t.y-40);stunPlayer(t,125);addStatus(t,{type:'dot',dur:310,str:5,elem:'nature'});spawnEP(t.x,t.y-22,'nature',18);}});
      spawnTextFX(p.x,p.y-92,'NATURE WRATH','#44aa22',20);break;
    case'divine_wrath':
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){const sins=(t.statusFX?.length||0)*16;dealDmg(t,p.atk*2.6+sins,'order',t.x,t.y-40);spawnEP(t.x,t.y-40,'order',16);}});break;
    case'summon_legion':
      for(let i=0;i<3;i++)setTimeout(()=>spawnMinion(p,'LEGION',elem),i*320);break;
    default:
      spawnImpact(p.x,p.y-42,elem,2.2);
      S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<125)dealDmg(t,p.atk*2.6,elem,t.x,t.y-40);});break;
  }
}

function spawnMinion(owner,type,elem){
  const m=mkPlayer(owner.x+owner.facing*44,owner.y,{name:type,role:'fighter',attrs:[elem],hp:42,atk:9,def:0,spd:5});
  m.isAI=true;m.aiOwner=owner.id;m.skinColor='#6633aa';m.depth=.74;
  S.players.push(m);refreshHUD();
  notify(`${owner.name} — ${type} SUMMONED!`);
}

// ═══════════════════════════ ELEMENT PLACEMENT ══════════════════
function placeElement(x,y){
  const sel=S.selElem;
  if(sel==='eraser'){
    S.elements=S.elements.filter(e=>dist(e.x,e.y,x,y)>32);
    S.hazards=S.hazards.filter(e=>dist(e.x,e.y,x,y)>55);
    return;
  }
  if(sel==='hazard'){
    S.hazards.push({x,y,radius:48,elem:'fire',life:-1});spawnEP(x,y,'fire',10);return;
  }
  const ec=ELEM[sel];if(!ec)return;
  spawnEP(x,y,sel,ec.cnt);

  S.players.forEach(p=>{
    if(p.isDead||dist(p.x,p.y,x,y)>70)return;
    if(p.absorbOn&&!p.absorbedElem){
      p.absorbedElem=sel;notify(`${p.name} ABSORBED ${ELEM[sel]?.abbr}!`);spawnEP(p.x,p.y-32,sel,12);
    } else {
      dealDmg(p,ec.dmg,sel,p.x,p.y-42);
    }
    if(sel==='wind'){const d=dist(p.x,p.y,x,y)||1;p.vx+=(p.x-x)/d*11;p.vy+=(p.y-y)/d*9-3;}
    if(sel==='water')p.vx*=.28;
    if(sel==='lightning')chainLightning({x,y,id:-999},ec.dmg*.62,2);
    if(sel==='gravity'||sel==='magnet')S.players.forEach(t=>{if(!t.isDead&&dist(t.x,t.y,x,y)<125)t.vx+=(x-t.x)*.065;});
    refreshHUD();
  });

  // Blob vs existing blobs for combos
  S.elements.forEach(e=>{
    if(e.elem!==sel&&dist(e.x,e.y,x,y)<58){
      const c=COMBOS[`${e.elem}+${sel}`];
      if(c){triggerCombo(c,(e.x+x)/2,(e.y+y)/2);e.life=0;}
    }
  });
  S.elements.push({x,y,elem:sel,life:125,maxLife:125,radius:26});
}

function releaseAbsorbed(p,mode){
  if(!p.absorbedElem)return;
  const ae=p.absorbedElem,ec=ELEM[ae];
  if(mode==='burst'){
    spawnImpact(p.x,p.y-42,ae,1.6);
    S.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<85)dealDmg(t,ec.dmg*2.1,ae,t.x,t.y-40);});
  } else {
    S.projectiles.push({x:p.x,y:p.y-42,vx:p.facing*16,vy:-1,elem:ae,dmg:ec.dmg*1.55,sz:6,owner:p.id,life:82});
  }
  notify(`${p.name} FIRED ${ec.abbr}!`);p.absorbedElem=null;refreshHUD();
}

// ═══════════════════════════ PATHS / MOVES ═══════════════════════
// Paths are HIDDEN — no visual when triggered; they execute as silent custom moves

function bindMove(player,key,pts,elem,type){
  if(player.isDead)return; // safety — can't bind while dead anyway
  const smooth=catmull(pts,.5,7);
  if(!player._moves)player._moves={};
  player._moves[key]={pts,smooth,elem,type};
  // Sync to global display for editor
  if(!S.moves[player.id])S.moves[player.id]={};
  S.moves[player.id][key]={elem,type,len:pts.length};
}

function triggerMove(player,key){
  if(player.isDead){return;} // disabled on death
  const mv=player._moves?.[key];
  if(!mv||!mv.smooth||mv.smooth.length<2){
    notify(`${player.name}: NO MOVE [${key}]`,'#ff8844');return;
  }
  const pts=mv.smooth,elem=mv.elem,type=mv.type||'strike';
  // Derive move name from elem + type
  const eName=ELEM[elem]?.abbr||elem.toUpperCase();

  switch(type){
    case'strike':
      // Each point deals damage to nearby enemies — invisible sweep
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(player.isDead)return;
        // Dense particles at hit points for visual flair
        spawnEP(pt.x,pt.y,elem,6);
        S.players.forEach(t=>{
          if(t.id!==player.id&&!t.isDead&&dist(t.x,t.y,pt.x,pt.y)<50){
            dealDmg(t,player.atk*.85,elem,t.x,t.y-40);
            t.vx+=(t.x-pt.x>0?1:-1)*4;
          }
        });
      },i*11));
      notify(`${player.name} · ${eName} STRIKE`);break;

    case'shield':
      // Creates a brief shield barrier along the path
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(player.isDead)return;
        S.effects.push({type:'ring_expand',x:pt.x,y:pt.y,r:22,col:ELEM[elem]?.col||'#fff',life:20,maxLife:20});
        spawnEP(pt.x,pt.y,elem,3);
      },i*9));
      player.shield=Math.min(player.maxShield,player.shield+35);
      notify(`${player.name} · ${eName} SHIELD`);break;

    case'trail':
      // Leaves element zones along path
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(player.isDead)return;
        S.elements.push({x:pt.x,y:pt.y,elem,life:95,maxLife:95,radius:20});
        spawnEP(pt.x,pt.y,elem,4);
      },i*9));
      notify(`${player.name} · ${eName} TRAIL`);break;

    case'burst':
      // Single explosion centered at path midpoint
      if(player.isDead)return;
      const mid=pts[Math.floor(pts.length/2)];
      spawnImpact(mid.x,mid.y,elem,1.4);
      S.players.forEach(t=>{
        if(t.id!==player.id&&!t.isDead&&dist(t.x,t.y,mid.x,mid.y)<95){
          dealDmg(t,player.atk*1.6,elem,t.x,t.y-40);
        }
      });
      notify(`${player.name} · ${eName} BURST`);break;

    case'loop':{
      // Continuous sweep along full path once
      let idx=0;
      const iv=setInterval(()=>{
        if(player.isDead){clearInterval(iv);return;}
        const pt=pts[idx];
        spawnEP(pt.x,pt.y,elem,6);
        S.players.forEach(t=>{if(t.id!==player.id&&!t.isDead&&dist(t.x,t.y,pt.x,pt.y)<42)dealDmg(t,player.atk*.52,elem,t.x,t.y-40);});
        idx++;if(idx>=pts.length)clearInterval(iv);
      },13);
      notify(`${player.name} · ${eName} LOOP`);break;
    }
  }
}

// ═══════════════════════════ GRAVITY WELL ════════════════════════
function spawnGravWell(x,y){
  S.gravWells.push({x,y,radius:138,str:3.2,life:210,maxLife:210});
  spawnEP(x,y,'void',30);notify('⬡ GRAVITY WELL');
}

// ═══════════════════════════ AI ══════════════════════════════════
function tickAI(p){
  const target=S.players.find(t=>t.id!==p.id&&!t.isDead);
  if(!target)return;
  const dx=target.x-p.x,d=dist(p.x,p.y,target.x,target.y);
  p.facing=dx>0?1:-1;
  const sm=S.sm;

  // Close gap or maintain distance
  if(d>62)p.vx+=p.facing*p.spd*.42*sm;
  else if(d<30)p.vx-=p.facing*p.spd*.3*sm;

  // Jump to reach
  if(target.y<p.y-35&&p.onGround&&Math.random()<.028)p.vy=-12.8;

  // Attacks
  if(d<56&&p.cstate==='idle'){
    if(Math.random()<.048)startAttack(p,'light',16);
    else if(p.sta>=20&&Math.random()<.018)startAttack(p,'heavy',28);
  }
  if(d<130&&p.cds.a1<=0&&p.sta>=20&&Math.random()<.009)useAbility(p,'a1');
  if(p.ultMeter>=p.maxUlt&&Math.random()<.018)useUltimate(p);

  // Dodge / block
  if(d<90&&Math.random()<.007)p.invFrames=18;
}

// ═══════════════════════════ PLAYER PHYSICS ══════════════════════
function tickPlayers(){
  const sm=S.sm;
  S.players.forEach(p=>{
    if(p.isDead){
      // Fallen body physics
      p.vx*=.88;p.vy+=GRAVITY*sm;
      p.x+=p.vx*sm;p.y+=p.vy*sm;
      const gy=GY()-60*p.depth;
      if(p.y>=gy){p.y=gy;p.vy=0;p.vx*=.78;}
      p.x=clamp(p.x,30,gc.width-30);
      return;
    }

    // Hitstop
    if(p.hitstopTimer>0){p.hitstopTimer-=sm;return;}

    const kb=KB[p.keybind||'wasd'];
    const K=S.keys;
    const stunned=p.cstate==='stunned'||hasStatus(p,'freeze')||hasStatus(p,'stun');

    if(!stunned&&p.cstate!=='dashing'){
      if(K[kb.left]){p.vx-=p.spd*.54*sm;p.facing=-1;}
      if(K[kb.right]){p.vx+=p.spd*.54*sm;p.facing=1;}

      // Jump
      if(K[kb.up+'_o']&&p.onGround&&p.cstate!=='attacking'){
        p.vy=-13;p.onGround=false;
        if(p.attrs[0]&&S.particles.length<PARTICLE_CAP-8)spawnEP(p.x,p.y,p.attrs[0]||'wind',7);
        delete K[kb.up+'_o'];
      }

      // Block
      if(K[kb.blk]&&p.cstate!=='attacking'&&p.sta>4){
        p.cstate='blocking';p.blockFrames++;p.sta=Math.max(0,p.sta-.42*sm);
      } else if(p.cstate==='blocking'){p.cstate='idle';p.blockFrames=0;}

      // Dash
      if(K[kb.dsh+'_o']&&p.cds.dash<=0&&p.sta>=22){
        p.cds.dash=42;p.sta-=22;p.cstate='dashing';
        p.vx=p.facing*19;p.invFrames=20;
        if(S.particles.length<PARTICLE_CAP-12)spawnEP(p.x,p.y,p.attrs[0]||'wind',12);
        delete K[kb.dsh+'_o'];
      }

      // Attacks
      if(K[kb.lt+'_o']&&p.cstate!=='attacking'&&p.sta>=9){startAttack(p,'light',16);p.sta-=9;delete K[kb.lt+'_o'];}
      if(K[kb.hy+'_o']&&p.cstate!=='attacking'&&p.sta>=22){startAttack(p,'heavy',28);p.sta-=22;delete K[kb.hy+'_o'];}

      // Abilities
      if(K[kb.a1+'_o']&&p.cds.a1<=0){useAbility(p,'a1');delete K[kb.a1+'_o'];}
      if(K[kb.a2+'_o']&&p.cds.a2<=0){useAbility(p,'a2');delete K[kb.a2+'_o'];}
      if(K[kb.ult+'_o']&&p.ultMeter>=p.maxUlt){useUltimate(p);delete K[kb.ult+'_o'];}

      // Fire moves
      if(K[kb.m1+'_o']){triggerMove(p,'1');delete K[kb.m1+'_o'];}
      if(K[kb.m2+'_o']){triggerMove(p,'2');delete K[kb.m2+'_o'];}
      if(K[kb.m3+'_o']){triggerMove(p,'3');delete K[kb.m3+'_o'];}
      if(K[kb.m4+'_o']){triggerMove(p,'4');delete K[kb.m4+'_o'];}

      // Gravity well
      if(K[kb.grav+'_o']){spawnGravWell(p.x,p.y-40);delete K[kb.grav+'_o'];}

      // Release absorbed
      if(K[kb.lt+'_o']&&p.absorbedElem){releaseAbsorbed(p,'burst');delete K[kb.lt+'_o'];}
      if(K[kb.hy+'_o']&&p.absorbedElem){releaseAbsorbed(p,'shot');delete K[kb.hy+'_o'];}
    }

    // Respawn
    if(K[kb.rx+'_o']&&p.isDead){respawnPlayer(p);delete K[kb.rx+'_o'];}

    // Attack tick
    if(p.cstate==='attacking'){
      p.atkFrame+=sm;
      if(p.atkFrame>=p.activeFrames[0]&&p.atkFrame<p.activeFrames[1])doMeleeHit(p);
      if(p.atkFrame>=p.atkMax){p.cstate='idle';p.atkType=null;p.hitSet=new Set();}
    }

    // Dash end
    if(p.cstate==='dashing'&&p.cds.dash<28)p.cstate='idle';

    // Stun recovery
    if(p.cstate==='stunned'){
      p.stunTimer=(p.stunTimer||0)-sm;
      if(p.stunTimer<=0){p.cstate='idle';p.stunTimer=0;}
    }

    // Physics
    p.vx*=.8;
    if(p.cstate==='dashing')p.vx*=.975;
    p.vy+=GRAVITY*sm;
    p.animTime+=Math.abs(p.vx)*.18*sm+sm*.52;
    p.x+=p.vx*sm;p.y+=p.vy*sm;

    // Ground
    const gy=GY()-60*p.depth;
    if(p.y>=gy){p.y=gy;p.vy=0;p.onGround=true;}else p.onGround=false;

    // Walls
    p.x=clamp(p.x,32,gc.width-32);

    // AI
    if(p.isAI&&!p.isDead)tickAI(p);
  });
}
</script>
<script>'use strict';
// stickbox_p4.js — HUD · EDITOR · INPUT · GAME LOOP · INIT
// ═══════════════════════════════════════════════════════════════════

// ═══════════════════════════ ELEMENT BAR ════════════════════════
function buildElemBar(){
  const bar=document.getElementById('elem-bar');
  bar.innerHTML='';
  const groups={classic:[],dark:[],holy:[],nature:[],cosmic:[]};
  EKEYS.forEach(k=>{const g=ELEM[k].group||'classic';if(groups[g])groups[g].push(k);else groups.classic.push(k);});
  ['classic','dark','holy','nature','cosmic'].forEach((grp,gi)=>{
    if(gi>0){const sep=document.createElement('div');sep.className='eb-sep';bar.appendChild(sep);}
    groups[grp].forEach(k=>{
      const e=ELEM[k];
      const isDark=(e.col==='#fffaaa'||e.col==='#a0e8ff'||e.col==='#e8e8ff'||e.col==='#88ffff'||e.col==='#aabbcc');
      const btn=document.createElement('div');
      btn.className='eb-btn'+(k===S.selElem?' sel':'');btn.dataset.elem=k;
      btn.style.background=`radial-gradient(circle at 38% 36%,${hexA(e.glow,.5)},${hexA(e.col,.78)},${hexA(e.dark,.9)})`;
      btn.innerHTML=`<div class="eb-abbr" style="color:${isDark?'#222':'#fff'}">${e.abbr}</div><div class="eb-dot" style="background:${e.glow};box-shadow:0 0 5px ${e.glow};"></div><div class="eb-tip">${e.name} · ${String(e.eff).replace(/_/g,' ')} · DMG ${e.dmg}</div>`;
      btn.onclick=()=>selectElem(k);
      btn.addEventListener('mouseenter',ev=>showTip(ev,`${e.name}: DMG ${e.dmg} · ${String(e.eff).replace(/_/g,' ')}`));
      btn.addEventListener('mousemove',moveTip);btn.addEventListener('mouseleave',hideTip);
      bar.appendChild(btn);
    });
  });
  const sep=document.createElement('div');sep.className='eb-sep';bar.appendChild(sep);
  ['eraser','hazard'].forEach(k=>{
    const btn=document.createElement('div');
    btn.className='eb-btn'+(k===S.selElem?' sel':'');btn.dataset.elem=k;
    btn.style.background=k==='hazard'?'rgba(80,16,16,.9)':'rgba(18,28,42,.9)';
    btn.style.borderColor=k==='hazard'?'rgba(200,0,0,.4)':'rgba(80,100,130,.3)';
    btn.innerHTML=`<div class="eb-abbr" style="color:#888">${k==='hazard'?'HZD':'ERA'}</div><div class="eb-dot" style="background:${k==='hazard'?'#ff4444':'#445566'};"></div><div class="eb-tip">${k==='hazard'?'Hazard Zone':'Eraser'}</div>`;
    btn.onclick=()=>selectElem(k);
    bar.appendChild(btn);
  });
}

function selectElem(k){
  S.selElem=k;
  document.querySelectorAll('#elem-bar .eb-btn').forEach(b=>b.classList.toggle('sel',b.dataset.elem===k));
}

// ═══════════════════════════ PLAYER HUD ═════════════════════════
function refreshHUD(){
  const list=document.getElementById('hud-left');if(!list)return;
  list.innerHTML='';
  S.players.forEach(p=>{
    const div=document.createElement('div');
    const isAct=S.selPlayer?.id===p.id;
    div.className=`plcard${isAct?' active':''}${p.isDead?' dead':''}`;
    const hp=Math.max(0,p.hp/p.maxHp);
    const sta=Math.max(0,p.sta/p.maxSta);
    const ult=p.ultMeter/p.maxUlt;
    const hpCol=hp>.6?'#44ff88':hp>.28?'#ffcc00':'#ff4444';
    const role=ROLES[p.role];
    const eTags=p.attrs.slice(0,3).map(a=>{const e=ELEM[a];return `<span class="pc-etag" style="background:${hexA(e.col,.16)};color:${e.col};">${e.abbr}</span>`;}).join('');
    const sfxTags=p.statusFX?.slice(0,4).map(fx=>`<span class="pc-sfx" style="background:rgba(255,255,255,.06);color:#778899;">${fx.type.slice(0,4).toUpperCase()}</span>`).join('')||'';
    div.innerHTML=`<div class="pc-top"><div class="pc-name" style="color:${p.skinColor};">${p.name}</div><div style="display:flex;align-items:center;gap:3px;">${p.isAI?'<span style="font-family:Share Tech Mono;font-size:6px;color:#4488ff;letter-spacing:1px;">AI</span>':''}<div class="pc-role-tag" style="background:${hexA(role?.col||'#888',.14)};color:${role?.col||'#888'};">${role?.abbr||'?'}</div><span class="pc-rm" onclick="event.stopPropagation();removePlayer(${p.id})">✕</span></div></div><div class="pc-bars"><div class="pc-brow"><div class="pc-blbl">HP</div><div class="pc-bbg"><div class="pc-bfg" style="width:${hp*100}%;background:${hpCol};"></div></div><div class="pc-bval" style="color:${hpCol};">${Math.ceil(p.hp)}</div></div><div class="pc-brow"><div class="pc-blbl">ST</div><div class="pc-bbg"><div class="pc-bfg" style="width:${sta*100}%;background:#ffcc44;"></div></div></div><div class="pc-brow"><div class="pc-blbl">UL</div><div class="pc-bbg"><div class="pc-bfg" style="width:${ult*100}%;background:${ult>=1?'#fff':'#c8a84b'};"></div></div></div></div><div class="pc-tags">${eTags}</div>${sfxTags?`<div class="pc-sfx-row">${sfxTags}</div>`:''}`;
    div.addEventListener('click',()=>{S.selPlayer=p;refreshHUD();});
    list.appendChild(div);
  });
}

// ═══════════════════════════ SPAWN / REMOVE ══════════════════════
function spawnPlayer(){
  const x=100+Math.random()*(gc.width-200);
  const y=gc.height-200;
  const role=RKEYS[rndInt(0,RKEYS.length-1)];
  const cols=['#4488ff','#ff4444','#44ff88','#ff8844','#cc44ff','#44ccff','#ff44cc','#88ff44'];
  const sc=cols[rndInt(0,cols.length-1)];
  const p=mkPlayer(x,y,{role,skinColor:sc,skinColor2:darken(sc,.38)});
  if(S.aiOn&&S.players.length>0)p.isAI=true;
  S.players.push(p);
  if(!S.selPlayer)S.selPlayer=p;
  refreshHUD();
  notify(`${p.name} [${ROLES[role].abbr}] SPAWNED`);
  if(!_gameRunning)startLoop();
  return p;
}

function removePlayer(id){
  S.players=S.players.filter(p=>p.id!==id);
  if(S.selPlayer?.id===id)S.selPlayer=S.players[0]||null;
  refreshHUD();
}

function clearAll(){
  S.particles=[];S.elements=[];S.hazards=[];S.gravWells=[];S.projectiles=[];S.effects=[];
  notify('SANDBOX CLEARED');
}

function toggleSlowmo(){
  S.slowmo=!S.slowmo;S.sm=S.slowmo?.22:1;
  document.getElementById('btn-slowmo').classList.toggle('lit',S.slowmo);
  document.getElementById('slowmo-bar').classList.toggle('show',S.slowmo);
  notify(S.slowmo?'◈ SLOW MOTION':'◈ NORMAL SPEED');
}

function toggleAI(){
  S.aiOn=!S.aiOn;
  document.getElementById('btn-ai').classList.toggle('lit',S.aiOn);
  S.players.forEach(p=>{if(p.id!==S.selPlayer?.id)p.isAI=S.aiOn;});
  notify(S.aiOn?'AI BOTS ON':'AI BOTS OFF');
}

// ═══════════════════════════ AMBIENT PARTICLES ═══════════════════
let _ambTimer=0;
function tickAmbient(){
  _ambTimer++;
  if(_ambTimer%12===0&&S.particles.length<PARTICLE_CAP-4){
    const k=rndOf(EKEYS);const e=ELEM[k];
    S.particles.push(mkParticle(
      Math.random()*gc.width,GY()-Math.random()*48,
      (Math.random()-.5)*.45,-Math.random()*.62-.08,
      rnd(1,2.8),e.col,e.glow,e.ps[0],
      .22,.003,-0.016,.992,Math.random()*Math.PI*2,(Math.random()-.5)*.025
    ));
  }
}

// ═══════════════════════════ GAME LOOP ═══════════════════════════
let _gameRunning=false;
function startLoop(){
  if(_gameRunning)return;
  _gameRunning=true;
  function loop(){
    if(S.page!=='game'){_gameRunning=false;return;}
    S.frame++;
    ctx.clearRect(0,0,gc.width,gc.height);
    drawBG();
    drawHazards();
    drawGravWells();
    drawElemBlobs();
    drawEffects();
    [...S.players].sort((a,b)=>a.depth-b.depth).forEach(p=>drawStickman(p,S.frame));
    drawProjectiles();
    drawParticles();
    tickPlayers();
    tickParticles();
    tickProjectiles();
    tickElements();
    tickGravWells();
    tickStatus();
    tickHazards();
    tickEffects();
    tickAmbient();
    // Clear once-keys at end of each frame
    for(const k in S.keys){if(k.endsWith('_o'))delete S.keys[k];}
    if(S.frame%3===0)refreshHUD();
    requestAnimationFrame(loop);
  }
  loop();
}

// ═══════════════════════════ INPUT ═══════════════════════════════
let _pathDrawing=false,_pathPoints=[];
let _mouseDown=false,_lastPlace=0;

window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(!S.keys[k]){S.keys[k+'_o']=true;}
  S.keys[k]=true;
  if(k==='tab'){e.preventDefault();const i=EKEYS.indexOf(S.selElem);selectElem(EKEYS[(i+1)%EKEYS.length]);}
  if(k==='p'&&S.page==='game'){_pathDrawing=!_pathDrawing;notify(_pathDrawing?'DRAW PATH (mousedown + drag)':'PATH MODE OFF');}
  if(k==='escape'){if(_pathDrawing){_pathDrawing=false;_pathPoints=[];return;}showPage('menu');}
});
window.addEventListener('keyup',e=>{S.keys[e.key.toLowerCase()]=false;});

gc.addEventListener('mousedown',e=>{
  if(e.button===2){
    let near=null,nd=85;
    S.players.forEach(p=>{const d=dist(p.x,p.y,e.offsetX,e.offsetY);if(d<nd){nd=d;near=p;}});
    if(near){S.selPlayer=near;refreshHUD();}
    return;
  }
  _mouseDown=true;
  if(_pathDrawing){_pathPoints=[{x:e.offsetX,y:e.offsetY}];return;}
  placeElement(e.offsetX,e.offsetY);_lastPlace=Date.now();
});

gc.addEventListener('mousemove',e=>{
  S.mouseX=e.offsetX;S.mouseY=e.offsetY;
  if(!_mouseDown)return;
  if(_pathDrawing){
    const last=_pathPoints[_pathPoints.length-1];
    if(!last||dist(last.x,last.y,e.offsetX,e.offsetY)>10)
      _pathPoints.push({x:e.offsetX,y:e.offsetY});
    return;
  }
  if(Date.now()-_lastPlace>52){placeElement(e.offsetX,e.offsetY);_lastPlace=Date.now();}
});

gc.addEventListener('mouseup',e=>{
  if(_pathDrawing&&_pathPoints.length>4){openPathBind([..._pathPoints]);_pathPoints=[];}
  _mouseDown=false;
});

gc.addEventListener('contextmenu',e=>e.preventDefault());

// ═══════════════════════════ PATH BIND MODAL ═════════════════════
let _pendingPath=null;

function openPathBind(rawPts){
  _pendingPath=rawPts;
  let modal=document.getElementById('path-modal');
  if(!modal){
    modal=document.createElement('div');modal.id='path-modal';
    modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:5000;';
    modal.innerHTML=`<div style="background:#06101c;border:1px solid rgba(200,168,75,.28);border-radius:8px;padding:26px;width:340px;">
      <div style="font-family:Orbitron,sans-serif;font-size:14px;color:#c8a84b;letter-spacing:3px;margin-bottom:18px;">BIND MOVE</div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:9px;">
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:#2a4a6a;width:80px;">PLAYER</div>
        <select id="pm-player" style="flex:1;background:#03080f;border:1px solid #0e1e2e;border-radius:3px;color:#bcd0e8;font-family:Rajdhani,sans-serif;font-size:13px;padding:6px 9px;cursor:pointer;"></select>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:9px;">
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:#2a4a6a;width:80px;">BIND KEY</div>
        <select id="pm-key" style="flex:1;background:#03080f;border:1px solid #0e1e2e;border-radius:3px;color:#bcd0e8;font-family:Rajdhani,sans-serif;font-size:13px;padding:6px 9px;cursor:pointer;">
          <option value="1">KEY 1</option><option value="2">KEY 2</option><option value="3">KEY 3</option><option value="4">KEY 4</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:9px;">
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:#2a4a6a;width:80px;">ELEMENT</div>
        <select id="pm-elem" style="flex:1;background:#03080f;border:1px solid #0e1e2e;border-radius:3px;color:#bcd0e8;font-family:Rajdhani,sans-serif;font-size:13px;padding:6px 9px;cursor:pointer;"></select>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
        <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:#2a4a6a;width:80px;">TYPE</div>
        <select id="pm-type" style="flex:1;background:#03080f;border:1px solid #0e1e2e;border-radius:3px;color:#bcd0e8;font-family:Rajdhani,sans-serif;font-size:13px;padding:6px 9px;cursor:pointer;">
          <option value="strike">Strike — damage sweep along path</option>
          <option value="shield">Shield — barrier along path</option>
          <option value="trail">Trail — element zone stream</option>
          <option value="burst">Burst — explosion at midpoint</option>
          <option value="loop">Loop — continuous sweep</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="closePathModal()" style="flex:1;padding:10px;border:1px solid #0e1e2e;border-radius:3px;font-family:Rajdhani,sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;color:#2a4a6a;background:transparent;text-transform:uppercase;">CANCEL</button>
        <button onclick="confirmPath()" style="flex:1;padding:10px;border:1px solid #c8a84b;border-radius:3px;font-family:Rajdhani,sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;cursor:pointer;color:#c8a84b;background:rgba(200,168,75,.08);text-transform:uppercase;">BIND MOVE</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
  }
  modal.style.display='flex';
  const psel=document.getElementById('pm-player');
  psel.innerHTML=S.players.filter(p=>!p.isDead).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(S.selPlayer)psel.value=S.selPlayer.id;
  const esel=document.getElementById('pm-elem');
  esel.innerHTML=EKEYS.map(k=>`<option value="${k}">[${ELEM[k].abbr}] ${ELEM[k].name}</option>`).join('');
  esel.value=S.selElem;
}

function closePathModal(){const m=document.getElementById('path-modal');if(m)m.style.display='none';_pendingPath=null;_pathDrawing=false;}

function confirmPath(){
  if(!_pendingPath||_pendingPath.length<4){closePathModal();return;}
  const pid=parseInt(document.getElementById('pm-player').value);
  const key=document.getElementById('pm-key').value;
  const elem=document.getElementById('pm-elem').value;
  const type=document.getElementById('pm-type').value;
  const player=S.players.find(p=>p.id===pid);
  if(player){
    bindMove(player,key,_pendingPath,elem,type);
    notify(`MOVE [${key}] → ${player.name} · ${ELEM[elem]?.abbr} · ${type.toUpperCase()}`);
    buildMoveList();
  }
  closePathModal();
}

function buildMoveList(){
  const ml=document.getElementById('move-list');if(!ml||!S.editPlayer)return;
  const moves=S.editPlayer._moves||{};
  const keys=Object.keys(moves);
  if(!keys.length){ml.innerHTML='<span style="color:#1a2c3e">No moves bound. Press P in-game to draw paths.</span>';return;}
  ml.innerHTML=keys.map(k=>{
    const mv=moves[k];
    return `<div>[${k}] ${ELEM[mv.elem]?.abbr||mv.elem} · ${(mv.type||'STRIKE').toUpperCase()} <span onclick="deleteMove('${k}')" style="color:#ff4444;cursor:pointer;margin-left:6px;font-size:9px;">✕</span></div>`;
  }).join('');
}

function deleteMove(key){if(!S.editPlayer)return;delete S.editPlayer._moves?.[key];buildMoveList();notify(`MOVE [${key}] DELETED`);}

// ═══════════════════════════ PAGE NAVIGATION ═════════════════════
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name)?.classList.add('active');
  S.page=name;
  if(name==='game'){if(S.players.length===0)spawnPlayer();if(!_gameRunning)startLoop();}
  if(name==='editor'){
    if(!S.editPlayer&&S.players.length>0)S.editPlayer=S.players[0];
    if(!S.editPlayer){const p=mkPlayer(gc.width/2,gc.height-200);S.players.push(p);S.editPlayer=p;}
    loadIntoEditor(S.editPlayer);buildEdCharList();startEdPreview();
  }
  if(name==='menu')menuLoop();
}

function openEditorFromGame(){showPage('editor');}

// ═══════════════════════════ EDITOR CORE ═════════════════════════
const SKIN_PAL=['#4488ff','#2266cc','#ff4444','#cc2222','#44ff88','#22aa66',
  '#ff8844','#cc5522','#cc44ff','#8822cc','#44ccff','#22aacc',
  '#ff44cc','#cc2288','#ffe01a','#aa8800','#ffffff','#aabbcc',
  '#556677','#111122','#88ff44','#ff4488','#44ffaa','#ffaa44'];

function buildEditorUI(){buildRoleList();buildAttrGrid();buildEdCharList();buildSkinPal();buildKBRow();}

function buildEdCharList(){
  const list=document.getElementById('ed-char-list');if(!list)return;
  list.innerHTML='';
  S.players.forEach(p=>{
    const div=document.createElement('div');
    div.className='char-card'+(S.editPlayer?.id===p.id?' active':'');
    div.innerHTML=`<div style="font-size:12px;font-weight:700;color:${p.skinColor};">${p.name}</div><div style="font-size:9px;color:${ROLES[p.role]?.col||'#888'};">${p.role.toUpperCase()}</div>`;
    div.onclick=()=>{S.editPlayer=p;loadIntoEditor(p);buildEdCharList();};
    list.appendChild(div);
  });
}

function edNewChar(){
  const p=mkPlayer(120+Math.random()*(gc.width-240),gc.height-200);
  S.players.push(p);S.editPlayer=p;
  refreshHUD();buildEdCharList();loadIntoEditor(p);notify('NEW CHARACTER CREATED');
  if(!_gameRunning)startLoop();
}

function buildRoleList(){
  const list=document.getElementById('role-list');if(!list)return;
  list.innerHTML='';
  RKEYS.forEach(k=>{
    const r=ROLES[k];const div=document.createElement('div');
    div.className='role-card'+(S.editPlayer?.role===k?' sel':'');div.dataset.role=k;
    div.innerHTML=`<div class="role-abbr-box" style="background:${hexA(r.col,.16)};color:${r.col};">${r.abbr}</div><div><div class="role-info-name" style="color:${r.col};">${r.name}</div><div class="role-info-desc">${r.desc}</div></div>`;
    div.onclick=()=>edSetRole(k);
    list.appendChild(div);
  });
}

function edSetRole(role){
  if(!S.editPlayer)return;
  const p=S.editPlayer,r=ROLES[role];
  p.role=role;p.maxHp=r.hp;p.hp=r.hp;p.atk=r.atk;p.def=r.def;p.spd=r.spd;p.maxSta=r.sta;p.sta=r.sta;
  p.abils={a1:r.a1,a2:r.a2,ult:r.ult};
  document.querySelectorAll('.role-card').forEach(c=>c.classList.toggle('sel',c.dataset.role===role));
  setStat('hp',r.hp);setStat('atk',r.atk);setStat('def',r.def);setStat('spd',r.spd);setStat('sta',r.sta);
  buildAbilList();notify(`ROLE: ${r.name.toUpperCase()}`);
}

function setStat(s,v){
  const sl=document.getElementById(`sl-${s}`),sv=document.getElementById(`sv-${s}`);
  if(sl)sl.value=v;if(sv)sv.textContent=v;
}

function loadIntoEditor(p){
  if(!p)return;
  setStat('hp',p.maxHp);setStat('atk',p.atk);setStat('def',p.def);setStat('spd',p.spd);setStat('sta',p.maxSta);
  document.querySelectorAll('.role-card').forEach(c=>c.classList.toggle('sel',c.dataset.role===p.role));
  document.querySelectorAll('.attr-btn').forEach(c=>c.classList.toggle('on',p.attrs.includes(c.dataset.attr)));
  updateAuraPrev();buildAbilList();buildMoveList();
  const tog=(onId,offId,val)=>{document.getElementById(onId)?.classList.toggle('on',val);document.getElementById(offId)?.classList.toggle('on',!val);};
  tog('ab-on','ab-off',p.absorbOn);
  tog('ls-on','ls-off',p.specials?.lifesteal);
  tog('sr-on','sr-off',p.specials?.shieldRegen);
  document.querySelectorAll('.kbbtn').forEach(b=>b.classList.toggle('on',b.dataset.kb===p.keybind));
}

function edStat(stat,val){
  if(!S.editPlayer)return;
  const p=S.editPlayer;
  if(stat==='hp'){p.maxHp=val;p.hp=Math.min(p.hp,val);}
  else if(stat==='atk')p.atk=val;
  else if(stat==='def')p.def=val;
  else if(stat==='spd')p.spd=val;
  else if(stat==='sta'){p.maxSta=val;p.sta=Math.min(p.sta,val);}
  document.getElementById(`sv-${stat}`).textContent=val;
}

function buildAttrGrid(){
  const grid=document.getElementById('attr-grid');if(!grid)return;
  grid.innerHTML='';
  EKEYS.forEach(k=>{
    const e=ELEM[k];const btn=document.createElement('div');
    btn.className='attr-btn'+(S.editPlayer?.attrs.includes(k)?' on':'');
    btn.dataset.attr=k;btn.style.color=e.col;btn.style.borderColor=hexA(e.col,.28);
    btn.style.background=hexA(e.col,.06);btn.textContent=e.abbr;btn.title=e.name;
    btn.onclick=()=>edToggleAttr(k);
    btn.addEventListener('mouseenter',ev=>showTip(ev,`${e.name}: ${String(e.eff).replace(/_/g,' ')}`));
    btn.addEventListener('mousemove',moveTip);btn.addEventListener('mouseleave',hideTip);
    grid.appendChild(btn);
  });
}

function edToggleAttr(attr){
  if(!S.editPlayer)return;
  const p=S.editPlayer,idx=p.attrs.indexOf(attr);
  if(idx>=0)p.attrs.splice(idx,1);
  else if(p.attrs.length<3)p.attrs.push(attr);
  else{notify('MAX 3 ELEMENTS','#ff8844');return;}
  document.querySelectorAll('.attr-btn').forEach(c=>c.classList.toggle('on',p.attrs.includes(c.dataset.attr)));
  updateAuraPrev();notify(idx>=0?`${ELEM[attr]?.abbr} REMOVED`:`${ELEM[attr]?.abbr} ADDED`);
}

function updateAuraPrev(){
  const p=S.editPlayer;
  const prev=document.getElementById('aura-prev'),lbl=document.getElementById('aura-lbl');if(!prev||!lbl)return;
  if(!p||!p.attrs.length){
    prev.style.cssText='background:rgba(10,20,34,.5);box-shadow:none;border:1px solid #0e1e2e;';
    prev.textContent='—';lbl.textContent='NO ELEMENT';lbl.style.color='';return;
  }
  const col=ELEM[p.attrs[0]]?.col,glo=ELEM[p.attrs[0]]?.glow;
  prev.style.background=`radial-gradient(circle at 36% 36%,${hexA(col,.55)},${hexA(col,.14)})`;
  prev.style.boxShadow=`0 0 32px ${hexA(col,.62)},inset 0 0 22px ${hexA(col,.2)}`;
  prev.style.border=`1px solid ${hexA(col,.52)}`;
  prev.style.color=col;prev.textContent=ELEM[p.attrs[0]]?.abbr||'?';
  lbl.textContent=p.attrs.map(a=>ELEM[a]?.name||a).join(' + ').toUpperCase();
  lbl.style.color=glo||'#888';
}

function buildAbilList(){
  const list=document.getElementById('ab-list');if(!list||!S.editPlayer)return;
  list.innerHTML='';
  const role=ROLES[S.editPlayer.role];if(!role)return;
  [role.a1,role.a2,role.ult].forEach(abKey=>{
    const ab=ABIL[abKey];if(!ab)return;
    const typeCol=ab.type==='u'?'#c8a84b':'#44aaff';
    const typeLabel=ab.type==='u'?'ULTIMATE':'ACTIVE';
    const div=document.createElement('div');div.className='ab-card';
    div.innerHTML=`<div class="ab-type" style="color:${typeCol};">${typeLabel}</div><div class="ab-name">${ab.name}</div><div class="ab-desc">${ab.desc} · CD:${ab.cd||0} · COST:${ab.cost}</div>`;
    list.appendChild(div);
  });
}

function buildSkinPal(){
  const pal=document.getElementById('skin-pal');if(!pal)return;
  pal.innerHTML='';
  SKIN_PAL.forEach(col=>{
    const div=document.createElement('div');div.className='sk-col';
    div.style.background=col;div.title=col;
    div.onclick=()=>{
      S.skinColor=col;
      document.querySelectorAll('.sk-col').forEach(c=>c.classList.toggle('on',c.title===col));
      if(S.editPlayer){S.editPlayer.skinColor=col;S.editPlayer.skinColor2=darken(col,.35);}
    };
    pal.appendChild(div);
  });
}

function buildKBRow(){
  const row=document.getElementById('kb-row');if(!row)return;
  row.innerHTML='';
  ['wasd','arrows','num'].forEach(kb=>{
    const btn=document.createElement('button');
    btn.className='kbbtn'+(S.editPlayer?.keybind===kb?' on':'');
    btn.dataset.kb=kb;btn.textContent=kb.toUpperCase();
    btn.onclick=()=>{if(S.editPlayer){S.editPlayer.keybind=kb;document.querySelectorAll('.kbbtn').forEach(b=>b.classList.toggle('on',b.dataset.kb===kb));}};
    row.appendChild(btn);
  });
}

// ═══════════════════════════ SKIN CANVAS ════════════════════════
let _skTool='brush',_skColor='#4488ff',_skPainting=false;
const skc=document.getElementById('skin-canvas');
const skCtx=skc?skc.getContext('2d'):null;

if(skc&&skCtx){
  skCtx.fillStyle='#1a2434';skCtx.fillRect(0,0,skc.width,skc.height);
  skc.addEventListener('mousedown',e=>{_skPainting=true;skinPaint(e);});
  skc.addEventListener('mousemove',e=>{if(_skPainting)skinPaint(e);});
  skc.addEventListener('mouseup',()=>_skPainting=false);
  skc.addEventListener('mouseleave',()=>_skPainting=false);
}

function skinPaint(e){
  if(!skCtx)return;
  const rect=skc.getBoundingClientRect();
  const x=e.clientX-rect.left,y=e.clientY-rect.top;
  if(_skTool==='brush'){skCtx.fillStyle=S.skinColor||'#4488ff';skCtx.beginPath();skCtx.arc(x,y,5,0,Math.PI*2);skCtx.fill();}
  else if(_skTool==='erase'){skCtx.clearRect(x-7,y-7,14,14);}
  else if(_skTool==='fill'){skCtx.fillStyle=S.skinColor||'#4488ff';skCtx.fillRect(0,0,skc.width,skc.height);}
}

function setSkinTool(t){
  _skTool=t;S.skinTool=t;
  document.querySelectorAll('.sk-tool').forEach(b=>b.classList.toggle('on',b.id===`skt-${t}`));
}

function edResetSkin(){if(skCtx){skCtx.clearRect(0,0,skc.width,skc.height);skCtx.fillStyle='#1a2434';skCtx.fillRect(0,0,skc.width,skc.height);}notify('SKIN RESET');}

function edSaveSkin(){
  if(!S.editPlayer)return;
  notify('SKIN SAVED — color applied to character');
}

function edAbsorb(on){
  if(!S.editPlayer)return;
  S.editPlayer.absorbOn=on;
  document.getElementById('ab-on')?.classList.toggle('on',on);
  document.getElementById('ab-off')?.classList.toggle('on',!on);
}

function edSpec(spec,on){
  if(!S.editPlayer)return;
  if(!S.editPlayer.specials)S.editPlayer.specials={};
  S.editPlayer.specials[spec]=on;
  const pre=spec==='lifesteal'?'ls':spec==='shieldRegen'?'sr':'xx';
  document.getElementById(`${pre}-on`)?.classList.toggle('on',on);
  document.getElementById(`${pre}-off`)?.classList.toggle('on',!on);
}

function edExport(){
  if(!S.editPlayer)return;
  const p=S.editPlayer;
  const data={name:p.name,role:p.role,attrs:p.attrs,maxHp:p.maxHp,atk:p.atk,def:p.def,spd:p.spd,maxSta:p.maxSta,skinColor:p.skinColor,keybind:p.keybind,specials:p.specials};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${p.name||'character'}.json`;a.click();
  notify('CHARACTER EXPORTED');
}

// ═══════════════════════════ INIT ════════════════════════════════
document.addEventListener('DOMContentLoaded',()=>{
  resizeGame();
  doLoad();
});

// Also kick off if DOM already ready
if(document.readyState!=='loading'){resizeGame();doLoad();}
</script>
</body>
</html>
