<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StickBox 2.0 — Elemental Arena</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

/* ═══════════════════════════ ROOT VARS ═══════════════════════════ */
:root {
  --bg0:#020408; --bg1:#060c14; --bg2:#0a1420; --bg3:#0f1c2e;
  --gold:#c8a84b; --gold2:#ffe87a; --silver:#7a9cb8; --dim:#2a4060;
  --border:#1a2c3e; --border2:#243850;
  --text:#ddeeff; --text2:#5a7a9a; --text3:#3a5070;
  --fire:#ff4d1a; --water:#1ab4ff; --lightning:#ffe01a; --ice:#a0e8ff;
  --void:#9b1aff; --plasma:#ff1a8c; --earth:#c8a060; --wind:#b0ffcc;
  --shadow:#8844cc; --light:#fffaaa; --poison:#44ff44; --magma:#ff6600;
  --storm:#2288cc; --frost:#88ddff; --arcane:#cc44ff; --blood:#cc0022;
  --time:#88ccaa; --space:#3344cc; --crystal:#88ffff; --metal:#aabbcc;
  --nature:#44aa22; --acid:#aaff00; --gravity:#6644aa; --sonic:#44ffff;
  --radiation:#ccff22; --magnet:#6688cc; --aether:#ffd080;
  --chaos:#ff4488; --order:#e8e8ff; --nether:#6600aa;
  --ease:cubic-bezier(0.23,1,0.32,1);
  --ease2:cubic-bezier(0.4,0,0.2,1);
}

/* ═══════════════════════════ RESET / BASE ═══════════════════════════ */
*{margin:0;padding:0;box-sizing:border-box;outline:none;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg0);
  color:var(--text);font-family:'Rajdhani',sans-serif;user-select:none;}
button,select,input{font-family:'Rajdhani',sans-serif;}

/* Scanline overlay */
body::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,
  rgba(0,0,0,0.018) 3px,rgba(0,0,0,0.018) 4px);}

/* Vignette */
body::after{content:'';position:fixed;inset:0;z-index:9997;pointer-events:none;
  background:radial-gradient(ellipse at 50% 50%,transparent 60%,rgba(0,0,0,0.6) 100%);}

/* ═══════════════════════════ SCROLLBAR ═══════════════════════════ */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg1);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--silver);}

/* ═══════════════════════════ LOADING ═══════════════════════════ */
#loading{position:fixed;inset:0;background:var(--bg0);z-index:99999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity 0.7s var(--ease);}
#loading.done{opacity:0;pointer-events:none;}
.ld-logo{font-family:'Orbitron',sans-serif;font-size:64px;font-weight:900;
  background:linear-gradient(135deg,#c8a84b 0%,#ffe87a 40%,#c8a84b 70%,#7a4c10 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-2px;margin-bottom:8px;}
.ld-sub{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:6px;
  color:var(--silver);margin-bottom:40px;}
.ld-bar{width:280px;height:2px;background:rgba(200,168,75,0.1);border-radius:1px;margin-bottom:12px;}
.ld-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));
  width:0;transition:width 0.35s var(--ease);border-radius:1px;}
.ld-text{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;
  color:var(--text2);}

/* ═══════════════════════════ PAGES ═══════════════════════════ */
.page{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;opacity:0;pointer-events:none;
  transition:opacity 0.45s var(--ease),transform 0.45s var(--ease);
  transform:translateY(12px);}
.page.active{opacity:1;pointer-events:all;transform:translateY(0);}

/* ═══════════════════════════ MENU PAGE ═══════════════════════════ */
#page-menu{background:radial-gradient(ellipse at 50% 65%,#0c1826 0%,#020408 70%);}
#menu-bg{position:absolute;inset:0;z-index:0;}
.menu-content{position:relative;z-index:2;display:flex;flex-direction:column;
  align-items:center;gap:0;}
.m-logo{font-family:'Orbitron',sans-serif;font-size:88px;font-weight:900;
  background:linear-gradient(135deg,#c8a84b 0%,#ffe87a 35%,#c8a84b 60%,#7a4c10 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:-3px;line-height:1;filter:drop-shadow(0 0 50px rgba(200,168,75,0.5));
  animation:logoFloat 5s ease-in-out infinite;}
@keyframes logoFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.m-sub{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:8px;
  color:var(--silver);margin-bottom:4px;}
.m-ver{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;
  color:var(--gold);opacity:0.6;margin-bottom:44px;}
.m-nav{display:flex;flex-direction:column;gap:8px;width:320px;}
.mbtn{position:relative;padding:16px 28px;background:linear-gradient(135deg,
  rgba(12,22,36,0.96),rgba(6,12,22,0.98));border:1px solid rgba(200,168,75,0.2);
  border-radius:3px;font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:600;
  letter-spacing:4px;color:var(--text);cursor:pointer;overflow:hidden;
  transition:all 0.28s var(--ease);text-transform:uppercase;text-align:left;}
.mbtn:hover{border-color:rgba(200,168,75,0.7);color:var(--gold);
  transform:translateX(8px);
  box-shadow:-4px 0 24px rgba(200,168,75,0.15),inset 0 0 20px rgba(200,168,75,0.04);}
.mbtn.primary{font-size:20px;border-color:rgba(200,168,75,0.4);
  background:linear-gradient(135deg,rgba(200,168,75,0.14),rgba(200,168,75,0.04));}
.mbtn::before{content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(200,168,75,0.06),transparent);
  transform:translateX(-110%);transition:transform 0.55s var(--ease);}
.mbtn:hover::before{transform:translateX(110%);}
.mbtn-arr{position:absolute;right:18px;top:50%;transform:translateY(-50%);
  opacity:0;color:var(--gold);font-size:11px;transition:all 0.25s;}
.mbtn:hover .mbtn-arr{opacity:1;right:14px;}
.m-divider{width:200px;height:1px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  opacity:0.25;margin:16px auto;}
.m-elems{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
  max-width:400px;margin-bottom:8px;}
.m-elem-badge{padding:4px 10px;border:1px solid transparent;border-radius:3px;
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;
  cursor:pointer;transition:all 0.25s var(--ease);font-weight:700;}
.m-elem-badge:hover{transform:scale(1.15) translateY(-3px);}
.m-bottom{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  display:flex;gap:12px;align-items:center;}
.m-music-btn{padding:7px 16px;border:1px solid rgba(200,168,75,0.25);border-radius:3px;
  background:rgba(10,18,30,0.8);font-family:'Rajdhani',sans-serif;font-size:12px;
  font-weight:600;letter-spacing:2px;color:var(--text2);cursor:pointer;transition:all 0.25s;}
.m-music-btn:hover{border-color:var(--gold);color:var(--gold);}

/* ═══════════════════════════ GAME PAGE ═══════════════════════════ */
#page-game{align-items:stretch;justify-content:flex-start;background:#000;flex-direction:row;}
#game-canvas{display:block;flex:1;cursor:crosshair;}
#game-hud{position:fixed;inset:0;pointer-events:none;z-index:20;}

/* Top bar */
#hud-top{position:absolute;top:0;left:0;right:0;height:52px;
  background:linear-gradient(180deg,rgba(2,4,8,0.95) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;pointer-events:all;}
.hud-logo{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;
  color:var(--gold);letter-spacing:4px;}
.hud-btns{display:flex;gap:6px;}
.hbtn{padding:6px 14px;border:1px solid rgba(200,168,75,0.22);border-radius:3px;
  background:rgba(6,12,22,0.85);font-family:'Rajdhani',sans-serif;font-size:12px;
  font-weight:600;letter-spacing:2px;color:var(--text2);cursor:pointer;
  transition:all 0.22s;text-transform:uppercase;}
.hbtn:hover{border-color:var(--gold);color:var(--gold);}
.hbtn.active-btn{border-color:var(--gold);color:var(--gold);
  background:rgba(200,168,75,0.1);}

/* Element palette */
#elem-palette{position:absolute;left:10px;top:58px;bottom:60px;
  display:flex;flex-direction:column;gap:4px;pointer-events:all;overflow-y:auto;
  background:rgba(4,8,16,0.9);border:1px solid var(--border);
  border-radius:6px;padding:8px 6px;width:60px;}
.pal-btn{position:relative;width:46px;height:36px;border-radius:4px;
  border:1px solid transparent;cursor:pointer;display:flex;align-items:center;
  justify-content:center;font-family:'Share Tech Mono',monospace;font-size:9.5px;
  font-weight:700;letter-spacing:0.5px;transition:all 0.2s var(--ease);}
.pal-btn:hover{transform:scale(1.1);z-index:5;}
.pal-btn.selected{border-color:white!important;
  box-shadow:0 0 14px rgba(255,255,255,0.3),inset 0 0 8px rgba(255,255,255,0.05);}
.pal-tip{position:absolute;left:54px;top:50%;transform:translateY(-50%);
  font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:1px;
  background:rgba(4,8,16,0.96);border:1px solid var(--border);
  padding:3px 8px;border-radius:3px;white-space:nowrap;opacity:0;
  pointer-events:none;transition:opacity 0.15s;z-index:100;}
.pal-btn:hover .pal-tip{opacity:1;}

/* Right toolbar */
#toolbar-right{position:absolute;right:10px;top:58px;width:196px;
  display:flex;flex-direction:column;gap:6px;pointer-events:all;max-height:calc(100vh - 80px);overflow-y:auto;}
.t-panel{background:rgba(4,8,16,0.9);border:1px solid var(--border);border-radius:6px;padding:10px;}
.t-panel-hd{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;
  color:var(--gold);margin-bottom:8px;opacity:0.8;}

/* Player cards in HUD */
.plcard{padding:8px;margin-bottom:4px;background:rgba(12,22,36,0.7);
  border-radius:4px;border:1px solid var(--border);cursor:pointer;transition:all 0.2s;}
.plcard:hover{border-color:var(--silver);}
.plcard.sel-pl{border-color:var(--gold);background:rgba(200,168,75,0.07);}
.plcard-name{font-size:13px;font-weight:700;letter-spacing:1px;}
.plcard-role{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;
  color:var(--text2);margin-top:1px;}
.plcard-bars{margin-top:5px;display:flex;flex-direction:column;gap:2px;}
.bar-row{display:flex;align-items:center;gap:4px;}
.bar-lbl{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text3);width:10px;}
.bar-bg{flex:1;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;}
.bar-fg{height:100%;border-radius:2px;transition:width 0.25s;}
.plcard-attrs{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;}
.attr-tag{font-family:'Share Tech Mono',monospace;font-size:7px;font-weight:700;
  padding:1px 5px;border-radius:2px;letter-spacing:0.5px;}

/* Controls panel */
.ctrl-line{font-family:'Share Tech Mono',monospace;font-size:8.5px;color:var(--text2);
  line-height:2;letter-spacing:0.5px;}
.ctrl-key{color:var(--gold);}

/* Path HUD bottom */
#path-hud{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
  display:flex;gap:8px;pointer-events:all;}
.path-btn{padding:7px 18px;border:1px solid rgba(200,168,75,0.25);border-radius:3px;
  background:rgba(4,8,16,0.9);font-family:'Rajdhani',sans-serif;font-size:12px;
  font-weight:600;letter-spacing:3px;color:var(--text2);cursor:pointer;
  transition:all 0.22s;text-transform:uppercase;}
.path-btn:hover{border-color:var(--gold);color:var(--gold);}
.path-btn.active{border-color:var(--gold);color:var(--gold);
  background:rgba(200,168,75,0.1);}

/* ═══════════════════════════ OVERLAYS ═══════════════════════════ */
#combo-hud{position:absolute;top:66px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',sans-serif;font-size:46px;font-weight:900;color:#fff;
  text-shadow:0 0 30px var(--gold),0 0 60px var(--gold);
  opacity:0;transition:opacity 0.3s;pointer-events:none;text-align:center;letter-spacing:4px;}
#combo-hud.show{opacity:1;}
#combo-lbl{font-size:12px;letter-spacing:6px;color:var(--gold);display:block;
  font-family:'Rajdhani',sans-serif;font-weight:700;}
#slowmo-ind{position:absolute;bottom:52px;left:50%;transform:translateX(-50%);
  font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:5px;
  color:var(--gold);opacity:0;pointer-events:none;transition:opacity 0.3s;}
#cine-flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;
  z-index:9996;transition:opacity 0.08s;}
#dmg-num-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.dmg-num{position:absolute;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900;
  pointer-events:none;animation:dmgFloat 0.9s var(--ease) forwards;}
@keyframes dmgFloat{0%{transform:translateY(0) scale(1);opacity:1;}
  60%{transform:translateY(-50px) scale(1.1);opacity:1;}
  100%{transform:translateY(-80px) scale(0.8);opacity:0;}}

/* ═══════════════════════════ PATH MODAL ═══════════════════════════ */
#path-modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);
  display:flex;align-items:center;justify-content:center;z-index:1000;
  opacity:0;pointer-events:none;transition:opacity 0.3s;}
#path-modal.show{opacity:1;pointer-events:all;}
.modal-box{background:var(--bg2);border:1px solid rgba(200,168,75,0.3);
  border-radius:8px;padding:28px;width:380px;}
.modal-ttl{font-family:'Orbitron',sans-serif;font-size:15px;color:var(--gold);
  margin-bottom:18px;letter-spacing:3px;}
.modal-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.modal-lbl{font-size:12px;font-weight:600;letter-spacing:2px;color:var(--text2);width:90px;}
.modal-sel{flex:1;background:var(--bg1);border:1px solid var(--border);border-radius:3px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:13px;padding:6px 10px;cursor:pointer;}
.modal-sel option{background:var(--bg2);}
.modal-btns{display:flex;gap:8px;margin-top:18px;}
.modal-btn{flex:1;padding:10px;border:1px solid var(--border);border-radius:3px;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;letter-spacing:2px;
  cursor:pointer;transition:all 0.2s;text-transform:uppercase;background:transparent;}
.modal-btn.confirm{border-color:var(--gold);color:var(--gold);}
.modal-btn.cancel{color:var(--text2);}
.modal-btn:hover{transform:scale(1.02);}

/* ═══════════════════════════ EDITOR PAGE ═══════════════════════════ */
#page-editor{background:radial-gradient(ellipse at 20% 50%,#080f1a 0%,#020408 80%);
  flex-direction:row;align-items:stretch;justify-content:flex-start;}
#ed-left{width:240px;background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;}
#ed-main{flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:flex-start;padding:16px;overflow-y:auto;}
#ed-right{width:240px;background:var(--bg2);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;}
.ed-sec{padding:14px;border-bottom:1px solid var(--border);}
.ed-sec-ttl{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;
  color:var(--gold);margin-bottom:10px;opacity:0.85;}
.ed-back{padding:11px 14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;cursor:pointer;transition:background 0.2s;}
.ed-back:hover{background:rgba(200,168,75,0.05);}
.ed-back-icon{color:var(--gold);font-size:14px;}
.ed-back-lbl{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;
  letter-spacing:3px;color:var(--text2);text-transform:uppercase;}

/* Role cards */
.role-card{padding:9px 11px;border:1px solid var(--border);border-radius:4px;
  cursor:pointer;margin-bottom:5px;transition:all 0.2s;display:flex;align-items:center;gap:8px;}
.role-card:hover{border-color:var(--silver);}
.role-card.active-role{border-color:var(--gold);background:rgba(200,168,75,0.07);}
.role-abbr{font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:700;
  width:30px;height:22px;display:flex;align-items:center;justify-content:center;
  border-radius:3px;letter-spacing:1px;}
.role-info{flex:1;}
.role-name{font-size:13px;font-weight:700;letter-spacing:2px;}
.role-desc{font-size:10px;color:var(--text2);margin-top:1px;}

/* Stat sliders */
.stat-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.stat-lbl{font-size:11px;font-weight:600;letter-spacing:1px;color:var(--text2);width:30px;}
.stat-sl{flex:1;-webkit-appearance:none;height:3px;border-radius:2px;
  background:var(--border2);outline:none;cursor:pointer;}
.stat-sl::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;
  border-radius:50%;background:var(--gold);cursor:pointer;
  box-shadow:0 0 6px rgba(200,168,75,0.5);}
.stat-val{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--gold);
  width:26px;text-align:right;}

/* Attr grid */
.attr-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;}
.attr-btn{padding:6px 4px;border:1px solid var(--border);border-radius:3px;cursor:pointer;
  text-align:center;transition:all 0.2s;font-family:'Share Tech Mono',monospace;
  font-size:9px;font-weight:700;letter-spacing:0.5px;}
.attr-btn:hover{border-color:var(--silver);}
.attr-btn.active-attr{border-color:currentColor;
  box-shadow:0 0 8px currentColor,inset 0 0 6px rgba(255,255,255,0.05);}

/* Aura preview */
.aura-prev{width:72px;height:72px;border-radius:50%;margin:6px auto;
  display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',
  monospace;font-size:14px;font-weight:700;transition:all 0.4s;}
.aura-lbl{text-align:center;font-family:'Share Tech Mono',monospace;font-size:9px;
  color:var(--text2);letter-spacing:1px;}

/* Skin canvas */
#skin-canvas{border:1px solid var(--border);border-radius:4px;cursor:crosshair;display:block;
  margin:0 auto 10px;image-rendering:pixelated;}
.skin-colors{display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin-bottom:8px;}
.sk-col{width:26px;height:26px;border-radius:50%;border:2px solid transparent;
  cursor:pointer;transition:transform 0.2s,border-color 0.2s;}
.sk-col:hover{transform:scale(1.2);}
.sk-col.sel{border-color:#fff;}
.skin-tools{display:flex;gap:5px;justify-content:center;margin-bottom:8px;}
.sk-tool{padding:5px 12px;border:1px solid var(--border);border-radius:3px;
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;letter-spacing:1px;
  color:var(--text2);cursor:pointer;transition:all 0.2s;text-transform:uppercase;}
.sk-tool:hover,.sk-tool.sel{border-color:var(--gold);color:var(--gold);}
.sk-size{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:8px;}
.sk-size-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text2);}

/* Path recorder */
.rec-disp{background:var(--bg1);border:1px solid var(--border);border-radius:3px;
  padding:8px;min-height:50px;font-family:'Share Tech Mono',monospace;font-size:9px;
  color:var(--text2);margin-bottom:7px;line-height:1.7;}
.rec-btns{display:flex;gap:5px;}
.rec-btn{flex:1;padding:7px;border:1px solid var(--border);border-radius:3px;
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;letter-spacing:1px;
  cursor:pointer;transition:all 0.2s;text-transform:uppercase;text-align:center;
  color:var(--text2);background:transparent;}
.rec-btn:hover{border-color:var(--silver);color:var(--text);}
.rec-btn.recording{border-color:#ff4444;color:#ff4444;animation:recPulse 1s ease infinite;}
@keyframes recPulse{0%,100%{opacity:1;}50%{opacity:0.45;}}

/* Ability cards */
.ab-card{padding:8px;border:1px solid var(--border);border-radius:4px;margin-bottom:5px;
  transition:all 0.2s;cursor:help;}
.ab-card:hover{border-color:var(--silver);}
.ab-name{font-size:12px;font-weight:700;letter-spacing:1px;}
.ab-type{font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;
  color:var(--text2);margin-bottom:3px;}
.ab-desc{font-size:10px;color:var(--text2);line-height:1.4;}

/* Special panel */
.spec-row{display:flex;gap:5px;margin-bottom:5px;}
.spec-btn{flex:1;padding:7px 0;border:1px solid var(--border);border-radius:3px;
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;letter-spacing:1px;
  color:var(--text2);cursor:pointer;transition:all 0.2s;text-transform:uppercase;
  text-align:center;background:transparent;}
.spec-btn:hover{border-color:var(--silver);color:var(--text);}
.spec-btn.sel{border-color:var(--gold);color:var(--gold);background:rgba(200,168,75,0.08);}

/* ═══════════════════════════ CHANGELOG PAGE ═══════════════════════════ */
#page-changelog{background:radial-gradient(ellipse at 30% 50%,#080d16 0%,#020408 80%);
  padding:20px;overflow-y:auto;justify-content:flex-start;align-items:center;}
.cl-wrap{max-width:720px;width:100%;margin:0 auto;padding:20px 0;}
.cl-title{font-family:'Orbitron',sans-serif;font-size:34px;font-weight:900;
  color:var(--gold);letter-spacing:4px;margin-bottom:8px;text-align:center;}
.cl-sub{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;
  color:var(--silver);text-align:center;margin-bottom:40px;}
.cl-back{display:inline-flex;align-items:center;gap:8px;padding:8px 18px;
  border:1px solid var(--border);border-radius:3px;color:var(--text2);
  font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:600;letter-spacing:2px;
  cursor:pointer;transition:all 0.22s;margin-bottom:28px;text-transform:uppercase;}
.cl-back:hover{border-color:var(--gold);color:var(--gold);}
.cl-entry{margin-bottom:22px;background:var(--bg2);border:1px solid var(--border);
  border-radius:6px;overflow:hidden;}
.cl-ehd{padding:12px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;}
.cl-ver{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--gold);}
.cl-date{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--silver);}
.cl-badge{margin-left:auto;padding:3px 10px;border-radius:2px;
  font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:2px;}
.cl-badge.latest{background:rgba(200,168,75,0.18);border:1px solid var(--gold);color:var(--gold);}
.cl-items{padding:14px 18px;display:flex;flex-direction:column;gap:7px;}
.cl-item{display:flex;align-items:flex-start;gap:10px;}
.cl-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;margin-top:7px;}
.cl-dot.feat{background:var(--gold);} .cl-dot.fix{background:#4af;} .cl-dot.chg{background:#f84;}
.cl-txt{font-size:13px;line-height:1.5;color:var(--text);}
.cl-tag{font-family:'Share Tech Mono',monospace;font-size:8px;padding:2px 5px;
  border-radius:2px;margin-right:5px;vertical-align:middle;}
.cl-tag.feat{background:rgba(200,168,75,0.14);color:var(--gold);}
.cl-tag.fix{background:rgba(68,170,255,0.14);color:#4af;}
.cl-tag.chg{background:rgba(255,136,68,0.14);color:#f84;}

/* ═══════════════════════════ NOTIFICATION ═══════════════════════════ */
#notif{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);
  background:var(--bg2);border:1px solid var(--gold);border-radius:4px;
  padding:9px 22px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;
  letter-spacing:2px;color:var(--gold);z-index:50000;
  transition:transform 0.4s var(--ease),opacity 0.4s;opacity:0;pointer-events:none;}
#notif.show{transform:translateX(-50%) translateY(0);opacity:1;}

/* ═══════════════════════════ TOOLTIP ═══════════════════════════ */
.gtt{position:fixed;background:rgba(4,8,16,0.97);border:1px solid var(--border);
  border-radius:3px;padding:5px 10px;font-family:'Share Tech Mono',monospace;font-size:9px;
  color:var(--text2);pointer-events:none;z-index:50000;opacity:0;transition:opacity 0.15s;
  max-width:200px;line-height:1.5;}
.gtt.show{opacity:1;}
</style>
</head>
<body>

<!-- ══════════════════════════ LOADING ══════════════════════════ -->
<div id="loading">
  <div class="ld-logo">StickBox</div>
  <div class="ld-sub">ELEMENTAL ARENA 2.0</div>
  <div class="ld-bar"><div class="ld-fill" id="ld-fill"></div></div>
  <div class="ld-text" id="ld-text">INITIALIZING ENGINE...</div>
</div>

<div id="notif"></div>
<div class="gtt" id="gtt"></div>
<audio id="bgm" loop></audio>

<!-- ══════════════════════════ MENU ══════════════════════════ -->
<div class="page active" id="page-menu">
  <canvas id="menu-bg"></canvas>
  <div class="menu-content">
    <div class="m-logo">StickBox</div>
    <div class="m-sub">ELEMENTAL ARENA</div>
    <div class="m-ver">VERSION 2.0.0 · EARLY ACCESS</div>
    <nav class="m-nav">
      <button class="mbtn primary" onclick="showPage('game')">PLAY SANDBOX<span class="mbtn-arr">▶</span></button>
      <button class="mbtn" onclick="showPage('editor')">CHARACTER EDITOR<span class="mbtn-arr">▶</span></button>
      <button class="mbtn" onclick="showPage('changelog')">CHANGELOG<span class="mbtn-arr">▶</span></button>
    </nav>
    <div class="m-divider"></div>
    <div class="m-elems" id="menu-elem-strip"></div>
  </div>
  <div class="m-bottom">
    <button class="m-music-btn" id="bgm-btn" onclick="toggleBGM()">♪ MUSIC</button>
    <input type="file" id="bgm-file" accept=".mp3,.wav,.ogg" style="display:none" onchange="loadBGM(event)">
    <button class="m-music-btn" onclick="document.getElementById('bgm-file').click()">LOAD MUSIC</button>
  </div>
</div>

<!-- ══════════════════════════ GAME ══════════════════════════ -->
<div class="page" id="page-game">
  <canvas id="game-canvas"></canvas>
  <div id="game-hud">
    <div id="hud-top">
      <div class="hud-logo">STICKBOX</div>
      <div class="hud-btns">
        <button class="hbtn" onclick="spawnPlayer()">+ SPAWN</button>
        <button class="hbtn" onclick="openEditorFromGame()">EDITOR</button>
        <button class="hbtn" id="btn-slowmo" onclick="toggleSlowmo()">SLOWMO</button>
        <button class="hbtn" onclick="toggleAI()">AI BOTS</button>
        <button class="hbtn" onclick="clearAll()">CLEAR</button>
        <button class="hbtn" onclick="showPage('menu')">MENU</button>
      </div>
    </div>
    <div id="elem-palette"></div>
    <div id="toolbar-right">
      <div class="t-panel">
        <div class="t-panel-hd">PLAYERS</div>
        <div id="player-list"></div>
      </div>
      <div class="t-panel">
        <div class="t-panel-hd">CONTROLS</div>
        <div class="ctrl-line"><span class="ctrl-key">WASD</span> — MOVE / JUMP</div>
        <div class="ctrl-line"><span class="ctrl-key">Q</span> — LIGHT ATTACK</div>
        <div class="ctrl-line"><span class="ctrl-key">E</span> — HEAVY ATTACK</div>
        <div class="ctrl-line"><span class="ctrl-key">R</span> — ABILITY 1</div>
        <div class="ctrl-line"><span class="ctrl-key">T</span> — ABILITY 2</div>
        <div class="ctrl-line"><span class="ctrl-key">F</span> — ULTIMATE</div>
        <div class="ctrl-line"><span class="ctrl-key">SHIFT</span> — BLOCK</div>
        <div class="ctrl-line"><span class="ctrl-key">V</span> — DASH</div>
        <div class="ctrl-line"><span class="ctrl-key">G</span> — GRAVITY WELL</div>
        <div class="ctrl-line"><span class="ctrl-key">1-4</span> — FIRE PATH</div>
        <div class="ctrl-line"><span class="ctrl-key">TAB</span> — CYCLE ELEMENT</div>
        <div class="ctrl-line"><span class="ctrl-key">X</span> — RESPAWN (DEAD)</div>
        <div class="ctrl-line"><span class="ctrl-key">RCLICK</span> — SELECT PLAYER</div>
        <div class="ctrl-line"><span class="ctrl-key">CLICK</span> — PLACE ELEMENT</div>
        <div class="ctrl-line"><span class="ctrl-key">DBLCLICK</span> — MANUAL ATTACK</div>
      </div>
    </div>
    <div id="combo-hud"><span id="combo-lbl">COMBO</span><span id="combo-num">0</span>x</div>
    <div id="slowmo-ind">◈ SLOW MOTION ◈</div>
    <div id="path-hud">
      <button class="path-btn" id="path-draw-btn" onclick="togglePathDraw()">✦ DRAW PATH</button>
      <select class="modal-sel" id="path-type-sel" style="width:120px;font-size:11px;" title="Path Type">
        <option value="strike">STRIKE</option>
        <option value="shield">SHIELD</option>
        <option value="trail">TRAIL</option>
        <option value="loop">LOOP</option>
      </select>
      <button class="path-btn" onclick="clearPaths()">✕ CLEAR PATHS</button>
    </div>
    <div id="path-modal">
      <div class="modal-box">
        <div class="modal-ttl">⬡ BIND PATH</div>
        <div class="modal-row">
          <div class="modal-lbl">PLAYER</div>
          <select class="modal-sel" id="pm-player"></select>
        </div>
        <div class="modal-row">
          <div class="modal-lbl">KEY BIND</div>
          <select class="modal-sel" id="pm-key">
            <option value="1">KEY 1</option><option value="2">KEY 2</option>
            <option value="3">KEY 3</option><option value="4">KEY 4</option>
          </select>
        </div>
        <div class="modal-row">
          <div class="modal-lbl">ELEMENT</div>
          <select class="modal-sel" id="pm-elem"></select>
        </div>
        <div class="modal-row">
          <div class="modal-lbl">TYPE</div>
          <select class="modal-sel" id="pm-type">
            <option value="strike">Strike (damages)</option>
            <option value="shield">Shield (barrier)</option>
            <option value="trail">Trail (element stream)</option>
            <option value="loop">Loop (continuous)</option>
          </select>
        </div>
        <div class="modal-btns">
          <button class="modal-btn cancel" onclick="closePathModal()">CANCEL</button>
          <button class="modal-btn confirm" onclick="confirmPath()">BIND PATH</button>
        </div>
      </div>
    </div>
    <div id="cine-flash"></div>
    <div id="dmg-num-layer"></div>
  </div>
</div>

<!-- ══════════════════════════ EDITOR ══════════════════════════ -->
<div class="page" id="page-editor">
  <div id="ed-left">
    <div class="ed-back" onclick="showPage('menu')">
      <span class="ed-back-icon">◂</span>
      <span class="ed-back-lbl">Back to Menu</span>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">CHARACTERS</div>
      <div id="ed-char-list"></div>
      <button onclick="edNewChar()" style="width:100%;margin-top:6px;padding:7px;border:1px dashed var(--border);border-radius:3px;background:transparent;color:var(--text2);font-family:'Rajdhani',sans-serif;font-size:12px;letter-spacing:2px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;">+ NEW CHARACTER</button>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">ROLE</div>
      <div id="role-list"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">BASE STATS</div>
      <div class="stat-row">
        <div class="stat-lbl">HP</div>
        <input type="range" class="stat-sl" id="sl-hp" min="20" max="250" value="100" oninput="edUpdateStat('hp',this.value)">
        <div class="stat-val" id="sv-hp">100</div>
      </div>
      <div class="stat-row">
        <div class="stat-lbl">ATK</div>
        <input type="range" class="stat-sl" id="sl-atk" min="1" max="60" value="15" oninput="edUpdateStat('atk',this.value)">
        <div class="stat-val" id="sv-atk">15</div>
      </div>
      <div class="stat-row">
        <div class="stat-lbl">DEF</div>
        <input type="range" class="stat-sl" id="sl-def" min="0" max="50" value="5" oninput="edUpdateStat('def',this.value)">
        <div class="stat-val" id="sv-def">5</div>
      </div>
      <div class="stat-row">
        <div class="stat-lbl">SPD</div>
        <input type="range" class="stat-sl" id="sl-spd" min="1" max="12" value="4" oninput="edUpdateStat('spd',this.value)">
        <div class="stat-val" id="sv-spd">4</div>
      </div>
      <div class="stat-row">
        <div class="stat-lbl">STA</div>
        <input type="range" class="stat-sl" id="sl-sta" min="30" max="200" value="100" oninput="edUpdateStat('sta',this.value)">
        <div class="stat-val" id="sv-sta">100</div>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">KEYBIND SET</div>
      <div class="spec-row">
        <button class="spec-btn sel" id="kb-wasd" onclick="edSetKeybind('wasd')">WASD</button>
        <button class="spec-btn" id="kb-arrows" onclick="edSetKeybind('arrows')">ARROWS</button>
        <button class="spec-btn" id="kb-num" onclick="edSetKeybind('num')">NUMPAD</button>
      </div>
    </div>
  </div>
  <div id="ed-main">
    <div style="font-family:'Orbitron',sans-serif;font-size:16px;color:var(--gold);letter-spacing:5px;margin-bottom:14px;">CHARACTER EDITOR</div>
    <canvas id="ed-preview" width="200" height="280"></canvas>
    <div style="margin-top:12px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--silver);letter-spacing:3px;text-align:center;margin-bottom:8px;">SKIN PAINTER</div>
    <canvas id="skin-canvas" width="160" height="160"></canvas>
    <div class="skin-colors" id="skin-colors"></div>
    <div class="skin-tools">
      <button class="sk-tool sel" id="skt-brush" onclick="setSkinTool('brush')">BRUSH</button>
      <button class="sk-tool" id="skt-fill" onclick="setSkinTool('fill')">FILL</button>
      <button class="sk-tool" id="skt-line" onclick="setSkinTool('line')">LINE</button>
      <button class="sk-tool" id="skt-erase" onclick="setSkinTool('erase')">ERASE</button>
    </div>
    <div class="sk-size">
      <span class="sk-size-lbl">SIZE:</span>
      <input type="range" style="width:100px;" min="1" max="12" value="5" id="brush-size" oninput="STATE.skinBrushSize=+this.value">
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:4px;">
      <button onclick="edResetSkin()" style="padding:5px 13px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--text2);font-family:'Rajdhani',sans-serif;font-size:11px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;">RESET</button>
      <button onclick="edSaveSkin()" style="padding:5px 13px;border:1px solid var(--gold);border-radius:3px;background:rgba(200,168,75,0.09);color:var(--gold);font-family:'Rajdhani',sans-serif;font-size:11px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;">SAVE SKIN</button>
      <button onclick="edExportChar()" style="padding:5px 13px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--text2);font-family:'Rajdhani',sans-serif;font-size:11px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;">EXPORT</button>
    </div>
  </div>
  <div id="ed-right">
    <div class="ed-sec">
      <div class="ed-sec-ttl">ELEMENTS (MAX 3)</div>
      <div class="attr-grid" id="attr-grid"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">AURA PREVIEW</div>
      <div class="aura-prev" id="aura-prev">—</div>
      <div class="aura-lbl" id="aura-lbl">NO ELEMENT</div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">ROLE ABILITIES</div>
      <div id="ab-list"></div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">SPECIALS</div>
      <div style="font-size:10px;color:var(--text2);margin-bottom:8px;">Toggle special passive traits.</div>
      <div class="spec-row" id="spec-absorb-row">
        <span style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;flex:1;">ABSORB</span>
        <button class="spec-btn sel" id="ab-off" onclick="edSetAbsorb(false)">OFF</button>
        <button class="spec-btn" id="ab-on" onclick="edSetAbsorb(true)">ON</button>
      </div>
      <div class="spec-row" style="margin-top:5px;">
        <span style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;flex:1;">LIFESTEAL</span>
        <button class="spec-btn sel" id="ls-off" onclick="edSetSpec('lifesteal',false)">OFF</button>
        <button class="spec-btn" id="ls-on" onclick="edSetSpec('lifesteal',true)">ON</button>
      </div>
      <div class="spec-row" style="margin-top:5px;">
        <span style="font-size:11px;color:var(--text2);font-weight:600;letter-spacing:1px;flex:1;">SHIELD REGEN</span>
        <button class="spec-btn sel" id="sr-off" onclick="edSetSpec('shieldRegen',false)">OFF</button>
        <button class="spec-btn" id="sr-on" onclick="edSetSpec('shieldRegen',true)">ON</button>
      </div>
    </div>
    <div class="ed-sec">
      <div class="ed-sec-ttl">PATH RECORDER</div>
      <div style="font-size:10px;color:var(--text2);margin-bottom:7px;">Record moves to replay later.</div>
      <div class="rec-disp" id="rec-disp">No recording.</div>
      <div class="rec-btns">
        <button class="rec-btn" id="rec-btn" onclick="toggleRecord()">⏺ REC</button>
        <button class="rec-btn" onclick="playRecord()">▶ PLAY</button>
        <button class="rec-btn" onclick="clearRecord()">✕</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════ CHANGELOG ══════════════════════════ -->
<div class="page" id="page-changelog">
  <div class="cl-wrap">
    <div class="cl-title">CHANGELOG</div>
    <div class="cl-sub">STICKBOX 2.0 DEVELOPMENT HISTORY</div>
    <div class="cl-back" onclick="showPage('menu')">◂ BACK TO MENU</div>
    <div class="cl-entry">
      <div class="cl-ehd"><div class="cl-ver">v2.0.0</div><div class="cl-date">2025-06-15</div><div class="cl-badge latest">LATEST</div></div>
      <div class="cl-items">
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>30 elements with unique particle configs, effects and combos</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>55+ elemental combo reactions with unique visual effects</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>12 character roles with passive/active/ultimate abilities</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Real fighting system: light/heavy/special/block/dash/ultimate</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Stagger system, parry windows, combo multipliers</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Improved character renderer with capsule limbs, glowing joints, weapons</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>20+ aura effects, elemental aura blending</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Working path system: draw, bind, trigger with effects</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Full character editor with working skin painter and save/export</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Specials: absorption, lifesteal, shield regen, reflect, parry-break</div></div>
        <div class="cl-item"><div class="cl-dot feat"></div><div class="cl-txt"><span class="cl-tag feat">FEAT</span>Multi-player keybind sets: WASD, Arrows, Numpad</div></div>
        <div class="cl-item"><div class="cl-dot chg"></div><div class="cl-txt"><span class="cl-tag chg">CHANGE</span>Replaced all emojis with colored letter abbreviations</div></div>
        <div class="cl-item"><div class="cl-dot fix"></div><div class="cl-txt"><span class="cl-tag fix">FIX</span>Player controls now work reliably for any selected player</div></div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
// ──────────────────────────── 30 ELEMENTS ────────────────────────────
const ELEM = {
  fire:      {abbr:'FIR',name:'Fire',      col:'#ff4d1a',glow:'#ff8844',dark:'#6e1500',ps:['tear','shard'],    grav:-0.15,drag:0.97, dmg:14,eff:'burn',       cnt:18},
  water:     {abbr:'WTR',name:'Water',     col:'#1ab4ff',glow:'#7dd4f8',dark:'#003d6e',ps:['tear','circle'],   grav:0.05, drag:0.98, dmg:8, eff:'slow',       cnt:14},
  lightning: {abbr:'LTN',name:'Lightning', col:'#ffe01a',glow:'#fff07a',dark:'#806000',ps:['bolt','shard'],    grav:-0.05,drag:0.94, dmg:18,eff:'stun_brief', cnt:22},
  ice:       {abbr:'ICE',name:'Ice',       col:'#a0e8ff',glow:'#e8f8ff',dark:'#1a5a80',ps:['snow','diamond'],  grav:0.02, drag:0.99, dmg:10,eff:'slow_heavy', cnt:16},
  void:      {abbr:'VOD',name:'Void',      col:'#9b1aff',glow:'#cc6fff',dark:'#2a003a',ps:['ring','star'],     grav:-0.01,drag:0.995,dmg:22,eff:'pull',       cnt:12},
  plasma:    {abbr:'PLS',name:'Plasma',    col:'#ff1a8c',glow:'#ff80c8',dark:'#5a0030',ps:['star','bolt'],     grav:-0.1, drag:0.96, dmg:20,eff:'burn_aoe',   cnt:20},
  earth:     {abbr:'ETH',name:'Earth',     col:'#c8a060',glow:'#e8c878',dark:'#3a2000',ps:['diamond','shard'], grav:0.2,  drag:0.93, dmg:16,eff:'knockdown',  cnt:12},
  wind:      {abbr:'WND',name:'Wind',      col:'#b0ffcc',glow:'#e8fff2',dark:'#206040',ps:['ring','tear'],     grav:-0.12,drag:0.98, dmg:8, eff:'knockback',  cnt:16},
  shadow:    {abbr:'SDW',name:'Shadow',    col:'#8844cc',glow:'#bb77ff',dark:'#0a0010',ps:['ring','star'],     grav:0,    drag:0.99, dmg:18,eff:'blind',      cnt:14},
  light:     {abbr:'LGT',name:'Light',     col:'#fffaaa',glow:'#ffffff',dark:'#c8a820',ps:['star','cross'],    grav:-0.2, drag:0.96, dmg:12,eff:'reveal',     cnt:18},
  poison:    {abbr:'PSN',name:'Poison',    col:'#44ff44',glow:'#88ff88',dark:'#004400',ps:['tear','shard'],    grav:0.1,  drag:0.97, dmg:6, eff:'dot_6s',     cnt:14},
  magma:     {abbr:'MGM',name:'Magma',     col:'#ff6600',glow:'#ff9944',dark:'#660000',ps:['shard','diamond'], grav:0.15, drag:0.95, dmg:20,eff:'burn_heavy', cnt:12},
  storm:     {abbr:'STM',name:'Storm',     col:'#2288cc',glow:'#66aaff',dark:'#001144',ps:['bolt','ring'],     grav:-0.08,drag:0.96, dmg:22,eff:'chain',      cnt:20},
  frost:     {abbr:'FRS',name:'Frost',     col:'#88ddff',glow:'#cceeff',dark:'#003366',ps:['snow','diamond'],  grav:0.03, drag:0.995,dmg:12,eff:'freeze_3s',  cnt:16},
  arcane:    {abbr:'ARC',name:'Arcane',    col:'#cc44ff',glow:'#ee88ff',dark:'#440066',ps:['star','ring'],     grav:-0.05,drag:0.97, dmg:24,eff:'curse',      cnt:16},
  blood:     {abbr:'BLD',name:'Blood',     col:'#cc0022',glow:'#ff4466',dark:'#440000',ps:['tear','shard'],    grav:0.1,  drag:0.97, dmg:16,eff:'bleed_5s',   cnt:14},
  time:      {abbr:'TIM',name:'Time',      col:'#88ccaa',glow:'#aaffcc',dark:'#224433',ps:['ring','circle'],   grav:0,    drag:0.999,dmg:15,eff:'haste_self', cnt:10},
  space:     {abbr:'SPC',name:'Space',     col:'#3344cc',glow:'#6688ff',dark:'#000022',ps:['star','ring'],     grav:-0.02,drag:0.998,dmg:20,eff:'warp',       cnt:12},
  crystal:   {abbr:'CRY',name:'Crystal',   col:'#88ffff',glow:'#ccffff',dark:'#004444',ps:['diamond','shard'], grav:0.05, drag:0.97, dmg:14,eff:'shard_burst',cnt:16},
  metal:     {abbr:'MTL',name:'Metal',     col:'#aabbcc',glow:'#ddeeff',dark:'#223344',ps:['diamond','cross'], grav:0.15, drag:0.94, dmg:18,eff:'armor_pen',  cnt:14},
  nature:    {abbr:'NAT',name:'Nature',    col:'#44aa22',glow:'#88cc66',dark:'#004400',ps:['tear','ring'],     grav:-0.05,drag:0.98, dmg:8, eff:'heal_dot',   cnt:14},
  acid:      {abbr:'ACD',name:'Acid',      col:'#aaff00',glow:'#ccff44',dark:'#334400',ps:['tear','shard'],    grav:0.08, drag:0.97, dmg:12,eff:'armor_shred',cnt:16},
  gravity:   {abbr:'GRV',name:'Gravity',   col:'#6644aa',glow:'#9977dd',dark:'#110022',ps:['ring','circle'],   grav:0.05, drag:1,    dmg:20,eff:'pull_strong',cnt:10},
  sonic:     {abbr:'SON',name:'Sonic',     col:'#44ffff',glow:'#88ffff',dark:'#004444',ps:['ring','cross'],    grav:-0.03,drag:0.97, dmg:14,eff:'stun_mid',   cnt:18},
  radiation: {abbr:'RAD',name:'Radiation', col:'#ccff22',glow:'#eeff88',dark:'#224400',ps:['star','ring'],     grav:0,    drag:0.98, dmg:8, eff:'dot_heavy',  cnt:14},
  magnet:    {abbr:'MAG',name:'Magnet',    col:'#6688cc',glow:'#88aaee',dark:'#112244',ps:['cross','ring'],    grav:0,    drag:0.97, dmg:12,eff:'attract',    cnt:14},
  aether:    {abbr:'AET',name:'Aether',    col:'#ffd080',glow:'#ffe8aa',dark:'#442200',ps:['star','diamond'],  grav:-0.15,drag:0.97, dmg:18,eff:'dispel',     cnt:14},
  chaos:     {abbr:'CHS',name:'Chaos',     col:'#ff4488',glow:'#ff88bb',dark:'#440011',ps:['shard','bolt'],    grav:-0.05,drag:0.95, dmg:30,eff:'random_all', cnt:22},
  order:     {abbr:'ORD',name:'Order',     col:'#e8e8ff',glow:'#ffffff',dark:'#334466',ps:['cross','diamond'], grav:0,    drag:0.98, dmg:10,eff:'parry_break',cnt:12},
  nether:    {abbr:'NTH',name:'Nether',    col:'#6600aa',glow:'#9933cc',dark:'#000000',ps:['ring','shard'],    grav:0.05, drag:0.999,dmg:35,eff:'doom',       cnt:10},
};
const EKEYS = Object.keys(ELEM);

// ─────────────────────────── 55+ COMBOS ──────────────────────────────
const COMBOS = {};
function RC(e1,e2,n,re,d,ef,aoe,fc){
  const k=`${e1}+${e2}`;
  COMBOS[k]=COMBOS[`${e2}+${e1}`]={name:n,result:re,dmg:d,eff:ef,aoe,flash:fc,key:k};
}
RC('fire','water',       'Steam Wall',        'water',   15,'steam_cloud',  100,'#aaccff');
RC('fire','wind',        'Firestorm',         'fire',    28,'tornado_fire', 130,'#ff8844');
RC('fire','earth',       'Magma Surge',       'magma',   32,'magma_slow',   100,'#ff6600');
RC('fire','ice',         'Supercool Burst',   'water',   42,'freeze_pop',    90,'#ccffff');
RC('fire','shadow',      'Hellfire',          'fire',    48,'unblockable',   70,'#ff0044');
RC('fire','lightning',   'Plasma Arc',        'plasma',  36,'chain_dmg',    110,'#ff44ff');
RC('fire','blood',       'Infernal Drain',    'blood',   52,'lifesteal',     80,'#ff0022');
RC('fire','magma',       'Volcanic Burst',    'magma',   60,'knockup',      140,'#ff6600');
RC('fire','chaos',       'Wildfire',          'chaos',   44,'random_burn',  150,'#ff44aa');
RC('fire','nature',      'Primal Flame',      'magma',   36,'burn_regen',   110,'#ff8844');
RC('water','ice',        'Blizzard',          'frost',   22,'freeze_zone',  160,'#aaeeff');
RC('water','lightning',  'Electrolysis',      'storm',   32,'stun_chain',   100,'#44ffff');
RC('water','poison',     'Toxic Flood',       'acid',    26,'dot_spread',   140,'#44ff44');
RC('water','earth',      'Mudslide',          'earth',   18,'slow_heavy',   130,'#88aa44');
RC('water','wind',       'Vortex Wave',       'wind',    22,'pull_wave',    150,'#aaffcc');
RC('water','nature',     'Life Surge',        'nature',  0, 'heal_all',     130,'#44ff88');
RC('water','acid',       'Acid Rain',         'acid',    28,'aoe_dot',      180,'#aaff00');
RC('lightning','ice',    'Frostbolt',         'frost',   48,'pierce_freeze', 60,'#88ddff');
RC('lightning','earth',  'Quake',             'earth',   42,'stun_ground',  170,'#c8a060');
RC('lightning','metal',  'Railgun',           'metal',   88,'pierce_all',    40,'#ccddff');
RC('lightning','storm',  'Thunderclap',       'storm',   38,'aoe_stun',     210,'#6699ff');
RC('lightning','shadow', 'Dark Charge',       'shadow',  58,'blind_chain',   90,'#6633cc');
RC('lightning','sonic',  'Shockwave',         'sonic',   40,'push_all',     200,'#44ffff');
RC('lightning','void',   'Arc Singularity',   'void',    55,'micro_pull',   120,'#9933ff');
RC('ice','crystal',      'Diamond Dust',      'crystal', 32,'slow_shard',   120,'#88ffff');
RC('ice','wind',         'Polar Vortex',      'frost',   28,'freeze_pull',  190,'#cceeff');
RC('ice','shadow',       'Frozen Soul',       'shadow',  38,'stun_long',     80,'#4444aa');
RC('ice','metal',        'Cryosteel',         'metal',   30,'armor_freeze',  90,'#88bbdd');
RC('void','plasma',      'Singularity',       'void',    65,'pull_all',     260,'#9b1aff');
RC('void','gravity',     'Black Hole',        'gravity', 85,'crush_all',    210,'#6644aa');
RC('void','shadow',      'Abyss',             'shadow',  108,'doom_zone',   130,'#000066');
RC('void','space',       'Dimensional Rift',  'space',   72,'teleport_dmg',   0,'#3344ff');
RC('void','nether',      'Oblivion Gate',     'nether',  95,'doom_aoe',     180,'#440066');
RC('plasma','chaos',     'Reality Shatter',   'chaos',   95,'chaos_burst',  320,'#ff44ff');
RC('shadow','blood',     'Vampiric Drain',    'blood',   42,'lifesteal_aoe',110,'#880022');
RC('shadow','arcane',    'Death Curse',       'arcane',  55,'dot_curse',     85,'#8800cc');
RC('shadow','nether',    'Soul Devour',       'nether',  90,'drain_soul',    80,'#440066');
RC('light','shadow',     'Annihilation',      'aether',  130,'annihilate',  160,'#ffffff');
RC('light','order',      'Divine Judgment',   'order',   88,'stun_holy',    140,'#ffffaa');
RC('light','blood',      'Holy Blaze',        'light',   68,'heal_dmg',     100,'#ffff88');
RC('light','arcane',     'Celestial Bolt',    'aether',  75,'dispel_burst', 110,'#ffeedd');
RC('time','space',       'Temporal Rift',     'space',   52,'slow_time_zone',210,'#88ccff');
RC('time','order',       'Chronostasis',      'time',    0, 'stop_all',     450,'#aaffcc');
RC('chaos','order',      'Reality Break',     'chaos',   160,'reality_break',600,'#ff88ff');
RC('earth','metal',      'Iron Fortress',     'metal',   20,'shield_create',  0,'#aabbcc');
RC('earth','crystal',    'Gem Storm',         'crystal', 38,'pierce_shard', 130,'#88ffff');
RC('earth','nature',     'Overgrowth',        'nature',  12,'root_bind',    160,'#44aa22');
RC('earth','gravity',    'Seismic Crush',     'gravity', 50,'ground_pound', 150,'#6644aa');
RC('wind','lightning',   'Hurricane Bolt',    'storm',   48,'push_stun',    140,'#2288cc');
RC('wind','arcane',      'Arcane Gale',       'arcane',  42,'push_curse',   170,'#cc44ff');
RC('blood','arcane',     'Blood Magic',       'arcane',  58,'lifesteal_curse',95,'#cc00cc');
RC('poison','acid',      'Corrosion',         'acid',    32,'dot_armor',    105,'#88ff00');
RC('poison','nature',    'Plague Bloom',      'poison',  28,'spread_dot',   150,'#44cc44');
RC('sonic','metal',      'Resonance Break',   'sonic',   58,'armor_shatter',130,'#88ccff');
RC('radiation','acid',   'Meltdown',          'acid',    65,'heavy_dot',    135,'#ccff00');
RC('gravity','magnet',   'Polar Collapse',    'gravity', 72,'crush_metal',  165,'#6688cc');
RC('aether','arcane',    'Celestial Burst',   'aether',  78,'heal_dmg_burst',110,'#ffd080');
RC('nether','void',      'Oblivion',          'nether',  115,'doom_aoe',    190,'#220033');
RC('magma','nature',     'Primordial Surge',  'magma',   45,'burn_heal',    120,'#ff7722');
RC('crystal','magnet',   'Magnetic Shards',   'crystal', 38,'pull_pierce',  175,'#88eeff');
RC('metal','order',      'Absolute Defense',  'metal',   0, 'full_shield',    0,'#e8e8ff');
RC('chaos','shadow',     'Nightmare',         'chaos',   70,'fear_debuff',  150,'#ff2266');
RC('storm','wind',       'Tempest',           'storm',   55,'mega_push',    220,'#4499ff');

// ──────────────────────────── 12 ROLES ───────────────────────────────
const ROLES = {
  fighter:    {name:'Fighter',    abbr:'FGT',col:'#ff8844',hp:100,atk:20,def:5, spd:4,sta:100,passive:'combo_bonus',   a1:'triple_slash', a2:'war_cry',      ult:'blade_storm',    desc:'Balanced melee combatant'},
  tank:       {name:'Tank',       abbr:'TNK',col:'#4488ff',hp:180,atk:8, def:20,spd:2,sta:150,passive:'fortress',      a1:'shield_bash',  a2:'taunt',        ult:'iron_fortress',  desc:'Immovable defense master'},
  assassin:   {name:'Assassin',   abbr:'ASN',col:'#cc44ff',hp:60, atk:35,def:2, spd:9,sta:80, passive:'crit_chance',   a1:'shadow_step',  a2:'backstab',     ult:'death_mark',     desc:'Glass cannon speed killer'},
  support:    {name:'Support',    abbr:'SUP',col:'#44ff88',hp:80, atk:5, def:5, spd:5,sta:120,passive:'aura_heal',     a1:'barrier',      a2:'rally',        ult:'mass_heal',      desc:'Healer and team buffer'},
  mage:       {name:'Mage',       abbr:'MGE',col:'#8844ff',hp:70, atk:28,def:3, spd:5,sta:90, passive:'elem_amp',      a1:'elem_bolt',    a2:'mana_shield',  ult:'elem_nova',      desc:'Elemental power master'},
  berserker:  {name:'Berserker',  abbr:'BRK',col:'#ff2222',hp:120,atk:30,def:3, spd:6,sta:200,passive:'rage_scaling',  a1:'frenzy',       a2:'blood_lust',   ult:'berserker_rage', desc:'Stronger as HP drops'},
  paladin:    {name:'Paladin',    abbr:'PLD',col:'#fffaaa',hp:130,atk:14,def:14,spd:3,sta:130,passive:'holy_regen',    a1:'consecrate',   a2:'holy_shield',  ult:'divine_judgment',desc:'Holy warrior and guardian'},
  rogue:      {name:'Rogue',      abbr:'RGU',col:'#cc8844',hp:75, atk:22,def:4, spd:8,sta:85, passive:'evasion',       a1:'smoke_bomb',   a2:'cheap_shot',   ult:'assassination',  desc:'Crit and evasion specialist'},
  summoner:   {name:'Summoner',   abbr:'SMN',col:'#44ccff',hp:65, atk:12,def:3, spd:5,sta:95, passive:'minion_buff',   a1:'summon_shade', a2:'elem_familiar',ult:'summon_legion',  desc:'Controls summoned entities'},
  necromancer:{name:'Necromancer',abbr:'NCR',col:'#6633aa',hp:75, atk:18,def:5, spd:4,sta:100,passive:'death_charge',  a1:'bone_spear',   a2:'life_drain',   ult:'death_wave',     desc:'Death and blood magic wielder'},
  druid:      {name:'Druid',      abbr:'DRD',col:'#44aa22',hp:95, atk:12,def:8, spd:5,sta:110,passive:'regen',         a1:'entangle',     a2:'animal_form',  ult:'nature_wrath',   desc:'Nature and earth shaper'},
  templar:    {name:'Templar',    abbr:'TPL',col:'#e8e8ff',hp:110,atk:16,def:12,spd:3,sta:120,passive:'counter_stance',a1:'judgement',    a2:'reflect',      ult:'divine_wrath',   desc:'Order and counter specialist'},
};
const RKEYS = Object.keys(ROLES);

// ─────────────────────────── ABILITIES ───────────────────────────────
const ABILITIES = {
  // Passives
  combo_bonus:    {type:'p',name:'Combo Bonus',    desc:'Each combo hit +5% damage'},
  fortress:       {type:'p',name:'Fortress',       desc:'No knockback while blocking'},
  crit_chance:    {type:'p',name:'Critical',       desc:'20% chance to deal 2x damage'},
  aura_heal:      {type:'p',name:'Aura Heal',      desc:'Allies near you regen 0.5 HP/s'},
  elem_amp:       {type:'p',name:'Elem Amp',       desc:'Element damage +30%'},
  rage_scaling:   {type:'p',name:'Rage',           desc:'ATK scales up to 3x as HP drops'},
  holy_regen:     {type:'p',name:'Holy Regen',     desc:'Slowly regenerate HP out of combat'},
  evasion:        {type:'p',name:'Evasion',        desc:'15% chance to dodge attacks'},
  minion_buff:    {type:'p',name:'Minion Mastery', desc:'Summoned entities +25% damage'},
  death_charge:   {type:'p',name:'Death Charge',   desc:'Defeats fill ultimate meter'},
  regen:          {type:'p',name:'Regeneration',   desc:'Regen 1 HP/s, +3 in nature zones'},
  counter_stance: {type:'p',name:'Counter Stance', desc:'Perfect block returns 200% damage'},
  // Actives (cd in frames @60fps)
  triple_slash:   {type:'a',name:'Triple Slash',  cd:60,  cost:20,desc:'3 rapid slashes in succession'},
  shield_bash:    {type:'a',name:'Shield Bash',   cd:90,  cost:25,desc:'Stun and push enemy back'},
  shadow_step:    {type:'a',name:'Shadow Step',   cd:45,  cost:15,desc:'Teleport behind nearest enemy'},
  barrier:        {type:'a',name:'Barrier',       cd:180, cost:40,desc:'Create protective barrier 5s'},
  elem_bolt:      {type:'a',name:'Elem Bolt',     cd:30,  cost:15,desc:'Fire concentrated element bolt'},
  frenzy:         {type:'a',name:'Frenzy',        cd:120, cost:50,desc:'Attack speed 2x for 3s'},
  consecrate:     {type:'a',name:'Consecrate',    cd:150, cost:35,desc:'Sanctify ground, damages enemies'},
  smoke_bomb:     {type:'a',name:'Smoke Bomb',    cd:90,  cost:20,desc:'Create smoke, gain stealth'},
  summon_shade:   {type:'a',name:'Summon Shade',  cd:200, cost:50,desc:'Summon shade to fight for you'},
  bone_spear:     {type:'a',name:'Bone Spear',    cd:40,  cost:20,desc:'Launch piercing bone projectile'},
  entangle:       {type:'a',name:'Entangle',      cd:120, cost:30,desc:'Root enemies in place 2s'},
  judgement:      {type:'a',name:'Judgement',     cd:80,  cost:25,desc:'Strike with order energy'},
  war_cry:        {type:'a',name:'War Cry',       cd:180, cost:30,desc:'Buff ally ATK 20% for 5s'},
  taunt:          {type:'a',name:'Taunt',         cd:120, cost:20,desc:'Force enemies to target you'},
  backstab:       {type:'a',name:'Backstab',      cd:60,  cost:25,desc:'Triple damage from behind'},
  rally:          {type:'a',name:'Rally',         cd:200, cost:45,desc:'Restore 30 HP to all allies'},
  mana_shield:    {type:'a',name:'Mana Shield',   cd:120, cost:35,desc:'Absorb next hit with element energy'},
  blood_lust:     {type:'a',name:'Blood Lust',    cd:90,  cost:40,desc:'Drain HP from nearby enemies'},
  holy_shield:    {type:'a',name:'Holy Shield',   cd:150, cost:30,desc:'Immune to next 3 hits'},
  cheap_shot:     {type:'a',name:'Cheap Shot',    cd:60,  cost:20,desc:'Stun enemy 1.5s'},
  elem_familiar:  {type:'a',name:'Elem Familiar', cd:180, cost:40,desc:'Summon element familiar'},
  life_drain:     {type:'a',name:'Life Drain',    cd:80,  cost:25,desc:'Steal HP from target'},
  animal_form:    {type:'a',name:'Animal Form',   cd:240, cost:60,desc:'Transform for +SPD and +ATK'},
  reflect:        {type:'a',name:'Reflect',       cd:100, cost:30,desc:'Reflect next projectile/spell'},
  // Ultimates
  blade_storm:    {type:'u',name:'Blade Storm',    cost:100,desc:'Rapid spinning attacks on all nearby'},
  iron_fortress:  {type:'u',name:'Iron Fortress',  cost:100,desc:'Invincible 4s, reflect all damage'},
  death_mark:     {type:'u',name:'Death Mark',     cost:100,desc:'Mark enemy: 5s to kill or die'},
  mass_heal:      {type:'u',name:'Mass Heal',      cost:100,desc:'Fully heal all allies'},
  elem_nova:      {type:'u',name:'Elem Nova',      cost:100,desc:'Giant elemental explosion centered on self'},
  berserker_rage: {type:'u',name:'Berserker Rage', cost:100,desc:'Unlimited stamina, 3x ATK, stun immunity 6s'},
  divine_judgment:{type:'u',name:'Divine Judgment',cost:100,desc:'Call holy fire on all enemies'},
  assassination:  {type:'u',name:'Assassination',  cost:100,desc:'Instant kill <30% HP, else 80% damage'},
  summon_legion:  {type:'u',name:'Summon Legion',  cost:100,desc:'Summon 3 powerful minions'},
  death_wave:     {type:'u',name:'Death Wave',     cost:100,desc:'Wave kills minions, drains HP'},
  nature_wrath:   {type:'u',name:'Nature Wrath',   cost:100,desc:'Massive roots and nature explosion'},
  divine_wrath:   {type:'u',name:'Divine Wrath',   cost:100,desc:'Judge all enemies by their sins'},
};

// ─────────────────────────── AURAS ───────────────────────────────────
const AURAS = {
  fire:      {name:'Ember Aura',       col:'#ff4d1a',eff:'flame_ring'},
  water:     {name:'Tide Aura',        col:'#1ab4ff',eff:'water_ripple'},
  lightning: {name:'Storm Corona',     col:'#ffe01a',eff:'lightning_ring'},
  ice:       {name:'Frost Crystals',   col:'#a0e8ff',eff:'crystal_orbit'},
  void:      {name:'Void Orbit',       col:'#9b1aff',eff:'void_spiral'},
  plasma:    {name:'Plasma Shell',     col:'#ff1a8c',eff:'plasma_burst'},
  earth:     {name:'Stone Shell',      col:'#c8a060',eff:'rock_orbit'},
  wind:      {name:'Wind Walker',      col:'#b0ffcc',eff:'wind_trails'},
  shadow:    {name:'Shadow Tendrils',  col:'#8844cc',eff:'tendrils'},
  light:     {name:'Holy Nimbus',      col:'#fffaaa',eff:'nimbus'},
  blood:     {name:'Blood Vortex',     col:'#cc0022',eff:'blood_swirl'},
  chaos:     {name:'Chaos Fractals',   col:'#ff4488',eff:'chaos_swirl'},
  order:     {name:'Order Lattice',    col:'#e8e8ff',eff:'lattice'},
  arcane:    {name:'Arcane Sigils',    col:'#cc44ff',eff:'sigil_orbit'},
  nether:    {name:'Nether Shroud',    col:'#6600aa',eff:'shroud'},
  metal:     {name:'Iron Plating',     col:'#aabbcc',eff:'armor_plates'},
  nature:    {name:'Living Vines',     col:'#44aa22',eff:'vine_wrap'},
  crystal:   {name:'Crystal Lattice',  col:'#88ffff',eff:'crystal_shell'},
  time:      {name:'Temporal Ring',    col:'#88ccaa',eff:'time_ring'},
  gravity:   {name:'Gravity Well',     col:'#6644aa',eff:'gravity_bend'},
  berserker_rage:{name:'Battle Rage',  col:'#ff2200',eff:'rage_fire'},
  divine:    {name:'Divine Glow',      col:'#fffaaa',eff:'divine_pulse'},
  death:     {name:'Death Mark',       col:'#660066',eff:'death_swirl'},
  summoned:  {name:'Bound Spirit',     col:'#44ccff',eff:'spirit_ring'},
};

// ─────────────────────────── KEYBIND SETS ────────────────────────────
const KEYBINDS = {
  wasd:   {left:'a',right:'d',jump:'w',down:'s',light:'q',heavy:'e',ab1:'r',ab2:'t',ult:'f',block:'shift',dash:'v',path1:'1',path2:'2',path3:'3',path4:'4',respawn:'x'},
  arrows: {left:'arrowleft',right:'arrowright',jump:'arrowup',down:'arrowdown',light:'j',heavy:'k',ab1:'l',ab2:';',ult:'\'',block:'rshift',dash:'/',path1:'numpad1',path2:'numpad2',path3:'numpad3',path4:'numpad4',respawn:'m'},
  num:    {left:'numpad4',right:'numpad6',jump:'numpad8',down:'numpad5',light:'numpad7',heavy:'numpad9',ab1:'numpad1',ab2:'numpad3',ult:'numpad0',block:'numpad2',dash:'numpadenter',path1:'f5',path2:'f6',path3:'f7',path4:'f8',respawn:'numpad5'},
};

// ─────────────────────────── STATE ───────────────────────────────────
const STATE = {
  page:'menu', frame:0,
  selectedElement:'fire',
  selectedPlayer:null,
  editingPlayer:null,

  players:[], particles:[], elements:[], hazardZones:[],
  gravityWells:[], projectiles:[], effects:[],

  pathDrawing:false, pathDrawType:'strike',
  currentPath:[], paths:[], pendingPath:null,

  isSlowmo:false, slowmoFactor:1,
  comboCount:0, comboTimer:null, lastComboElem:null,

  skinTool:'brush', skinColor:'#4488ff', skinBrushSize:5,
  skinLineStart:null,

  musicPlaying:false, sfxEnabled:true,
  isRecording:false, recordBuffer:[],

  aiEnabled:false,
  keys:{},
};

// ─────────────────────────── PLAYER FACTORY ──────────────────────────
let _pid = 0;
function mkPlayer(x,y,opts={}){
  const id=++_pid;
  const role=opts.role||'fighter';
  const rs=ROLES[role];
  return {
    id, name:opts.name||`P${id}`,
    x, y, vx:0, vy:0,
    onGround:false, facing:1,

    maxHp:opts.hp||rs.hp, hp:opts.hp||rs.hp,
    atk:opts.atk||rs.atk, def:opts.def||rs.def,
    spd:opts.spd||rs.spd,
    maxSta:opts.sta||rs.sta, sta:opts.sta||rs.sta,
    shield:0, maxShield:50,
    stagger:0, maxStagger:100,
    ultMeter:0, maxUlt:100,
    role, attrs:opts.attrs||[], activeElem:null,

    skinColor:opts.skinColor||'#4488ff',
    skinColor2:opts.skinColor2||'#2266cc',
    customPixels:null,
    keybind:opts.keybind||'wasd',

    abils:{passive:rs.passive,a1:rs.a1,a2:rs.a2,ult:rs.ult},
    cds:{a1:0,a2:0,ult:0,dash:0},

    absorbEnabled:false, absorbedElem:null,
    specials:{lifesteal:false,shieldRegen:false},
    statusFX:[],   // [{type,dur,str}]

    cstate:'idle', // idle|attacking|blocking|dashing|stunned|dead|hurt
    attackType:null, attackFrame:0, attackMax:0,
    activeFrames:[0,0], hitThisAttack:new Set(),
    blockFrames:0,
    invFrames:0,
    comboStep:0, lastLightAt:0,
    frenzied:false,

    animTime:0, depth:opts.depth||(0.85+Math.random()*0.3),
    isDead:false, isHurt:false, hurtTimer:0,

    paths:{},
    inputHistory:[],
  };
}

// ─────────────────────────── UTIL ────────────────────────────────────
const dist=(x1,y1,x2,y2)=>Math.sqrt((x1-x2)**2+(y1-y2)**2);
const lerp=(a,b,t)=>a+(b-a)*t;
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const rnd=(a,b)=>a+Math.random()*(b-a);
const rndInt=(a,b)=>Math.floor(rnd(a,b+1));
const rndOf=arr=>arr[Math.floor(Math.random()*arr.length)];
function lightenHex(hex,t){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgb(${Math.round(r+(255-r)*t)},${Math.round(g+(255-g)*t)},${Math.round(b+(255-b)*t)})`;
}
function darkenHex(hex,t){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgb(${Math.round(r*(1-t))},${Math.round(g*(1-t))},${Math.round(b*(1-t))})`;
}
function hexA(hex,a){
  if(hex.startsWith('rgb')){return hex.replace(/rgb\((.+)\)/,`rgba($1,${a})`);}
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}
function catmullRom(pts,tension=0.5,segments=8){
  if(pts.length<2)return pts;
  const result=[];
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(pts.length-1,i+2)];
    for(let s=0;s<segments;s++){
      const t=s/segments,t2=t*t,t3=t2*t;
      const h0=-tension*t3+2*tension*t2-tension*t;
      const h1=(2-tension)*t3+(tension-3)*t2+1;
      const h2=(tension-2)*t3+(3-2*tension)*t2+tension*t;
      const h3=tension*t3-tension*t2;
      result.push({x:h0*p0.x+h1*p1.x+h2*p2.x+h3*p3.x,y:h0*p0.y+h1*p1.y+h2*p2.y+h3*p3.y});
    }
  }
  result.push(pts[pts.length-1]);
  return result;
}

// ─────────────────────────── NOTIFY / TOOLTIP ────────────────────────
let _notifT;
function notify(msg,col){
  const el=document.getElementById('notif');
  el.textContent=msg;
  el.style.borderColor=col||'var(--gold)';
  el.style.color=col||'var(--gold)';
  el.classList.add('show');
  clearTimeout(_notifT);
  _notifT=setTimeout(()=>el.classList.remove('show'),2400);
}
const gtt=document.getElementById('gtt');
function showTooltip(e,txt){gtt.textContent=txt;gtt.classList.add('show');
  gtt.style.left=(e.clientX+12)+'px';gtt.style.top=(e.clientY-8)+'px';}
function moveTooltip(e){gtt.style.left=(e.clientX+12)+'px';gtt.style.top=(e.clientY-8)+'px';}
function hideTooltip(){gtt.classList.remove('show');}

// ─────────────────────────── FLASH / DAMAGE NUMBERS ──────────────────
function cinFlash(intensity=0.3){
  const f=document.getElementById('cine-flash');
  f.style.opacity=String(intensity);
  setTimeout(()=>{f.style.opacity='0';},100);
}
function spawnDmgNum(x,y,val,col){
  const layer=document.getElementById('dmg-num-layer');
  const el=document.createElement('div');
  el.className='dmg-num';
  el.textContent=val>0?`-${val}`:(val<0?`+${-val}`:'MISS');
  el.style.color=val>0?(col||'#ff4444'):'#44ff88';
  el.style.left=x+'px'; el.style.top=y+'px';
  el.style.textShadow=`0 0 10px ${el.style.color}`;
  layer.appendChild(el);
  setTimeout(()=>el.remove(),950);
}

// ─────────────────────────── MUSIC ───────────────────────────────────
const bgm=document.getElementById('bgm');
function toggleBGM(){
  const btn=document.getElementById('bgm-btn');
  if(STATE.musicPlaying){bgm.pause();STATE.musicPlaying=false;btn.textContent='♪ MUSIC';}
  else{bgm.play().catch(()=>{});STATE.musicPlaying=true;btn.textContent='■ MUSIC';}
}
function loadBGM(e){
  const f=e.target.files[0];if(!f)return;
  bgm.src=URL.createObjectURL(f);bgm.load();
  bgm.play().catch(()=>{});STATE.musicPlaying=true;
  document.getElementById('bgm-btn').textContent='■ MUSIC';
  notify('MUSIC LOADED');
}

// ─────────────────────────── LOADING ─────────────────────────────────
const LOAD_STEPS=[
  'LOADING ENGINE...','BUILDING ELEMENTS...','COMPILING COMBOS...',
  'SPAWNING PARTICLES...','BUILDING FIGHTERS...','READY!'
];
let _lStep=0;
function doLoad(){
  const fill=document.getElementById('ld-fill'),txt=document.getElementById('ld-text');
  const iv=setInterval(()=>{
    _lStep++;
    fill.style.width=Math.min(100,_lStep/LOAD_STEPS.length*100)+'%';
    txt.textContent=LOAD_STEPS[Math.min(_lStep,LOAD_STEPS.length-1)];
    if(_lStep>=LOAD_STEPS.length){
      clearInterval(iv);
      setTimeout(()=>{
        document.getElementById('loading').classList.add('done');
        startMenuFX();
        buildPalette();
        buildMenuElemStrip();
      },450);
    }
  },260);
}
const gc=document.getElementById('game-canvas');
const ctx=gc.getContext('2d');
function resizeGame(){gc.width=window.innerWidth;gc.height=window.innerHeight;}
window.addEventListener('resize',resizeGame);resizeGame();
const GY=()=>gc.height-100;

function drawShape(c,shape,x,y,sz,col,a,rot=0){
  c.save();c.globalAlpha=Math.max(0,Math.min(1,a));c.translate(x,y);c.rotate(rot);
  c.fillStyle=col;c.strokeStyle=col;c.shadowBlur=sz*2;c.shadowColor=col;
  switch(shape){
    case'tear':c.beginPath();c.arc(0,-sz*0.3,sz*0.7,0,Math.PI*2);c.fill();c.beginPath();c.moveTo(-sz*0.5,-sz*0.3);c.quadraticCurveTo(0,sz*1.6,sz*0.5,-sz*0.3);c.fill();break;
    case'diamond':c.beginPath();c.moveTo(0,-sz*1.4);c.lineTo(sz*0.8,0);c.lineTo(0,sz*1.4);c.lineTo(-sz*0.8,0);c.closePath();c.fill();break;
    case'shard':c.beginPath();c.moveTo(0,-sz*2);c.lineTo(sz*0.4,-sz*0.5);c.lineTo(sz*0.2,sz);c.lineTo(-sz*0.2,sz);c.lineTo(-sz*0.4,-sz*0.5);c.closePath();c.fill();break;
    case'bolt':c.beginPath();c.moveTo(sz*0.3,-sz*1.5);c.lineTo(-sz*0.2,0);c.lineTo(sz*0.3,0);c.lineTo(-sz*0.3,sz*1.5);c.lineTo(sz*0.2,0);c.lineTo(-sz*0.3,0);c.closePath();c.fill();break;
    case'star':c.beginPath();for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2-Math.PI/2,ia=a+Math.PI/5;i===0?c.moveTo(Math.cos(a)*sz,Math.sin(a)*sz):c.lineTo(Math.cos(a)*sz,Math.sin(a)*sz);c.lineTo(Math.cos(ia)*sz*0.4,Math.sin(ia)*sz*0.4);}c.closePath();c.fill();break;
    case'ring':c.beginPath();c.arc(0,0,sz,0,Math.PI*2);c.lineWidth=sz*0.35;c.stroke();break;
    case'cross':c.lineWidth=sz*0.4;c.lineCap='round';c.beginPath();c.moveTo(0,-sz*1.3);c.lineTo(0,sz*1.3);c.stroke();c.beginPath();c.moveTo(-sz*1.3,0);c.lineTo(sz*1.3,0);c.stroke();break;
    case'snow':c.lineWidth=sz*0.2;for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2;c.beginPath();c.moveTo(0,0);c.lineTo(Math.cos(a)*sz,Math.sin(a)*sz);c.stroke();}break;
    default:c.beginPath();c.arc(0,0,sz,0,Math.PI*2);c.fill();break;
  }
  c.restore();
}

function spawnEP(x,y,elemKey,count=null){
  const e=ELEM[elemKey];if(!e)return;
  const n=count!==null?count:e.cnt;
  for(let i=0;i<n;i++){
    const ang=Math.random()*Math.PI*2,spd=rnd(0.6,3.5),sz=rnd(e.cnt>16?2:3,e.cnt>16?6:9);
    STATE.particles.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd+(e.grav<0?-2:-0.5),sz,col:e.col,glow:e.glow,shape:rndOf(e.ps),alpha:0.92,decay:rnd(0.01,0.022),grav:e.grav,drag:e.drag,rot:Math.random()*Math.PI*2,rspd:(Math.random()-0.5)*0.14,scaleUp:false,scaleRate:0});
  }
}

function spawnImpact(x,y,elemKey,scale=1){
  cinFlash(0.22*scale);
  spawnEP(x,y,elemKey,Math.floor((ELEM[elemKey]?.cnt||14)*1.7*scale));
  const e=ELEM[elemKey];
  STATE.particles.push({x,y,vx:0,vy:0,sz:4,col:e?.col||'#fff',glow:e?.glow||'#fff',shape:'ring',alpha:0.9,decay:0.04,grav:0,drag:1,rot:0,rspd:0,scaleUp:true,scaleRate:3.5*scale});
}

function drawCapsule(c,x1,y1,x2,y2,r,colA,colB,glow,glowStr=12){
  const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1,ux=dx/len,uy=dy/len,nx=-uy,ny=ux,ang=Math.atan2(dy,dx);
  const grd=c.createLinearGradient(x1-nx*r*1.5,y1-ny*r*1.5,x1+nx*r*1.5,y1+ny*r*1.5);
  grd.addColorStop(0,lightenHex(colA,0.35));grd.addColorStop(0.45,colA);grd.addColorStop(1,colB);
  c.beginPath();c.moveTo(x1+nx*r,y1+ny*r);c.lineTo(x2+nx*r,y2+ny*r);
  c.arc(x2,y2,r,ang-Math.PI*0.5,ang+Math.PI*0.5);c.lineTo(x1-nx*r,y1-ny*r);
  c.arc(x1,y1,r,ang+Math.PI*0.5,ang-Math.PI*0.5);c.closePath();
  if(glow){c.shadowBlur=glowStr;c.shadowColor=glow;}
  c.fillStyle=grd;c.fill();
  if(glow){c.shadowBlur=0;}
}

function drawJoint(c,x,y,r,col,glow){
  const grd=c.createRadialGradient(x-r*0.4,y-r*0.4,0,x,y,r*1.3);
  grd.addColorStop(0,'rgba(255,255,255,0.9)');grd.addColorStop(0.3,col);grd.addColorStop(1,hexA(col,0.3));
  if(glow){c.shadowBlur=r*4;c.shadowColor=glow;}
  c.beginPath();c.arc(x,y,r,0,Math.PI*2);c.fillStyle=grd;c.fill();
  if(glow)c.shadowBlur=0;
}

function drawHead(c,cx,cy,r,col,glow,eyeDir=1,dead=false){
  const grd=c.createRadialGradient(cx-r*0.35,cy-r*0.35,0,cx,cy,r*1.2);
  grd.addColorStop(0,lightenHex(col,0.55));grd.addColorStop(0.4,col);grd.addColorStop(1,darkenHex(col,0.45));
  if(glow){c.shadowBlur=r*3;c.shadowColor=glow;}
  c.beginPath();c.arc(cx,cy,r,0,Math.PI*2);c.fillStyle=grd;c.fill();
  if(glow)c.shadowBlur=0;
  c.strokeStyle=hexA(col,0.5);c.lineWidth=0.8;c.stroke();
  if(dead){
    c.strokeStyle='rgba(30,10,10,0.85)';c.lineWidth=1.8;c.lineCap='round';
    [[-r*0.35],[r*0.2]].forEach(([ex])=>{
      c.beginPath();c.moveTo(cx+ex-r*0.12,cy-r*0.25-r*0.12);c.lineTo(cx+ex+r*0.12,cy-r*0.25+r*0.12);c.stroke();
      c.beginPath();c.moveTo(cx+ex+r*0.12,cy-r*0.25-r*0.12);c.lineTo(cx+ex-r*0.12,cy-r*0.25+r*0.12);c.stroke();
    });return;
  }
  c.fillStyle='rgba(255,255,255,0.92)';c.beginPath();c.ellipse(cx-r*0.32,cy-r*0.18,r*0.22,r*0.17,0,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(8,8,20,0.9)';c.beginPath();c.arc(cx-r*0.32+r*0.06*eyeDir,cy-r*0.18,r*0.1,0,Math.PI*2);c.fill();
  c.fillStyle='rgba(255,255,255,0.85)';c.beginPath();c.arc(cx-r*0.34+r*0.06*eyeDir,cy-r*0.22,r*0.038,0,Math.PI*2);c.fill();
  c.strokeStyle='rgba(0,0,0,0.35)';c.lineWidth=1.2;c.lineCap='round';
  c.beginPath();c.arc(cx,cy+r*0.22,r*0.28,0.2,Math.PI-0.2);c.stroke();
}

function getPose(p,fr){
  const {cstate,animTime,onGround,facing,isHurt,isDead,attackType,attackFrame,attackMax}=p;
  const at=animTime||0;
  const walkCycle=onGround?Math.sin(at*0.18)*0.55:0;
  const breathe=Math.sin(fr*0.04)*0.8;
  let pose={headY:-65+breathe*0.5,torsoY1:-56,torsoY2:-28,shoulderX:9,shoulderY:-53,hipY:-28,
    upperArmL:0.6+walkCycle*0.8,forearmL:0.3+walkCycle*0.4,
    upperArmR:-0.6-walkCycle*0.8,forearmR:-0.3-walkCycle*0.4,
    upperLegL:0.4+walkCycle*0.7,shinL:-0.2+Math.max(0,walkCycle)*0.5,
    upperLegR:-0.4-walkCycle*0.7,shinR:0.2+Math.max(0,-walkCycle)*0.5};
  if(isDead){pose.headY=-20;pose.torsoY1=-12;pose.torsoY2=0;pose.upperArmL=1.8;pose.forearmL=1.2;pose.upperArmR=2.2;pose.forearmR=1.6;pose.upperLegL=0.8;pose.shinL=1.2;pose.upperLegR=-0.3;pose.shinR=0.5;return pose;}
  if(isHurt){pose.upperArmL=1.5;pose.upperArmR=-1.5;pose.headY=-60;return pose;}
  if(cstate==='blocking'){pose.upperArmL=1.6;pose.forearmL=0.3;pose.upperArmR=1.4;pose.forearmR=0.4;return pose;}
  if(cstate==='dashing'){pose.upperArmL=2.4;pose.forearmL=0.5;pose.upperArmR=-0.3;pose.forearmR=-0.8;pose.upperLegL=-1.2;pose.shinL=0.4;pose.upperLegR=0.8;pose.shinR=-0.2;return pose;}
  const progress=attackMax>0?attackFrame/attackMax:0;
  if(attackType==='light'){const swing=Math.sin(progress*Math.PI)*1.8;pose.upperArmR=-0.8+swing;pose.forearmR=-0.3+swing*0.5;}
  else if(attackType==='heavy'){if(progress<0.4){pose.upperArmR=-1.8+progress*2;pose.forearmR=-0.8+progress;pose.upperArmL=1.2-progress;}else{const s=1-(progress-0.4)/0.6;pose.upperArmR=1.8-s*3.6;pose.forearmR=0.5-s;pose.upperArmL=-0.2+s*1.4;}}
  else if(attackType==='special'){pose.upperArmL=2.2;pose.forearmL=1.5;pose.upperArmR=2.0;pose.forearmR=1.3;}
  else if(attackType==='ult'){const pulse=Math.sin(progress*Math.PI*3);pose.upperArmL=1.8+pulse;pose.forearmL=0.8+pulse*0.5;pose.upperArmR=1.8-pulse;pose.forearmR=0.8-pulse*0.5;}
  if(!onGround){pose.upperLegL=-0.5;pose.shinL=0.8;pose.upperLegR=0.4;pose.shinR=0.3;}
  return pose;
}

function drawWeapon(c,role,hx,hy,facing,elemCol,fr){
  c.save();c.translate(hx,hy);c.scale(facing,1);
  const ec=elemCol||'#aabbcc';
  switch(role){
    case'fighter':case'berserker':{const sg=c.createLinearGradient(0,-2,18,0);sg.addColorStop(0,lightenHex(ec,0.4));sg.addColorStop(1,hexA(ec,0.6));c.shadowBlur=8;c.shadowColor=ec;c.fillStyle=sg;c.fillRect(4,-2,18,4);c.fillStyle='#8a7a60';c.fillRect(-2,-1,6,2);c.fillStyle='#6a5a40';c.fillRect(-6,-1.5,5,3);break;}
    case'mage':case'summoner':case'druid':{c.shadowBlur=14;c.shadowColor=ec;c.strokeStyle='#886633';c.lineWidth=3;c.lineCap='round';c.beginPath();c.moveTo(0,0);c.lineTo(16,-12);c.stroke();const pulse=0.5+0.5*Math.sin(fr*0.1);const og=c.createRadialGradient(18,-14,0,18,-14,7);og.addColorStop(0,'rgba(255,255,255,0.9)');og.addColorStop(0.4,ec);og.addColorStop(1,hexA(ec,0));c.fillStyle=og;c.globalAlpha=0.7+pulse*0.3;c.beginPath();c.arc(18,-14,5+pulse*2,0,Math.PI*2);c.fill();break;}
    case'assassin':case'rogue':{const dg=c.createLinearGradient(0,0,12,0);dg.addColorStop(0,'#ccddff');dg.addColorStop(1,hexA(ec,0.7));c.shadowBlur=5;c.shadowColor=ec;c.fillStyle=dg;c.fillRect(4,-1.5,12,3);c.fillStyle='#6a6a80';c.fillRect(2,-2.5,4,5);c.fillRect(-8,-1,4,2);c.fillRect(-12,-1.5,8,3);break;}
    case'tank':{c.shadowBlur=6;c.shadowColor=ec;c.fillStyle=hexA(ec,0.8);c.beginPath();c.roundRect(-4,-10,20,18,3);c.fill();c.strokeStyle=lightenHex(ec,0.3);c.lineWidth=1.5;c.stroke();break;}
    default:{c.fillStyle=ec;c.fillRect(4,-1.5,10,3);break;}
  }
  c.restore();
}

function drawAura(c,p,fr){
  if(!p.attrs||!p.attrs.length)return;
  const ae=ELEM[p.attrs[0]];if(!ae)return;
  const col=ae.col,glow=ae.glow,pulse=0.5+0.5*Math.sin(fr*0.06+p.id);
  c.save();c.globalCompositeOperation='screen';
  const eff=AURAS[p.attrs[0]]?.eff||'ring';
  if(eff==='flame_ring'){for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+(fr*0.04),r=28+pulse*8;c.globalAlpha=0.35+pulse*0.2;drawShape(c,'tear',Math.cos(a)*r,Math.sin(a)*r,rnd(3,6),col,1,a+Math.PI*0.5);}}
  else if(eff==='lightning_ring'){c.globalAlpha=0.4+pulse*0.3;for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2+(fr*0.12);c.strokeStyle=glow;c.lineWidth=1.5;c.beginPath();c.moveTo(Math.cos(a)*20,Math.sin(a)*20);c.lineTo(Math.cos(a)*(36+pulse*8),Math.sin(a)*(36+pulse*8));c.stroke();}}
  else if(eff==='crystal_orbit'){for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2+(fr*0.025)+i,r=26+i*4+pulse*6;c.globalAlpha=0.5+pulse*0.2;drawShape(c,'diamond',Math.cos(a)*r,Math.sin(a)*r,4,col,1,a);}}
  else if(eff==='void_spiral'){for(let i=0;i<12;i++){const a=(i/12)*Math.PI*2+(fr*0.06),r=18+i*2.5+pulse*10;c.globalAlpha=0.3+pulse*0.2;drawShape(c,'ring',Math.cos(a)*r,Math.sin(a)*r,2+i*0.3,col,1);}}
  else if(eff==='tendrils'){for(let i=0;i<6;i++){const base=(i/6)*Math.PI*2,wave=Math.sin(fr*0.08+i)*0.8;c.globalAlpha=0.5+pulse*0.2;c.strokeStyle=col;c.lineWidth=2.5;c.lineCap='round';c.beginPath();c.moveTo(0,0);const mx=Math.cos(base+wave)*18,my=Math.sin(base+wave)*18;c.quadraticCurveTo(mx,my,Math.cos(base+wave*1.5)*34,Math.sin(base+wave*1.5)*34);c.stroke();}}
  else if(eff==='nimbus'){const rg=c.createRadialGradient(0,-20,0,0,-20,40+pulse*10);rg.addColorStop(0,hexA(col,0.4));rg.addColorStop(0.5,hexA(col,0.15));rg.addColorStop(1,hexA(col,0));c.fillStyle=rg;c.globalAlpha=1;c.beginPath();c.ellipse(0,-20,40+pulse*10,30+pulse*6,0,0,Math.PI*2);c.fill();}
  else if(eff==='blood_swirl'){for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+(fr*0.07),r=22+pulse*10;c.globalAlpha=0.5+pulse*0.2;drawShape(c,'tear',Math.cos(a)*r,Math.sin(a)*r,3+pulse*1,col,1,a+Math.PI);}}
  else if(eff==='vine_wrap'){c.globalAlpha=0.55+pulse*0.2;c.strokeStyle=col;c.lineWidth=2.5;c.lineCap='round';for(let i=0;i<3;i++){const phase=(i/3)*Math.PI*2+fr*0.04;c.beginPath();for(let t=0;t<Math.PI*2;t+=0.15){const r=24+Math.sin(t*3+phase)*8+pulse*5;t===0?c.moveTo(Math.cos(t)*r,Math.sin(t)*r):c.lineTo(Math.cos(t)*r,Math.sin(t)*r);}c.stroke();}}
  else if(eff==='sigil_orbit'){for(let i=0;i<4;i++){const a=(i/4)*Math.PI*2+(fr*0.03),r=30+pulse*6;c.globalAlpha=0.6+pulse*0.2;drawShape(c,'star',Math.cos(a)*r,Math.sin(a)*r,5,col,1,a+fr*0.05);}}
  else if(eff==='chaos_swirl'){const cols=['#ff4488','#8844ff','#44ffff','#ff8844'];for(let i=0;i<10;i++){const a=(i/10)*Math.PI*2+(fr*0.1),r=20+rnd(-5,5)+pulse*8;c.globalAlpha=0.4;drawShape(c,rndOf(['shard','bolt','star']),Math.cos(a)*r,Math.sin(a)*r,3,cols[i%4],1,a*2);}}
  else{const rg=c.createRadialGradient(0,0,10,0,0,35+pulse*10);rg.addColorStop(0,hexA(col,0));rg.addColorStop(0.5,hexA(col,0.18));rg.addColorStop(1,hexA(col,0));c.fillStyle=rg;c.globalAlpha=1;c.beginPath();c.arc(0,0,35+pulse*10,0,Math.PI*2);c.fill();}
  if(p.attrs.length>1){for(let ai=1;ai<Math.min(p.attrs.length,3);ai++){const ae2=ELEM[p.attrs[ai]];if(!ae2)continue;const a0=(ai/p.attrs.length)*Math.PI*2+(fr*0.035*ai),r2=42+ai*8+pulse*6;c.globalAlpha=0.3;drawShape(c,'ring',Math.cos(a0)*r2,Math.sin(a0)*r2,6,ae2.col,1,a0);}}
  if(p.ultMeter>0){c.globalAlpha=(p.ultMeter/p.maxUlt)*0.4;c.strokeStyle='#ffffff';c.lineWidth=2;c.beginPath();c.arc(0,-40,16,-Math.PI/2,-Math.PI/2+(p.ultMeter/p.maxUlt)*Math.PI*2);c.stroke();}
  if(p.frenzied){c.globalAlpha=0.5+pulse*0.3;for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+(fr*0.15);drawShape(c,'shard',Math.cos(a)*30,Math.sin(a)*30,5,'#ff2200',1,a);}}
  c.restore();
}

function drawStickman(p,fr){
  const {x,y,facing,depth:d,role,attrs,isDead,isHurt,hurtTimer,cstate,blockFrames}=p;
  const sc=p.skinColor||'#4488ff',sc2=p.skinColor2||darkenHex(sc,0.3);
  const glow=attrs.length>0?ELEM[attrs[0]]?.glow:null;
  ctx.save();ctx.translate(x,y);
  drawAura(ctx,p,fr);
  ctx.scale(d,d);
  if(isDead){ctx.rotate(facing*0.55);ctx.translate(0,10);}
  if(isHurt&&hurtTimer%4<2)ctx.filter='brightness(3) saturate(0)';
  if(p.absorbedElem){ctx.shadowBlur=16;ctx.shadowColor=ELEM[p.absorbedElem]?.glow||'#fff';}
  const pose=getPose(p,fr);const limR=4.5,torsoR=5.5;
  const bLegA=facing>0?pose.upperLegR:pose.upperLegL,bShinA=facing>0?pose.shinR:pose.shinL;
  const bHipX=facing>0?4:-4,bKneeX=bHipX+Math.sin(bLegA*facing)*20,bKneeY=pose.hipY+Math.cos(bLegA*facing)*20;
  const bFootX=bKneeX+Math.sin((bLegA+bShinA)*facing)*18,bFootY=bKneeY+Math.cos((bLegA+bShinA)*facing)*18;
  drawCapsule(ctx,bHipX,pose.hipY,bKneeX,bKneeY,limR,sc,sc2,null);
  drawCapsule(ctx,bKneeX,bKneeY,bFootX,bFootY,limR-0.8,sc,sc2,null);
  drawJoint(ctx,bKneeX,bKneeY,limR*0.85,sc,null);
  const bArmA=facing>0?pose.upperArmR:pose.upperArmL,bFarmA=facing>0?pose.forearmR:pose.forearmL;
  const bSX=facing>0?pose.shoulderX:-pose.shoulderX;
  const bElbX=bSX+Math.sin(bArmA*facing)*18,bElbY=pose.shoulderY+Math.cos(bArmA*facing)*18;
  const bHndX=bElbX+Math.sin((bArmA+bFarmA)*facing)*15,bHndY=bElbY+Math.cos((bArmA+bFarmA)*facing)*15;
  drawCapsule(ctx,bSX,pose.shoulderY,bElbX,bElbY,limR-0.5,sc,sc2,null);
  drawCapsule(ctx,bElbX,bElbY,bHndX,bHndY,limR-1,sc,sc2,null);
  drawJoint(ctx,bElbX,bElbY,limR*0.8,sc,null);
  const isBlocking=cstate==='blocking';
  drawCapsule(ctx,0,pose.torsoY1,0,pose.torsoY2,torsoR,isBlocking?lightenHex(sc,0.2):sc,sc2,glow,glow?10:0);
  drawCapsule(ctx,0,pose.torsoY1,0,pose.headY+10,3.5,sc,sc2,glow,glow?6:0);
  const fLegA=facing>0?pose.upperLegL:pose.upperLegR,fShinA=facing>0?pose.shinL:pose.shinR;
  const fHipX=facing>0?-4:4,fKneeX=fHipX+Math.sin(fLegA*facing)*20,fKneeY=pose.hipY+Math.cos(fLegA*facing)*20;
  const fFootX=fKneeX+Math.sin((fLegA+fShinA)*facing)*18,fFootY=fKneeY+Math.cos((fLegA+fShinA)*facing)*18;
  drawCapsule(ctx,fHipX,pose.hipY,fKneeX,fKneeY,limR,sc,sc2,glow,glow?4:0);
  drawCapsule(ctx,fKneeX,fKneeY,fFootX,fFootY,limR-0.8,sc,sc2,glow,glow?3:0);
  drawJoint(ctx,fKneeX,fKneeY,limR,sc,glow);
  ctx.fillStyle=sc2;ctx.beginPath();ctx.ellipse(fFootX+facing*4,fFootY,7,4,0,0,Math.PI*2);ctx.fill();
  const fArmA=facing>0?pose.upperArmL:pose.upperArmR,fFarmA=facing>0?pose.forearmL:pose.forearmR;
  const fSX=facing>0?-pose.shoulderX:pose.shoulderX;
  const fElbX=fSX+Math.sin(fArmA*facing)*18,fElbY=pose.shoulderY+Math.cos(fArmA*facing)*18;
  const fHndX=fElbX+Math.sin((fArmA+fFarmA)*facing)*15,fHndY=fElbY+Math.cos((fArmA+fFarmA)*facing)*15;
  drawCapsule(ctx,fSX,pose.shoulderY,fElbX,fElbY,limR-0.5,sc,sc2,glow,glow?5:0);
  drawCapsule(ctx,fElbX,fElbY,fHndX,fHndY,limR-1,sc,sc2,glow,glow?4:0);
  drawJoint(ctx,fElbX,fElbY,limR*0.9,sc,glow);
  drawJoint(ctx,bSX,pose.shoulderY,limR-0.5,sc,glow);
  drawJoint(ctx,fSX,pose.shoulderY,limR,sc,glow);
  drawHead(ctx,0,pose.headY,12,sc,glow,facing,isDead);
  drawWeapon(ctx,role,fHndX,fHndY,facing,attrs.length>0?ELEM[attrs[0]]?.col:sc,fr);
  if(isBlocking){ctx.save();const sf=blockFrames<5?'#ffffff':hexA(sc,0.8);ctx.shadowBlur=20;ctx.shadowColor=sf;ctx.strokeStyle=sf;ctx.lineWidth=3;ctx.beginPath();ctx.arc(-facing*10,-45,22,Math.PI*0.6,Math.PI*1.4);ctx.stroke();ctx.restore();}
  if(p.absorbedElem){const ae=ELEM[p.absorbedElem];ctx.fillStyle=hexA(ae.col,0.85);ctx.strokeStyle=ae.glow;ctx.lineWidth=1;ctx.beginPath();ctx.roundRect(fHndX-6,fHndY-8,20,12,3);ctx.fill();ctx.stroke();ctx.font='bold 7px Share Tech Mono';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='#fff';ctx.fillText(ae.abbr,fHndX+4,fHndY-2);}
  ctx.filter='none';ctx.restore();
  if(!isDead){
    const bW=44*d,bH=3.5,bX=x-bW/2,bY=y-92*d;
    const hp=p.hp/p.maxHp,sta=p.sta/p.maxSta,stag=p.stagger/p.maxStagger;
    const hpCol=hp>0.6?'#44ff88':hp>0.3?'#ffcc00':'#ff4444';
    ctx.fillStyle='rgba(0,0,0,0.45)';ctx.fillRect(bX,bY,bW,bH);
    ctx.fillStyle=hpCol;ctx.fillRect(bX,bY,bW*hp,bH);
    if(p.shield>0){ctx.fillStyle='#4499ff';ctx.fillRect(bX,bY,bW*(p.shield/p.maxShield)*hp,bH*0.4);}
    ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fillRect(bX,bY+bH+1.5,bW,bH-0.5);
    ctx.fillStyle='#ffcc44';ctx.fillRect(bX,bY+bH+1.5,bW*sta,bH-0.5);
    if(p.stagger>0){ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fillRect(bX,bY+bH*2+3,bW,bH-0.5);ctx.fillStyle='#ff6644';ctx.fillRect(bX,bY+bH*2+3,bW*stag,bH-0.5);}
    ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(bX,bY+bH*3+5,bW,1.5);
    ctx.fillStyle='#c8a84b';ctx.fillRect(bX,bY+bH*3+5,bW*(p.ultMeter/p.maxUlt),1.5);
    ctx.font=`bold ${11*d}px Rajdhani,sans-serif`;ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillText(p.name,x+1,bY-1);
    ctx.fillStyle='rgba(255,255,255,0.75)';ctx.fillText(p.name,x,bY-2);
    const r=ROLES[p.role];if(r){ctx.font=`bold ${8.5*d}px Share Tech Mono`;ctx.fillStyle=hexA(r.col,0.7);ctx.fillText(r.abbr,x,bY-13*d);}
  }
}

function drawBG(){
  const W=gc.width,H=gc.height;
  const sky=ctx.createLinearGradient(0,0,0,H);sky.addColorStop(0,'#020408');sky.addColorStop(0.5,'#040c18');sky.addColorStop(1,'#06070d');ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  ctx.fillStyle='rgba(255,255,255,0.6)';
  for(let i=0;i<80;i++){const sx=((i*137.508+STATE.frame*0.02)%W+W)%W,sy=(i*89.3)%(H*0.72),ss=(i%5)/5*1.5+0.2+Math.sin(STATE.frame*0.04+i)*0.2;ctx.globalAlpha=0.1+0.2*(i%3)/2+Math.sin(STATE.frame*0.06+i)*0.1;ctx.beginPath();ctx.arc(sx,sy,ss,0,Math.PI*2);ctx.fill();}
  ctx.globalAlpha=1;
  const g=ctx.createLinearGradient(0,H-130,0,H);g.addColorStop(0,'#0c1a10');g.addColorStop(1,'#060a08');ctx.fillStyle=g;ctx.beginPath();ctx.moveTo(0,H-100);ctx.lineTo(W,H-100);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
  const ge=ctx.createLinearGradient(0,H-108,0,H-96);ge.addColorStop(0,'transparent');ge.addColorStop(0.5,'rgba(200,168,75,0.28)');ge.addColorStop(1,'transparent');ctx.fillStyle=ge;ctx.fillRect(0,H-108,W,14);
  ctx.strokeStyle='rgba(200,168,75,0.04)';ctx.lineWidth=1;
  for(let i=0;i<16;i++){const gx=(i/16)*W;ctx.beginPath();ctx.moveTo(gx,H-100);ctx.lineTo(W/2+(gx-W/2)*0.08,H);ctx.stroke();}
}

function drawHazardZones(){
  STATE.hazardZones.forEach(hz=>{
    const p2=0.5+0.5*Math.sin(STATE.frame*0.07),ec=ELEM[hz.elem]?.col||'#ff0000';
    ctx.save();ctx.globalAlpha=0.45+p2*0.2;ctx.strokeStyle=ec;ctx.lineWidth=2;ctx.beginPath();ctx.arc(hz.x,hz.y,hz.radius+p2*8,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=0.08+p2*0.05;ctx.fillStyle=ec;ctx.beginPath();ctx.arc(hz.x,hz.y,hz.radius,0,Math.PI*2);ctx.fill();ctx.globalAlpha=0.6+p2*0.3;ctx.font=`bold ${hz.radius*0.55}px Share Tech Mono`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle=ec;ctx.fillText(ELEM[hz.elem]?.abbr||'HZ',hz.x,hz.y);ctx.restore();
  });
}

function drawGravWells(){
  STATE.gravityWells.forEach(w=>{
    const t=w.life/w.maxLife;ctx.save();ctx.globalAlpha=t*0.28;
    const rg=ctx.createRadialGradient(w.x,w.y,0,w.x,w.y,w.radius);rg.addColorStop(0,'rgba(100,68,170,0.7)');rg.addColorStop(1,'transparent');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(w.x,w.y,w.radius,0,Math.PI*2);ctx.fill();
    for(let i=0;i<3;i++){const ang=STATE.frame*0.05*(i%2===0?1:-1)+i;ctx.strokeStyle=`rgba(155,26,255,${t*(0.8-i*0.2)})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(w.x,w.y,w.radius*(0.3+i*0.26),ang,ang+Math.PI*1.5);ctx.stroke();}
    ctx.restore();
  });
}

function drawElemBlobs(){
  STATE.elements.forEach(e=>{
    const life=e.life/e.maxLife,col=ELEM[e.elem]?.col||'#fff';ctx.save();ctx.globalAlpha=life*0.38;
    const rg=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.radius);rg.addColorStop(0,col);rg.addColorStop(1,'transparent');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(e.x,e.y,e.radius,0,Math.PI*2);ctx.fill();ctx.restore();
    if(Math.random()<0.06)spawnEP(e.x+(Math.random()-0.5)*e.radius,e.y+(Math.random()-0.5)*e.radius,e.elem,1);
  });
}

function drawEffects(){
  STATE.effects.forEach(ef=>{
    ctx.save();const t=ef.life/ef.maxLife;
    if(ef.type==='shield_ring'){ctx.globalAlpha=t*0.6;ctx.strokeStyle=ef.col;ctx.lineWidth=3;ctx.shadowBlur=12;ctx.shadowColor=ef.col;ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(2-t)*0.6,0,Math.PI*2);ctx.stroke();}
    else if(ef.type==='slash'){ctx.globalAlpha=t*0.8;ctx.strokeStyle=ef.col;ctx.lineWidth=4*(0.5+t*0.5);ctx.lineCap='round';ctx.shadowBlur=10;ctx.shadowColor=ef.col;ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*t,ef.ang-0.7,ef.ang+0.7);ctx.stroke();}
    else if(ef.type==='hit_spark'){ctx.globalAlpha=t;for(let i=0;i<6;i++){const sa=(i/6)*Math.PI*2,sl=20*(1-t)+5;ctx.strokeStyle=ef.col;ctx.lineWidth=2;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(ef.x+Math.cos(sa)*5,ef.y+Math.sin(sa)*5);ctx.lineTo(ef.x+Math.cos(sa)*sl,ef.y+Math.sin(sa)*sl);ctx.stroke();}}
    else if(ef.type==='ring_expand'){ctx.globalAlpha=t*0.7;ctx.strokeStyle=ef.col;ctx.lineWidth=2.5;ctx.shadowBlur=10;ctx.shadowColor=ef.col;ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(1-t+0.2),0,Math.PI*2);ctx.stroke();}
    else if(ef.type==='text_float'){ctx.globalAlpha=t;ctx.font=`bold ${ef.fs||14}px Orbitron,sans-serif`;ctx.textAlign='center';ctx.fillStyle=ef.col;ctx.shadowBlur=8;ctx.shadowColor=ef.col;ctx.fillText(ef.text,ef.x,ef.y-(ef.maxLife-ef.life)*0.4);}
    ctx.restore();
  });
}

function drawProjectiles(){
  STATE.projectiles.forEach(pr=>{
    const col=ELEM[pr.elem]?.col||'#fff',glo=ELEM[pr.elem]?.glow||col;
    ctx.save();ctx.shadowBlur=14;ctx.shadowColor=glo;const ang=Math.atan2(pr.vy,pr.vx);ctx.translate(pr.x,pr.y);ctx.rotate(ang);ctx.fillStyle=col;ctx.globalAlpha=0.9;ctx.beginPath();ctx.moveTo(pr.sz*2.5,0);ctx.lineTo(-pr.sz,pr.sz*0.7);ctx.lineTo(-pr.sz,-pr.sz*0.7);ctx.closePath();ctx.fill();ctx.fillStyle=hexA(glo,0.3);ctx.beginPath();ctx.ellipse(-pr.sz*2,0,pr.sz*3,pr.sz*0.5,0,0,Math.PI*2);ctx.fill();ctx.restore();
  });
}

function drawParticles(){STATE.particles.forEach(p=>{if(p.alpha>0.01)drawShape(ctx,p.shape,p.x,p.y,p.sz,p.col,p.alpha,p.rot);});}

function drawPaths(){
  STATE.paths.forEach(pb=>{
    if(!pb.smooth||pb.smooth.length<2)return;
    const col=ELEM[pb.elem]?.col||'#fff';
    const glo=ELEM[pb.elem]?.glow||col;
    ctx.save();
    ctx.shadowBlur=10;ctx.shadowColor=glo;
    ctx.strokeStyle=col;ctx.lineWidth=2;ctx.globalAlpha=0.5;
    ctx.lineCap='round';ctx.lineJoin='round';
    ctx.beginPath();ctx.moveTo(pb.smooth[0].x,pb.smooth[0].y);
    pb.smooth.forEach(pt=>ctx.lineTo(pt.x,pt.y));
    ctx.stroke();
    // Directional arrows
    for(let i=10;i<pb.smooth.length-1;i+=18){
      const dx=pb.smooth[i+1].x-pb.smooth[i].x,dy=pb.smooth[i+1].y-pb.smooth[i].y;
      const ang=Math.atan2(dy,dx);
      ctx.save();ctx.translate(pb.smooth[i].x,pb.smooth[i].y);ctx.rotate(ang);
      ctx.globalAlpha=0.7;ctx.fillStyle=col;
      ctx.beginPath();ctx.moveTo(6,0);ctx.lineTo(-4,-4);ctx.lineTo(-4,4);ctx.closePath();ctx.fill();
      ctx.restore();
    }
    // Type label at start
    ctx.globalAlpha=0.85;ctx.font='bold 9px Share Tech Mono';ctx.textAlign='left';
    ctx.fillStyle=glo;
    ctx.fillText(`[${pb.key||'?'}] ${(pb.type||'strike').toUpperCase()}`,pb.smooth[0].x+6,pb.smooth[0].y-6);
    ctx.restore();
  });

  // Live drawing preview
  if(STATE.pathDrawing&&STATE.currentPath.length>1){
    const smooth=catmullRom(STATE.currentPath,0.5,5);
    const col=ELEM[STATE.selectedElement]?.col||'#fff';
    ctx.save();ctx.strokeStyle=col;ctx.lineWidth=2.5;ctx.globalAlpha=0.85;
    ctx.shadowBlur=14;ctx.shadowColor=col;ctx.setLineDash([6,5]);
    ctx.beginPath();ctx.moveTo(smooth[0].x,smooth[0].y);
    smooth.forEach(pt=>ctx.lineTo(pt.x,pt.y));ctx.stroke();
    ctx.setLineDash([]);
    // Ghost start
    ctx.globalAlpha=0.5;ctx.fillStyle=col;
    ctx.beginPath();ctx.arc(STATE.currentPath[0].x,STATE.currentPath[0].y,5,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

function drawProjectiles(){
  STATE.projectiles.forEach(pr=>{
    const col=ELEM[pr.elem]?.col||'#fff';
    const glo=ELEM[pr.elem]?.glow||col;
    ctx.save();ctx.shadowBlur=14;ctx.shadowColor=glo;
    const ang=Math.atan2(pr.vy,pr.vx);
    ctx.translate(pr.x,pr.y);ctx.rotate(ang);
    ctx.fillStyle=col;ctx.globalAlpha=0.9;
    ctx.beginPath();ctx.moveTo(pr.sz*2.5,0);ctx.lineTo(-pr.sz,pr.sz*0.7);ctx.lineTo(-pr.sz,-pr.sz*0.7);ctx.closePath();ctx.fill();
    // Trail
    ctx.fillStyle=hexA(glo,0.3);ctx.beginPath();ctx.ellipse(-pr.sz*2,0,pr.sz*3,pr.sz*0.5,0,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });
}

function drawParticles(){
  STATE.particles.forEach(p=>{
    if(p.alpha<=0.01)return;
    drawShape(ctx,p.shape,p.x,p.y,p.sz,p.col,p.alpha,p.rot);
  });
}

function drawEffects(){
  STATE.effects.forEach(ef=>{
    ctx.save();
    const t=ef.life/ef.maxLife;
    if(ef.type==='shield_ring'){
      ctx.globalAlpha=t*0.6;ctx.strokeStyle=ef.col;ctx.lineWidth=3;
      ctx.shadowBlur=12;ctx.shadowColor=ef.col;
      ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(2-t)*0.6,0,Math.PI*2);ctx.stroke();
    }else if(ef.type==='slash'){
      ctx.globalAlpha=t*0.8;
      ctx.strokeStyle=ef.col;ctx.lineWidth=4*(0.5+t*0.5);ctx.lineCap='round';
      ctx.shadowBlur=10;ctx.shadowColor=ef.col;
      const a=ef.ang||0,r=ef.r*t;
      ctx.beginPath();
      ctx.arc(ef.x,ef.y,r,a-0.7,a+0.7);ctx.stroke();
    }else if(ef.type==='hit_spark'){
      ctx.globalAlpha=t;
      for(let i=0;i<6;i++){
        const sa=(i/6)*Math.PI*2,sl=20*(1-t)+5;
        ctx.strokeStyle=ef.col;ctx.lineWidth=2;ctx.lineCap='round';
        ctx.beginPath();ctx.moveTo(ef.x+Math.cos(sa)*5,ef.y+Math.sin(sa)*5);
        ctx.lineTo(ef.x+Math.cos(sa)*sl,ef.y+Math.sin(sa)*sl);ctx.stroke();
      }
    }else if(ef.type==='ring_expand'){
      ctx.globalAlpha=t*0.7;ctx.strokeStyle=ef.col;ctx.lineWidth=2.5;
      ctx.shadowBlur=10;ctx.shadowColor=ef.col;
      ctx.beginPath();ctx.arc(ef.x,ef.y,ef.r*(1-t+0.2),0,Math.PI*2);ctx.stroke();
    }else if(ef.type==='text_float'){
      ctx.globalAlpha=t;ctx.font=`bold ${ef.fs||14}px Orbitron,sans-serif`;
      ctx.textAlign='center';ctx.fillStyle=ef.col;
      ctx.shadowBlur=8;ctx.shadowColor=ef.col;
      ctx.fillText(ef.text,ef.x,ef.y-(ef.maxLife-ef.life)*0.4);
    }
    ctx.restore();
  });
}

// ═══════════════════════════════════════════════════════════════════════
//  PHYSICS
// ═══════════════════════════════════════════════════════════════════════
const GRAVITY=0.52;

function tickParticles(){
  STATE.particles=STATE.particles.filter(p=>{
    p.alpha-=p.decay*STATE.slowmoFactor;
    if(p.scaleUp){p.sz+=p.scaleRate*STATE.slowmoFactor;p.alpha-=0.016*STATE.slowmoFactor;}
    p.vx*=p.drag;p.vy*=p.drag;
    p.vy+=p.grav*STATE.slowmoFactor;
    p.x+=p.vx*STATE.slowmoFactor;p.y+=p.vy*STATE.slowmoFactor;
    p.rot+=p.rspd*STATE.slowmoFactor;
    return p.alpha>0.01;
  });
}

function tickProjectiles(){
  STATE.projectiles=STATE.projectiles.filter(pr=>{
    pr.x+=pr.vx*STATE.slowmoFactor;pr.y+=pr.vy*STATE.slowmoFactor;
    pr.vy+=0.05*STATE.slowmoFactor;pr.life-=STATE.slowmoFactor;
    spawnEP(pr.x,pr.y,pr.elem,1);
    // Check hits
    let hit=false;
    STATE.players.forEach(t=>{
      if(t.id===pr.owner||t.isDead)return;
      if(dist(t.x,t.y,pr.x,pr.y)<30){
        dealDamage(t,pr.dmg,pr.elem,pr.x,pr.y);
        hit=true;
        spawnImpact(pr.x,pr.y,pr.elem,0.8);
      }
    });
    return !hit&&pr.life>0&&pr.y<gc.height+50;
  });
}

function tickEffects(){
  STATE.effects=STATE.effects.filter(ef=>{
    ef.life-=STATE.slowmoFactor;
    return ef.life>0;
  });
}

function tickGravWells(){
  STATE.gravityWells=STATE.gravityWells.filter(w=>{
    w.life-=STATE.slowmoFactor;
    if(w.life>0&&Math.random()<0.3)
      spawnEP(w.x+(Math.random()-0.5)*w.radius*0.5,w.y+(Math.random()-0.5)*w.radius*0.5,'void',2);
    STATE.players.forEach(p=>{
      if(p.isDead)return;
      const dx=w.x-p.x,dy=w.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<w.radius&&d>5){p.vx+=(dx/d)*w.strength*0.12*STATE.slowmoFactor;p.vy+=(dy/d)*w.strength*0.12*STATE.slowmoFactor;}
    });
    return w.life>0;
  });
}

function tickElements(){
  STATE.elements=STATE.elements.filter(e=>{e.life-=STATE.slowmoFactor;return e.life>0;});
}

function tickStatusFX(){
  STATE.players.forEach(p=>{
    if(!p.statusFX)return;
    p.statusFX=p.statusFX.filter(fx=>{
      fx.dur-=STATE.slowmoFactor;
      if(fx.type==='burn'&&STATE.frame%60<1){dealDamage(p,fx.str||3,'fire',p.x,p.y-30,true);}
      if(fx.type==='bleed'&&STATE.frame%45<1){dealDamage(p,fx.str||4,'blood',p.x,p.y-30,true);}
      if(fx.type==='dot'&&STATE.frame%30<1){dealDamage(p,fx.str||5,fx.elem||'poison',p.x,p.y-30,true);}
      if(fx.type==='heal_dot'&&STATE.frame%40<1){p.hp=Math.min(p.maxHp,p.hp+(fx.str||6));spawnEP(p.x,p.y-30,'nature',3);}
      return fx.dur>0;
    });
    // Druid passive regen
    if(p.role==='druid'&&!p.isDead&&STATE.frame%60<1)p.hp=Math.min(p.maxHp,p.hp+1);
    // Paladin holy regen
    if(p.role==='paladin'&&!p.isDead&&STATE.frame%90<1)p.hp=Math.min(p.maxHp,p.hp+0.5);
    // Support aura heal
    if(p.role==='support'&&!p.isDead){
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<120){t.hp=Math.min(t.maxHp,t.hp+0.008*STATE.slowmoFactor);}});
    }
    // Shield regen special
    if(p.specials?.shieldRegen&&!p.isDead)p.shield=Math.min(p.maxShield,p.shield+0.03*STATE.slowmoFactor);
    // Stamina regen
    if(!p.isDead)p.sta=Math.min(p.maxSta,p.sta+0.25*STATE.slowmoFactor);
    // Stagger recovery
    if(p.stagger>0)p.stagger=Math.max(0,p.stagger-0.4*STATE.slowmoFactor);
    // Cooldowns
    for(const k in p.cds)if(p.cds[k]>0)p.cds[k]-=STATE.slowmoFactor;
    // Hurt timer
    if(p.isHurt&&p.hurtTimer>0){p.hurtTimer-=STATE.slowmoFactor;if(p.hurtTimer<=0){p.isHurt=false;p.hurtTimer=0;}}
    // Invulnerability frames
    if(p.invFrames>0)p.invFrames-=STATE.slowmoFactor;
    // Ultimate passive: necro death charge
    if(p.role==='necromancer'&&p.isDead)p.ultMeter=Math.min(p.maxUlt,p.ultMeter+2);
    // Berserker rage scaling
    if(p.role==='berserker'&&!p.isDead){
      const ratio=1-(p.hp/p.maxHp);p._rageAtk=p.atk*(1+ratio*2);
    }
  });
}

function tickHazards(){
  STATE.hazardZones.forEach(hz=>{
    STATE.players.forEach(p=>{
      if(p.isDead)return;
      if(dist(p.x,p.y,hz.x,hz.y)<hz.radius+22){
        p.hp=Math.max(0,p.hp-0.06);
        if(Math.random()<0.04)spawnEP(p.x,p.y-20,hz.elem,2);
        if(p.hp<=0&&!p.isDead)killPlayer(p);
      }
    });
  });
}

function tickPlayers(){
  STATE.players.forEach(p=>{
    if(p.isDead)return;
    const sm=STATE.slowmoFactor;
    const kb=KEYBINDS[p.keybind||'wasd'];
    const K=STATE.keys;
    const sp=p.spd;
    const stunned=p.cstate==='stunned'||hasStatus(p,'freeze')||hasStatus(p,'stun');

    // Input handling
    if(!stunned&&p.cstate!=='dashing'){
      if(K[kb.left]){p.vx-=sp*0.52*sm;p.facing=-1;}
      if(K[kb.right]){p.vx+=sp*0.52*sm;p.facing=1;}
      if((K[kb.jump]||K[kb.jump+'_once'])&&p.onGround&&p.cstate!=='attacking'){
        p.vy=-12.5;p.onGround=false;
        spawnEP(p.x,p.y,p.attrs[0]||'wind',5);
        delete K[kb.jump+'_once'];
      }
      // Block
      if(K[kb.block]&&p.cstate!=='attacking'&&p.sta>5){
        p.cstate='blocking';p.blockFrames++;
        p.sta=Math.max(0,p.sta-0.4*sm);
      } else if(p.cstate==='blocking'){
        p.cstate='idle';p.blockFrames=0;
      }
      // Dash
      if(K[kb.dash+'_once']&&p.cds.dash<=0&&p.sta>=20){
        p.cds.dash=40;p.sta-=20;p.cstate='dashing';
        p.vx=p.facing*18;p.invFrames=18;
        spawnEP(p.x,p.y,p.attrs[0]||'wind',10);
        notify(`${p.name} DASH!`);
        delete K[kb.dash+'_once'];
      }
      // Light attack
      if(K[kb.light+'_once']&&p.cstate!=='attacking'&&p.sta>=8){
        startAttack(p,'light',16);p.sta-=8;
        delete K[kb.light+'_once'];
      }
      // Heavy attack
      if(K[kb.heavy+'_once']&&p.cstate!=='attacking'&&p.sta>=20){
        startAttack(p,'heavy',28);p.sta-=20;
        delete K[kb.heavy+'_once'];
      }
      // Abilities
      if(K[kb.ab1+'_once']&&p.cds.a1<=0){useAbility(p,'a1');delete K[kb.ab1+'_once'];}
      if(K[kb.ab2+'_once']&&p.cds.a2<=0){useAbility(p,'a2');delete K[kb.ab2+'_once'];}
      if(K[kb.ult+'_once']&&p.ultMeter>=p.maxUlt){useUltimate(p);delete K[kb.ult+'_once'];}
      // Path triggers
      ['1','2','3','4'].forEach((n,i)=>{
        if(K[(kb[`path${i+1}`]||n)+'_once']){triggerPath(p,n);delete K[(kb[`path${i+1}`]||n)+'_once'];}
      });
      // Gravity well
      if(K['g_once']){spawnGravWell(p.x,p.y);delete K['g_once'];}
      // Release absorbed element Q / E
      if(K['q_once']&&p.absorbedElem){releaseAbsorbed(p,'burst');delete K['q_once'];}
      if(K['e_once']&&p.absorbedElem){releaseAbsorbed(p,'shot');delete K['e_once'];}
      // Respawn
      if(K[kb.respawn+'_once']&&p.isDead){respawnPlayer(p);delete K[kb.respawn+'_once'];}
    }

    // Attack tick
    if(p.cstate==='attacking'){
      p.attackFrame+=sm;
      const [af,al]=p.activeFrames;
      if(p.attackFrame>=af&&p.attackFrame<al){
        doMeleeHit(p);
      }
      if(p.attackFrame>=p.attackMax){
        p.cstate='idle';p.attackType=null;p.hitThisAttack=new Set();
        // Combo light chain window
      }
    }

    // Dashing end
    if(p.cstate==='dashing'&&p.cds.dash<30){p.cstate='idle';}

    // Stunned recovery
    if(p.cstate==='stunned'){
      p.stunTimer=(p.stunTimer||0)-sm;
      if(p.stunTimer<=0){p.cstate='idle';p.stunTimer=0;}
    }

    // Physics
    p.vx*=0.8;
    if(p.cstate==='dashing')p.vx*=0.97;
    p.vy+=GRAVITY*sm;
    p.animTime+=Math.abs(p.vx)*0.18*sm+sm*0.5;
    p.x+=p.vx*sm;p.y+=p.vy*sm;

    // Ground check
    const gy=GY()-60*p.depth;
    if(p.y>=gy){p.y=gy;p.vy=0;p.onGround=true;}else{p.onGround=false;}

    // Wall bounds
    if(p.x<40)p.x=40;
    if(p.x>gc.width-40)p.x=gc.width-40;

    // AI
    if(p.isAI&&!p.isDead)tickAI(p);

    // Ultimate meter fill
    p.ultMeter=Math.min(p.maxUlt,p.ultMeter+0.015*sm);
  });
}

// ═══════════════════════════════════════════════════════════════════════
//  FIGHTING SYSTEM
// ═══════════════════════════════════════════════════════════════════════

function startAttack(p,type,dur){
  p.cstate='attacking';p.attackType=type;
  p.attackFrame=0;p.attackMax=dur;
  p.hitThisAttack=new Set();
  if(type==='light'){p.activeFrames=[4,11];}
  else if(type==='heavy'){p.activeFrames=[10,20];}
  else if(type==='special'){p.activeFrames=[6,18];}
  else if(type==='ult'){p.activeFrames=[0,dur];}
  // Combo counter
  const now=STATE.frame;
  if(type==='light'&&(now-p.lastLightAt)<35){p.comboStep=Math.min(p.comboStep+1,4);}
  else{p.comboStep=0;}
  p.lastLightAt=now;
  // Effect
  const col=ELEM[p.attrs[0]||STATE.selectedElement]?.col||p.skinColor;
  STATE.effects.push({type:'slash',x:p.x+p.facing*30,y:p.y-38,r:28,col,ang:p.facing*0.3,life:12,maxLife:12});
}

function doMeleeHit(attacker){
  const range=attacker.attackType==='heavy'?70:50;
  const atkY=attacker.y-35;
  STATE.players.forEach(t=>{
    if(t.id===attacker.id||t.isDead||attacker.hitThisAttack.has(t.id))return;
    if(dist(attacker.x,t.x,attacker.y,t.y)<range){// simplified check
    if(Math.abs(attacker.x-t.x)<range+10&&Math.abs(attacker.y-t.y)<50){
      attacker.hitThisAttack.add(t.id);
      const blocked=t.cstate==='blocking'&&(t.x-attacker.x)*attacker.facing>-20;
      if(blocked){
        // Perfect parry (templar)
        if(t.role==='templar'&&t.blockFrames<8){
          const pdmg=Math.floor(attacker.atk*2);
          dealDamage(attacker,pdmg,t.attrs[0]||'order',attacker.x,attacker.y-40);
          notify(`${t.name} PERFECT PARRY! ${pdmg}`, '#e8e8ff');
          cinFlash(0.4);
          t.ultMeter=Math.min(t.maxUlt,t.ultMeter+25);
        } else {
          attacker.stagger=Math.min(attacker.maxStagger,attacker.stagger+30);
          spawnEP(t.x,t.y-40,'order',8);
          notify(`${t.name} BLOCKED!`,'#aabbff');
        }
        return;
      }
      let baseDmg=attacker.attackType==='heavy'?attacker.atk*1.8:attacker.atk;
      // Berserker rage
      if(attacker.role==='berserker'&&attacker._rageAtk)baseDmg=attacker._rageAtk*(attacker.attackType==='heavy'?1.6:1);
      // Combo bonus (fighter)
      if(attacker.role==='fighter')baseDmg*=(1+attacker.comboStep*0.05);
      // Crit (assassin/rogue)
      const crit=(attacker.role==='assassin'||attacker.role==='rogue')&&Math.random()<0.2;
      if(crit){baseDmg*=2;cinFlash(0.35);}
      // Backstab
      const behind=(t.facing===attacker.facing);
      if(behind&&attacker.role==='assassin')baseDmg*=3;
      const combo=checkCombo(attacker,t);
      const elem=attacker.attrs[0]||STATE.selectedElement;
      dealDamage(t,Math.round(baseDmg),elem,t.x,t.y-40);
      // Knockback
      const kb=attacker.attackType==='heavy'?8:4;
      t.vx+=attacker.facing*kb;t.vy=-4;
      // Lifesteal
      if(attacker.specials?.lifesteal)attacker.hp=Math.min(attacker.maxHp,attacker.hp+baseDmg*0.15);
      // Stagger
      t.stagger=Math.min(t.maxStagger,t.stagger+20);
      attacker.ultMeter=Math.min(attacker.maxUlt,attacker.ultMeter+6);
      // Sparks
      STATE.effects.push({type:'hit_spark',x:t.x,y:t.y-38,col:ELEM[elem]?.glow||'#fff',life:12,maxLife:12});
      if(combo)triggerComboReaction(combo,(attacker.x+t.x)/2,(attacker.y+t.y)/2-40);
      if(crit)spawnTextEffect(t.x,t.y-60,'CRIT!','#ffff44',20);
      if(behind&&attacker.role==='assassin')spawnTextEffect(t.x,t.y-60,'BACKSTAB!','#cc44ff',18);
      incrementCombo();
    }}
  });
}

function checkCombo(attacker,target){
  if(!attacker.attrs||!target.attrs)return null;
  for(const ae of attacker.attrs){
    for(const te of target.attrs){
      const c=COMBOS[`${ae}+${te}`];
      if(c)return c;
    }
  }
  // Also check attacker's current element vs target attrs
  const sel=STATE.selectedElement;
  for(const te of target.attrs){
    const c=COMBOS[`${sel}+${te}`];
    if(c)return c;
  }
  return null;
}

function dealDamage(target,dmg,elemKey,fx,fy,isDot=false){
  if(target.isDead||target.invFrames>0)return;
  const e=ELEM[elemKey];
  let reduced=Math.max(1,dmg-target.def);
  // Shield absorbs first
  if(target.shield>0){const absorbed=Math.min(target.shield,reduced);target.shield-=absorbed;reduced-=absorbed;}
  target.hp=Math.max(0,target.hp-reduced);
  target.isHurt=true;target.hurtTimer=10;
  if(!isDot){
    spawnDmgNum(fx,fy,reduced,e?.col);
    STATE.effects.push({type:'ring_expand',x:fx,y:fy,r:30,col:e?.col||'#fff',life:16,maxLife:16});
  }
  // Apply status effect
  applyElemEffect(target,elemKey,reduced);
  if(target.hp<=0)killPlayer(target);
}

function applyElemEffect(target,elemKey,dmg){
  const e=ELEM[elemKey];if(!e)return;
  switch(e.eff){
    case'burn':addStatus(target,{type:'burn',dur:180,str:Math.max(1,dmg*0.15)});break;
    case'burn_heavy':addStatus(target,{type:'burn',dur:300,str:Math.max(2,dmg*0.2)});break;
    case'slow':target.spd=Math.max(1,target.spd*0.6);setTimeout(()=>{if(target)target.spd=ROLES[target.role]?.spd||4;},2000);break;
    case'slow_heavy':addStatus(target,{type:'slow',dur:240});target.vx*=0.3;break;
    case'stun_brief':stunPlayer(target,60);break;
    case'stun_mid':stunPlayer(target,120);break;
    case'freeze_3s':addStatus(target,{type:'freeze',dur:180});stunPlayer(target,180);break;
    case'knockdown':target.vy=-8;target.vx*=0.5;target.onGround=false;break;
    case'knockback':target.vx+=target.facing*-12;target.vy=-6;break;
    case'pull':target.vx-=target.vx*0.5;break;
    case'bleed_5s':addStatus(target,{type:'bleed',dur:300,str:Math.max(1,dmg*0.1)});break;
    case'dot_6s':addStatus(target,{type:'dot',dur:360,str:2,elem:elemKey});break;
    case'dot_heavy':addStatus(target,{type:'dot',dur:420,str:4,elem:elemKey});break;
    case'armor_pen':target.def=Math.max(0,target.def-5);setTimeout(()=>{if(target)target.def=ROLES[target.role]?.def||5;},3000);break;
    case'armor_shred':target.def=Math.max(0,target.def-8);break;
    case'chain':chainLightning(target,dmg*0.6,2);break;
    case'chain_dmg':chainLightning(target,dmg*0.7,3);break;
    case'heal_dot':addStatus(target,{type:'heal_dot',dur:240,str:6});break;
    case'doom':addStatus(target,{type:'doom',dur:300,str:dmg*0.5});spawnTextEffect(target.x,target.y-70,'DOOM','#440066',22);break;
  }
}

function addStatus(target,fx){
  if(!target.statusFX)target.statusFX=[];
  // Remove existing same type
  target.statusFX=target.statusFX.filter(s=>s.type!==fx.type);
  target.statusFX.push({...fx});
}
function hasStatus(p,type){return p.statusFX&&p.statusFX.some(s=>s.type===type);}
function stunPlayer(p,dur){p.cstate='stunned';p.stunTimer=(p.stunTimer||0)+dur;}

function chainLightning(origin,dmg,jumps){
  if(jumps<=0)return;
  let nearest=null,nd=200;
  STATE.players.forEach(t=>{
    if(t.id===origin.id||t.isDead)return;
    const d=dist(origin.x,origin.y,t.x,t.y);
    if(d<nd){nd=d;nearest=t;}
  });
  if(!nearest)return;
  // Draw bolt
  const steps=8;
  for(let i=0;i<steps;i++){
    const t=i/steps,px=lerp(origin.x,nearest.x,t)+(Math.random()-0.5)*20;
    const py=lerp(origin.y,nearest.y,t)+(Math.random()-0.5)*20;
    STATE.particles.push({x:px,y:py,vx:0,vy:0,sz:2.5,col:'#ffe01a',glow:'#fff07a',shape:'circle',alpha:0.95,decay:0.08,grav:0,drag:1,rot:0,rspd:0,scaleUp:false,scaleRate:0});
  }
  dealDamage(nearest,Math.round(dmg),'lightning',nearest.x,nearest.y-40);
  setTimeout(()=>chainLightning(nearest,dmg*0.6,jumps-1),80);
}

function killPlayer(p){
  if(p.isDead)return;
  p.isDead=true;p.cstate='dead';
  for(let i=0;i<50;i++){
    const e=p.attrs[Math.floor(Math.random()*Math.max(1,p.attrs.length))]||'fire';
    spawnEP(p.x+(Math.random()-0.5)*30,p.y-30+(Math.random()-0.5)*30,e,2);
  }
  cinFlash(0.4);
  spawnTextEffect(p.x,p.y-80,'KO!','#ff4444',26);
  notify(`${p.name} HAS FALLEN`,'#ff4444');
  // Necro passive
  STATE.players.forEach(pl=>{
    if(pl.role==='necromancer'&&pl.id!==p.id&&!pl.isDead)
      pl.ultMeter=Math.min(pl.maxUlt,pl.ultMeter+20);
  });
  updatePlayerList();
}

function respawnPlayer(p){
  p.hp=p.maxHp;p.isDead=false;p.cstate='idle';
  p.x=100+Math.random()*(gc.width-200);p.y=GY()-60*p.depth;
  p.vx=0;p.vy=0;p.shield=0;p.stagger=0;p.statusFX=[];p.absorbedElem=null;
  spawnEP(p.x,p.y-30,p.attrs[0]||'wind',20);
  notify(`${p.name} RESPAWNED`);
  updatePlayerList();
}

function spawnTextEffect(x,y,text,col,fs=16){
  STATE.effects.push({type:'text_float',x,y,text,col,fs,life:55,maxLife:55});
}

// ═══════════════════════════════════════════════════════════════════════
//  ABILITIES
// ═══════════════════════════════════════════════════════════════════════
function useAbility(p,slot){
  const abilKey=p.abils[slot];if(!abilKey)return;
  const ab=ABILITIES[abilKey];if(!ab)return;
  const cost=ab.cost||0;
  if(p.sta<cost){notify(`${p.name}: NOT ENOUGH STAMINA`,'#ff8844');return;}
  p.sta-=cost;p.cds[slot]=ab.cd||60;
  const elem=p.attrs[0]||STATE.selectedElement;
  notify(`${p.name}: ${ab.name.toUpperCase()}`);

  switch(abilKey){
    case'triple_slash':
      startAttack(p,'special',30);
      setTimeout(()=>{if(!p.isDead)startAttack(p,'light',16);},200);
      setTimeout(()=>{if(!p.isDead)startAttack(p,'light',16);},380);
      break;
    case'shadow_step':{
      // Teleport behind nearest enemy
      let nearest=null,nd=999;
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){const d=dist(p.x,p.y,t.x,t.y);if(d<nd){nd=d;nearest=t;}}});
      if(nearest){
        spawnEP(p.x,p.y-30,'shadow',12);
        p.x=nearest.x-nearest.facing*40;p.y=nearest.y;
        spawnEP(p.x,p.y-30,'shadow',12);
        p.invFrames=20;
      }break;}
    case'barrier':
      p.shield=p.maxShield;
      STATE.effects.push({type:'shield_ring',x:p.x,y:p.y-40,r:50,col:ELEM[elem]?.col||'#4488ff',life:300,maxLife:300});
      spawnEP(p.x,p.y-40,elem,14);break;
    case'elem_bolt':
      for(let i=-1;i<=1;i++){
        STATE.projectiles.push({x:p.x,y:p.y-40,vx:p.facing*14+i,vy:-1+i*0.5,elem,dmg:p.atk*1.4,sz:5,owner:p.id,life:90});
      }break;
    case'frenzy':
      p.frenzied=true;p.attackType=null;
      setTimeout(()=>{if(p)p.frenzied=false;},3000);break;
    case'consecrate':{
      const x=p.x+p.facing*60,y=p.y;
      STATE.hazardZones.push({x,y,radius:55,elem:'light',color:'#fffaaa',life:300});
      spawnEP(x,y,'light',20);break;}
    case'shield_bash':{
      const t=findNearest(p,80);
      if(t){dealDamage(t,p.atk*0.8,'order',t.x,t.y-40);stunPlayer(t,90);t.vx=p.facing*10;}
      spawnEP(p.x+p.facing*30,p.y-40,'metal',10);break;}
    case'smoke_bomb':
      for(let i=0;i<30;i++)STATE.particles.push({x:p.x+(Math.random()-0.5)*80,y:p.y-20+(Math.random()-0.5)*60,vx:(Math.random()-0.5)*1.5,vy:-Math.random()*1,sz:rnd(6,14),col:'#888899',glow:'#aaaacc',shape:'circle',alpha:0.55,decay:0.006,grav:-0.02,drag:0.99,rot:0,rspd:0,scaleUp:false,scaleRate:0});
      p.invFrames=80;break;
    case'backstab':{
      const bt=findNearest(p,70);
      if(bt){const dmg=p.atk*3;dealDamage(bt,dmg,'shadow',bt.x,bt.y-40);spawnTextEffect(bt.x,bt.y-70,'BACKSTAB!','#cc44ff',18);}break;}
    case'bone_spear':
      STATE.projectiles.push({x:p.x,y:p.y-40,vx:p.facing*16,vy:0,elem:'shadow',dmg:p.atk*2.2,sz:6,owner:p.id,life:70});break;
    case'entangle':{
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<130){stunPlayer(t,120);addStatus(t,{type:'slow',dur:120});spawnEP(t.x,t.y-20,'nature',8);}});break;}
    case'judgement':{
      const jt=findNearest(p,110);
      if(jt){
        const jdmg=p.atk*2+(jt.statusFX?.length||0)*8;
        dealDamage(jt,jdmg,'light',jt.x,jt.y-40);
        spawnTextEffect(jt.x,jt.y-70,'JUDGED!','#fffaaa',16);
      }break;}
    case'war_cry':
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<160){t.atk=Math.round(t.atk*1.2);setTimeout(()=>{if(t)t.atk=ROLES[t.role]?.atk||15;},5000);}});
      spawnEP(p.x,p.y-40,'fire',20);spawnTextEffect(p.x,p.y-80,'WAR CRY!','#ff8844',18);break;
    case'life_drain':{
      const lt=findNearest(p,100);
      if(lt){const ld=p.atk*1.5;dealDamage(lt,ld,'blood',lt.x,lt.y-40);p.hp=Math.min(p.maxHp,p.hp+ld*0.5);}break;}
    case'reflect':
      addStatus(p,{type:'reflect',dur:120});spawnTextEffect(p.x,p.y-60,'REFLECT!','#e8e8ff',14);break;
    case'cheap_shot':{
      const ct=findNearest(p,80);if(ct){stunPlayer(ct,90);dealDamage(ct,p.atk,'sonic',ct.x,ct.y-40);}break;}
    case'rally':
      STATE.players.forEach(t=>{if(!t.isDead&&dist(p.x,p.y,t.x,t.y)<180){t.hp=Math.min(t.maxHp,t.hp+30);spawnEP(t.x,t.y-30,'nature',6);}});
      spawnTextEffect(p.x,p.y-80,'RALLY!','#44ff88',18);break;
    case'blood_lust':
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(p.x,p.y,t.x,t.y)<120){const bld=8;dealDamage(t,bld,'blood',t.x,t.y-40);p.hp=Math.min(p.maxHp,p.hp+bld*0.5);}});break;
    case'holy_shield':
      p.shield=p.maxShield*2;addStatus(p,{type:'holy_shield',dur:180});
      spawnEP(p.x,p.y-40,'light',16);break;
    case'elem_familiar':
      STATE.projectiles.push({x:p.x,y:p.y-40,vx:p.facing*6,vy:-3,elem,dmg:p.atk*0.8,sz:8,owner:p.id,life:120,isFamiliar:true});break;
    case'animal_form':
      p._origSpd=p.spd;p._origAtk=p.atk;p.spd=p.spd*1.8;p.atk=Math.round(p.atk*1.4);
      addStatus(p,{type:'transformed',dur:300});
      setTimeout(()=>{if(p){p.spd=p._origSpd||p.spd;p.atk=p._origAtk||p.atk;}},5000);
      spawnTextEffect(p.x,p.y-70,'ANIMAL FORM!','#44aa22',16);break;
    case'mana_shield':addStatus(p,{type:'mana_shield',dur:240});p.shield=p.maxShield*1.5;break;
    case'summon_shade':
      spawnMinion(p,'shade',elem);break;
    default:
      spawnEP(p.x,p.y-40,elem,14);break;
  }
}

function useUltimate(p){
  if(p.ultMeter<p.maxUlt)return;
  p.ultMeter=0;p.cds.ult=300;
  const abilKey=p.abils.ult;
  notify(`${p.name}: ${ABILITIES[abilKey]?.name?.toUpperCase()||'ULTIMATE'}!`,'#c8a84b');
  cinFlash(0.55);
  const elem=p.attrs[0]||STATE.selectedElement;

  switch(abilKey){
    case'blade_storm':
      startAttack(p,'ult',80);
      for(let i=0;i<16;i++){
        setTimeout(()=>{
          if(!p.isDead){
            const a=(i/16)*Math.PI*2;
            const sx=p.x+Math.cos(a)*70,sy=p.y-40+Math.sin(a)*40;
            spawnEP(sx,sy,elem,6);
            STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,sx,sy)<45)dealDamage(t,p.atk*0.6,elem,t.x,t.y-40);});
          }
        },i*80);
      }break;
    case'iron_fortress':
      p.invFrames=240;p.shield=p.maxShield*5;
      addStatus(p,{type:'fortress',dur:240});
      spawnTextEffect(p.x,p.y-90,'IRON FORTRESS!','#4488ff',18);
      for(let i=0;i<30;i++)spawnEP(p.x,p.y-40,'metal',2);break;
    case'death_mark':{
      const dt=findNearest(p,500);
      if(dt){addStatus(dt,{type:'doom',dur:300,str:dt.hp*0.5});spawnTextEffect(dt.x,dt.y-80,'DEATH MARK!','#cc44ff',18);}break;}
    case'mass_heal':
      STATE.players.forEach(t=>{if(!t.isDead){t.hp=t.maxHp;spawnEP(t.x,t.y-30,'light',14);}});
      spawnTextEffect(p.x,p.y-90,'MASS HEAL!','#44ff88',20);break;
    case'elem_nova':
      for(let i=0;i<24;i++){
        setTimeout(()=>{
          const a=(i/24)*Math.PI*2,r=80+Math.random()*40;
          const sx=p.x+Math.cos(a)*r,sy=p.y-40+Math.sin(a)*r;
          spawnImpact(sx,sy,elem,0.7);
          STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,sx,sy)<60)dealDamage(t,p.atk*1.4,elem,t.x,t.y-40);});
        },i*60);
      }break;
    case'berserker_rage':
      p.frenzied=true;p.invFrames=30;p._ultAtk=p.atk;p.atk=p.atk*3;
      addStatus(p,{type:'berserk',dur:360});
      setTimeout(()=>{if(p){p.frenzied=false;if(p._ultAtk)p.atk=p._ultAtk;}},6000);
      spawnTextEffect(p.x,p.y-90,'BERSERKER RAGE!','#ff2200',18);
      for(let i=0;i<30;i++)spawnEP(p.x,p.y-40,'fire',2);break;
    case'divine_judgment':
      STATE.players.forEach(t=>{
        if(t.id!==p.id&&!t.isDead){
          const jd=p.atk*3+(t.statusFX?.length||0)*12;
          dealDamage(t,jd,'light',t.x,t.y-40);
          for(let i=0;i<8;i++)setTimeout(()=>spawnEP(t.x,t.y-40,'light',4),i*40);
        }
      });
      cinFlash(0.7);break;
    case'assassination':{
      const at=findNearest(p,600);
      if(at){
        if(at.hp/at.maxHp<0.3){killPlayer(at);spawnTextEffect(at.x,at.y-90,'EXECUTED!','#cc44ff',22);}
        else{dealDamage(at,Math.round(at.maxHp*0.8),'shadow',at.x,at.y-40);}
      }break;}
    case'summon_legion':
      for(let i=0;i<3;i++)setTimeout(()=>spawnMinion(p,'legion',elem),i*300);break;
    case'death_wave':
      for(let w=0;w<gc.width;w+=20){
        setTimeout(()=>{
          const wy=GY();
          STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&Math.abs(t.x-w)<25){dealDamage(t,p.atk*1.6,'shadow',t.x,t.y-40);}});
          spawnEP(w,wy,'shadow',3);
        },(w/gc.width)*1200);
      }break;
    case'nature_wrath':
      STATE.players.forEach(t=>{
        if(t.id!==p.id&&!t.isDead){
          dealDamage(t,p.atk*2,'nature',t.x,t.y-40);
          stunPlayer(t,120);addStatus(t,{type:'dot',dur:300,str:5,elem:'nature'});
          spawnEP(t.x,t.y-20,'nature',16);
        }
      });
      spawnTextEffect(p.x,p.y-90,'NATURE WRATH!','#44aa22',20);break;
    case'divine_wrath':
      STATE.players.forEach(t=>{
        if(t.id!==p.id&&!t.isDead){
          const sins=(t.statusFX?.length||0)*15;
          dealDamage(t,p.atk*2.5+sins,'order',t.x,t.y-40);
          spawnEP(t.x,t.y-40,'order',14);
        }
      });break;
    default:
      spawnImpact(p.x,p.y-40,elem,2);
      STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<120)dealDamage(t,p.atk*2.5,elem,t.x,t.y-40);});break;
  }
}

function findNearest(p,maxDist=300){
  let nearest=null,nd=maxDist;
  STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead){const d=dist(p.x,p.y,t.x,t.y);if(d<nd){nd=d;nearest=t;}}});
  return nearest;
}

function spawnMinion(owner,type,elem){
  const m=mkPlayer(owner.x+owner.facing*40,owner.y,{name:`${type.toUpperCase()}`,role:'fighter',attrs:[elem],hp:40,atk:8,def:0,spd:5});
  m.isAI=true;m.aiOwner=owner.id;m.skinColor='#6633aa';m.depth=0.75;
  STATE.players.push(m);updatePlayerList();
  notify(`${owner.name}: ${type.toUpperCase()} SUMMONED!`);
}

// ═══════════════════════════════════════════════════════════════════════
//  COMBO REACTIONS
// ═══════════════════════════════════════════════════════════════════════
function triggerComboReaction(combo,x,y){
  notify(`⚗ ${combo.name.toUpperCase()}!`,'#c8a84b');
  if(combo.flash)cinFlash(0.45);
  if(combo.aoe>0){
    STATE.players.forEach(t=>{
      if(!t.isDead&&dist(t.x,t.y,x,y)<combo.aoe){
        dealDamage(t,combo.dmg,combo.result,t.x,t.y-40);
      }
    });
  }
  spawnImpact(x,y,combo.result,1.5);
  const eff=combo.eff||'';
  if(eff==='steam_cloud'){
    for(let i=0;i<25;i++)STATE.particles.push({x:x+(Math.random()-0.5)*80,y,vx:(Math.random()-0.5)*2,vy:-Math.random()*3-1,sz:rnd(6,14),col:'#ccddff',glow:'#aaccff',shape:'ring',alpha:0.55,decay:0.009,grav:-0.08,drag:0.98,rot:0,rspd:0,scaleUp:false,scaleRate:0});
  }else if(eff==='pull_all'||eff==='crush_all'){
    STATE.gravityWells.push({x,y,radius:combo.aoe||200,strength:6,life:120,maxLife:120});
  }else if(eff==='stop_all'){
    STATE.players.forEach(t=>{if(!t.isDead)stunPlayer(t,180);});
    STATE.slowmoFactor=0.15;setTimeout(()=>{STATE.slowmoFactor=STATE.isSlowmo?0.25:1;},3000);
  }else if(eff==='chain'||eff==='stun_chain'){
    chainLightning({x,y,id:-1},combo.dmg*0.5,4);
  }else if(eff==='reality_break'){
    for(let i=0;i<6;i++)setTimeout(()=>{
      const rx=x+(Math.random()-0.5)*400,ry=(Math.random())*gc.height*0.8;
      spawnImpact(rx,ry,'chaos',0.8);
      STATE.players.forEach(t=>{if(!t.isDead&&dist(t.x,t.y,rx,ry)<80)dealDamage(t,40,'chaos',t.x,t.y-40);});
    },i*120);
  }
  spawnTextEffect(x,y-40,combo.name,combo.flash||'#c8a84b',16);
  incrementCombo(combo.name);
}

// ═══════════════════════════════════════════════════════════════════════
//  ELEMENT PLACEMENT
// ═══════════════════════════════════════════════════════════════════════
function placeElement(x,y){
  const sel=STATE.selectedElement;
  if(sel==='eraser'){
    STATE.elements=STATE.elements.filter(e=>dist(e.x,e.y,x,y)>30);
    STATE.hazardZones=STATE.hazardZones.filter(e=>dist(e.x,e.y,x,y)>50);
    return;
  }
  if(sel==='hazard'){
    STATE.hazardZones.push({x,y,radius:45,elem:'fire',life:-1});
    spawnEP(x,y,'fire',8);return;
  }
  const ec=ELEM[sel];if(!ec)return;
  spawnEP(x,y,sel,ec.cnt);

  // Hit players
  STATE.players.forEach(p=>{
    if(p.isDead||dist(p.x,p.y,x,y)>65)return;
    if(p.absorbEnabled&&!p.absorbedElem){
      p.absorbedElem=sel;
      notify(`${p.name} ABSORBED ${ELEM[sel]?.abbr}!`);
      spawnEP(p.x,p.y-30,sel,10);
    }else{
      dealDamage(p,ec.dmg,sel,p.x,p.y-40);
    }
    // Element vs element combos
    STATE.elements.forEach(e=>{
      if(e.elem!==sel&&dist(e.x,e.y,x,y)<55){
        const c=COMBOS[`${e.elem}+${sel}`];
        if(c){triggerComboReaction(c,(e.x+x)/2,(e.y+y)/2);e.life=0;}
      }
    });
    // Wind knockback
    if(sel==='wind'){const d=dist(p.x,p.y,x,y);p.vx+=(p.x-x)/d*10;p.vy+=(p.y-y)/d*8-3;}
    // Water slow
    if(sel==='water')p.vx*=0.3;
    // Lightning chain
    if(sel==='lightning')chainLightning({x,y,id:-999},ec.dmg*0.6,2);
    // Gravity pull
    if(sel==='gravity'||sel==='magnet')STATE.players.forEach(t=>{if(!t.isDead&&dist(t.x,t.y,x,y)<120)t.vx+=(x-t.x)*0.06;});
    updatePlayerList();
  });
  STATE.elements.push({x,y,elem:sel,life:120,maxLife:120,radius:24});
}

function releaseAbsorbed(p,mode){
  if(!p.absorbedElem)return;
  const ae=p.absorbedElem,ec=ELEM[ae];
  if(mode==='burst'){
    spawnImpact(p.x,p.y-40,ae,1.5);
    STATE.players.forEach(t=>{if(t.id!==p.id&&!t.isDead&&dist(t.x,t.y,p.x,p.y)<80)dealDamage(t,ec.dmg*2,ae,t.x,t.y-40);});
  }else{
    STATE.projectiles.push({x:p.x,y:p.y-40,vx:p.facing*15,vy:-1,elem:ae,dmg:ec.dmg*1.5,sz:6,owner:p.id,life:80});
  }
  notify(`${p.name} FIRED ${ec.abbr}!`);
  p.absorbedElem=null;updatePlayerList();
}

// ═══════════════════════════════════════════════════════════════════════
//  PATHS SYSTEM
// ═══════════════════════════════════════════════════════════════════════
function togglePathDraw(){
  STATE.pathDrawing=!STATE.pathDrawing;
  STATE.currentPath=[];
  document.getElementById('path-draw-btn').classList.toggle('active',STATE.pathDrawing);
  notify(STATE.pathDrawing?'✦ DRAW PATH — click & drag on canvas':'✦ PATH DRAW MODE OFF');
}
function clearPaths(){STATE.paths=[];notify('PATHS CLEARED');}

function openPathModal(rawPath){
  STATE.pendingPath=rawPath;
  const psel=document.getElementById('pm-player');
  psel.innerHTML=STATE.players.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  const esel=document.getElementById('pm-elem');
  esel.innerHTML=EKEYS.map(k=>`<option value="${k}">[${ELEM[k].abbr}] ${ELEM[k].name}</option>`).join('');
  const typeDrawn=document.getElementById('path-type-sel')?.value||'strike';
  document.getElementById('pm-type').value=typeDrawn;
  document.getElementById('path-modal').classList.add('show');
}
function closePathModal(){document.getElementById('path-modal').classList.remove('show');STATE.pendingPath=null;}

function confirmPath(){
  if(!STATE.pendingPath||STATE.pendingPath.length<3)return;
  const pid=parseInt(document.getElementById('pm-player').value);
  const key=document.getElementById('pm-key').value;
  const elem=document.getElementById('pm-elem').value;
  const type=document.getElementById('pm-type').value;
  const player=STATE.players.find(p=>p.id===pid);
  if(player){
    const smooth=catmullRom(STATE.pendingPath,0.5,6);
    const pathObj={path:STATE.pendingPath,smooth,elem,type,key};
    player.paths[key]=pathObj;
    // Also save to global display
    STATE.paths=STATE.paths.filter(pb=>!(pb.pid===pid&&pb.key===key));
    STATE.paths.push({...pathObj,pid});
    notify(`PATH BOUND [${key}] → ${player.name} · ${ELEM[elem]?.abbr} · ${type.toUpperCase()}`);
  }
  closePathModal();
}

function triggerPath(player,key){
  const pb=player.paths?.[key];
  if(!pb||!pb.smooth||pb.smooth.length<2){notify(`${player.name}: NO PATH ON [${key}]`,'#ff8844');return;}
  const pts=pb.smooth,elem=pb.elem,type=pb.type||'strike';
  notify(`[${key}] ${player.name} → ${ELEM[elem]?.abbr} ${type.toUpperCase()}`);

  switch(type){
    case'strike':
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(!player.isDead){
          spawnEP(pt.x,pt.y,elem,4);
          STATE.players.forEach(t=>{if(t.id!==player.id&&!t.isDead&&dist(t.x,t.y,pt.x,pt.y)<45)dealDamage(t,player.atk*0.8,elem,t.x,t.y-40);});
        }
      },i*12));break;
    case'shield':
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(!player.isDead){
          STATE.effects.push({type:'ring_expand',x:pt.x,y:pt.y,r:22,col:ELEM[elem]?.col||'#fff',life:18,maxLife:18});
          spawnEP(pt.x,pt.y,elem,2);
        }
      },i*10));
      player.shield=player.maxShield;break;
    case'trail':
      pts.forEach((pt,i)=>setTimeout(()=>{
        if(!player.isDead){
          STATE.elements.push({x:pt.x,y:pt.y,elem,life:90,maxLife:90,radius:18});
          spawnEP(pt.x,pt.y,elem,3);
        }
      },i*10));break;
    case'loop':{
      // Continuously fire along path until 1 full pass
      let idx=0;
      const iv=setInterval(()=>{
        if(player.isDead){clearInterval(iv);return;}
        const pt=pts[idx];
        spawnEP(pt.x,pt.y,elem,5);
        STATE.players.forEach(t=>{if(t.id!==player.id&&!t.isDead&&dist(t.x,t.y,pt.x,pt.y)<40)dealDamage(t,player.atk*0.5,elem,t.x,t.y-40);});
        idx++;
        if(idx>=pts.length)clearInterval(iv);
      },14);break;}
  }
}

// ═══════════════════════════════════════════════════════════════════════
//  GRAVITY WELLS / MISC
// ═══════════════════════════════════════════════════════════════════════
function spawnGravWell(x,y){
  STATE.gravityWells.push({x,y,radius:130,strength:3,life:200,maxLife:200});
  spawnEP(x,y,'void',28);notify('⬡ GRAVITY WELL');
}

function toggleSlowmo(){
  STATE.isSlowmo=!STATE.isSlowmo;
  STATE.slowmoFactor=STATE.isSlowmo?0.25:1;
  document.getElementById('slowmo-ind').style.opacity=STATE.isSlowmo?'1':'0';
  document.getElementById('btn-slowmo').classList.toggle('active-btn',STATE.isSlowmo);
  notify(STATE.isSlowmo?'◈ SLOW MOTION ON':'◈ NORMAL SPEED');
}

function clearAll(){
  STATE.particles=[];STATE.elements=[];STATE.hazardZones=[];
  STATE.gravityWells=[];STATE.paths=[];STATE.currentPath=[];
  STATE.projectiles=[];STATE.effects=[];
  notify('SANDBOX CLEARED');
}

function incrementCombo(comboName=null){
  STATE.comboCount++;clearTimeout(STATE.comboTimer);
  const el=document.getElementById('combo-hud'),num=document.getElementById('combo-num');
  if(STATE.comboCount>=2){
    num.textContent=STATE.comboCount;el.classList.add('show');
    const s=Math.min(1+STATE.comboCount*0.03,1.6);
    el.style.transform=`translateX(-50%) scale(${s})`;
  }
  STATE.comboTimer=setTimeout(()=>{el.classList.remove('show');STATE.comboCount=0;},2000);
}

// ═══════════════════════════════════════════════════════════════════════
//  AI SYSTEM
// ═══════════════════════════════════════════════════════════════════════
let _aiEnabled=false;
function toggleAI(){
  _aiEnabled=!_aiEnabled;
  STATE.players.forEach(p=>{if(p.id!==STATE.selectedPlayer?.id)p.isAI=_aiEnabled;});
  notify(_aiEnabled?'AI BOTS ON':'AI BOTS OFF');
}
function tickAI(p){
  const target=STATE.players.find(t=>t.id!==p.id&&!t.isDead);
  if(!target)return;
  const dx=target.x-p.x,dy=target.y-p.y,d=dist(p.x,p.y,target.x,target.y);
  p.facing=dx>0?1:-1;
  // Move toward target
  if(d>60)p.vx+=p.facing*p.spd*0.4*STATE.slowmoFactor;
  // Jump to reach
  if(target.y<p.y-30&&p.onGround&&Math.random()<0.03)p.vy=-12;
  // Attack
  if(d<55&&p.cstate==='idle'&&Math.random()<0.04)startAttack(p,'light',16);
  if(d<65&&p.cstate==='idle'&&p.sta>=20&&Math.random()<0.015)startAttack(p,'heavy',28);
  // Ability
  if(d<120&&p.cds.a1<=0&&p.sta>=20&&Math.random()<0.008)useAbility(p,'a1');
  // Ultimate
  if(p.ultMeter>=p.maxUlt&&Math.random()<0.02)useUltimate(p);
  // Block when being attacked
  if(d<80&&Math.random()<0.008){STATE.keys[KEYBINDS[p.keybind||'wasd'].block]=true;setTimeout(()=>{STATE.keys[KEYBINDS[p.keybind||'wasd'].block]=false;},500);}
}

// ═══════════════════════════════════════════════════════════════════════
//  PLAYER UI / PALETTE
// ═══════════════════════════════════════════════════════════════════════
function buildPalette(){
  const pal=document.getElementById('elem-palette');pal.innerHTML='';
  EKEYS.forEach(k=>{
    const e=ELEM[k];
    const btn=document.createElement('div');
    btn.className='pal-btn'+(k===STATE.selectedElement?' selected':'');
    btn.dataset.elem=k;
    btn.style.background=`radial-gradient(circle at 38% 38%,${e.glow},${e.col},${e.dark})`;
    btn.style.color=e.abbr==='LGT'||e.abbr==='ICE'||e.abbr==='FRS'||e.abbr==='CRY'?'#222':'#fff';
    btn.style.borderColor=hexA(e.col,0.45);
    btn.style.textShadow=e.abbr==='LGT'?'none':`0 0 6px ${e.glow}`;
    btn.innerHTML=`${e.abbr}<span class="pal-tip">${e.name} · ${e.eff?.replace(/_/g,' ')}</span>`;
    btn.onclick=()=>selectElement(k);
    btn.addEventListener('mouseenter',ev=>showTooltip(ev,`${e.name}: DMG ${e.dmg} · ${e.eff?.replace(/_/g,' ')}`));
    btn.addEventListener('mousemove',moveTooltip);
    btn.addEventListener('mouseleave',hideTooltip);
    pal.appendChild(btn);
  });
  // Eraser + Hazard
  ['eraser','hazard'].forEach(k=>{
    const btn=document.createElement('div');
    btn.className='pal-btn'+(k===STATE.selectedElement?' selected':'');
    btn.dataset.elem=k;
    btn.style.background=k==='hazard'?'rgba(80,20,20,0.9)':'rgba(30,40,60,0.9)';
    btn.style.borderColor=k==='hazard'?'rgba(200,0,0,0.5)':'rgba(100,120,140,0.3)';
    btn.style.color='#ccc';
    btn.innerHTML=k==='hazard'?'HZD<span class="pal-tip">Hazard Zone</span>':'ERA<span class="pal-tip">Eraser</span>';
    btn.onclick=()=>selectElement(k);
    pal.appendChild(btn);
  });
}

function selectElement(k){
  STATE.selectedElement=k;
  document.querySelectorAll('#elem-palette .pal-btn').forEach(b=>b.classList.toggle('selected',b.dataset.elem===k));
}

function buildMenuElemStrip(){
  const strip=document.getElementById('menu-elem-strip');strip.innerHTML='';
  EKEYS.slice(0,16).forEach(k=>{
    const e=ELEM[k];
    const el=document.createElement('div');
    el.className='m-elem-badge';
    el.style.background=hexA(e.col,0.15);
    el.style.borderColor=hexA(e.col,0.5);
    el.style.color=e.col;
    el.style.textShadow=`0 0 8px ${e.glow}`;
    el.textContent=e.abbr;
    el.title=e.name;
    el.addEventListener('click',()=>{
      for(let i=0;i<8;i++)setTimeout(()=>{
        const rect=el.getBoundingClientRect();
        menuParticles.push({
          x:rect.left+rect.width/2,y:rect.top+rect.height/2,
          vx:(Math.random()-0.5)*4,vy:-(Math.random()*3+1),
          sz:rnd(2,6),col:e.col,glow:e.glow,shape:e.ps[0],
          alpha:0.9,decay:0.03,grav:-0.04,drag:0.97,
          rot:Math.random()*Math.PI*2,rspd:(Math.random()-0.5)*0.12,
          scaleUp:false,scaleRate:0,age:0,maxLife:70
        });
      },i*25);
    });
    strip.appendChild(el);
  });
}

function updatePlayerList(){
  const list=document.getElementById('player-list');if(!list)return;
  list.innerHTML='';
  STATE.players.forEach(p=>{
    const div=document.createElement('div');
    div.className='plcard'+(STATE.selectedPlayer?.id===p.id?' sel-pl':'');
    const hp=Math.max(0,p.hp/p.maxHp),sta=Math.max(0,p.sta/p.maxSta);
    const hpCol=hp>0.6?'#44ff88':hp>0.3?'#ffcc00':'#ff4444';
    const role=ROLES[p.role];
    const attrTags=p.attrs.slice(0,3).map(a=>{
      const e=ELEM[a];return `<span class="attr-tag" style="background:${hexA(e.col,0.18)};color:${e.col};">${e.abbr}</span>`;
    }).join('');
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="plcard-name" style="color:${p.skinColor};">${p.name}</div>
        <div style="display:flex;gap:4px;align-items:center;">
          ${p.isAI?'<span style="font-family:Share Tech Mono;font-size:7px;color:#4488ff;letter-spacing:1px;">AI</span>':''}
          <div style="font-size:9px;cursor:pointer;color:#ff4444;" onclick="event.stopPropagation();removePlayer(${p.id})">✕</div>
        </div>
      </div>
      <div class="plcard-role" style="color:${role?.col||'#888'};">${role?.abbr||'?'} · ${p.role.toUpperCase()}</div>
      <div class="plcard-bars">
        <div class="bar-row"><div class="bar-lbl" style="color:#44ff88;">HP</div><div class="bar-bg"><div class="bar-fg" style="width:${hp*100}%;background:${hpCol};"></div></div><div style="font-family:Share Tech Mono;font-size:7px;color:${hpCol};margin-left:3px;">${Math.ceil(p.hp)}</div></div>
        <div class="bar-row"><div class="bar-lbl" style="color:#ffcc44;">ST</div><div class="bar-bg"><div class="bar-fg" style="width:${sta*100}%;background:#ffcc44;"></div></div></div>
        <div class="bar-row"><div class="bar-lbl" style="color:#c8a84b;">UL</div><div class="bar-bg"><div class="bar-fg" style="width:${(p.ultMeter/p.maxUlt)*100}%;background:#c8a84b;"></div></div></div>
      </div>
      <div class="plcard-attrs">${attrTags}</div>`;
    div.addEventListener('click',()=>{STATE.selectedPlayer=p;updatePlayerList();});
    list.appendChild(div);
  });
}

function spawnPlayer(){
  const x=120+Math.random()*(gc.width-240),y=gc.height-200;
  const roles=RKEYS;const role=roles[Math.floor(Math.random()*roles.length)];
  const skinCols=['#4488ff','#ff4444','#44ff88','#ff8844','#cc44ff','#44ccff','#ff44cc','#88ff44'];
  const skinColor=skinCols[Math.floor(Math.random()*skinCols.length)];
  const p=mkPlayer(x,y,{role,skinColor,skinColor2:darkenHex(skinColor,0.35)});
  STATE.players.push(p);
  if(!STATE.selectedPlayer)STATE.selectedPlayer=p;
  updatePlayerList();notify(`${p.name} [${ROLES[role].abbr}] SPAWNED`);
  return p;
}

function removePlayer(id){
  STATE.players=STATE.players.filter(p=>p.id!==id);
  if(STATE.selectedPlayer?.id===id)STATE.selectedPlayer=STATE.players[0]||null;
  updatePlayerList();
}

// ═══════════════════════════════════════════════════════════════════════
//  MOUSE & KEYBOARD INPUT
// ═══════════════════════════════════════════════════════════════════════
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  STATE.keys[k]=true;
  STATE.keys[k+'_once']=true;
  if(k==='tab'){e.preventDefault();const idx=EKEYS.indexOf(STATE.selectedElement);selectElement(EKEYS[(idx+1)%EKEYS.length]);}
  if(k==='escape'){STATE.pathDrawing=false;document.getElementById('path-draw-btn').classList.remove('active');showPage('menu');}
  if(STATE.isRecording&&STATE.page==='editor'){STATE.recordBuffer.push({key:e.key,t:Date.now()});updateRecDisp();}
});
window.addEventListener('keyup',e=>{
  const k=e.key.toLowerCase();
  STATE.keys[k]=false;
  // _once flags are cleared per-frame in tickPlayers
});

// After tickPlayers runs, clear _once flags
function clearOnceKeys(){
  for(const k in STATE.keys){if(k.endsWith('_once'))delete STATE.keys[k];}
}

let _mDown=false,_lastPlace=0;
gc.addEventListener('mousedown',e=>{
  if(e.button===2){
    // Right click = select player
    let near=null,nd=80;
    STATE.players.forEach(p=>{const d=dist(p.x,p.y,e.offsetX,e.offsetY);if(d<nd){nd=d;near=p;}});
    if(near){STATE.selectedPlayer=near;updatePlayerList();}
    return;
  }
  if(STATE.pathDrawing){STATE.currentPath=[{x:e.offsetX,y:e.offsetY}];_mDown=true;return;}
  _mDown=true;placeElement(e.offsetX,e.offsetY);_lastPlace=Date.now();
});
gc.addEventListener('mousemove',e=>{
  if(!_mDown)return;
  if(STATE.pathDrawing){
    // Only add if moved enough
    const last=STATE.currentPath[STATE.currentPath.length-1];
    if(!last||dist(last.x,last.y,e.offsetX,e.offsetY)>8)
      STATE.currentPath.push({x:e.offsetX,y:e.offsetY});
    return;
  }
  if(Date.now()-_lastPlace>55){placeElement(e.offsetX,e.offsetY);_lastPlace=Date.now();}
});
gc.addEventListener('mouseup',e=>{
  if(STATE.pathDrawing&&STATE.currentPath.length>4){
    openPathModal([...STATE.currentPath]);
    STATE.currentPath=[];STATE.pathDrawing=false;
    document.getElementById('path-draw-btn').classList.remove('active');
  }
  _mDown=false;
});
gc.addEventListener('dblclick',e=>{
  const p=STATE.selectedPlayer;if(!p||p.isDead)return;
  if(p.sta>=8)startAttack(p,'light',16);
});
gc.addEventListener('contextmenu',e=>e.preventDefault());

// ═══════════════════════════════════════════════════════════════════════
//  AMBIENT PARTICLES
// ═══════════════════════════════════════════════════════════════════════
setInterval(()=>{
  if(STATE.page!=='game')return;
  const k=rndOf(EKEYS);const e=ELEM[k];
  const x=Math.random()*gc.width,y=GY()-Math.random()*50;
  STATE.particles.push({x,y,vx:(Math.random()-0.5)*0.5,vy:-Math.random()*0.7-0.1,
    sz:rnd(1.2,3),col:e.col,glow:e.glow,shape:e.ps[0],
    alpha:0.28,decay:0.004,grav:-0.02,drag:0.99,rot:Math.random()*Math.PI*2,rspd:(Math.random()-0.5)*0.03,scaleUp:false,scaleRate:0});
},200);

// ═══════════════════════════════════════════════════════════════════════
//  MENU PARTICLES
// ═══════════════════════════════════════════════════════════════════════
const mCanvas=document.getElementById('menu-bg');
const mCtx=mCanvas.getContext('2d');
let menuParticles=[];
function startMenuFX(){
  mCanvas.width=window.innerWidth;mCanvas.height=window.innerHeight;
  menuParticles=Array.from({length:80},()=>mkMenuParticle());
  menuLoop();
}
function mkMenuParticle(){
  const k=rndOf(EKEYS);const e=ELEM[k];
  return {x:Math.random()*mCanvas.width,y:Math.random()*mCanvas.height,
    vx:(Math.random()-0.5)*0.45,vy:-Math.random()*0.55-0.08,
    sz:rnd(2,6),col:e.col,glow:e.glow,shape:rndOf(e.ps),
    alpha:rnd(0.1,0.5),decay:0,grav:-0.01,drag:0.99,
    rot:Math.random()*Math.PI*2,rspd:(Math.random()-0.5)*0.035,
    age:Math.random()*200,maxLife:rnd(120,350),scaleUp:false,scaleRate:0};
}
function menuLoop(){
  if(STATE.page!=='menu'){requestAnimationFrame(menuLoop);return;}
  mCtx.clearRect(0,0,mCanvas.width,mCanvas.height);
  for(let i=menuParticles.length-1;i>=0;i--){
    const p=menuParticles[i];p.age++;p.x+=p.vx;p.y+=p.vy;p.rot+=p.rspd;
    const life=1-p.age/p.maxLife;
    if(p.age>p.maxLife){menuParticles[i]=mkMenuParticle();menuParticles[i].y=mCanvas.height+10;continue;}
    drawShape(mCtx,p.shape,p.x,p.y,p.sz,p.col,p.alpha*life,p.rot);
  }
  requestAnimationFrame(menuLoop);
}
window.addEventListener('resize',()=>{mCanvas.width=window.innerWidth;mCanvas.height=window.innerHeight;});

// ═══════════════════════════════════════════════════════════════════════
//  PAGE NAVIGATION
// ═══════════════════════════════════════════════════════════════════════
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  STATE.page=name;
  if(name==='game'){if(STATE.players.length===0)spawnPlayer();if(!_gameRunning)startGameLoop();}
  if(name==='editor')initEditor();
  if(name==='menu')menuLoop();
}
function openEditorFromGame(){showPage('editor');}

// ═══════════════════════════════════════════════════════════════════════
//  GAME LOOP
// ═══════════════════════════════════════════════════════════════════════
let _gameRunning=false;
function startGameLoop(){
  if(_gameRunning)return;
  _gameRunning=true;
  function loop(){
    if(STATE.page!=='game'){_gameRunning=false;return;}
    STATE.frame++;
    ctx.clearRect(0,0,gc.width,gc.height);
    // Render
    drawBG();
    drawHazardZones();
    drawGravWells();
    drawElemBlobs();
    drawPaths();
    drawEffects();
    // Draw players sorted by depth
    [...STATE.players].sort((a,b)=>a.depth-b.depth).forEach(p=>drawStickman(p,STATE.frame));
    drawProjectiles();
    drawParticles();
    // Tick
    tickPlayers();
    tickParticles();
    tickProjectiles();
    tickElements();
    tickGravWells();
    tickStatusFX();
    tickHazards();
    tickEffects();
    clearOnceKeys();
    // Update UI every 4 frames
    if(STATE.frame%4===0)updatePlayerList();
    requestAnimationFrame(loop);
  }
  loop();
}

// ═══════════════════════════════════════════════════════════════════════
//  EDITOR SYSTEM
// ═══════════════════════════════════════════════════════════════════════
function initEditor(){
  buildRoleList();buildAttrGrid();buildEdCharList();buildSkinColors();
  if(!STATE.editingPlayer&&STATE.players.length===0)spawnEditorChar();
  if(!STATE.editingPlayer&&STATE.players.length>0)STATE.editingPlayer=STATE.players[0];
  if(STATE.editingPlayer)loadPlayerIntoEditor(STATE.editingPlayer);
  initSkinCanvas();
  startEdPreviewLoop();
}

function spawnEditorChar(){
  const p=mkPlayer(0,0);STATE.players.push(p);STATE.editingPlayer=p;updatePlayerList();
}

function buildEdCharList(){
  const list=document.getElementById('ed-char-list');list.innerHTML='';
  STATE.players.forEach(p=>{
    const div=document.createElement('div');div.className='plcard'+(STATE.editingPlayer?.id===p.id?' sel-pl':'');
    div.innerHTML=`<div class="plcard-name" style="color:${p.skinColor};">${p.name}</div><div class="plcard-role" style="color:${ROLES[p.role]?.col||'#888'};">${p.role.toUpperCase()}</div>`;
    div.onclick=()=>{STATE.editingPlayer=p;loadPlayerIntoEditor(p);buildEdCharList();};
    list.appendChild(div);
  });
}

function edNewChar(){
  const p=mkPlayer(100,100);STATE.players.push(p);
  STATE.editingPlayer=p;updatePlayerList();buildEdCharList();
  loadPlayerIntoEditor(p);notify('NEW CHARACTER CREATED');
}

function buildRoleList(){
  const list=document.getElementById('role-list');list.innerHTML='';
  RKEYS.forEach(k=>{
    const r=ROLES[k];
    const div=document.createElement('div');div.className='role-card'+(STATE.editingPlayer?.role===k?' active-role':'');div.dataset.role=k;
    const abbr=document.createElement('div');abbr.className='role-abbr';
    abbr.style.background=hexA(r.col,0.18);abbr.style.color=r.col;abbr.textContent=r.abbr;
    const info=document.createElement('div');info.className='role-info';
    info.innerHTML=`<div class="role-name" style="color:${r.col};">${r.name}</div><div class="role-desc">${r.desc}</div>`;
    div.appendChild(abbr);div.appendChild(info);
    div.onclick=()=>{edSetRole(k);};
    list.appendChild(div);
  });
}

function edSetRole(role){
  if(!STATE.editingPlayer)return;
  const p=STATE.editingPlayer,r=ROLES[role];
  p.role=role;p.maxHp=r.hp;p.hp=r.hp;p.atk=r.atk;p.def=r.def;p.spd=r.spd;p.maxSta=r.sta;p.sta=r.sta;
  p.abils={passive:r.passive,a1:r.a1,a2:r.a2,ult:r.ult};
  loadPlayerIntoEditor(p);
  document.querySelectorAll('.role-card').forEach(c=>c.classList.toggle('active-role',c.dataset.role===role));
  notify(`ROLE: ${r.name.toUpperCase()}`);
}

function loadPlayerIntoEditor(p){
  if(!p)return;
  document.getElementById('sl-hp').value=p.maxHp;document.getElementById('sv-hp').textContent=p.maxHp;
  document.getElementById('sl-atk').value=p.atk;document.getElementById('sv-atk').textContent=p.atk;
  document.getElementById('sl-def').value=p.def;document.getElementById('sv-def').textContent=p.def;
  document.getElementById('sl-spd').value=p.spd;document.getElementById('sv-spd').textContent=p.spd;
  document.getElementById('sl-sta').value=p.maxSta;document.getElementById('sv-sta').textContent=p.maxSta;
  document.querySelectorAll('.role-card').forEach(c=>c.classList.toggle('active-role',c.dataset.role===p.role));
  document.querySelectorAll('.attr-btn').forEach(c=>c.classList.toggle('active-attr',p.attrs.includes(c.dataset.attr)));
  updateAuraPreview();buildAbilityList();
  document.getElementById('ab-on').classList.toggle('sel',p.absorbEnabled);
  document.getElementById('ab-off').classList.toggle('sel',!p.absorbEnabled);
  document.getElementById('ls-on').classList.toggle('sel',p.specials?.lifesteal);
  document.getElementById('ls-off').classList.toggle('sel',!p.specials?.lifesteal);
  document.getElementById('sr-on').classList.toggle('sel',p.specials?.shieldRegen);
  document.getElementById('sr-off').classList.toggle('sel',!p.specials?.shieldRegen);
  // Keybind
  ['wasd','arrows','num'].forEach(kb=>{
    const el=document.getElementById(`kb-${kb}`);if(el)el.classList.toggle('sel',p.keybind===kb);
  });
}

function edUpdateStat(stat,val){
  if(!STATE.editingPlayer)return;
  val=parseInt(val);const p=STATE.editingPlayer;
  if(stat==='hp'){p.maxHp=val;p.hp=Math.min(p.hp,val);document.getElementById('sv-hp').textContent=val;}
  if(stat==='atk'){p.atk=val;document.getElementById('sv-atk').textContent=val;}
  if(stat==='def'){p.def=val;document.getElementById('sv-def').textContent=val;}
  if(stat==='spd'){p.spd=val;document.getElementById('sv-spd').textContent=val;}
  if(stat==='sta'){p.maxSta=val;p.sta=Math.min(p.sta,val);document.getElementById('sv-sta').textContent=val;}
}

function buildAttrGrid(){
  const grid=document.getElementById('attr-grid');grid.innerHTML='';
  EKEYS.forEach(k=>{
    const e=ELEM[k];
    const btn=document.createElement('div');
    btn.className='attr-btn'+(STATE.editingPlayer?.attrs.includes(k)?' active-attr':'');
    btn.dataset.attr=k;
    btn.style.color=e.col;
    btn.style.borderColor=hexA(e.col,0.3);
    btn.style.background=hexA(e.col,0.06);
    btn.style.textShadow=`0 0 6px ${hexA(e.glow,0.5)}`;
    btn.textContent=e.abbr;
    btn.title=e.name;
    btn.onclick=()=>edToggleAttr(k);
    btn.addEventListener('mouseenter',ev=>showTooltip(ev,`${e.name}: ${e.eff?.replace(/_/g,' ')}`));
    btn.addEventListener('mousemove',moveTooltip);btn.addEventListener('mouseleave',hideTooltip);
    grid.appendChild(btn);
  });
}

function edToggleAttr(attr){
  if(!STATE.editingPlayer)return;
  const p=STATE.editingPlayer,idx=p.attrs.indexOf(attr);
  if(idx>=0)p.attrs.splice(idx,1);
  else if(p.attrs.length<3)p.attrs.push(attr);
  else{notify('MAX 3 ELEMENTS','#ff8844');return;}
  document.querySelectorAll('.attr-btn').forEach(c=>c.classList.toggle('active-attr',p.attrs.includes(c.dataset.attr)));
  updateAuraPreview();notify(idx>=0?`${ELEM[attr]?.abbr} REMOVED`:`${ELEM[attr]?.abbr} ADDED`);
}

function updateAuraPreview(){
  const p=STATE.editingPlayer;
  const prev=document.getElementById('aura-prev'),lbl=document.getElementById('aura-lbl');
  if(!p||!p.attrs.length){
    prev.style.cssText='background:rgba(20,30,50,0.5);box-shadow:none;border:1px solid #1a2c3e;';
    prev.textContent='—';lbl.textContent='NO ELEMENT';return;
  }
  const col=ELEM[p.attrs[0]]?.col,glo=ELEM[p.attrs[0]]?.glow;
  prev.style.background=`radial-gradient(circle at 38% 38%,${hexA(col,0.5)},${hexA(col,0.12)})`;
  prev.style.boxShadow=`0 0 30px ${hexA(col,0.6)},inset 0 0 20px ${hexA(col,0.18)}`;
  prev.style.border=`1px solid ${hexA(col,0.5)}`;
  prev.style.color=col;prev.textContent=ELEM[p.attrs[0]]?.abbr||'?';
  lbl.textContent=p.attrs.map(a=>ELEM[a]?.name||a).join(' + ').toUpperCase();
  lbl.style.color=glo||'#888';
}

function buildAbilityList(){
  const list=document.getElementById('ab-list');list.innerHTML='';
  const p=STATE.editingPlayer;if(!p)return;
  const role=ROLES[p.role];if(!role)return;
  [role.passive,role.a1,role.a2,role.ult].forEach(abKey=>{
    const ab=ABILITIES[abKey];if(!ab)return;
    const div=document.createElement('div');div.className='ab-card';
    const typeCol={p:'#888888',a:'#44aaff',u:'#c8a84b'}[ab.type]||'#888';
    div.innerHTML=`<div class="ab-type" style="color:${typeCol};">${{p:'PASSIVE',a:'ACTIVE',u:'ULTIMATE'}[ab.type]||''} ${ab.type==='a'?`· CD:${ab.cd}f · ST:${ab.cost}`:ab.type==='u'?'· 100 ULT':''}</div><div class="ab-name" style="color:${typeCol};">${ab.name}</div><div class="ab-desc">${ab.desc}</div>`;
    list.appendChild(div);
  });
}

function edSetAbsorb(val){
  if(!STATE.editingPlayer)return;
  STATE.editingPlayer.absorbEnabled=val;
  document.getElementById('ab-on').classList.toggle('sel',val);
  document.getElementById('ab-off').classList.toggle('sel',!val);
  notify(val?'ABSORPTION ON':'ABSORPTION OFF');
}

function edSetSpec(spec,val){
  if(!STATE.editingPlayer)return;
  if(!STATE.editingPlayer.specials)STATE.editingPlayer.specials={};
  STATE.editingPlayer.specials[spec]=val;
  document.getElementById(`${spec==='lifesteal'?'ls':spec==='shieldRegen'?'sr':'??'}-on`).classList.toggle('sel',val);
  document.getElementById(`${spec==='lifesteal'?'ls':spec==='shieldRegen'?'sr':'??'}-off`).classList.toggle('sel',!val);
  notify(`${spec.replace(/([A-Z])/g,' $1').toUpperCase()} ${val?'ON':'OFF'}`);
}

function edSetKeybind(kb){
  if(!STATE.editingPlayer)return;
  STATE.editingPlayer.keybind=kb;
  ['wasd','arrows','num'].forEach(k=>{
    const el=document.getElementById(`kb-${k}`);if(el)el.classList.toggle('sel',k===kb);
  });
  notify(`KEYBIND: ${kb.toUpperCase()}`);
}

// ─────────────────────────── SKIN PAINTER ────────────────────────────
const SKIN_PAL=[
  '#4488ff','#2266cc','#ff4444','#cc2222','#44ff88','#22aa66',
  '#ff8844','#cc5522','#cc44ff','#8822cc','#44ccff','#22aacc',
  '#ff44cc','#cc2288','#ffe01a','#cc9900','#ffffff','#aabbcc',
  '#333344','#111118','#88ff44','#ff4488'
];
function buildSkinColors(){
  const wrap=document.getElementById('skin-colors');wrap.innerHTML='';
  SKIN_PAL.forEach(c=>{
    const btn=document.createElement('div');btn.className='sk-col'+(c===STATE.skinColor?' sel':'');
    btn.style.background=c;
    btn.onclick=()=>{STATE.skinColor=c;document.querySelectorAll('.sk-col').forEach(b=>b.classList.toggle('sel',b.style.background===c));};
    wrap.appendChild(btn);
  });
}
function setSkinTool(t){
  STATE.skinTool=t;
  ['brush','fill','line','erase'].forEach(k=>{const el=document.getElementById(`skt-${k}`);if(el)el.classList.toggle('sel',k===t);});
}

let _skinCanvas=null,_skinCtx=null,_skinDown=false,_skinLineP=null;
function initSkinCanvas(){
  _skinCanvas=document.getElementById('skin-canvas');
  _skinCtx=_skinCanvas.getContext('2d');
  // Draw initial character outline
  redrawSkinBG();
  _skinCanvas.addEventListener('mousedown',e=>{_skinDown=true;_skinLineP={x:e.offsetX,y:e.offsetY};doSkinPaint(e);});
  _skinCanvas.addEventListener('mousemove',e=>{if(_skinDown)doSkinPaint(e);});
  _skinCanvas.addEventListener('mouseup',()=>{_skinDown=false;_skinLineP=null;});
  _skinCanvas.addEventListener('mouseleave',()=>{_skinDown=false;_skinLineP=null;});
}

function redrawSkinBG(){
  if(!_skinCtx)return;
  const W=_skinCanvas.width,H=_skinCanvas.height;
  _skinCtx.fillStyle='#060c18';_skinCtx.fillRect(0,0,W,H);
  // Grid
  _skinCtx.strokeStyle='rgba(200,168,75,0.06)';_skinCtx.lineWidth=1;
  for(let i=0;i<W;i+=16){_skinCtx.beginPath();_skinCtx.moveTo(i,0);_skinCtx.lineTo(i,H);_skinCtx.stroke();}
  for(let i=0;i<H;i+=16){_skinCtx.beginPath();_skinCtx.moveTo(0,i);_skinCtx.lineTo(W,i);_skinCtx.stroke();}
  // Character outline for reference
  const p=STATE.editingPlayer;
  const sc=p?.skinColor||'#4488ff';
  _skinCtx.save();_skinCtx.translate(W/2,H*0.72);_skinCtx.scale(0.9,0.9);
  _skinCtx.strokeStyle=hexA(sc,0.35);_skinCtx.lineWidth=2;_skinCtx.lineCap='round';
  _skinCtx.beginPath();_skinCtx.moveTo(0,-60);_skinCtx.lineTo(0,-22);_skinCtx.stroke();// torso
  _skinCtx.beginPath();_skinCtx.arc(0,-72,12,0,Math.PI*2);_skinCtx.stroke();// head
  _skinCtx.beginPath();_skinCtx.moveTo(0,-50);_skinCtx.lineTo(-22,-30);_skinCtx.lineTo(-28,-16);_skinCtx.stroke();// arm L
  _skinCtx.beginPath();_skinCtx.moveTo(0,-50);_skinCtx.lineTo(22,-30);_skinCtx.lineTo(28,-16);_skinCtx.stroke();// arm R
  _skinCtx.beginPath();_skinCtx.moveTo(0,-22);_skinCtx.lineTo(-12,6);_skinCtx.lineTo(-10,28);_skinCtx.stroke();// leg L
  _skinCtx.beginPath();_skinCtx.moveTo(0,-22);_skinCtx.lineTo(12,6);_skinCtx.lineTo(10,28);_skinCtx.stroke();// leg R
  _skinCtx.restore();
}

function doSkinPaint(e){
  if(!_skinCtx||!STATE.editingPlayer)return;
  const x=e.offsetX,y=e.offsetY,r=STATE.skinBrushSize||5;
  if(STATE.skinTool==='brush'){
    if(_skinLineP&&STATE.skinTool==='brush'){
      _skinCtx.strokeStyle=STATE.skinColor;_skinCtx.lineWidth=r*2;_skinCtx.lineCap='round';
      _skinCtx.beginPath();_skinCtx.moveTo(_skinLineP.x,_skinLineP.y);_skinCtx.lineTo(x,y);_skinCtx.stroke();
    }else{
      _skinCtx.fillStyle=STATE.skinColor;_skinCtx.beginPath();_skinCtx.arc(x,y,r,0,Math.PI*2);_skinCtx.fill();
    }
    _skinLineP={x,y};
    STATE.editingPlayer.customPixels=STATE.skinColor;
    STATE.editingPlayer.skinColor=STATE.skinColor;
  }else if(STATE.skinTool==='erase'){
    _skinCtx.clearRect(x-r*2,y-r*2,r*4,r*4);
    redrawSkinBG();
  }else if(STATE.skinTool==='fill'){
    _skinCtx.fillStyle=hexA(STATE.skinColor,0.45);
    _skinCtx.fillRect(0,0,_skinCanvas.width,_skinCanvas.height);
    STATE.editingPlayer.skinColor=STATE.skinColor;
    STATE.editingPlayer.skinColor2=darkenHex(STATE.skinColor,0.35);
  }else if(STATE.skinTool==='line'&&_skinLineP){
    _skinCtx.strokeStyle=STATE.skinColor;_skinCtx.lineWidth=r;_skinCtx.lineCap='round';
    _skinCtx.beginPath();_skinCtx.moveTo(_skinLineP.x,_skinLineP.y);_skinCtx.lineTo(x,y);_skinCtx.stroke();
  }
}

function edResetSkin(){
  if(!STATE.editingPlayer)return;
  STATE.editingPlayer.customPixels=null;
  redrawSkinBG();notify('SKIN RESET');
}
function edSaveSkin(){
  if(!STATE.editingPlayer)return;
  STATE.editingPlayer.skinColor=STATE.skinColor;
  STATE.editingPlayer.skinColor2=darkenHex(STATE.skinColor,0.35);
  notify('SKIN SAVED ✓');
}
function edExportChar(){
  if(!STATE.editingPlayer)return;
  const p=STATE.editingPlayer;
  const data=JSON.stringify({name:p.name,role:p.role,attrs:p.attrs,hp:p.maxHp,atk:p.atk,def:p.def,spd:p.spd,sta:p.maxSta,skinColor:p.skinColor,keybind:p.keybind,specials:p.specials,absorbEnabled:p.absorbEnabled});
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${p.name}_char.json`;a.click();
  notify('CHARACTER EXPORTED');
}

// ─────────────────────────── EDITOR PREVIEW ──────────────────────────
let _edPreviewRunning=false,_edFr=0;
function startEdPreviewLoop(){
  if(_edPreviewRunning)return;_edPreviewRunning=true;edPreviewLoop();
}
function edPreviewLoop(){
  if(STATE.page!=='editor'){_edPreviewRunning=false;return;}
  const cv=document.getElementById('ed-preview');if(!cv){_edPreviewRunning=false;return;}
  const c=cv.getContext('2d');_edFr++;
  c.clearRect(0,0,cv.width,cv.height);
  // Background
  const bg=c.createLinearGradient(0,0,0,cv.height);bg.addColorStop(0,'#040a14');bg.addColorStop(1,'#0a1420');
  c.fillStyle=bg;c.fillRect(0,0,cv.width,cv.height);
  c.strokeStyle='rgba(200,168,75,0.04)';c.lineWidth=1;
  for(let i=0;i<cv.width;i+=18){c.beginPath();c.moveTo(i,0);c.lineTo(i,cv.height);c.stroke();}
  for(let i=0;i<cv.height;i+=18){c.beginPath();c.moveTo(0,i);c.lineTo(cv.width,i);c.stroke();}
  // Ground
  c.strokeStyle='rgba(200,168,75,0.12)';c.lineWidth=1;
  c.beginPath();c.moveTo(0,cv.height-36);c.lineTo(cv.width,cv.height-36);c.stroke();
  const p=STATE.editingPlayer;
  if(p){
    // Temporarily place player for preview
    const px=p.x,py=p.y;const pd=p.depth;
    p.x=cv.width/2;p.y=cv.height-36;p.depth=1;p.onGround=true;
    p.animTime=(_edFr*0.5);p.isDead=false;p.isHurt=false;p.cstate='idle';p.attackType=null;
    // Use the main drawStickman but with a temp canvas context override
    const savedCtx=ctx;
    // We can't easily swap ctx, so draw manually into c
    drawEdPreviewStickman(c,p,_edFr);
    p.x=px;p.y=py;p.depth=pd;
  }
  requestAnimationFrame(edPreviewLoop);
}

function drawEdPreviewStickman(c,p,fr){
  // Simplified stickman drawing in editor preview canvas context
  const cx=p.x,cy=p.y;
  const sc=p.skinColor||'#4488ff';
  const sc2=p.skinColor2||darkenHex(sc,0.3);
  const glow=p.attrs.length>0?ELEM[p.attrs[0]]?.glow:null;
  const pose=getPose(p,fr);
  c.save();c.translate(cx,cy);
  // Aura glow
  if(p.attrs.length>0){
    const col=ELEM[p.attrs[0]]?.col;const pulse=0.5+0.5*Math.sin(fr*0.06);
    const rg=c.createRadialGradient(0,0,5,0,0,50);
    rg.addColorStop(0,hexA(col,0));rg.addColorStop(0.5,hexA(col,0.2+pulse*0.12));rg.addColorStop(1,hexA(col,0));
    c.fillStyle=rg;c.globalAlpha=1;c.beginPath();c.arc(0,-30,50,0,Math.PI*2);c.fill();
  }
  const fr2=(facing)=>{
  const jR=4,tR=5,lR=4;
  const bSY=pose.shoulderY;
  const bLegA=pose.upperLegR,bShinA=pose.shinR,bHipX=4;
  const bKnee={x2:bHipX+Math.sin(bLegA)*20,y2:pose.hipY+Math.cos(bLegA)*20};
  const bFoot={x2:bKnee.x2+Math.sin(bLegA+bShinA)*18,y2:bKnee.y2+Math.cos(bLegA+bShinA)*18};
  function capsule(x1,y1,x2,y2,r,col1,col2,glw){
    c.save();if(glw){c.shadowBlur=8;c.shadowColor=glw;}
    const dx=x2-x1,dy=y2-y1,len=Math.sqrt(dx*dx+dy*dy)||1,ux=dx/len,uy=dy/len,nx=-uy,ny=ux,ang=Math.atan2(dy,dx);
    const grd=c.createLinearGradient(x1-nx*r*1.5,y1-ny*r*1.5,x1+nx*r*1.5,y1+ny*r*1.5);
    grd.addColorStop(0,lightenHex(col1,0.3));grd.addColorStop(1,col2);
    c.beginPath();c.moveTo(x1+nx*r,y1+ny*r);c.lineTo(x2+nx*r,y2+ny*r);
    c.arc(x2,y2,r,ang-Math.PI*0.5,ang+Math.PI*0.5);c.lineTo(x1-nx*r,y1-ny*r);
    c.arc(x1,y1,r,ang+Math.PI*0.5,ang-Math.PI*0.5);c.closePath();c.fillStyle=grd;c.fill();
    if(glw)c.shadowBlur=0;c.restore();
  }
  capsule(bHipX,pose.hipY,bKnee.x2,bKnee.y2,jR,sc,sc2,null);
  capsule(bKnee.x2,bKnee.y2,bFoot.x2,bFoot.y2,jR-0.5,sc,sc2,null);
  const bArmA=pose.upperArmR,bFarmA=pose.forearmR,bSX=pose.shoulderX;
  const bElbow={x2:bSX+Math.sin(bArmA)*18,y2:bSY+Math.cos(bArmA)*18};
  const bHand={x2:bElbow.x2+Math.sin(bArmA+bFarmA)*15,y2:bElbow.y2+Math.cos(bArmA+bFarmA)*15};
  capsule(bSX,bSY,bElbow.x2,bElbow.y2,jR-0.5,sc,sc2,null);
  capsule(bElbow.x2,bElbow.y2,bHand.x2,bHand.y2,jR-1,sc,sc2,null);
  capsule(0,pose.torsoY1,0,pose.torsoY2,tR,sc,sc2,glow,glow?8:0);
  const fLegA=pose.upperLegL,fShinA=pose.shinL,fHipX=-4;
  const fKnee={x2:fHipX+Math.sin(fLegA)*20,y2:pose.hipY+Math.cos(fLegA)*20};
  const fFoot={x2:fKnee.x2+Math.sin(fLegA+fShinA)*18,y2:fKnee.y2+Math.cos(fLegA+fShinA)*18};
  capsule(fHipX,pose.hipY,fKnee.x2,fKnee.y2,jR,sc,sc2,glow,glow?4:0);
  capsule(fKnee.x2,fKnee.y2,fFoot.x2,fFoot.y2,jR-0.5,sc,sc2,glow,glow?3:0);
  const fArmA=pose.upperArmL,fFarmA=pose.forearmL,fSX=-pose.shoulderX;
  const fElbow={x2:fSX+Math.sin(fArmA)*18,y2:bSY+Math.cos(fArmA)*18};
  const fHand={x2:fElbow.x2+Math.sin(fArmA+fFarmA)*15,y2:fElbow.y2+Math.cos(fArmA+fFarmA)*15};
  capsule(fSX,bSY,fElbow.x2,fElbow.y2,jR-0.5,sc,sc2,glow,glow?5:0);
  capsule(fElbow.x2,fElbow.y2,fHand.x2,fHand.y2,jR-1,sc,sc2,glow,glow?4:0);
  drawHead(c,0,pose.headY,12,sc,glow,1,false);
  };
  fr2(1);
  c.restore();
}

// ─────────────────────────── PATH RECORDER ───────────────────────────
function toggleRecord(){
  const btn=document.getElementById('rec-btn');
  if(!STATE.isRecording){
    STATE.isRecording=true;STATE.recordBuffer=[];
    btn.textContent='⏹ STOP';btn.classList.add('recording');
    notify('● RECORDING');
  }else{
    STATE.isRecording=false;
    btn.textContent='⏺ REC';btn.classList.remove('recording');
    notify(`RECORDED ${STATE.recordBuffer.length} INPUTS`);
  }
}
function updateRecDisp(){
  const d=document.getElementById('rec-disp');if(!d)return;
  if(!STATE.recordBuffer.length){d.textContent='No recording.';return;}
  const recent=STATE.recordBuffer.slice(-10);
  d.textContent=recent.map(r=>`[${r.key}]`).join(' ')+(STATE.recordBuffer.length>10?` +${STATE.recordBuffer.length-10}more`:'');
}
function playRecord(){
  if(!STATE.recordBuffer.length){notify('NO RECORDING','#ff8844');return;}
  if(!STATE.editingPlayer){notify('NO PLAYER SELECTED','#ff8844');return;}
  notify(`▶ PLAYING ${STATE.recordBuffer.length} INPUTS`);
  const start=STATE.recordBuffer[0].t;
  STATE.recordBuffer.forEach(r=>{
    setTimeout(()=>{
      STATE.keys[r.key.toLowerCase()]=true;
      STATE.keys[r.key.toLowerCase()+'_once']=true;
      setTimeout(()=>{STATE.keys[r.key.toLowerCase()]=false;},80);
    },r.t-start);
  });
}
function clearRecord(){
  STATE.recordBuffer=[];STATE.isRecording=false;
  const btn=document.getElementById('rec-btn');if(btn){btn.textContent='⏺ REC';btn.classList.remove('recording');}
  updateRecDisp();notify('RECORDING CLEARED');
}

// ═══════════════════════════════════════════════════════════════════════
//  COOL FEATURES TRACKER (aura)
// ═══════════════════════════════════════════════════════════════════════
// On game start, show a quick tip
setTimeout(()=>{
  if(STATE.page==='menu')notify('TIP: Spawn 2+ fighters and press Q/E to attack!');
},3000);

doLoad();
</script>
</body>
</html>
