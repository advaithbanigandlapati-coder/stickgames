<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GeoDash — Deep Space</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width:100%; height:100%; background:#000; overflow:hidden; touch-action:none; user-select:none; }
  canvas { display:block; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); cursor:pointer; }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="canvas"></canvas>
<script>
'use strict';
// ═══════════════════════════════════════════════════════════════
//  GeoDash — Deep Space  |  v2.0
//  Fixed physics, calm audio, 5 distinct levels
// ═══════════════════════════════════════════════════════════════

const BASE_W   = 900;
const BASE_H   = 500;
const GROUND_Y = 400;      // top of ground surface
const GRAVITY  = 1800;     // px/s²  (positive = down)
const JUMP_VEL = -660;     // px/s   (negative = up)
const PLAYER_S = 28;

// ─── UTILS ──────────────────────────────────────────────────────
const lerp   = (a,b,t) => a+(b-a)*t;
const clamp  = (v,lo,hi) => Math.max(lo,Math.min(hi,v));
const rnd    = (a,b) => a+Math.random()*(b-a);
const rndInt = (a,b) => Math.floor(rnd(a,b+1));
const easeOut= t => 1-Math.pow(1-t,3);
const hex2rgba=(hex,a)=>{const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;};

// ─── CANVAS ─────────────────────────────────────────────────────
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let scale=1;
function resize(){
  scale=Math.min(window.innerWidth/BASE_W,window.innerHeight/BASE_H);
  canvas.width=BASE_W; canvas.height=BASE_H;
  canvas.style.width=BASE_W*scale+'px'; canvas.style.height=BASE_H*scale+'px';
}
resize();
window.addEventListener('resize',resize);

// ─── LEVELS ─────────────────────────────────────────────────────
const LEVELS=[
  { id:0, name:'THE VOID',      threshold:0,    baseSpd:240, maxSpd:340, root:110,
    bg1:'#000010',bg2:'#000818',bg3:'#00050f',
    accent:'#00d4ff',accent2:'#0077bb',obGlow:'#00aaff',obGlow2:'#004488',starCol:'#aaeeff',patSet:0 },
  { id:1, name:'NEBULA STORM',  threshold:600,  baseSpd:300, maxSpd:420, root:138,
    bg1:'#0a0018',bg2:'#14002a',bg3:'#09001e',
    accent:'#cc44ff',accent2:'#7700bb',obGlow:'#bb33ff',obGlow2:'#550099',starCol:'#ddaaff',patSet:1 },
  { id:2, name:'SOLAR FLARE',   threshold:1400, baseSpd:360, maxSpd:500, root:165,
    bg1:'#140800',bg2:'#1e0a00',bg3:'#170600',
    accent:'#ff6600',accent2:'#aa2200',obGlow:'#ff4400',obGlow2:'#881100',starCol:'#ffccaa',patSet:2 },
  { id:3, name:'QUANTUM RIFT',  threshold:2600, baseSpd:420, maxSpd:580, root:185,
    bg1:'#001410',bg2:'#001e18',bg3:'#001510',
    accent:'#00ffaa',accent2:'#009955',obGlow:'#00ff88',obGlow2:'#007744',starCol:'#aaffdd',patSet:3 },
  { id:4, name:'EVENT HORIZON', threshold:4200, baseSpd:500, maxSpd:680, root:220,
    bg1:'#080808',bg2:'#0f0f18',bg3:'#080810',
    accent:'#ffffff',accent2:'#aaaaee',obGlow:'#ffffff',obGlow2:'#7777cc',starCol:'#ffffff',patSet:4 },
];
function levelFor(score){ let l=LEVELS[0]; for(const x of LEVELS){if(score>=x.threshold)l=x;} return l; }

// ─── AUDIO ──────────────────────────────────────────────────────
// Gentle triangle/sine pads only — no harsh sawtooth
const Aud=(()=>{
  let AC,muted=false,pads=[],padGain,arpT=null,curRoot=110;

  function init(){ if(AC)return; AC=new(window.AudioContext||window.webkitAudioContext)(); }

  function chime(freq,vol=0.10,dur=0.22){
    if(!AC||muted)return;
    const o=AC.createOscillator(),g=AC.createGain(),f=AC.createBiquadFilter();
    o.type='triangle'; o.frequency.value=freq;
    f.type='lowpass'; f.frequency.value=freq*4;
    g.gain.setValueAtTime(vol,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+dur);
    o.connect(f);f.connect(g);g.connect(AC.destination);
    o.start();o.stop(AC.currentTime+dur);
  }

  function jump(){ chime(520,0.09,0.16); chime(780,0.04,0.10); }

  function die(){
    if(!AC||muted)return;
    const o=AC.createOscillator(),g=AC.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(110,AC.currentTime);
    o.frequency.exponentialRampToValueAtTime(35,AC.currentTime+0.45);
    g.gain.setValueAtTime(0.22,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+0.5);
    o.connect(g);g.connect(AC.destination);
    o.start();o.stop(AC.currentTime+0.5);
    setTimeout(()=>chime(180,0.07,0.2),70);
    setTimeout(()=>chime(140,0.05,0.2),140);
  }

  function levelUp(){ [523,659,784,1046].forEach((f,i)=>setTimeout(()=>chime(f,0.07,0.3),i*70)); }

  function startBG(root=110){
    if(!AC)return; stopBG(); curRoot=root; if(muted)return;
    padGain=AC.createGain(); padGain.gain.value=0.055;
    const filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=700; filt.Q.value=0.7;
    padGain.connect(filt); filt.connect(AC.destination);
    [root,root*1.5,root*2,root*3].forEach((f,i)=>{
      const o=AC.createOscillator(),g=AC.createGain();
      o.type=i<2?'triangle':'sine'; o.frequency.value=f+rnd(-0.2,0.2);
      g.gain.value=[0.5,0.3,0.15,0.07][i];
      o.connect(g);g.connect(padGain); o.start(); pads.push(o);
    });
    const notes=[root*2,root*2.5,root*3,root*4];
    let s=0;
    function tick(){ if(!AC||muted)return; chime(notes[s++%notes.length],0.035,0.22); arpT=setTimeout(tick,rnd(290,380)); }
    tick();
  }

  function stopBG(){ pads.forEach(o=>{try{o.stop();}catch(e){}});pads=[];clearTimeout(arpT);arpT=null; }

  function shiftRoot(root){
    curRoot=root;
    if(!AC||muted)return;
    pads.forEach((o,i)=>{
      const freqs=[root,root*1.5,root*2,root*3];
      if(freqs[i])o.frequency.linearRampToValueAtTime(freqs[i],AC.currentTime+2);
    });
  }

  function toggleMute(){ muted=!muted; if(muted)stopBG(); else startBG(curRoot); return muted; }

  return {init,jump,die,levelUp,startBG,stopBG,shiftRoot,toggleMute,get muted(){return muted;}};
})();

// ─── PARTICLES ──────────────────────────────────────────────────
const MAX_P=320,pPool=[],pActive=[];
const pg=()=>pPool.length?pPool.pop():{};
function precycle(p){const i=pActive.indexOf(p);if(i!==-1)pActive.splice(i,1);pPool.push(p);}
function spawnP(x,y,n,o={}){
  for(let i=0;i<n&&pActive.length<MAX_P;i++){
    const p=pg();
    const an=o.angle!==undefined?o.angle+rnd(-(o.spread||Math.PI),o.spread||Math.PI):rnd(0,Math.PI*2);
    const sp=rnd(o.minSp||1,o.maxSp||5);
    p.x=x;p.y=y;p.vx=Math.cos(an)*sp;p.vy=Math.sin(an)*sp;
    p.life=1;p.decay=rnd(o.minD||0.016,o.maxD||0.04);
    p.size=rnd(o.minSz||1,o.maxSz||4);
    p.color=o.colors?o.colors[rndInt(0,o.colors.length-1)]:'#fff';
    p.grav=o.grav!==undefined?o.grav:0.08;
    pActive.push(p);
  }
}
function updateP(dt){ for(let i=pActive.length-1;i>=0;i--){const p=pActive[i];p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;p.vy+=p.grav*dt*60;p.life-=p.decay*dt*60;if(p.life<=0)precycle(p);} }
function drawP(){
  ctx.save();ctx.globalCompositeOperation='lighter';
  pActive.forEach(p=>{ctx.globalAlpha=Math.max(0,p.life*0.9);ctx.shadowColor=p.color;ctx.shadowBlur=5;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(0.1,p.size*p.life),0,Math.PI*2);ctx.fill();});
  ctx.restore();
}

// ─── BACKGROUND ─────────────────────────────────────────────────
const BG=(()=>{
  let layers=[],planets=[],fogs=[],shooters=[],curLv=LEVELS[0];
  function mkPlanet(x){const cs=[['#1a3a6e','#2255aa'],['#3a1a6e','#7722aa'],['#1a5a4e','#22aa88'],['#6e3a1a','#aa7722']];const c=cs[rndInt(0,cs.length-1)];return{x,y:rnd(45,GROUND_Y-90),r:rnd(14,44),c1:c[0],c2:c[1],rings:Math.random()>0.5,spd:rnd(0.04,0.12)};}
  function init(){
    layers=[];
    for(let l=0;l<4;l++){const stars=[];const n=[280,140,60,20][l];for(let i=0;i<n;i++)stars.push({x:rnd(0,BASE_W),y:rnd(0,BASE_H),r:rnd(0.15+l*0.12,0.45+l*0.35),tw:rnd(0,Math.PI*2),ts:rnd(0.5,2.5)});layers.push(stars);}
    planets=[];for(let i=0;i<3;i++)planets.push(mkPlanet(rnd(0,BASE_W)));
    fogs=[];for(let i=0;i<3;i++)fogs.push({x:rnd(0,BASE_W),y:rnd(0,BASE_H),r:rnd(80,210),al:rnd(0.02,0.07),dx:rnd(-0.05,0.05)});
  }
  function update(dt,spd,lv){
    curLv=lv;
    const ss=[spd*0.013,spd*0.038,spd*0.095,spd*0.19];
    layers.forEach((ls,l)=>ls.forEach(s=>{s.x-=ss[l]*dt*60;if(s.x<-2)s.x=BASE_W+2;s.tw+=s.ts*dt;}));
    if(Math.random()<0.004)shooters.push({x:rnd(BASE_W*0.4,BASE_W),y:rnd(0,BASE_H*0.4),vx:rnd(-7,-3),vy:rnd(0.5,2.5),len:rnd(40,90),life:1});
    for(let i=shooters.length-1;i>=0;i--){const s=shooters[i];s.x+=s.vx*dt*60;s.y+=s.vy*dt*60;s.life-=dt*0.9;if(s.life<=0||s.x<-50)shooters.splice(i,1);}
    planets.forEach((p,i)=>{p.x-=p.spd*spd*dt;if(p.x<-60)planets[i]=mkPlanet(BASE_W+60);});
    fogs.forEach(f=>{f.x+=f.dx*dt*60-spd*0.011*dt*60;if(f.x<-f.r*2)f.x=BASE_W+f.r;});
  }
  function draw(spd){
    const lv=curLv,t=Date.now()*0.001,inten=Math.min(1,spd/480);
    const gr=ctx.createLinearGradient(0,0,0,BASE_H);
    gr.addColorStop(0,lv.bg1);gr.addColorStop(0.5,lv.bg2);gr.addColorStop(1,lv.bg3);
    ctx.fillStyle=gr;ctx.fillRect(0,0,BASE_W,BASE_H);
    fogs.forEach(f=>{const ng=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.r);ng.addColorStop(0,hex2rgba(lv.accent,f.al*(1+inten)));ng.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=ng;ctx.beginPath();ctx.arc(f.x,f.y,f.r,0,Math.PI*2);ctx.fill();});
    planets.forEach(p=>{ctx.save();ctx.shadowColor=p.c2;ctx.shadowBlur=16;const pg=ctx.createRadialGradient(p.x-p.r*0.3,p.y-p.r*0.3,p.r*0.1,p.x,p.y,p.r);pg.addColorStop(0,p.c2);pg.addColorStop(1,p.c1);ctx.fillStyle=pg;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();if(p.rings){ctx.globalAlpha=0.28;ctx.strokeStyle=p.c2;ctx.lineWidth=1.4;ctx.beginPath();ctx.ellipse(p.x,p.y,p.r*1.8,p.r*0.32,0.3,0,Math.PI*2);ctx.stroke();}ctx.restore();});
    layers.forEach((ls,l)=>{ls.forEach(s=>{const tw=0.6+0.4*Math.sin(s.tw);ctx.save();ctx.globalAlpha=([0.4,0.6,0.8,1][l])*tw;ctx.globalCompositeOperation='lighter';ctx.fillStyle=lv.starCol;ctx.shadowColor=lv.accent;ctx.shadowBlur=s.r*4;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});});
    shooters.forEach(sh=>{const ang=Math.atan2(sh.vy,sh.vx);const sg=ctx.createLinearGradient(sh.x,sh.y,sh.x-Math.cos(ang)*sh.len,sh.y-Math.sin(ang)*sh.len);sg.addColorStop(0,`rgba(220,245,255,${sh.life})`);sg.addColorStop(1,'rgba(0,0,0,0)');ctx.save();ctx.globalCompositeOperation='lighter';ctx.strokeStyle=sg;ctx.lineWidth=1.4;ctx.beginPath();ctx.moveTo(sh.x,sh.y);ctx.lineTo(sh.x-Math.cos(ang)*sh.len,sh.y-Math.sin(ang)*sh.len);ctx.stroke();ctx.restore();});
    const vig=ctx.createRadialGradient(BASE_W/2,BASE_H/2,BASE_H*0.2,BASE_W/2,BASE_H/2,BASE_H*0.85);vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(1,'rgba(0,0,0,0.58)');ctx.fillStyle=vig;ctx.fillRect(0,0,BASE_W,BASE_H);
  }
  return{init,update,draw};
})();

// ─── GROUND ─────────────────────────────────────────────────────
function drawGround(spd,lv){
  const t=Date.now()*0.001;
  const gg=ctx.createLinearGradient(0,GROUND_Y,0,BASE_H);gg.addColorStop(0,'#040410');gg.addColorStop(1,'#000');
  ctx.fillStyle=gg;ctx.fillRect(0,GROUND_Y,BASE_W,BASE_H-GROUND_Y);
  ctx.save();ctx.globalCompositeOperation='lighter';
  const pulse=0.38+0.28*Math.sin(t*4);
  const ge=ctx.createLinearGradient(0,GROUND_Y,0,GROUND_Y+5);ge.addColorStop(0,hex2rgba(lv.accent,pulse));ge.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=ge;ctx.fillRect(0,GROUND_Y,BASE_W,5);ctx.restore();
  const gridSp=55,offset=(Date.now()*spd*0.00009)%gridSp;
  ctx.save();ctx.globalAlpha=0.09;ctx.strokeStyle=lv.accent;ctx.lineWidth=0.8;
  for(let gx=-offset;gx<BASE_W;gx+=gridSp){ctx.beginPath();ctx.moveTo(gx,GROUND_Y);ctx.lineTo(gx-26,BASE_H);ctx.stroke();}
  ctx.restore();
}

// ─── OBSTACLE PATTERNS ───────────────────────────────────────────
// 5 sets, progressively harder
const PAT=[
  [[{t:'s',rx:0}],[{t:'s',rx:0},{t:'s',rx:28}],[{t:'b',rx:0}],[{t:'s',rx:0},{t:'b',rx:80}]],
  [[{t:'s',rx:0},{t:'s',rx:28}],[{t:'b',rx:0},{t:'s',rx:36}],[{t:'s',rx:0},{t:'s',rx:28},{t:'b',rx:110}],[{t:'b',rx:0},{t:'b',rx:34}]],
  [[{t:'s',rx:0},{t:'s',rx:28},{t:'s',rx:56}],[{t:'b',rx:0},{t:'s',rx:36},{t:'s',rx:64}],[{t:'s',rx:0},{t:'b',rx:80},{t:'s',rx:114}],[{t:'s',rx:0},{t:'s',rx:28},{t:'b',rx:100},{t:'b',rx:132}]],
  [[{t:'s',rx:0},{t:'s',rx:28},{t:'s',rx:56},{t:'b',rx:140}],[{t:'b',rx:0},{t:'b',rx:34},{t:'s',rx:100}],[{t:'s',rx:0},{t:'s',rx:28},{t:'s',rx:56},{t:'s',rx:84}],[{t:'b',rx:0},{t:'s',rx:36},{t:'b',rx:80},{t:'s',rx:116}]],
  [[{t:'s',rx:0},{t:'s',rx:28},{t:'s',rx:56},{t:'s',rx:84}],[{t:'b',rx:0},{t:'s',rx:36},{t:'s',rx:64},{t:'b',rx:130}],[{t:'s',rx:0},{t:'s',rx:28},{t:'b',rx:90},{t:'s',rx:126},{t:'s',rx:154}],[{t:'s',rx:0},{t:'s',rx:28},{t:'s',rx:56},{t:'s',rx:84},{t:'b',rx:158}]],
];

// ─── OBSTACLES ──────────────────────────────────────────────────
const Obs=(()=>{
  const SW=24,SH=36,BW=32,BH=32;
  let obs=[],nextX=0;
  function reset(){obs=[];nextX=BASE_W+260;}
  function spawnGroup(x,lv){
    const ps=PAT[lv.patSet];
    const tmpl=ps[rndInt(0,ps.length-1)];
    tmpl.forEach(({t,rx})=>{
      if(t==='s')obs.push({type:'spike',x:x+rx,y:GROUND_Y-SH,w:SW,h:SH,ph:rnd(0,Math.PI*2),lv});
      else obs.push({type:'block',x:x+rx,y:GROUND_Y-BH,w:BW,h:BH,ph:rnd(0,Math.PI*2),lv});
    });
  }
  function update(dt,spd,lv){
    obs.forEach(o=>o.x-=spd*dt);
    obs=obs.filter(o=>o.x+o.w>-80);
    // Ensure there are obstacles ready ahead
    const frontX=obs.reduce((m,o)=>Math.max(m,o.x+o.w),nextX-200);
    while(nextX<frontX+BASE_W+300){spawnGroup(nextX,lv);nextX+=rnd(230,370);}
  }
  function drawSpike(o,t){
    const p=0.55+0.45*Math.sin(t*4+o.ph),lv=o.lv;
    ctx.save();ctx.shadowColor=lv.obGlow;ctx.shadowBlur=14*p;
    const sg=ctx.createLinearGradient(o.x+o.w/2,o.y+o.h,o.x+o.w/2,o.y);
    sg.addColorStop(0,'#040008');sg.addColorStop(0.4,lv.obGlow2);sg.addColorStop(1,lv.accent);
    ctx.fillStyle=sg;ctx.beginPath();ctx.moveTo(o.x,o.y+o.h);ctx.lineTo(o.x+o.w/2,o.y);ctx.lineTo(o.x+o.w,o.y+o.h);ctx.closePath();ctx.fill();
    ctx.globalAlpha=0.55*p;ctx.strokeStyle=lv.accent;ctx.lineWidth=1.1;ctx.shadowBlur=3;ctx.stroke();
    ctx.restore();
  }
  function drawBlock(o,t){
    const p=0.6+0.4*Math.sin(t*2.5+o.ph),lv=o.lv;
    ctx.save();ctx.shadowColor=lv.obGlow;ctx.shadowBlur=12*p;
    const bg=ctx.createLinearGradient(o.x,o.y,o.x+o.w,o.y+o.h);bg.addColorStop(0,'#04000a');bg.addColorStop(0.5,lv.obGlow2);bg.addColorStop(1,'#010005');
    ctx.fillStyle=bg;ctx.fillRect(o.x,o.y,o.w,o.h);
    ctx.globalAlpha=0.65*p;ctx.strokeStyle=lv.accent;ctx.lineWidth=1.3;ctx.shadowBlur=4;ctx.strokeRect(o.x+0.5,o.y+0.5,o.w-1,o.h-1);
    ctx.restore();
  }
  function draw(t){obs.forEach(o=>o.type==='spike'?drawSpike(o,t):drawBlock(o,t));}
  function collides(hb){
    for(const o of obs){
      if(o.type==='spike'){const m=4;if(hb.x<o.x+o.w-m&&hb.x+hb.w>o.x+m&&hb.y+hb.h>o.y+o.h*0.38&&hb.y<o.y+o.h)return true;}
      else{if(hb.x<o.x+o.w&&hb.x+hb.w>o.x&&hb.y<o.y+o.h&&hb.y+hb.h>o.y)return true;}
    }
    return false;
  }
  return{reset,update,draw,collides};
})();

// ─── PLAYER ─────────────────────────────────────────────────────
const Player=(()=>{
  const S=PLAYER_S;
  let x,y,vy,grnd,dead,rot,rotv,trail=[];
  const TLEN=20;

  function reset(){x=100;y=GROUND_Y-S;vy=0;grnd=true;dead=false;rot=0;rotv=0;trail=[];}

  function jump(){
    if(grnd&&!dead){
      vy=JUMP_VEL;           // correct upward velocity
      grnd=false;rotv=-11;
      Aud.jump();
      spawnP(x+S/2,y+S,5,{angle:-Math.PI/2,spread:0.7,minSp:1,maxSp:4,colors:['#4cf','#8af','#fff'],minD:0.04,maxD:0.07,grav:0.03});
    }
  }

  function kill(lv){
    if(dead)return;dead=true;
    Aud.die();Shake.trigger(13,0.5);
    spawnP(x+S/2,y+S/2,60,{minSp:1,maxSp:10,colors:['#f44','#f80','#ff0',lv.accent,'#fff'],minD:0.012,maxD:0.035,grav:0.05,minSz:1,maxSz:5});
    spawnP(x+S/2,y+S/2,18,{minSp:3,maxSp:13,colors:['#fff','#ffe'],minD:0.04,maxD:0.07,grav:0.01,minSz:2,maxSz:6});
  }

  function update(dt){
    if(dead)return;
    // ── CORRECT physics ──────────────────────────────────
    vy += GRAVITY * dt;    // gravity in px/s² → adds px/s per second
    y  += vy * dt;         // position in px, velocity in px/s
    // ─────────────────────────────────────────────────────
    if(y>=GROUND_Y-S){y=GROUND_Y-S;vy=0;grnd=true;rotv=lerp(rotv,0,0.3);}
    else grnd=false;
    rot+=rotv*dt*60*0.016;
    if(!grnd)rotv=lerp(rotv,-4.5,0.018);
    trail.unshift({x:x+S/2,y:y+S/2});
    if(trail.length>TLEN)trail.pop();
    if(Math.random()<0.5)spawnP(x-3,y+S*0.5+rnd(-4,4),1,{angle:Math.PI,spread:0.45,minSp:1.5,maxSp:4,colors:['#4cfbff','#08aaff','#6af'],minD:0.05,maxD:0.1,grav:0,minSz:0.4,maxSz:2});
  }

  function draw(lv){
    trail.forEach((pt,i)=>{const a=(1-i/TLEN)*0.42,r=S*0.4*(1-i/TLEN);ctx.save();ctx.globalAlpha=a;ctx.globalCompositeOperation='lighter';const tg=ctx.createRadialGradient(pt.x,pt.y,0,pt.x,pt.y,r);tg.addColorStop(0,lv.accent);tg.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=tg;ctx.beginPath();ctx.arc(pt.x,pt.y,r,0,Math.PI*2);ctx.fill();ctx.restore();});
    if(dead)return;
    const cx=x+S/2,cy=y+S/2;
    ctx.save();ctx.translate(cx,cy);ctx.rotate(rot);
    ctx.save();ctx.globalCompositeOperation='lighter';ctx.globalAlpha=0.28;ctx.fillStyle=lv.accent;ctx.shadowColor=lv.accent;ctx.shadowBlur=22;ctx.fillRect(-S/2-4,-S/2-4,S+8,S+8);ctx.restore();
    const bg=ctx.createLinearGradient(-S/2,-S/2,S/2,S/2);bg.addColorStop(0,'#ffffff');bg.addColorStop(0.3,lv.accent);bg.addColorStop(1,lv.accent2);
    ctx.fillStyle=bg;ctx.shadowColor=lv.accent;ctx.shadowBlur=16;ctx.fillRect(-S/2,-S/2,S,S);
    ctx.strokeStyle='rgba(255,255,255,0.42)';ctx.lineWidth=1.5;ctx.shadowBlur=0;ctx.beginPath();ctx.moveTo(-S/2+5,0);ctx.lineTo(S/2-5,0);ctx.moveTo(0,-S/2+5);ctx.lineTo(0,S/2-5);ctx.stroke();
    ctx.fillStyle='#fff';ctx.shadowBlur=6;[[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([dx,dy])=>{ctx.beginPath();ctx.arc(dx*(S/2-5),dy*(S/2-5),2,0,Math.PI*2);ctx.fill();});
    ctx.restore();
  }

  function hitbox(){const m=5;return{x:x+m,y:y+m,w:S-m*2,h:S-m*2};}
  return{reset,jump,kill,update,draw,hitbox,get dead(){return dead;}};
})();

// ─── SCREEN SHAKE ────────────────────────────────────────────────
const Shake=(()=>{let mag=0,dur=0,el=0;return{trigger(m,d){mag=m;dur=d;el=0;},update(dt){if(el<dur)el+=dt;else mag=0;},apply(){if(!mag)return;const d=1-(el/dur);ctx.translate(rnd(-1,1)*mag*d,rnd(-1,1)*mag*d);}};})();

// ─── STATE ───────────────────────────────────────────────────────
const ST={MENU:0,CD:1,PLAY:2,PAUSE:3,DEAD:4};
const G={
  state:ST.MENU, score:0, best:parseInt(localStorage.getItem('gdv2_hi')||'0'),
  spd:240, time:0, lv:LEVELS[0],
  cdVal:3,cdT:0, deadA:0, lvFlash:0,

  startGame(){
    this.score=0;this.spd=LEVELS[0].baseSpd;this.time=0;this.lv=LEVELS[0];
    this.deadA=0;this.lvFlash=0;
    Player.reset();Obs.reset();pActive.length=0;
    this.state=ST.CD;this.cdVal=3;this.cdT=0;
    Aud.startBG(LEVELS[0].root);
  },
  restart(){this.startGame();}
};

// ─── INPUT ───────────────────────────────────────────────────────
function onAction(){
  Aud.init();
  if(G.state===ST.MENU){G.startGame();return;}
  if(G.state===ST.PLAY){Player.jump();return;}
  if(G.state===ST.DEAD&&G.deadA>0.65){G.restart();return;}
}
canvas.addEventListener('pointerdown',e=>{e.preventDefault();onAction();});
window.addEventListener('keydown',e=>{
  if(['Space','ArrowUp','KeyW'].includes(e.code)){e.preventDefault();onAction();}
  if(['Escape','KeyP'].includes(e.code)){if(G.state===ST.PLAY)G.state=ST.PAUSE;else if(G.state===ST.PAUSE)G.state=ST.PLAY;}
  if(e.code==='KeyM')Aud.toggleMute();
});

// ─── UI ──────────────────────────────────────────────────────────
function txt(s,x,y,o={}){
  ctx.save();ctx.font=`${o.w||'700'} ${o.sz||18}px Orbitron,monospace`;ctx.textAlign=o.align||'center';ctx.textBaseline=o.base||'middle';
  if(o.glow){ctx.shadowColor=o.glow;ctx.shadowBlur=o.gb||16;}
  ctx.fillStyle=o.color||'#fff';
  if(o.stroke){ctx.strokeStyle=o.stroke;ctx.lineWidth=o.sw||3;ctx.strokeText(s,x,y);}
  ctx.fillText(s,x,y);ctx.restore();
}

function drawMenu(t){
  const bob=Math.sin(t*1.4)*7;
  ctx.save();ctx.globalCompositeOperation='lighter';ctx.globalAlpha=0.22+0.1*Math.sin(t*2);ctx.font='900 86px Orbitron,monospace';ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor='#00d4ff';ctx.shadowBlur=55;ctx.fillStyle='#00d4ff';ctx.fillText('GEODASH',BASE_W/2,BASE_H/2-52+bob);ctx.restore();
  const tg=ctx.createLinearGradient(0,BASE_H/2-98,0,BASE_H/2-12);tg.addColorStop(0,'#fff');tg.addColorStop(0.35,'#88eeff');tg.addColorStop(1,'#0077aa');
  ctx.save();ctx.font='900 86px Orbitron,monospace';ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor='#00d4ff';ctx.shadowBlur=26;ctx.fillStyle=tg;ctx.fillText('GEODASH',BASE_W/2,BASE_H/2-52+bob);ctx.restore();
  txt('DEEP SPACE',BASE_W/2,BASE_H/2+5+bob,{sz:17,w:'400',color:`rgba(80,210,255,${0.5+0.45*Math.sin(t*3)})`,glow:'#4cf',gb:10});
  // Level list
  LEVELS.forEach((lv,i)=>txt(lv.name,BASE_W/2,BASE_H/2+42+i*20,{sz:10,w:'400',color:hex2rgba(lv.accent,0.35+0.2*Math.sin(t*2+i)),glow:lv.accent,gb:5}));
  const pp=0.45+0.55*Math.sin(t*3.2);
  txt('SPACE  ·  CLICK  ·  TAP  TO  START',BASE_W/2,BASE_H/2+158,{sz:13,w:'400',color:`rgba(160,235,255,${pp})`});
  if(G.best>0)txt(`BEST  ${G.best.toString().padStart(6,'0')}`,BASE_W/2,BASE_H-34,{sz:12,color:'#f8a',glow:'#f4a',gb:12});
  txt('M  MUTE   ESC  PAUSE',BASE_W-14,BASE_H-13,{sz:9,w:'400',align:'right',color:'rgba(60,120,160,0.5)'});
}

function drawHUD(lv){
  txt(lv.name,18,28,{sz:10,w:'400',align:'left',color:hex2rgba(lv.accent,0.78),glow:lv.accent,gb:8});
  txt(G.score.toString().padStart(6,'0'),BASE_W-16,27,{sz:22,w:'900',align:'right',color:'#efffff',glow:'#4cfbff',gb:18});
  txt('SCORE',BASE_W-16,46,{sz:9,w:'400',align:'right',color:'rgba(80,200,255,0.6)'});
  txt(G.best.toString().padStart(6,'0'),BASE_W-16,68,{sz:13,align:'right',color:hex2rgba(lv.accent,0.72),glow:lv.accent,gb:8});
  txt('BEST',BASE_W-16,82,{sz:9,w:'400',align:'right',color:hex2rgba(lv.accent,0.42)});
  const w=Math.floor((G.spd-LEVELS[0].baseSpd)/28);
  if(w>0)txt(`WARP ${w}`,18,52,{sz:10,w:'400',align:'left',color:`rgba(255,${Math.max(0,215-w*18)},50,0.9)`,glow:'#f80',gb:10});
  if(Aud.muted)txt('♪ MUTED',BASE_W/2,17,{sz:10,color:'rgba(200,80,80,0.8)'});
}

function drawCD(val,frac){
  const label=val===0?'GO!':String(val);const sz=80+easeOut(frac)*115;const a=frac<0.5?frac*2:1-(frac-0.5)*2;
  ctx.save();ctx.globalAlpha=a;ctx.font=`900 ${sz}px Orbitron,monospace`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowColor=val===0?'#4cfbff':'#fff';ctx.shadowBlur=50;ctx.fillStyle='#fff';ctx.fillText(label,BASE_W/2,BASE_H/2);ctx.restore();
}

function drawDead(a,lv){
  ctx.save();ctx.globalAlpha=Math.min(a,0.78);ctx.fillStyle='rgba(0,0,0,0.88)';ctx.fillRect(0,0,BASE_W,BASE_H);ctx.restore();
  if(a>0.3){const fa=(a-0.3)/0.7;ctx.save();ctx.globalAlpha=fa;txt('GAME OVER',BASE_W/2,BASE_H/2-54,{sz:54,w:'900',color:'#fee',glow:'#f44',gb:40});txt(`SCORE  ${G.score.toString().padStart(6,'0')}`,BASE_W/2,BASE_H/2+14,{sz:22,w:'700',color:'#eef',glow:lv.accent,gb:20});txt(lv.name,BASE_W/2,BASE_H/2+42,{sz:12,w:'400',color:hex2rgba(lv.accent,0.8)});if(G.score>=G.best&&G.score>0){const pb=0.5+0.5*Math.sin(Date.now()*0.005);txt('NEW  BEST!',BASE_W/2,BASE_H/2+68,{sz:14,color:`rgba(255,220,60,${pb})`,glow:'#ffa',gb:15});}if(a>0.68){const pp=0.45+0.55*Math.sin(Date.now()*0.005);txt('TAP  OR  SPACE  TO  RETRY',BASE_W/2,BASE_H/2+102,{sz:13,color:`rgba(180,240,255,${pp})`});}ctx.restore();}
}

function drawPaused(){ctx.fillStyle='rgba(0,0,15,0.65)';ctx.fillRect(0,0,BASE_W,BASE_H);txt('PAUSED',BASE_W/2,BASE_H/2-18,{sz:52,w:'900',color:'#eff',glow:'#4cf',gb:40});txt('ESC / P  ·  RESUME',BASE_W/2,BASE_H/2+36,{sz:14,color:'rgba(100,220,255,0.8)'});}

function drawLvFlash(a,lv){
  if(a<=0)return;
  ctx.save();ctx.globalAlpha=a*0.55;ctx.fillStyle=lv.accent;ctx.globalCompositeOperation='lighter';ctx.fillRect(0,0,BASE_W,BASE_H);ctx.restore();
  ctx.save();ctx.globalAlpha=a;txt(lv.name,BASE_W/2,BASE_H/2,{sz:40,w:'900',color:'#fff',glow:lv.accent,gb:40});ctx.restore();
}

// ─── MAIN LOOP ────────────────────────────────────────────────────
let last=0;
function loop(ts){
  const dt=Math.min((ts-last)/1000,0.05); last=ts;
  const t=ts*0.001;
  ctx.clearRect(0,0,BASE_W,BASE_H);
  ctx.save();
  Shake.update(dt);Shake.apply();

  const lv=G.lv;
  BG.update(dt,G.state===ST.PLAY?G.spd:180,lv);
  BG.draw(G.spd);

  if(G.state===ST.MENU){
    drawGround(180,LEVELS[0]);drawMenu(t);
  }
  else if(G.state===ST.CD){
    drawGround(G.spd,lv);Obs.draw(t);updateP(dt);drawP();Player.draw(lv);
    G.cdT+=dt;if(G.cdT>=1){G.cdT=0;G.cdVal--;if(G.cdVal<0)G.state=ST.PLAY;}
    if(G.cdVal>=0)drawCD(G.cdVal,G.cdT);else drawCD(0,G.cdT);
  }
  else if(G.state===ST.PLAY){
    G.time+=dt;
    G.score=Math.floor(G.time*12);

    // Speed ramp within this level's range
    G.spd=clamp(lv.baseSpd+G.time*14,lv.baseSpd,lv.maxSpd);

    // Level check
    const nLv=levelFor(G.score);
    if(nLv.id!==lv.id){G.lv=nLv;G.lvFlash=1;Aud.shiftRoot(nLv.root);Aud.levelUp();}
    G.lvFlash=Math.max(0,G.lvFlash-dt*1.9);

    if(G.score>G.best){G.best=G.score;localStorage.setItem('gdv2_hi',G.best);}

    Obs.update(dt,G.spd,lv);
    Player.update(dt);
    updateP(dt);

    if(!Player.dead&&Obs.collides(Player.hitbox())){Player.kill(lv);G.state=ST.DEAD;G.deadA=0;Aud.stopBG();}

    drawGround(G.spd,lv);Obs.draw(t);drawP();Player.draw(lv);drawHUD(lv);
    if(G.lvFlash>0)drawLvFlash(G.lvFlash,lv);
  }
  else if(G.state===ST.PAUSE){
    drawGround(G.spd,lv);Obs.draw(t);drawP();Player.draw(lv);drawHUD(lv);drawPaused();
  }
  else if(G.state===ST.DEAD){
    G.deadA=Math.min(1,G.deadA+dt*1.1);
    updateP(dt);
    drawGround(G.spd,lv);Obs.draw(t);drawP();Player.draw(lv);drawHUD(lv);drawDead(G.deadA,lv);
  }

  ctx.restore();
  requestAnimationFrame(loop);
}

// ── BOOT ─────────────────────────────────────────────────────────
BG.init();Player.reset();
requestAnimationFrame(ts=>{last=ts;requestAnimationFrame(loop);});
</script>
</body>
</html>
